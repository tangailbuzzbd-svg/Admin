<!DOCTYPE html>
<html lang="en" class="theme-indigo">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Default Light Mode Colors */
            --c-bg-primary: #ffffff; /* white */
            --c-bg-secondary: #ffffff; /* white */
            --c-text-primary: #1f2937; /* dark gray */
            --c-text-secondary: #6b7280; /* gray-500 */
            --c-border: #e5e7eb; /* gray-200 */
        }
        
        html.dark {
            /* Dark Mode Colors */
            --c-bg-primary: #111827; /* gray-900 */
            --c-bg-secondary: #1f2937; /* gray-800 */
            --c-text-primary: #f3f4f6; /* light gray */
            --c-text-secondary: #d1d5db; /* gray-300 */
            --c-border: #374151; /* gray-700 */
        }
        
        body { 
            font-family: 'Inter', sans-serif;
            background-color: var(--c-bg-primary);
            color: var(--c-text-primary);
        }

        .bg-primary { background-color: var(--c-bg-primary); }
        .bg-secondary { background-color: var(--c-bg-secondary); }
        .text-primary { color: var(--c-text-primary); }
        .text-secondary { color: var(--c-text-secondary); }
        .border-color { border-color: var(--c-border); }

        .sidebar { transition: transform 0.3s ease-in-out; }
        .main-content { transition: margin-left 0.3s ease-in-out; }
        .stat-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .stat-card:hover { transform: translateY(-5px); }
        [x-cloak] { display: none !important; }
        #new-order-alert { transition: transform 0.3s ease-in-out; }
        .rotate-anim { animation: spin 1s ease-in-out; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* --- Theme Variables --- */
        .theme-indigo {
            --c-primary: #4f46e5; --c-primary-hover: #4338ca; --c-ring: #4f46e5;
            --c-text-theme: #4f46e5; --c-bg-light: #e0e7ff;
        }
        .theme-forest {
            --c-primary: #16a34a; --c-primary-hover: #15803d; --c-ring: #16a34a;
            --c-text-theme: #16a34a; --c-bg-light: #dcfce7;
        }
        .theme-crimson {
            --c-primary: #dc2626; --c-primary-hover: #b91c1c; --c-ring: #dc2626;
            --c-text-theme: #dc2626; --c-bg-light: #fee2e2;
        }
        .theme-ocean {
            --c-primary: #0284c7; --c-primary-hover: #0369a1; --c-ring: #0284c7;
            --c-text-theme: #0284c7; --c-bg-light: #e0f2fe;
        }
        .theme-royal {
            --c-primary: #9333ea; --c-primary-hover: #7e22ce; --c-ring: #9333ea;
            --c-text-theme: #9333ea; --c-bg-light: #f3e8ff;
        }

        /* --- Theme-aware Component Styles --- */
        .nav-link.active { background-color: var(--c-primary); color: white; }
        .bg-theme-primary { background-color: var(--c-primary); }
        .hover\:bg-theme-primary-hover:hover { background-color: var(--c-primary-hover); }
        .focus\:ring-theme-primary:focus { --tw-ring-color: var(--c-ring) !important; box-shadow: 0 0 0 2px var(--c-ring) !important; }
        .text-theme-primary { color: var(--c-text-theme); }
        .bg-theme-bg-light { background-color: var(--c-bg-light); }
        .peer:checked ~ .peer-checked\:bg-theme-primary { background-color: var(--c-primary); }
        
        /* Custom style for pending order highlighting */
        .pending-order {
            background-color: #fffbeb; /* Light yellow background */
        }
        html.dark .pending-order {
            background-color: #2b2b23; /* Darker yellow/gray for dark mode */
        }

        /* Custom style for unread chat highlighting */
        .unread-chat {
            background-color: #eef2ff; /* indigo-100 */
        }
        html.dark .unread-chat {
            background-color: #3730a3; /* indigo-800 */
        }
        .chat-list-item {
            transition: background-color 0.2s ease-in-out;
        }

        /* Neon Button Glow Effect */
        .btn-glow {
            --glow-color: var(--c-primary);
            --glow-ring-color: var(--c-ring);
            box-shadow: 0 0 3px rgba(255,255,255,0.3), 0 0 8px var(--glow-color), 0 0 12px var(--glow-ring-color);
            transition: all 0.2s ease-in-out;
            border: 1px solid color-mix(in srgb, var(--glow-color) 70%, white 30%);
        }
        .btn-glow:hover {
            box-shadow: 0 0 4px rgba(255,255,255,0.4), 0 0 12px var(--glow-color), 0 0 20px var(--glow-ring-color);
            transform: translateY(-1px);
        }

        .btn-glow-red {
            --glow-color: #dc2626; /* red-600 */
            --glow-ring-color: #f87171; /* red-400 */
            box-shadow: 0 0 3px rgba(255,255,255,0.3), 0 0 8px var(--glow-color), 0 0 12px var(--glow-ring-color);
            transition: all 0.2s ease-in-out;
            border: 1px solid var(--glow-ring-color);
        }
        .btn-glow-red:hover {
            box-shadow: 0 0 4px rgba(255,255,255,0.4), 0 0 12px var(--glow-color), 0 0 20px var(--glow-ring-color);
            transform: translateY(-1px);
        }

        .btn-glow-green {
            --glow-color: #16a34a; /* green-600 */
            --glow-ring-color: #4ade80; /* green-400 */
            box-shadow: 0 0 3px rgba(255,255,255,0.3), 0 0 8px var(--glow-color), 0 0 12px var(--glow-ring-color);
            transition: all 0.2s ease-in-out;
            border: 1px solid var(--glow-ring-color);
        }
        .btn-glow-green:hover {
            box-shadow: 0 0 4px rgba(255,255,255,0.4), 0 0 12px var(--glow-color), 0 0 20px var(--glow-ring-color);
            transform: translateY(-1px);
        }
    </style>
</head>
<body class="bg-primary">

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="flex items-center justify-center min-h-screen">
        <div class="w-16 h-16 border-4 border-t-4 border-gray-200 border-t-indigo-600 rounded-full animate-spin"></div>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="flex items-center justify-center min-h-screen hidden bg-cover bg-center" style="background-image: url('https://github.com/tangailbuzzbd-svg/TangailBuzz-Picture-/blob/main/vecteezy_ai-generated-empty-wooden-table-on-the-natural-background_40890255.jpg?raw=true');">
        <div class="w-full max-w-sm relative">
            <img id="login-profile-pic" src="https://github.com/tangailbuzzbd-svg/TangailBuzz-Picture-/blob/main/WhatsApp%20Image%202025-07-30%20at%2019.29.33_9f8c7d06.jpg?raw=true" alt="Profile" class="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-24 h-24 rounded-full border-4 border-white dark:border-gray-700 shadow-lg z-10">
            <div class="p-8 pt-16 space-y-6 bg-white/20 dark:bg-gray-900/60 backdrop-blur-lg border border-white/30 rounded-2xl shadow-2xl">
                <h2 class="text-2xl font-bold text-center text-white">Tangail Buzz Admin</h2>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="email" class="text-sm font-medium text-white block mb-1">Enter Your Email</label>
                        <input type="email" id="email" name="email" required class="w-full px-4 py-2 bg-white/50 dark:bg-gray-700/50 border-0 border-b-2 border-white/50 text-white placeholder-gray-300 focus:ring-0 focus:border-white transition">
                    </div>
                    <div>
                        <label for="password" class="text-sm font-medium text-white block mb-1">Enter Your Password</label>
                        <input type="password" id="password" name="password" required class="w-full px-4 py-2 bg-white/50 dark:bg-gray-700/50 border-0 border-b-2 border-white/50 text-white placeholder-gray-300 focus:ring-0 focus:border-white transition">
                    </div>
                    <div class="flex items-center">
                        <input id="keep-signed-in" type="checkbox" class="h-4 w-4 text-theme-primary bg-gray-50/50 border-white/50 focus:ring-theme-primary rounded">
                        <label for="keep-signed-in" class="ml-2 block text-sm text-white">Keep me signed in on this device</label>
                    </div>
                    <p id="login-error" class="text-sm text-red-300"></p>
                    <button type="submit" class="w-full py-3 font-semibold text-white bg-green-500 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-400 disabled:bg-green-400 btn-glow-green">LOGIN</button>
                </form>
            </div>
        </div>
    </div>

    <!-- PIN Verification Screen -->
    <div id="pin-verification-screen" class="flex items-center justify-center min-h-screen hidden bg-cover bg-center" style="background-image: url('https://github.com/tangailbuzzbd-svg/TangailBuzz-Picture-/blob/main/vecteezy_ai-generated-empty-wooden-table-on-the-natural-background_40890255.jpg?raw=true');">
        <div class="w-full max-w-sm p-8 space-y-6 bg-white/20 dark:bg-gray-900/60 backdrop-blur-lg border border-white/30 rounded-2xl shadow-2xl">
            <h2 class="text-2xl font-bold text-center text-white">Enter Security PIN</h2>
            <form id="pin-verification-form" class="space-y-4">
                <div>
                    <label for="pin-input" class="text-sm font-medium text-white block mb-1">Your 4-Digit PIN</label>
                    <input type="password" id="pin-input" name="pin" required maxlength="4" pattern="\d{4}" class="w-full px-4 py-2 bg-white/50 dark:bg-gray-700/50 border-0 border-b-2 border-white/50 text-white text-center text-2xl tracking-[1em] focus:ring-0 focus:border-white transition">
                </div>
                <p id="pin-error" class="text-sm text-red-300"></p>
                <button type="submit" class="w-full py-3 font-semibold text-white bg-green-500 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-400 disabled:bg-green-400 btn-glow-green">VERIFY</button>
            </form>
        </div>
    </div>

 
     <!-- Admin Panel -->
     <div id="admin-panel" class="hidden">
         <div class="flex h-screen" x-data="{ sidebarOpen: true }">
            <!-- Sidebar -->
            <aside class="sidebar fixed inset-y-0 left-0 z-30 w-64 bg-secondary transform transition-transform duration-300 ease-in-out" :class="{'translate-x-0': sidebarOpen, '-translate-x-full': !sidebarOpen}">
                <div class="flex items-center justify-between h-20 px-6 border-b border-color">
                    <h1 class="text-2xl font-bold text-theme-primary">Admin</h1>
                </div>
                <nav class="mt-6">
                    <a href="#dashboard" class="nav-link flex items-center px-6 py-3 text-text-primary hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-theme-primary active" data-page="dashboard"><i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i><span>Dashboard</span></a>
                    <a href="#products" class="nav-link flex items-center px-6 py-3 text-text-primary hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-theme-primary" data-page="products"><i data-lucide="package" class="w-5 h-5 mr-3"></i><span>Products</span></a>
                    <a href="#low-stock" class="nav-link flex items-center px-6 py-3 text-text-primary hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-theme-primary" data-page="low-stock"><i data-lucide="alert-triangle" class="w-5 h-5 mr-3"></i><span>Low Stock</span></a>
                    <a href="#add-product" class="nav-link flex items-center px-6 py-3 text-text-primary hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-theme-primary" data-page="add-product"><i data-lucide="plus-circle" class="w-5 h-5 mr-3"></i><span>Add Product</span></a>
                    <a href="#reviews" class="nav-link flex items-center px-6 py-3 text-text-primary hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-theme-primary" data-page="reviews"><i data-lucide="star" class="w-5 h-5 mr-3"></i><span>Reviews & Ratings</span></a>
                    <a href="#banners" class="nav-link flex items-center px-6 py-3 text-text-primary hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-theme-primary" data-page="banners"><i data-lucide="image" class="w-5 h-5 mr-3"></i><span>Banners</span></a>
                    <a href="#side-promo" class="nav-link flex items-center px-6 py-3 text-text-primary hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-theme-primary" data-page="side-promo">
                        <i data-lucide="image-plus" class="w-5 h-5 mr-3"></i>
                        <span>Side Promo</span>
                    </a>
                    <a href="#coupons" class="nav-link flex items-center px-6 py-3 text-text-primary hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-theme-primary" data-page="coupons"><i data-lucide="ticket-percent" class="w-5 h-5 mr-3"></i><span>Coupons</span></a>
                    <a href="#orders" class="nav-link flex items-center px-6 py-3 text-text-primary hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-theme-primary" data-page="orders"><i data-lucide="shopping-cart" class="w-5 h-5 mr-3"></i><span>Orders</span><span id="pending-orders-badge" class="ml-auto text-xs font-bold text-white bg-red-500 rounded-full px-2 py-0.5 hidden">0</span></a>
                    <a href="#users" class="nav-link flex items-center px-6 py-3 text-text-primary hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-theme-primary" data-page="users"><i data-lucide="users" class="w-5 h-5 mr-3"></i><span>Users</span></a>
                    <a href="#delivery" class="nav-link flex items-center px-6 py-3 text-text-primary hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-theme-primary" data-page="delivery"><i data-lucide="truck" class="w-5 h-5 mr-3"></i><span>Delivery</span></a>
                    <a href="#chat" class="nav-link flex items-center px-6 py-3 text-text-primary hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-theme-primary relative" data-page="chat">
                        <i data-lucide="message-square" class="w-5 h-5 mr-3"></i>
                        <span>Live Chat</span>
                        <span id="unseen-sms-badge" class="ml-auto text-xs font-bold text-white bg-red-500 rounded-full px-2 py-0.5 hidden">0</span>
                        <span id="chat-notification-bubble" class="absolute left-4 top-2 w-2 h-2 bg-red-500 rounded-full hidden animate-pulse"></span>
                    </a>
                    <a href="#settings" class="nav-link flex items-center px-6 py-3 text-text-primary hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-theme-primary" data-page="settings"><i data-lucide="settings" class="w-5 h-5 mr-3"></i><span>Settings</span></a>
                </nav>
            </aside>

            <!-- Main Content -->
            <div class="main-content flex-1 flex flex-col overflow-hidden transition-all duration-300 ease-in-out" :class="{'ml-64': sidebarOpen, 'ml-0': !sidebarOpen}">
                <header class="flex items-center justify-between h-20 px-6 bg-secondary border-b border-color">
                    <button @click="sidebarOpen = !sidebarOpen" class="text-text-secondary focus:outline-none"><i data-lucide="menu" class="w-6 h-6"></i></button>
                    <div class="text-2xl font-semibold text-text-primary" id="page-title">Dashboard</div>
                    <div class="flex items-center">
                        <!-- Global Search -->
                        <div class="hidden md:flex items-center relative mr-4 w-72">
                            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-text-secondary"></i>
                            <input id="global-search-input" type="text" placeholder="Search by Order/User/Product/Delivery ID..." class="w-full pl-10 pr-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary" />
                        </div>
                        <!-- Quick section select -->
                        <div class="mr-4">
                            <select id="quick-section-select" class="px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-theme-primary">
                                <option value="dashboard">Dashboard</option>
                                <option value="products">Products</option>
                                <option value="low-stock">Low Stock</option>
                                <option value="reviews">Reviews</option>
                                <option value="orders">All Orders</option>
                                <option value="users">All Users</option>
                            </select>
                        </div>
                        <!-- UPDATED: Digital Clock container -->
                        <div id="digital-clock" class="text-right text-text-secondary mr-4 hidden sm:block tabular-nums leading-tight">
                            <!-- Clock content will be injected by JS -->
                        </div>
                        <!-- Manual Refresh Button -->
                        <button id="manual-refresh-button" class="text-text-secondary focus:outline-none mr-4" title="Refresh Data">
                            <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                        </button>
                        <!-- Notification Bell -->
                        <div x-data="{ notificationsOpen: false }" class="relative">
                            <button @click="handleNotificationClick($data)" class="relative text-text-secondary focus:outline-none">
                                <i data-lucide="bell" class="w-6 h-6"></i>
                                <span id="notification-count" class="absolute -top-1 -right-1 flex items-center justify-center w-4 h-4 text-xs font-bold text-white bg-red-500 rounded-full hidden"></span>
                            </button>
                            <div x-show="notificationsOpen" @click.away="notificationsOpen = false" x-cloak class="absolute right-0 mt-2 w-80 bg-secondary rounded-lg shadow-xl overflow-hidden z-10">
                                <div class="py-2 px-4 text-sm font-semibold text-text-primary border-b border-color">Notifications</div>
                                <div id="notification-list" class="max-h-64 overflow-y-auto">
                                    <p class="p-4 text-sm text-text-secondary">No new notifications.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Profile Dropdown -->
                        <div x-data="{ profileOpen: false }" class="relative ml-4">
                            <button @click="profileOpen = !profileOpen" class="flex items-center space-x-2 focus:outline-none">
                                <span id="header-admin-name" class="hidden sm:inline text-sm font-medium text-text-primary">Admin</span>
                                <img id="header-admin-image" class="w-8 h-8 rounded-full object-cover" src="https://placehold.co/32x32/e2e8f0/64748b?text=A" alt="Admin Profile">
                            </button>
                            <div x-show="profileOpen" @click.away="profileOpen = false" x-cloak class="absolute right-0 mt-2 w-48 bg-secondary rounded-lg shadow-xl overflow-hidden z-10">
                                <div class="px-4 py-2 border-b border-color">
                                    <p id="dropdown-admin-name" class="text-sm font-semibold text-text-primary">Admin</p>
                                    <p id="dropdown-admin-email" class="text-xs text-text-secondary truncate">email@example.com</p>
                                </div>
                                <a href="#settings" @click="profileOpen = false" class="nav-link block px-4 py-2 text-sm text-text-primary hover:bg-gray-100 dark:hover:bg-gray-600" data-page="settings">Settings</a>
                                <button id="logout-button" class="w-full text-left block px-4 py-2 text-sm text-red-600 hover:bg-gray-100 dark:text-red-400 dark:hover:bg-gray-600">Logout</button>
                            </div>
                        </div>
                    </div>
                </header>

                <main class="flex-1 overflow-x-hidden overflow-y-auto p-6 bg-primary">
                    <!-- Dashboard Page -->
                    <div id="dashboard-page" class="page-content">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                            <!-- RE-ORGANIZED: Stat Cards for better logical flow -->
                            
                            <!-- Group 1: Key Financial & Inventory Metrics -->
                            <div class="stat-card bg-gradient-to-br from-purple-600 to-blue-500 text-white p-4 rounded-lg shadow-lg flex items-center space-x-4 cursor-pointer" data-page="orders" data-filter="delivered" title="Shudhu 'Delivered' order theke total sale hishab kora hoyeche">
                                <div class="bg-white/20 rounded-full p-3 flex-shrink-0"><i data-lucide="dollar-sign" class="w-8 h-8"></i></div>
                                <div><p class="text-sm font-medium text-blue-100">Total Sales</p><p class="text-3xl font-bold" id="total-sale">৳0</p></div>
                            </div>
                            <div class="stat-card bg-gradient-to-br from-green-500 to-teal-400 text-white p-4 rounded-lg shadow-lg flex items-center space-x-4 cursor-pointer" data-page="orders" data-filter="all">
                                <div class="bg-white/20 rounded-full p-3 flex-shrink-0"><i data-lucide="shopping-bag" class="w-8 h-8"></i></div>
                                <div><p class="text-sm font-medium text-teal-100">Total Orders</p><p class="text-3xl font-bold" id="total-orders">0</p></div>
                            </div>
                            <div class="stat-card bg-gradient-to-br from-teal-400 to-cyan-600 text-white p-4 rounded-lg shadow-lg flex items-center space-x-4 cursor-pointer" title="Total value of all products currently in stock">
                               <div class="bg-white/20 rounded-full p-3 flex-shrink-0"><i data-lucide="database" class="w-8 h-8"></i></div>
                               <div><p class="text-sm font-medium text-cyan-100">Total Stock Value</p><p class="text-3xl font-bold" id="total-stock-value">৳0</p></div>
                           </div>
                            <div class="stat-card bg-gradient-to-br from-lime-500 to-emerald-500 text-white p-4 rounded-lg shadow-lg flex items-center space-x-4 cursor-pointer" data-page="products" title="Total units of all products currently in stock">
                                <div class="bg-white/20 rounded-full p-3 flex-shrink-0"><i data-lucide="layers" class="w-8 h-8"></i></div>
                                <div><p class="text-sm font-medium text-emerald-100">Total Stock</p><p class="text-3xl font-bold" id="total-stock-count">0</p></div>
                            </div>
                           
                            <!-- Group 2: Order Status Breakdown -->
                            <div class="stat-card bg-gradient-to-br from-yellow-400 to-orange-400 text-white p-4 rounded-lg shadow-lg flex items-center space-x-4 cursor-pointer" data-page="orders" data-filter="pending">
                                <div class="bg-white/20 rounded-full p-3 flex-shrink-0"><i data-lucide="clock" class="w-8 h-8"></i></div>
                                <div><p class="text-sm font-medium text-orange-100">Pending Orders</p><p class="text-3xl font-bold" id="total-pending">0</p></div>
                            </div>
                            <div class="stat-card bg-gradient-to-br from-emerald-500 to-green-600 text-white p-4 rounded-lg shadow-lg flex items-center space-x-4 cursor-pointer" data-page="orders" data-filter="confirmed">
                                <div class="bg-white/20 rounded-full p-3 flex-shrink-0"><i data-lucide="check-circle" class="w-8 h-8"></i></div>
                                <div><p class="text-sm font-medium text-green-100">Confirmed Orders</p><p class="text-3xl font-bold" id="total-confirmed">0</p></div>
                            </div>
                            <div class="stat-card bg-gradient-to-br from-sky-500 to-indigo-500 text-white p-4 rounded-lg shadow-lg flex items-center space-x-4 cursor-pointer" data-page="orders" data-filter="shipped">
                                <div class="bg-white/20 rounded-full p-3 flex-shrink-0"><i data-lucide="ship" class="w-8 h-8"></i></div>
                                <div><p class="text-sm font-medium text-indigo-100">Shipped Orders</p><p class="text-3xl font-bold" id="total-shipped">0</p></div>
                            </div>
                            <div class="stat-card bg-gradient-to-br from-orange-400 to-red-500 text-white p-4 rounded-lg shadow-lg flex items-center space-x-4 cursor-pointer" data-page="orders" data-filter="out-for-delivery">
                                <div class="bg-white/20 rounded-full p-3 flex-shrink-0"><i data-lucide="truck" class="w-8 h-8"></i></div>
                                <div><p class="text-sm font-medium text-red-100">Out for Delivery</p><p class="text-3xl font-bold" id="total-out-for-delivery">0</p></div>
                            </div>
                            <div class="stat-card bg-gradient-to-br from-violet-500 to-fuchsia-500 text-white p-4 rounded-lg shadow-lg flex items-center space-x-4 cursor-pointer" data-page="orders" data-filter="delivered">
                                <div class="bg-white/20 rounded-full p-3 flex-shrink-0"><i data-lucide="package-check" class="w-8 h-8"></i></div>
                                <div><p class="text-sm font-medium text-fuchsia-100">Delivered Orders</p><p class="text-3xl font-bold" id="total-delivered">0</p></div>
                            </div>
                            <div class="stat-card bg-gradient-to-br from-rose-500 to-red-600 text-white p-4 rounded-lg shadow-lg flex items-center space-x-4 cursor-pointer" data-page="orders" data-filter="cancelled">
                                <div class="bg-white/20 rounded-full p-3 flex-shrink-0"><i data-lucide="x-circle" class="w-8 h-8"></i></div>
                                <div><p class="text-sm font-medium text-red-100">Cancelled Orders</p><p class="text-3xl font-bold" id="total-cancelled">0</p></div>
                            </div>

                            <!-- Group 3: Platform Metrics -->
                            <div class="stat-card bg-gradient-to-br from-pink-500 to-rose-500 text-white p-4 rounded-lg shadow-lg flex items-center space-x-4 cursor-pointer" data-page="products">
                                <div class="bg-white/20 rounded-full p-3 flex-shrink-0"><i data-lucide="archive" class="w-8 h-8"></i></div>
                                <div><p class="text-sm font-medium text-rose-100">Total Products</p><p class="text-3xl font-bold" id="total-products-stat">0</p></div>
                            </div>
                             <div class="stat-card bg-gradient-to-br from-red-500 to-orange-500 text-white p-4 rounded-lg shadow-lg flex items-center space-x-4 cursor-pointer" data-page="users">
                                <div class="bg-white/20 rounded-full p-3 flex-shrink-0"><i data-lucide="users" class="w-8 h-8"></i></div>
                                <div><p class="text-sm font-medium text-orange-100">Total Users</p><p class="text-3xl font-bold" id="total-users">0</p></div>
                            </div>
                            <div class="stat-card bg-gradient-to-br from-indigo-500 to-violet-500 text-white p-4 rounded-lg shadow-lg flex items-center space-x-4 cursor-pointer" data-page="delivery">
                                <div class="bg-white/20 rounded-full p-3 flex-shrink-0"><i data-lucide="user-check" class="w-8 h-8"></i></div>
                                <div><p class="text-sm font-medium text-violet-100">Total Delivery Men</p><p class="text-3xl font-bold" id="total-delivery-men">0</p></div>
                            </div>
                            <div class="stat-card bg-gradient-to-br from-red-600 to-rose-600 text-white p-4 rounded-lg shadow-lg flex items-center space-x-4 cursor-pointer" data-page="low-stock" title="Products with stock below threshold">
                                <div class="bg-white/20 rounded-full p-3 flex-shrink-0"><i data-lucide="alert-triangle" class="w-8 h-8"></i></div>
                                <div><p class="text-sm font-medium text-rose-100">Low Stock</p><p class="text-3xl font-bold" id="total-low-stock">0</p></div>
                            </div>
                            <div class="stat-card bg-gradient-to-br from-cyan-500 to-sky-500 text-white p-4 rounded-lg shadow-lg flex items-center space-x-4 cursor-pointer" data-page="coupons">
                                <div class="bg-white/20 rounded-full p-3 flex-shrink-0"><i data-lucide="ticket-percent" class="w-8 h-8"></i></div>
                                <div><p class="text-sm font-medium text-sky-100">Active Coupons</p><p class="text-3xl font-bold" id="total-active-coupons">0</p></div>
                            </div>
                            <div class="stat-card bg-gradient-to-br from-amber-500 to-yellow-400 text-white p-4 rounded-lg shadow-lg flex items-center space-x-4 cursor-pointer" data-page="chat">
                                <div class="bg-white/20 rounded-full p-3 flex-shrink-0"><i data-lucide="mail-unread" class="w-8 h-8"></i></div>
                                <div><p class="text-sm font-medium text-yellow-100">Total Unseen SMS</p><p class="text-3xl font-bold" id="total-unseen-sms">0</p></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
                            <div class="bg-secondary p-6 rounded-lg shadow-md"><h3 class="text-xl font-semibold text-text-primary mb-4">Recent Orders</h3><div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="text-xs font-semibold tracking-wide text-text-secondary uppercase border-b border-color bg-gray-50 dark:bg-gray-700"><th class="px-4 py-3">Sl. No.</th><th class="px-4 py-3">Order ID</th><th class="px-4 py-3">Customer</th><th class="px-4 py-3">Amount</th><th class="px-4 py-3">Status</th></tr></thead><tbody class="divide-y border-color" id="recent-orders-body"><tr class="text-text-primary"><td colspan="5" class="px-4 py-3 text-center">Loading...</td></tr></tbody></table></div></div>
                            <div class="bg-secondary p-6 rounded-lg shadow-md"><h3 class="text-xl font-semibold text-text-primary mb-4">New Users</h3><div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="text-xs font-semibold tracking-wide text-text-secondary uppercase border-b border-color bg-gray-50 dark:bg-gray-700"><th class="px-4 py-3">User</th><th class="px-4 py-3">Email</th><th class="px-4 py-3">Join Date</th></tr></thead><tbody class="divide-y border-color" id="recent-users-body"><tr class="text-text-primary"><td colspan="3" class="px-4 py-3 text-center">Loading...</td></tr></tbody></table></div></div>
                        </div>
                    </div>

                    <!-- Live Chat Page -->
                    <div id="chat-page" class="page-content hidden">
                        <div class="h-[calc(100vh-10rem)] bg-secondary rounded-lg shadow-md flex">
                            <!-- Chat List -->
                            <div class="w-1/3 border-r border-color flex flex-col">
                                <div class="p-4 border-b border-color">
                                    <h3 class="text-lg font-semibold text-text-primary">Conversations</h3>
                                    <div class="mt-3 flex items-center gap-2">
                                        <div class="relative flex-1">
                                            <input id="chat-search-input" type="text" placeholder="Search name or message..." class="w-full pl-9 pr-3 py-2 text-sm bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-theme-primary" />
                                            <i data-lucide="search" class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-text-secondary"></i>
                                        </div>
                                        <label class="flex items-center gap-2 text-xs text-text-secondary select-none">
                                            <input id="chat-unread-toggle" type="checkbox" class="accent-theme-primary" />
                                            Unread only
                                        </label>
                                    </div>
                                </div>
                                <div id="chat-list-container" class="flex-1 overflow-y-auto">
                                    <p class="p-4 text-center text-text-secondary">Loading chats...</p>
                                </div>
                            </div>
                            <!-- Chat Window -->
                            <div class="w-2/3 flex flex-col">
                                <div id="chat-window-placeholder" class="flex flex-col items-center justify-center h-full text-center text-text-secondary">
                                    <i data-lucide="message-square" class="w-16 h-16 mb-4"></i>
                                    <h3 class="text-xl font-semibold">Select a conversation</h3>
                                    <p>Choose a user from the list to start chatting.</p>
                                </div>
                                <div id="chat-window-main" class="hidden flex-col h-full">
                                    <!-- Chat Header -->
                                <div id="chat-header" class="p-4 border-b border-color flex items-center justify-between cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors">
                                    <div class="flex items-center gap-3">
                                        <img id="chat-header-avatar" src="https://placehold.co/40x40" class="w-10 h-10 rounded-full object-cover">
                                        <div>
                                            <div class="flex items-center gap-2">
                                                <h3 id="chat-header-name" class="font-semibold text-text-primary">User Name</h3>
                                                <span id="chat-header-blocked-badge" class="hidden text-[10px] font-semibold px-1.5 py-0.5 rounded bg-red-100 text-red-700 dark:bg-red-800/40 dark:text-red-300">Blocked</span>
                                            </div>
                                            <p id="chat-header-status" class="text-xs text-text-secondary">Last update: —</p>
                                        </div>
                                    </div>
                                    <div id="chat-header-actions" class="flex items-center gap-1 px-1">
                                        <button class="view-profile-btn p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700" title="View Profile">
                                            <i data-lucide="id-card" class="w-4 h-4"></i>
                                        </button>
                                        <button id="chat-header-block-btn" class="block-user-btn p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700" data-id="" data-blocked="false" title="Block/Unblock">
                                            <i data-lucide="ban" class="w-4 h-4"></i>
                                        </button>
                                        <button id="chat-header-delete-btn" class="delete-chat-btn p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 text-red-600" data-id="" title="Delete Conversation">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                                <!-- Messages -->
                                <div id="messages-container" class="flex-1 p-4 overflow-y-auto space-y-4">
                                    <!-- Messages will be injected here -->
                                    </div>
                                    <!-- Message Input -->
                                    <div class="p-4 border-t border-color">
                                        <div id="chat-blocked-banner" class="hidden mb-2 text-xs text-red-600 bg-red-50 dark:bg-red-900/30 dark:text-red-300 px-3 py-2 rounded-md">User is blocked. Messaging is disabled.</div>
                                        <form id="chat-message-form" class="flex items-end gap-2">
                                            <textarea id="chat-message-input" rows="1" placeholder="Type a message (Enter to send, Shift+Enter for new line)" autocomplete="off" class="resize-none w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-theme-primary"></textarea>
                                            <button type="submit" class="p-3 bg-theme-primary text-white rounded-md disabled:bg-opacity-70 flex-shrink-0 btn-glow" title="Send">
                                                <i data-lucide="send" class="w-5 h-5"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Products Page -->
                    <div id="products-page" class="page-content hidden">
                        <div class="bg-secondary p-6 rounded-lg shadow-md">
                            <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                                <h3 class="text-xl font-semibold text-text-primary">All Products</h3>
                                <div class="flex flex-wrap items-center gap-4 mt-2 sm:mt-0">
								<button id="bulk-upload-btn" class="bg-theme-primary text-white font-bold py-2 px-4 rounded-lg disabled:bg-opacity-70 btn-glow flex items-center space-x-2 mr-4">
    <i data-lucide="upload-cloud" class="w-5 h-5"></i>
    <span>Bulk Upload (CSV)</span>
</button>
<input type="file" id="csv-file-input" accept=".csv" class="hidden">
                                    <!-- Category Filters -->
                                    <div id="product-category-filters" class="flex flex-wrap items-center gap-2">
                                        <!-- Filter buttons will be dynamically inserted here -->
                                    </div>
                                    <!-- Sub-Category Filter Dropdown -->
                                    <div id="product-subcategory-filter-container" class="hidden">
                                        <!-- Dropdown will be inserted here by JS -->
                                    </div>
                                    <!-- Bulk actions -->
                                    <div class="flex items-center gap-3">
                                        <label class="inline-flex items-center text-sm select-none">
                                            <input id="products-select-all" type="checkbox" class="mr-2 accent-theme-primary">
                                            Select All
                                        </label>
                                        <button id="products-delete-selected" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-3 rounded-lg btn-glow-red" title="Delete selected products">Delete Selected</button>
                                    </div>
                                    <!-- Duplicates Detector (top-right) -->
                                    <div class="ml-auto flex items-center gap-2 order-last">
                                        <button id="products-toggle-duplicates" class="bg-amber-500 hover:bg-amber-600 text-white font-semibold py-2 px-3 rounded-lg btn-glow" title="Show only duplicated products">
                                            <i data-lucide="alert-triangle" class="w-4 h-4 mr-2"></i>
                                            Show Duplicates
                                        </button>
                                        <span id="duplicates-summary" class="text-xs text-text-secondary"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead>
                                        <tr class="text-xs font-semibold tracking-wide text-text-secondary uppercase border-b border-color bg-gray-50 dark:bg-gray-700">
                                            <th class="px-4 py-3">#</th>
                                            <th class="px-4 py-3 text-center">Select</th>
                                            <th class="px-4 py-3">Image</th>
                                            <th class="px-4 py-3">Name</th>
                                            <th class="px-4 py-3">Product ID</th>
                                            <th class="px-4 py-3">Category</th>
                                            <th class="px-4 py-3">Sub-Category</th>
                                            <th class="px-4 py-3">Main Price</th>
                                            <th class="px-4 py-3">Offer Price</th>
                                            <th class="px-4 py-3">Stock</th>
                                            <th class="px-4 py-3">Offer %</th>
                                            <th class="px-4 py-3">On Offer</th>
                                            <th class="px-4 py-3">Refundable</th>
                                            <th class="px-4 py-3">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y border-color" id="all-products-body"><tr class="text-text-primary"><td colspan="14" class="px-4 py-3 text-center">Loading...</td></tr></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Low Stock Page -->
                    <div id="low-stock-page" class="page-content hidden">
                        <div class="bg-secondary p-6 rounded-lg shadow-md">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-semibold text-text-primary">Low Stock Products</h3>
                                <div class="flex items-center gap-4">
                                    <span class="text-sm text-text-secondary">Threshold: <span id="low-stock-threshold-display">5</span></span>
                                    <label class="inline-flex items-center text-sm select-none">
                                        <input id="low-stock-select-all" type="checkbox" class="mr-2 accent-theme-primary">
                                        Select All
                                    </label>
                                    <button id="low-stock-delete-selected" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-3 rounded-lg btn-glow-red" title="Delete selected low-stock products">Delete Selected</button>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead>
                                        <tr class="text-xs font-semibold tracking-wide text-text-secondary uppercase border-b border-color bg-gray-50 dark:bg-gray-700">
                                            <th class="px-4 py-3">#</th>
                                            <th class="px-4 py-3 text-center">Select</th>
                                            <th class="px-4 py-3">Image</th>
                                            <th class="px-4 py-3">Name</th>
                                            <th class="px-4 py-3">Category</th>
                                            <th class="px-4 py-3">Sub-Category</th>
                                            <th class="px-4 py-3">Stock</th>
                                            <th class="px-4 py-3">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y border-color" id="low-stock-body">
                                        <tr class="text-text-primary"><td colspan="8" class="px-4 py-3 text-center">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Add Product Page -->
                    <!-- Reviews & Ratings Page -->
                    <div id="reviews-page" class="page-content hidden">
                        <div class="bg-secondary p-6 rounded-lg shadow-md">
                            <div class="flex flex-wrap items-center justify-between mb-4 gap-3">
                                <h3 class="text-xl font-semibold text-text-primary">Product Reviews & Ratings</h3>
                                <div class="flex items-center gap-2 text-sm">
                                    <span class="px-2 py-1 rounded-full bg-gray-100 dark:bg-gray-700 text-text-secondary">Total: <span id="reviews-summary-total">0</span></span>
                                    <span class="px-2 py-1 rounded-full bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300">Avg: <span id="reviews-summary-avg">0.0</span> ★</span>
                                    <span class="hidden sm:inline-block w-px h-5 bg-gray-300 dark:bg-gray-600 mx-1"></span>
                                    <label class="inline-flex items-center text-sm select-none">
                                        <input id="reviews-select-all" type="checkbox" class="mr-2 accent-theme-primary">
                                        Select All
                                    </label>
                                    <button id="reviews-delete-selected" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-3 rounded-lg btn-glow-red" title="Delete selected reviews">Delete Selected</button>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead>
                                        <tr class="text-xs font-semibold tracking-wide text-text-secondary uppercase border-b border-color bg-gray-50 dark:bg-gray-700">
                                            <th class="px-4 py-3">#</th>
                                            <th class="px-4 py-3 text-center">Select</th>
                                            <th class="px-4 py-3">Product</th>
                                            <th class="px-4 py-3">Rating</th>
                                            <th class="px-4 py-3">Comment</th>
                                            <th class="px-4 py-3">Author</th>
                                            <th class="px-4 py-3">Date</th>
                                            <th class="px-4 py-3">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y border-color" id="reviews-body">
                                        <tr class="text-text-primary"><td colspan="8" class="px-4 py-3 text-center">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div id="add-product-page" class="page-content hidden">
                        <div class="bg-secondary p-8 rounded-lg shadow-md max-w-4xl mx-auto">
                            <h2 class="text-2xl font-bold mb-6 text-text-primary">Add New Product</h2>
                            <form id="add-product-form" class="space-y-6">
                                <!-- Reusable form content will be injected here by JS -->
                            </form>
                        </div>
                    </div>

                    <!-- Edit Product Page -->
                    <div id="edit-product-page" class="page-content hidden">
                        <div class="bg-secondary p-8 rounded-lg shadow-md max-w-4xl mx-auto">
                            <h2 class="text-2xl font-bold mb-6 text-text-primary">Edit Product</h2>
                            <form id="edit-product-form" class="space-y-6">
                                 <!-- Reusable form content will be injected here by JS -->
                                 <div class="p-4 border rounded-lg bg-gray-50/50 dark:bg-gray-800/50 border-color">
                                     <label class="block text-text-primary font-medium mb-1">Document ID</label>
                                     <input id="edit-product-doc-id" type="text" class="w-full px-4 py-2 bg-gray-200 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-sm font-mono" readonly value="" />
                                 </div>
                            </form>
                        </div>
                    </div>

                    <!-- Banners Page -->
                    <div id="banners-page" class="page-content hidden">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg-col-span-1"><div class="bg-secondary p-8 rounded-lg shadow-md"><h2 class="text-2xl font-bold mb-6 text-text-primary">Add New Banner</h2><form id="add-banner-form"><div class="mb-4"><label for="banner-image" class="block text-text-primary font-medium mb-2">Banner Image URL</label><input type="url" id="banner-image" required class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary" placeholder="https://example.com/banner.jpg"></div><div class="mb-4"><label for="banner-link" class="block text-text-primary font-medium mb-2">Link (Optional)</label><input type="url" id="banner-link" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary" placeholder="/products/promo"></div><button type="submit" class="w-full bg-theme-primary text-white font-bold py-3 px-4 rounded-lg disabled:bg-opacity-70 btn-glow">Add Banner</button></form></div></div>
                            <div class="lg-col-span-2"><div class="bg-secondary p-6 rounded-lg shadow-md"><h3 class="text-xl font-semibold text-text-primary mb-4">Current Banners</h3><div id="banners-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="text-text-primary">Loading...</div></div></div></div>
                        </div>
                    </div>

                    <!-- Side Promo Page -->
                    <div id="side-promo-page" class="page-content hidden">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-1">
                                <div class="bg-secondary p-8 rounded-lg shadow-md">
                                    <h2 class="text-2xl font-bold mb-6 text-text-primary">Add Side Promo</h2>
                                    <form id="add-side-promo-form" class="space-y-4">
                                        <div>
                                            <label for="side-promo-image" class="block text-text-primary font-medium mb-2">Image URL</label>
                                            <input type="url" id="side-promo-image" required class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary" placeholder="https://example.com/side-promo.jpg">
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label for="side-promo-title" class="block text-text-primary font-medium mb-2">Title (EN)</label>
                                                <input type="text" id="side-promo-title" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary" placeholder="e.g., Smart Prices on Accessories">
                                            </div>
                                            <div>
                                                <label for="side-promo-title-bn" class="block text-text-primary font-medium mb-2">Title (BN)</label>
                                                <input type="text" id="side-promo-title-bn" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary" placeholder="উদাহরণ: স্মার্ট প্রাইসেস অন অ্যাকসেসরিজ">
                                            </div>
                                            <div>
                                                <label for="side-promo-subtitle" class="block text-text-primary font-medium mb-2">Subtitle (EN)</label>
                                                <input type="text" id="side-promo-subtitle" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary" placeholder="e.g., Up to 70% off">
                                            </div>
                                            <div>
                                                <label for="side-promo-subtitle-bn" class="block text-text-primary font-medium mb-2">Subtitle (BN)</label>
                                                <input type="text" id="side-promo-subtitle-bn" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary" placeholder="উদাহরণ: সর্বোচ্চ ৭০% ছাড়">
                                            </div>
                                        </div>
                                        <div>
                                            <label for="side-promo-link" class="block text-text-primary font-medium mb-2">Link (Optional)</label>
                                            <input type="url" id="side-promo-link" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary" placeholder="/products/special">
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label for="side-promo-alt" class="block text-text-primary font-medium mb-2">Alt Text (Optional)</label>
                                                <input type="text" id="side-promo-alt" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary" placeholder="Accessible image description">
                                            </div>
                                            <div>
                                                <label for="side-promo-order" class="block text-text-primary font-medium mb-2">Order (Optional)</label>
                                                <input type="number" id="side-promo-order" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary" placeholder="0">
                                            </div>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span class="text-text-primary font-medium">Active</span>
                                            <label for="side-promo-active" class="relative inline-flex items-center cursor-pointer">
                                                <input type="checkbox" id="side-promo-active" class="sr-only peer" checked>
                                                <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-600 peer-checked:bg-theme-primary peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
                                            </label>
                                        </div>
                                        <button type="submit" class="w-full bg-theme-primary text-white font-bold py-3 px-4 rounded-lg disabled:bg-opacity-70 btn-glow">Add Side Promo</button>
                                    </form>
                                </div>
                            </div>
                            <div class="lg:col-span-2">
                                <div class="bg-secondary p-6 rounded-lg shadow-md">
                                    <h3 class="text-xl font-semibold text-text-primary mb-4">Current Side Promos</h3>
                                    <div id="side-promos-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="text-text-primary">Loading...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Coupons Page -->
                    <div id="coupons-page" class="page-content hidden">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-1">
                                <div class="bg-secondary p-8 rounded-lg shadow-md">
                                    <h2 class="text-2xl font-bold mb-6 text-text-primary">Add New Coupon</h2>
                                    <form id="add-coupon-form" class="space-y-4">
                                        <div>
                                            <label for="coupon-code" class="block text-text-primary font-medium mb-2">Coupon Code</label>
                                            <input type="text" id="coupon-code" required placeholder="e.g., SUMMER25" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary uppercase">
                                        </div>
                                        <div>
                                            <label for="coupon-type" class="block text-text-primary font-medium mb-2">Discount Type</label>
                                            <select id="coupon-type" required class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary">
                                                <option value="percentage">Percentage</option>
                                                <option value="fixed">Fixed Amount</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="coupon-value" class="block text-text-primary font-medium mb-2">Value (e.g., 25 or 100)</label>
                                            <input type="number" id="coupon-value" required min="0" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary">
                                        </div>
                                        <div>
                                            <label for="coupon-expiry" class="block text-text-primary font-medium mb-2">Expiry Date</label>
                                            <input type="date" id="coupon-expiry" required class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary">
                                        </div>
                                        <div>
                                            <label for="coupon-min-spend" class="block text-text-primary font-medium mb-2">Minimum Spend (Optional)</label>
                                            <input type="number" id="coupon-min-spend" min="0" placeholder="e.g., 500" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary">
                                        </div>
                                        <button type="submit" class="w-full bg-theme-primary text-white font-bold py-3 px-4 rounded-lg disabled:bg-opacity-70 btn-glow">Add Coupon</button>
                                    </form>
                                </div>
                            </div>
                            <div class="lg:col-span-2">
                                <div class="bg-secondary p-6 rounded-lg shadow-md">
                                    <h3 class="text-xl font-semibold text-text-primary mb-4">All Coupons</h3>
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-left">
                                            <thead>
                                                <tr class="text-xs font-semibold tracking-wide text-text-secondary uppercase border-b border-color bg-gray-50 dark:bg-gray-700">
                                                    <th class="px-4 py-3">Code</th>
                                                    <th class="px-4 py-3">Type</th>
                                                    <th class="px-4 py-3">Value</th>
                                                    <th class="px-4 py-3">Min. Spend</th>
                                                    <th class="px-4 py-3">Expires</th>
                                                    <th class="px-4 py-3">Status</th>
                                                    <th class="px-4 py-3">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y border-color" id="all-coupons-body">
                                                <tr class="text-text-primary"><td colspan="7" class="px-4 py-3 text-center">Loading...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Orders Page -->
                    <div id="orders-page" class="page-content hidden">
                         <div class="bg-secondary p-6 rounded-lg shadow-md">
                             <div class="flex flex-col sm:flex-row justify-between items-start mb-4 gap-4">
                                 <h3 class="text-xl font-semibold text-text-primary">All Orders</h3>
                                 <div class="flex flex-col sm:items-end gap-4 w-full sm:w-auto">
                                     <div id="order-status-filters" class="flex flex-wrap items-center justify-start sm:justify-end gap-2">
                                         <!-- Filter buttons will be dynamically inserted here -->
                                     </div>
                                     <div class="relative w-full sm:w-72">
                                         <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-text-secondary"></i>
                                         <input type="text" id="order-search-input" placeholder="Search by Order ID..." class="w-full pl-10 pr-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary">
                                     </div>
                                     <div class="flex items-center gap-3 self-start sm:self-end">
                                         <label class="inline-flex items-center text-sm select-none">
                                             <input id="orders-select-all" type="checkbox" class="mr-2 accent-theme-primary">
                                             Select All
                                         </label>
                                         <button id="orders-delete-selected" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-3 rounded-lg btn-glow-red" title="Delete selected orders">Delete Selected</button>
                                     </div>
                                 </div>
                             </div>
                             <div class="overflow-x-auto">
                                 <table class="w-full text-left">
                                     <thead><tr class="text-xs font-semibold tracking-wide text-text-secondary uppercase border-b border-color bg-gray-50 dark:bg-gray-700"><th class="px-4 py-3">Sl. No.</th><th class="px-4 py-3 text-center">Select</th><th class="px-4 py-3">Order ID</th><th class="px-4 py-3">Customer Name</th><th class="px-4 py-3">Mobile</th><th class="px-4 py-3">Date & Time</th><th class="px-4 py-3">Items</th><th class="px-4 py-3">Amount</th><th class="px-4 py-3">Location</th><th class="px-4 py-3">Payment Method</th><th class="px-4 py-3">Delivery Charge</th><th class="px-4 py-3">Assign Delivery Man</th><th class="px-4 py-3">Status</th><th class="px-4 py-3">Actions</th></tr></thead>
                                     <tbody class="divide-y border-color" id="all-orders-body"><tr class="text-text-primary"><td colspan="14" class="px-4 py-3 text-center">Loading...</td></tr></tbody>
                                 </table>
                             </div>
                         </div>
                    </div>
                    
                    <!-- Users Page -->
                    <div id="users-page" class="page-content hidden">
                        <div class="bg-secondary p-6 rounded-lg shadow-md">
                            <div class="flex items-center justify-between mb-4 gap-3">
                                <h3 class="text-xl font-semibold text-text-primary">All Users</h3>
                                <div class="flex items-center gap-3">
                                    <label class="inline-flex items-center text-sm select-none">
                                        <input id="users-select-all" type="checkbox" class="mr-2 accent-theme-primary">
                                        Select All
                                    </label>
                                    <button id="users-delete-selected" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-3 rounded-lg btn-glow-red" title="Delete selected users">Delete Selected</button>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead><tr class="text-xs font-semibold tracking-wide text-text-secondary uppercase border-b border-color bg-gray-50 dark:bg-gray-700"><th class="px-4 py-3">User</th><th class="px-4 py-3 text-center">Select</th><th class="px-4 py-3">Email</th><th class="px-4 py-3">Mobile</th><th class="px-4 py-3">Location</th><th class="px-4 py-3">Join Date</th><th class="px-4 py-3">UID</th><th class="px-4 py-3">Status</th><th class="px-4 py-3">Actions</th></tr></thead>
                                    <tbody class="divide-y border-color" id="all-users-body"><tr class="text-text-primary"><td colspan="9" class="px-4 py-3 text-center">Loading...</td></tr></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Delivery Page -->
                    <div id="delivery-page" class="page-content hidden">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                             <div class="lg:col-span-1">
                                 <div class="bg-secondary p-8 rounded-lg shadow-md">
                                     <h2 class="text-2xl font-bold mb-6 text-text-primary">Add Delivery Man</h2>
                                     <form id="add-delivery-man-form" class="space-y-4">
                                         <div>
                                             <label for="delivery-man-name" class="block text-text-primary font-medium mb-2">Name</label>
                                             <input type="text" id="delivery-man-name" required class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary">
                                         </div>
                                         <div>
                                             <label for="delivery-man-email" class="block text-text-primary font-medium mb-2">Email</label>
                                             <input type="email" id="delivery-man-email" required class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary">
                                         </div>
                                         <div>
                                             <label for="delivery-man-password" class="block text-text-primary font-medium mb-2">Password</label>
                                             <input type="password" id="delivery-man-password" required minlength="6" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary">
                                         </div>
                                         <div>
                                             <label for="delivery-man-phone" class="block text-text-primary font-medium mb-2">Phone Number</label>
                                             <input type="tel" id="delivery-man-phone" required class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary">
                                         </div>
                                         <div>
                                             <label for="delivery-man-vehicle" class="block text-text-primary font-medium mb-2">Vehicle Details (e.g., Bike, Cycle)</label>
                                             <input type="text" id="delivery-man-vehicle" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary">
                                         </div>
                                         <button type="submit" class="w-full bg-theme-primary text-white font-bold py-3 px-4 rounded-lg disabled:bg-opacity-70 btn-glow">Add Delivery Man</button>
                                     </form>
                                 </div>
                             </div>
                            <div class="lg:col-span-2">
                                <div class="bg-secondary p-6 rounded-lg shadow-md">
                                    <h3 class="text-xl font-semibold text-text-primary mb-4">All Delivery Men</h3>
                                    <div id="delivery-man-cards-container" class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                                        <div class="text-text-primary text-center xl:col-span-2">Loading...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- Settings Page -->
                    <div id="settings-page" class="page-content hidden">
                        <div class="max-w-4xl mx-auto space-y-8">
                            <!-- Profile Settings -->
                            <div class="bg-secondary p-6 rounded-lg shadow-md">
                                <h3 class="text-xl font-semibold text-text-primary mb-4">Profile Settings</h3>
                                <form id="profile-settings-form" class="space-y-4">
                                    <div>
                                        <label for="admin-name" class="block text-text-primary font-medium mb-2">Name</label>
                                        <input type="text" id="admin-name" class="w-full px-4 py-2 border rounded-lg bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-text-primary">
                                    </div>
                                    <div>
                                        <label for="admin-image" class="block text-text-primary font-medium mb-2">Profile Picture URL</label>
                                        <input type="url" id="admin-image" class="w-full px-4 py-2 border rounded-lg bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-text-primary">
                                    </div>
                                     <p class="text-sm text-text-secondary">Your Email: <span id="admin-profile-email" class="font-semibold"></span></p>
                                    <div class="flex justify-end">
                                        <button type="submit" class="bg-theme-primary text-white font-bold py-2 px-4 rounded-lg disabled:bg-opacity-70 btn-glow">Save Changes</button>
                                    </div>
                                </form>
                            </div>

                             <!-- Theme Settings -->
                            <div class="bg-secondary p-6 rounded-lg shadow-md">
                                <h3 class="text-xl font-semibold text-text-primary mb-4">Theme</h3>
                                <div id="theme-selector" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4">
                                    <div class="theme-option cursor-pointer" data-theme="indigo">
                                        <div class="w-full h-16 rounded-lg bg-indigo-600 flex items-center justify-center relative border-4 border-transparent"><i data-lucide="check-circle" class="w-8 h-8 text-white hidden theme-check"></i></div>
                                        <p class="text-center text-sm mt-2 text-text-primary">Indigo</p>
                                    </div>
                                    <div class="theme-option cursor-pointer" data-theme="forest">
                                        <div class="w-full h-16 rounded-lg bg-green-600 flex items-center justify-center relative border-4 border-transparent"><i data-lucide="check-circle" class="w-8 h-8 text-white hidden theme-check"></i></div>
                                        <p class="text-center text-sm mt-2 text-text-primary">Forest</p>
                                    </div>
                                    <div class="theme-option cursor-pointer" data-theme="crimson">
                                        <div class="w-full h-16 rounded-lg bg-red-600 flex items-center justify-center relative border-4 border-transparent"><i data-lucide="check-circle" class="w-8 h-8 text-white hidden theme-check"></i></div>
                                        <p class="text-center text-sm mt-2 text-text-primary">Crimson</p>
                                    </div>
                                    <div class="theme-option cursor-pointer" data-theme="ocean">
                                        <div class="w-full h-16 rounded-lg bg-sky-600 flex items-center justify-center relative border-4 border-transparent"><i data-lucide="check-circle" class="w-8 h-8 text-white hidden theme-check"></i></div>
                                        <p class="text-center text-sm mt-2 text-text-primary">Ocean</p>
                                    </div>
                                    <div class="theme-option cursor-pointer" data-theme="royal">
                                        <div class="w-full h-16 rounded-lg bg-purple-600 flex items-center justify-center relative border-4 border-transparent"><i data-lucide="check-circle" class="w-8 h-8 text-white hidden theme-check"></i></div>
                                        <p class="text-center text-sm mt-2 text-text-primary">Royal</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Appearance Settings -->
                            <div class="bg-secondary p-6 rounded-lg shadow-md">
                                <h3 class="text-xl font-semibold text-text-primary mb-4">Appearance</h3>
                                <div class="flex items-center justify-between">
                                    <span class="text-text-primary">Dark Mode</span>
                                    <label for="dark-mode-toggle" class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="dark-mode-toggle" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-600 peer-checked:bg-theme-primary peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
                                    </label>
                                </div>
                                <!-- NEW: Time Zone Setting -->
                                <div class="flex items-center justify-between mt-6 pt-4 border-t border-color">
                                    <span class="text-text-primary">Time Zone</span>
                                    <select id="timezone-selector" class="w-64 px-3 py-1.5 text-sm rounded-lg bg-gray-50 dark:bg-gray-700 text-text-primary border border-gray-300 dark:border-gray-600 focus:border-theme-primary focus:ring-theme-primary">
                                        <option>Loading timezones...</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>
    
    <!-- Order Details Modal -->
    <div id="order-details-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-secondary rounded-lg shadow-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center border-b border-color pb-3 mb-4">
                <h3 class="text-xl font-semibold text-text-primary">Order Details</h3>
                <button id="modal-close-btn" class="text-text-secondary text-3xl leading-none hover:text-text-primary">&times;</button>
            </div>
            <div id="modal-order-content" class="space-y-4">
                <p>Loading...</p>
            </div>
        </div>
    </div>
    
    <!-- Delivery Man Details Modal -->
    <div id="delivery-man-details-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-secondary rounded-lg shadow-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center border-b border-color pb-3 mb-4">
                <h3 class="text-xl font-semibold text-text-primary">Delivery Man Details</h3>
                <button id="delivery-modal-close-btn" class="text-text-secondary text-3xl leading-none hover:text-text-primary">&times;</button>
            </div>
            <div id="modal-delivery-man-content" class="space-y-4">
                <p>Loading...</p>
            </div>
        </div>
    </div>

    <!-- User Profile Modal -->
    <div id="user-profile-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-secondary rounded-lg shadow-xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center border-b border-color pb-3 mb-4">
                <h3 class="text-xl font-semibold text-text-primary">User Profile</h3>
                <button id="user-profile-modal-close-btn" class="text-text-secondary text-3xl leading-none hover:text-text-primary">&times;</button>
            </div>
            <div id="modal-user-profile-content" class="space-y-4">
                <p>Loading...</p>
            </div>
        </div>
    </div>


    <!-- New Order Alert Modal -->
    <div id="new-order-alert" class="fixed top-5 right-5 z-50 bg-secondary rounded-lg shadow-xl p-5 w-full max-w-sm transform transition-transform translate-x-full hidden">
        <div class="flex justify-between items-center border-b border-color pb-2 mb-3">
            <div class="flex items-center space-x-2">
                <i data-lucide="bell-ring" class="text-green-500"></i>
                <h3 class="text-lg font-semibold text-text-primary">New Order Received!</h3>
            </div>
            <button id="new-order-alert-close-btn" class="text-text-secondary text-3xl leading-none hover:text-text-primary">&times;</button>
        </div>
        <div id="new-order-alert-content" class="space-y-2 text-sm">
            <!-- Dynamic content will go here -->
        </div>
        <div class="mt-4 pt-3 border-t border-color flex justify-end">
             <button id="view-full-order-btn" class="px-4 py-2 bg-theme-primary text-white rounded-lg text-sm btn-glow">View Full Order</button>
        </div>
    </div>

    <!-- New Message Alert Modal -->
    <div id="new-message-alert" class="fixed bottom-5 right-5 z-50 bg-secondary rounded-lg shadow-xl p-5 w-full max-w-sm transform transition-transform translate-x-full hidden">
        <div class="flex justify-between items-center border-b border-color pb-2 mb-3">
            <div class="flex items-center space-x-2">
                <i data-lucide="message-square-text" class="text-blue-500"></i>
                <h3 class="text-lg font-semibold text-text-primary">New Message Received!</h3>
            </div>
            <button id="new-message-alert-close-btn" class="text-text-secondary text-3xl leading-none hover:text-text-primary">&times;</button>
        </div>
        <div id="new-message-alert-content" class="space-y-2 text-sm">
            <!-- Dynamic content will go here -->
        </div>
        <div class="mt-4 pt-3 border-t border-color flex justify-end">
             <button id="view-full-chat-btn" class="px-4 py-2 bg-theme-primary text-white rounded-lg text-sm btn-glow">View Chat</button>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-secondary rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 id="modal-title" class="text-xl font-semibold text-text-primary">Are you sure?</h3>
            <p id="modal-text" class="mt-2 text-text-secondary">This action cannot be undone.</p>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500">Cancel</button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg btn-glow-red">Confirm</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transition-transform transform translate-y-20 opacity-0"><p id="toast-message"></p></div>
    
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

    <script type="module">
        import { initializeApp, deleteApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, createUserWithEmailAndPassword, reauthenticateWithCredential, EmailAuthProvider, setPersistence, browserLocalPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, getDocs, addDoc, serverTimestamp, query, where, getCountFromServer, doc, getDoc, deleteDoc, updateDoc, writeBatch, increment, setDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        /*
            SECURITY NOTE:
            - The Firebase configuration is exposed on the client-side. In a production environment,
              it's crucial to secure your data using Firestore Security Rules.
            - Admin PINs are stored as plaintext. This is not recommended. For a production
              system, PINs/passwords should be hashed using a secure, one-way algorithm (e.g., bcrypt)
              on a server-side environment (like Cloud Functions) before being stored.
            - Deleting delivery men only removes their Firestore record, not their Firebase Authentication
              account, which requires a backend with the Admin SDK. This implementation uses a "soft delete"
              (freezing the account) to prevent orphaned auth accounts.
        */

        // --- Firebase Config & Initialization ---
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
          apiKey: "AIzaSyBIRNr3X-_xOHQ6ITW3pXgqgcjhP2xEEEA",
          authDomain: "tangailbuzz47.firebaseapp.com",
          projectId: "tangailbuzz47",
          storageBucket: "tangailbuzz47.appspot.com",
          messagingSenderId: "1017968115713",
          appId: "1:1017968115713:web:967a0e13107d8816b44000",
          measurementId: "G-7HYDCZTN2H"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let currentUserProfile = null;
        
        // Use a persistent user ID for the anonymous session if no custom token is available.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const userId = auth.currentUser?.uid || crypto.randomUUID();

        // --- State Management & Constants---
        let allProducts = [];
        let allOrders = [];
        let currentProductCategoryFilter = 'all';
        let currentProductSubCategoryFilter = 'all';
    let showDuplicatesOnly = false; // When true, render only duplicated products
    let currentOrderStatusFilter = 'all';
    let duplicateIdSet = new Set(); // computed across all products (global detection)
        let allDeliveryMen = [];
        let notifications = [];
        let confirmCallback = null;
        let unsubscribeListeners = [];
        let allUsersMap = new Map();
        let currentChatUserId = null;
        let unsubscribeMessages = null;
        let initialChatLoadComplete = false;
        let lastChatsSnapshot = null; 
        let initialUsersLoadComplete = false;
        let clockInterval = null;

        const UI = {
            loadingSpinner: document.getElementById('loading-spinner'),
            loginScreen: document.getElementById('login-screen'),
            adminPanel: document.getElementById('admin-panel'),
            loginForm: document.getElementById('login-form'),
            loginError: document.getElementById('login-error'),
            pageTitle: document.getElementById('page-title'),
            navLinks: document.querySelectorAll('.nav-link'),
            pages: document.querySelectorAll('.page-content'),
            notificationList: document.getElementById('notification-list'),
            notificationCountBadge: document.getElementById('notification-count'),
            orderDetailsModal: document.getElementById('order-details-modal'),
            orderDetailsContent: document.getElementById('modal-order-content'),
            orderDetailsCloseBtn: document.getElementById('modal-close-btn'),
            deliveryManDetailsModal: document.getElementById('delivery-man-details-modal'),
            deliveryManDetailsContent: document.getElementById('modal-delivery-man-content'),
            deliveryManModalCloseBtn: document.getElementById('delivery-modal-close-btn'),
            userProfileModal: document.getElementById('user-profile-modal'),
            userProfileModalContent: document.getElementById('modal-user-profile-content'),
            userProfileModalCloseBtn: document.getElementById('user-profile-modal-close-btn'),
            confirmationModal: document.getElementById('confirmation-modal'),
            newOrderAlert: document.getElementById('new-order-alert'),
            newMessageAlert: document.getElementById('new-message-alert'),
            // PIN verification removed
        };
        
    const PAGE_TITLES = { dashboard: 'Dashboard', chat: 'Live Chat', products: 'All Products', 'low-stock': 'Low Stock Products', 'add-product': 'Add Product', 'edit-product': 'Edit Product', banners: 'Banner Management', 'side-promo': 'Side Promo', coupons: 'Coupon Management', orders: 'All Orders', users: 'All Users', delivery: 'Delivery Management', settings: 'Settings' };

        const CATEGORY_MAP = {
            'electronics': 'Electronics',
            'fashion': 'Fashion',
            'home-garden': 'Home & Garden',
            'health-beauty': 'Health & Beauty',
            'sports-outdoors': 'Sports & Outdoors',
            'books-stationery': 'Books & Stationery',
            'kids-toys': 'Kids & Toys',
            'cars-bikes': 'Cars & Bikes'
        };

        const SUB_CATEGORY_MAP = {
            'electronics': ['Mobile Phone', 'Laptop & Computer', 'Tablet', 'TV & Home Theater', 'Headphone & Speaker', 'Camera & Accessories', 'Wearable Smart Watch', 'Gaming Console'],
            'fashion': ['Men\'s Clothing', 'Women\'s Clothing', 'Kids\' Clothing', 'Shoes & Sandals', 'Watch & Jewelry', 'Bags & Accessories', 'Traditional Wear (Saree, Panjabi)'],
            'home-garden': ['Furniture', 'Kitchen Items', 'Home Decor', 'Lighting', 'Garden Tools', 'Home Appliances', 'Storage & Organizer'],
            'health-beauty': ['Skincare', 'Haircare', 'Makeup', 'Perfume', 'Health Supplement', 'Fitness Equipment', 'Personal Care (Shaver, Trimmer)', 'Oral Care'],
            'sports-outdoors': ['Sports Apparel', 'Sports Shoes', 'Fitness Gear', 'Cycles', 'Gym Equipment', 'Outdoor Camping Gear', 'Football, Cricket, Badminton Items'],
            'books-stationery': ['Educational Books', 'Story Books', 'Religious Books', 'Office Stationery', 'School Stationery', 'Notebook & Diary', 'Arts & Crafts Supplies'],
            'kids-toys': ['Educational Toys', 'Soft Toys', 'Dolls & Action Figures', 'Games & Puzzles', 'Outdoor Toys (Cycles, Scooters)', 'Remote Control Toys', 'Lego & Building Blocks'],
            'cars-bikes': ['Car Accessories', 'Bike Accessories', 'Helmets & Riding Gear', 'Tires & Wheels', 'Car Care Products', 'Motor Oil & Lubricants', 'Electric Scooters & Bikes']
        };

        // --- Helper & Utility Functions ---
        const formatDateDivider = (date) => {
            const now = new Date();
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterdayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);

            const options = { day: 'numeric', month: 'long', year: 'numeric' };

            if (date >= todayStart) {
                return `Today, ${date.toLocaleDateString([], options)}`;
            }
            if (date >= yesterdayStart) {
                return `Yesterday, ${date.toLocaleDateString([], options)}`;
            }
            return date.toLocaleDateString([], options);
        };

        const formatTimestamp = (timestamp) => {
            if (!timestamp || !timestamp.toDate) {
                try {
                    // Fallbacks for non-Firestore timestamp values
                    if (timestamp instanceof Date) return timestamp.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: true });
                    if (typeof timestamp === 'number') return new Date(timestamp).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: true });
                    if (typeof timestamp === 'string') {
                        const d = new Date(timestamp);
                        if (!isNaN(d)) return d.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: true });
                    }
                } catch {}
                return '';
            }
            const date = timestamp.toDate();
            const now = new Date();
            const diffSeconds = Math.round((now - date) / 1000);

            if (diffSeconds < 60) {
                return 'Just now';
            }
            if (diffSeconds < 3600) {
                return `${Math.floor(diffSeconds / 60)} min ago`;
            }

            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterdayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);

            if (date >= todayStart) {
                // Return time like "10:30 AM" for today
                return date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: true });
            }
            if (date >= yesterdayStart) {
                return 'Yesterday';
            }

            // Return date like "30/09/2025" for older messages
            return date.toLocaleDateString([], { day: '2-digit', month: '2-digit', year: 'numeric' });
        };

        // Safe join date formatter that tolerates different types
        const formatJoinDate = (value, withTime = false) => {
            try {
                if (!value) return 'N/A';
                let date = null;
                if (typeof value?.toDate === 'function') {
                    date = value.toDate();
                } else if (value instanceof Date) {
                    date = value;
                } else if (typeof value === 'number') {
                    date = new Date(value < 1e12 ? value * 1000 : value);
                } else if (typeof value === 'string') {
                    const parsed = new Date(value);
                    if (!isNaN(parsed)) date = parsed;
                }
                if (!date) return 'N/A';
                return withTime ? date.toLocaleString() : date.toLocaleDateString();
            } catch (e) {
                return 'N/A';
            }
        };
        
        const showToast = (message, type = 'success') => {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            
            const typeClasses = {
                success: 'bg-green-500 text-white',
                error: 'bg-red-500 text-white',
                warning: 'bg-yellow-500 text-black'
            };

            toast.className = `fixed bottom-5 right-5 py-2 px-4 rounded-lg shadow-lg transition-transform transform translate-y-20 opacity-0 ${typeClasses[type] || typeClasses.success}`;
            setTimeout(() => {
                toast.className = toast.className.replace('translate-y-20 opacity-0', 'translate-y-0 opacity-100');
            }, 10); // show fast
            setTimeout(() => {
                toast.className = toast.className.replace('translate-y-0 opacity-100', 'translate-y-20 opacity-0');
            }, 3000);
        };

        const handleSnapshotError = (context) => (error) => {
            console.error(`Error loading ${context}:`, error);
            showToast(`Could not load ${context}!`, 'error');
        };

        // --- Sound Effects Logic ---
        let audioCtx;
        const initAudio = () => {
            if (!audioCtx) {
                try {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    // Some browsers require a "silent" sound to be played to fully unlock the audio context.
                    const buffer = audioCtx.createBuffer(1, 1, 22050);
                    const source = audioCtx.createBufferSource();
                    source.buffer = buffer;
                    source.connect(audioCtx.destination);
                    source.start(0);
                    console.log("AudioContext initialized and unlocked.");
                } catch (e) {
                    console.warn("Web Audio API is not supported in this browser.");
                }
            }
        };

        const playSound = async (type) => {
            if (!audioCtx) {
                console.warn("AudioContext not initialized. Cannot play sound.");
                return;
            }

            if (audioCtx.state === 'suspended') {
                await audioCtx.resume();
            }

            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            gainNode.gain.setValueAtTime(0, audioCtx.currentTime);

            switch (type) {
                case 'newOrder':
                    // Two quick, high-pitched beeps
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(880, audioCtx.currentTime); // A5
                    gainNode.gain.linearRampToValueAtTime(0.5, audioCtx.currentTime + 0.05);
                    gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.15);
                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + 0.15);

                    // Schedule the second beep
                    const osc2 = audioCtx.createOscillator();
                    const gain2 = audioCtx.createGain();
                    osc2.connect(gain2);
                    gain2.connect(audioCtx.destination);
                    gain2.gain.setValueAtTime(0, audioCtx.currentTime + 0.15);
                    osc2.type = 'sine';
                    osc2.frequency.setValueAtTime(1046.5, audioCtx.currentTime + 0.15); // C6
                    gain2.gain.linearRampToValueAtTime(0.5, audioCtx.currentTime + 0.15 + 0.05);
                    gain2.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.15 + 0.15);
                    osc2.start(audioCtx.currentTime + 0.15);
                    osc2.stop(audioCtx.currentTime + 0.15 + 0.15);
                    break;
                case 'newMessage':
                    // A single, softer beep
                    oscillator.type = 'triangle';
                    oscillator.frequency.setValueAtTime(659.25, audioCtx.currentTime); // E5
                    gainNode.gain.linearRampToValueAtTime(0.4, audioCtx.currentTime + 0.05);
                    gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.2);
                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + 0.3);
                    break;
                case 'logout':
                    // A descending tone
                    oscillator.type = 'sawtooth';
                    oscillator.frequency.setValueAtTime(440, audioCtx.currentTime); // A4
                    oscillator.frequency.linearRampToValueAtTime(220, audioCtx.currentTime + 0.3);
                    gainNode.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + 0.05);
                    gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.3);
                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + 0.4);
                    break;
                case 'login':
                    // An ascending tone
                    oscillator.type = 'square';
                    oscillator.frequency.setValueAtTime(220, audioCtx.currentTime); // A3
                    oscillator.frequency.linearRampToValueAtTime(440, audioCtx.currentTime + 0.2);
                    gainNode.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + 0.05);
                    gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.2);
                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + 0.3);
                    break;
            }
        };

        const playWelcomeMessage = () => {
            if ('speechSynthesis' in window) {
                // Using Bengali script for better pronunciation by TTS engines
                const utterance = new SpeechSynthesisUtterance("হ্যালো অ্যাডমিন, টাঙ্গাইল বাজ অ্যাডমিন ওয়ার্ল্ডে আপনাকে স্বাগতম");

                const setVoice = () => {
                    const voices = window.speechSynthesis.getVoices();
                    let femaleVoice = voices.find(voice => voice.lang === 'bn-BD' && (voice.name.toLowerCase().includes('female') || voice.gender === 'female'));
                    if (!femaleVoice) {
                        femaleVoice = voices.find(voice => voice.lang === 'bn-IN' && (voice.name.toLowerCase().includes('female') || voice.gender === 'female'));
                    }
                    if (!femaleVoice) {
                        femaleVoice = voices.find(voice => voice.lang.startsWith('bn')); // Any Bengali voice as a fallback
                    }
                     if (!femaleVoice) {
                        femaleVoice = voices.find(voice => voice.lang.startsWith('en') && voice.gender === 'female'); // Fallback to English female
                    }

                    if (femaleVoice) {
                        utterance.voice = femaleVoice;
                    }
                    
                    utterance.lang = 'bn-BD';
                    utterance.rate = 0.9; // Slightly slower for clarity
                    utterance.pitch = 1.1;

                    window.speechSynthesis.speak(utterance);
                };

                // Voices can load asynchronously.
                if (window.speechSynthesis.getVoices().length === 0) {
                    window.speechSynthesis.onvoiceschanged = setVoice;
                } else {
                    setVoice();
                }
            } else {
                console.warn("Speech Synthesis not supported in this browser.");
            }
        };

        // --- Clock Logic ---
        const updateClock = () => {
            const clockElement = document.getElementById('digital-clock');
            if (!clockElement) return;

            const timeZone = localStorage.getItem('adminTimeZone') || 'Asia/Riyadh'; // Default to Saudi time
            
            try {
                const now = new Date();
                
                const dateOptions = {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    timeZone: timeZone
                };

                const timeOptions = {
                    hour12: true,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    timeZone: timeZone
                };

                const dateString = now.toLocaleDateString('en-GB', dateOptions);
                const timeString = now.toLocaleTimeString('en-US', timeOptions);
                
                // Display date and time on two separate lines
                clockElement.innerHTML = `
                    <div class="text-xs font-medium">${dateString}</div>
                    <div class="text-lg font-semibold">${timeString}</div>
                `;

            } catch (e) {
                console.error("Invalid time zone:", timeZone, e);
                localStorage.removeItem('adminTimeZone'); // Clear invalid setting
                clockElement.textContent = new Date().toLocaleString('en-US');
            }
        };

        const startClock = () => {
            if (clockInterval) clearInterval(clockInterval);
            updateClock(); // Initial display
            clockInterval = setInterval(updateClock, 1000);
        };

        const stopClock = () => {
            if (clockInterval) clearInterval(clockInterval);
            clockInterval = null;
        };
// --- BULK UPLOAD CSV LOGIC ---

/**
 * CSV টেক্সট পার্স করে একটি JavaScript অবজেক্ট অ্যারেতে রূপান্তর করে।
 * @param {string} csvText - CSV ফাইলের সম্পূর্ণ টেক্সট।
 * @returns {Array<Object>} প্রোডাক্ট ডেটার অ্যারে।
 */
const parseCSV = (csvText) => {
    const lines = csvText.split('\n').filter(line => line.trim() !== '');
    if (lines.length === 0) return [];

    // Header row কে কমা দ্বারা ভাগ করে key হিসেবে ব্যবহার করা
    const headers = lines[0].split(',').map(header => header.trim());
    const result = [];

    for (let i = 1; i < lines.length; i++) {
        // CSV তে কমা যুক্ত ডেটা (যেমন Description, Specifications) হ্যান্ডেল করার জন্য উন্নত Regex
        const values = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);

        if (!values || values.length !== headers.length) {
            console.warn(`Skipping line ${i + 1}: Column count mismatch. Values found: ${values ? values.length : 0}. Expected: ${headers.length}`);
            continue;
        }

        const obj = {};
        let specificationDescription = ''; // Specifications Description এর জন্য অতিরিক্ত ভেরিয়েবল
        let thumbnailURL = ''; // Thumbnail URL এর জন্য ভেরিয়েবল

        headers.forEach((header, index) => {
            let value = values[index].trim().replace(/^"|"$/g, ''); // ডাবল কোটেশন সরিয়ে দেওয়া
            let key;

            // আপনার CSV header-কে কোডের key-তে রূপান্তর (Mapping)
            switch (header) {
                case 'Product Name': key = 'name'; break;
                case 'Main Price': key = 'mainPrice'; break;
                case 'Offer Price': key = 'offerPrice'; break;
                case 'Discount %': key = 'discount'; break;
                case 'Stock Count': key = 'stock'; break;
                // 'Rating' ফিল্ডটি CSV-তে নেই, তাই এটিকে বাদ দেওয়া হলো।
                case 'On Offer': key = 'isOnOffer'; break;
                case 'Refundable': key = 'isRefundable'; break;
                case 'main Image URL': key = 'imageUrl'; break; // নতুন মেইন ইমেজ ফিল্ড
                case 'thumbnil image URL': thumbnailURL = value; return; // Thumbnail URL ভেরিয়েবলে সেভ করা
                case 'Description': key = 'details'; break;
                case 'Sub-Category': key = 'subcategory'; break;
                case 'Category': key = 'category'; break;
                case 'Brand': key = 'brand'; break;
                case 'Warranty': key = 'warranty'; break;
                case 'Specifications Description': specificationDescription = value; return; // Specification Description ভেরিয়েবলে সেভ করা
                default: key = header.toLowerCase().replace(/\s/g, ''); 
            }
            
            // ডেটা টাইপ রূপান্তর: সংখ্যা, বুলিয়ান ইত্যাদি।
            if (key === 'mainPrice' || key === 'offerPrice' || key === 'stock' || key === 'discount') {
                obj[key] = parseFloat(value) || 0;
            } else if (key === 'isOnOffer' || key === 'isRefundable') {
                obj[key] = value.toLowerCase() === 'yes' || value.toLowerCase() === 'true' || false;
            } else {
                obj[key] = value;
            }
        });
        
        // *গুরুত্বপূর্ণ ফিক্স:* ক্যাটাগরি ID কে ছোট হাতের অক্ষরে রূপান্তর করা হচ্ছে
        if (obj.category && typeof obj.category === 'string') {
            obj.category = obj.category.toLowerCase().replace(/\s/g, '-').replace('&', 'and');
        }

        // Thumbnail URL কে Array আকারে যুক্ত করা
        obj.thumbnails = thumbnailURL ? [thumbnailURL] : []; 
        
        // Specifications Description কে একটি specification object এ যুক্ত করা (আপনার আপলোড ফর্ম অনুযায়ী)
        obj.specification = specificationDescription ? { "Details": specificationDescription } : {};

        // যদি Rating না থাকে, তবে ০ সেট করা
        obj.rating = obj.rating !== undefined ? Number(obj.rating) : 0; 

        // যদি Category ID সঠিক না হয়, তবে প্রোডাক্ট স্কিপ করা
        if (obj.category && !CATEGORY_MAP[obj.category]) {
            console.warn(`Skipping product ${obj.name}: Invalid category key '${obj.category}'.`);
            continue;
        }

        result.push(obj);
    }
    return result;
};


/**
 * পার্স করা ডেটা Firestore-এ বাল্ক সেভ করে।
 * @param {Array<Object>} products - প্রোডাক্ট ডেটার অ্যারে।
 */
const saveBulkProducts = async (products) => {
    if (products.length === 0) {
        showToast("No valid product data found in CSV.", "warning");
        return;
    }

    let batch = writeBatch(db);
    const productsCollectionRef = collection(db, 'products');
    let successfulCount = 0;

    for (const product of products) {
        const newDocRef = doc(productsCollectionRef);
        const productModel = product.model || newDocRef.id.substring(0, 8); 

        const productData = { 
            ...product,
            createdAt: serverTimestamp(),
            // নিশ্চিত করা যে data types ঠিক আছে
            mainPrice: Number(product.mainPrice || 0),
            offerPrice: Number(product.offerPrice || 0),
            discount: Number(product.discount || 0),
            stock: Number(product.stock || 0),
            rating: Number(product.rating || 0),
            isOnOffer: product.isOnOffer || false,
            isRefundable: product.isRefundable || false,
            model: productModel,
            // নতুন কাঠামোর ডেটা
            specification: product.specification || {},
            thumbnails: product.thumbnails || [],
            imageUrl: product.imageUrl || '',
        };

        batch.set(newDocRef, productData);
        successfulCount++;

        if (successfulCount % 499 === 0) { 
            console.log("Committing batch...");
            await batch.commit();
            batch = writeBatch(db);
        }
    }

    if (successfulCount % 499 !== 0) {
        await batch.commit();
    }

    showToast(`${successfulCount} products uploaded successfully!`, 'success');
};







        const renderFilteredOrders = () => {
            const searchTerm = document.getElementById('order-search-input').value.toLowerCase().trim();
            const filteredDocs = allOrders.filter(doc => {
                const order = doc.data();
                const orderId = order.orderId || doc.id;

                // Normalize statuses to canonical values to ensure filter works with variants
                const normalizeStatus = (s) => {
                    if (!s) return 'pending';
                    const raw = String(s).trim().toLowerCase();
                    if (raw === 'canceled') return 'cancelled';
                    const hyphenated = raw.replace(/\s+/g, '-');
                    if (hyphenated === 'out-for-delivery') return 'out-for-delivery';
                    return hyphenated;
                };

                const statusMatch = currentOrderStatusFilter === 'all' || normalizeStatus(order.status || 'pending') === currentOrderStatusFilter;
                const searchMatch = searchTerm === '' || orderId.toLowerCase().includes(searchTerm);
                
                return statusMatch && searchMatch;
            });
            
            // Re-render the table with only the filtered documents
            renderTable({ docs: filteredDocs, empty: filteredDocs.length === 0 }, 'all-orders-body', renderOrderRow_All);
        };

        const setButtonLoading = (button, isLoading, text = 'Loading...') => {
            if (!button) return;
            if (isLoading) {
                button.disabled = true;
                button.dataset.originalText = button.textContent;
                button.innerHTML = `<span class="inline-flex items-center">${text} <svg class="animate-spin -mr-1 ml-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></span>`;
            } else {
                button.disabled = false;
                button.innerHTML = button.dataset.originalText || 'Submit';
            }
        };

        const cleanupListeners = () => {
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
        };

        // --- Authentication & PIN Logic ---
        // The isAdmin function was removed as it causes a "Missing or insufficient permissions" error.
        // The security rules prevent non-admins from reading the 'admins' collection to check their own status.
        // Role checking is now done securely via ID token claims in the onAuthStateChanged listener below.

        const showScreen = (screenName) => {
            const screens = ['loading-spinner', 'login-screen', 'admin-panel'];
            screens.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.toggle('hidden', id !== screenName);
            });
        };

     onAuthStateChanged(auth, async (user) => {
         showScreen('loading-spinner');
            if (user) {
                try {
                    // Force refresh the token to get the latest custom claims (e.g., role)
                    const idTokenResult = await user.getIdTokenResult(true);
                    
                    // Check if the user's token has an 'admin' or 'co-admin' role claim.
                    // This is the secure way to verify admin status on the client.
                    const userIsAdmin = idTokenResult.claims.role === 'admin' || idTokenResult.claims.role === 'co-admin';

                    if (userIsAdmin) {
                        const adminDoc = await getDoc(doc(db, "admins", user.uid));
                        if(adminDoc.exists()) {
                            currentUserProfile = { id: adminDoc.id, ...adminDoc.data() };
                        }
                        // Bypass PIN verification and go directly to admin panel
                        showScreen('admin-panel');
                        initializeAdminPanel(user);
                    } else {
                        // If a user is logged in but is not an admin, show an error and sign them out.
                        console.warn("Non-admin user attempted to access the panel. Signing out.");
                        showToast("You do not have permission to access this panel.", "error");
                        await signOut(auth); // This will re-trigger onAuthStateChanged with user=null
                    }
                } catch (error) {
                    // If any error occurs during the admin check, sign out for security.
                    console.error("Error verifying admin status:", error);
                    showToast("An error occurred during verification. Please log in again.", "error");
                    await signOut(auth);
                }
            } else {
                cleanupListeners();
                stopClock(); // Stop the clock on logout
                showScreen('login-screen');
            }
        });

        UI.loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('button[type="submit"]');
            setButtonLoading(button, true, 'LOGGING IN...');
            UI.loginError.textContent = '';
            
            const email = e.target.email.value;
            const password = e.target.password.value;
            const keepSignedIn = document.getElementById('keep-signed-in').checked;

            try {
                // Set persistence based on the checkbox
                await setPersistence(auth, keepSignedIn ? browserLocalPersistence : browserSessionPersistence);
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged will handle the rest
            } catch (error) {
                console.error("Login failed:", error);
                const errorCode = error.code;
                let errorMessage = 'An unknown error occurred.';
                if (errorCode === 'auth/user-not-found' || errorCode === 'auth/wrong-password' || errorCode === 'auth/invalid-credential') {
                    errorMessage = 'Invalid email or password. Please try again.';
                } else if (errorCode === 'auth/too-many-requests') {
                    errorMessage = 'Access to this account has been temporarily disabled due to many failed login attempts. You can immediately restore it by resetting your password or you can try again later.';
                }
                UI.loginError.textContent = errorMessage;
            } finally {
                setButtonLoading(button, false);
            }
        });

        // PIN verification disabled; no separate handler needed.

        document.getElementById('logout-button').addEventListener('click', () => {
            playSound('logout');
            signOut(auth);
        });
        
        // --- Navigation ---
        const showPage = (pageId) => {
            const targetPage = document.getElementById(`${pageId}-page`);
            if (!targetPage) {
                console.warn(`Page not found: ${pageId}. Redirecting to dashboard.`);
                pageId = 'dashboard';
            }

            // If we are navigating away from the chat page, reset its state.
            if (pageId !== 'chat') {
                resetChatView();
            }

            UI.pages.forEach(p => p.classList.toggle('hidden', p.id !== `${pageId}-page`));
            UI.navLinks.forEach(l => l.classList.toggle('active', l.dataset.page === pageId));
            UI.pageTitle.textContent = PAGE_TITLES[pageId] || 'Dashboard';
            // Keep quick section dropdown in sync
            const quickSel = document.getElementById('quick-section-select');
            if (quickSel && quickSel.value !== pageId) quickSel.value = pageId;
        };

        // --- Appearance & Theming ---
        const applyTheme = (themeName) => {
            document.documentElement.className = document.documentElement.className.replace(/theme-\w+/g, '');
            document.documentElement.classList.add(`theme-${themeName}`);
            localStorage.setItem('adminTheme', themeName);
            document.querySelectorAll('.theme-option').forEach(opt => {
                const checkIcon = opt.querySelector('.theme-check');
                const colorBox = opt.querySelector('.relative.border-4');
                const isActive = opt.dataset.theme === themeName;
                checkIcon.classList.toggle('hidden', !isActive);
                colorBox.classList.toggle('border-transparent', !isActive);
                colorBox.classList.toggle('border-blue-500', isActive);
                colorBox.classList.toggle('dark:border-blue-400', isActive);
            });
        };

        const applyDarkMode = (isDark) => {
            document.documentElement.classList.toggle('dark', isDark);
            if(document.getElementById('dark-mode-toggle')) {
                document.getElementById('dark-mode-toggle').checked = isDark;
            }
        };

        const initializeAppearance = () => {
            applyTheme(localStorage.getItem('adminTheme') || 'forest');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            applyDarkMode(localStorage.theme === 'dark' || (!('theme' in localStorage) && prefersDark));
            
            const loginScreenDivs = document.querySelectorAll('#login-screen');
            const loginProfilePic = document.getElementById('login-profile-pic');
            const defaultBg = 'https://github.com/tangailbuzzbd-svg/TangailBuzz-Picture-/blob/main/vecteezy_ai-generated-empty-wooden-table-on-the-natural-background_40890255.jpg?raw=true';
            const defaultAvatar = 'https://github.com/tangailbuzzbd-svg/TangailBuzz-Picture-/blob/main/WhatsApp%20Image%202025-07-30%20at%2019.29.33_9f8c7d06.jpg?raw=true';
            
            const bgUrl = `url('${localStorage.getItem('login-bg-url') || defaultBg}')`;
            loginScreenDivs.forEach(div => div.style.backgroundImage = bgUrl);
            loginProfilePic.src = localStorage.getItem('login-profile-url') || defaultAvatar;
        };

        // --- Data Loading & Rendering ---
        // --- Reviews & Ratings Rendering ---
        const renderReviewsList = async () => {
            const tbody = document.getElementById('reviews-body');
            const totalEl = document.getElementById('reviews-summary-total');
            const avgEl = document.getElementById('reviews-summary-avg');
            if (!tbody) return;
            tbody.innerHTML = `<tr class="text-text-primary"><td colspan="7" class="px-4 py-3 text-center">Loading...</td></tr>`;
            try {
                const productsSnap = await getDocs(collection(db, 'products'));
                let allReviews = [];
                productsSnap.forEach(doc => {
                    const data = doc.data();
                    if (Array.isArray(data.reviews)) {
                        data.reviews.forEach((review, idx) => {
                            allReviews.push({
                                productName: data.name || 'Unknown Product',
                                productId: doc.id,
                                reviewIdx: idx,
                                productImage: data.imageUrl || '',
                                ...review
                            });
                        });
                    }
                });

                if (totalEl) totalEl.textContent = String(allReviews.length);
                const numericRatings = allReviews.map(r => Number(r.rating)).filter(v => !Number.isNaN(v));
                const avg = numericRatings.length ? (numericRatings.reduce((a, b) => a + b, 0) / numericRatings.length) : 0;
                if (avgEl) avgEl.textContent = avg.toFixed(1);

                if (allReviews.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-text-secondary">No reviews found.</td></tr>`;
                    return;
                }

                allReviews.sort((a, b) => {
                    const ta = (a.timestamp && a.timestamp.toDate) ? a.timestamp.toDate().getTime() : new Date(a.timestamp || 0).getTime();
                    const tb = (b.timestamp && b.timestamp.toDate) ? b.timestamp.toDate().getTime() : new Date(b.timestamp || 0).getTime();
                    return tb - ta;
                });

                tbody.innerHTML = '';
                allReviews.forEach((r, idx) => {
                    let dateString = '';
                    if (r.timestamp && r.timestamp.toDate) {
                        dateString = r.timestamp.toDate().toLocaleString();
                    } else if (r.timestamp instanceof Date) {
                        dateString = r.timestamp.toLocaleString();
                    } else if (typeof r.timestamp === 'string' || typeof r.timestamp === 'number') {
                        dateString = new Date(r.timestamp).toLocaleString();
                    } else {
                        dateString = 'N/A';
                    }

                    const productImage = r.productImage || r.imageUrl || 'https://placehold.co/48x48/e2e8f0/64748b?text=Img';
                    const ratingText = (r.rating !== undefined && r.rating !== null && r.rating !== '') ? `${r.rating} ★` : 'No rating';

                    tbody.insertAdjacentHTML('beforeend', `
                        <tr class="text-text-primary">
                            <td class="px-4 py-3 text-sm">${idx + 1}</td>
                            <td class="px-4 py-3 text-center"><input type=\"checkbox\" class=\"row-select accent-theme-primary\" data-coll=\"review\" data-product-id=\"${r.productId}\" data-review-idx=\"${r.reviewIdx}\"></td>
                            <td class="px-4 py-3 text-sm">
                                <div class="flex items-center gap-3">
                                    <img src="${productImage}" onerror="this.src='https://placehold.co/48x48/e2e8f0/64748b?text=Img'" class="h-10 w-10 object-cover rounded">
                                    <span class="font-semibold">${r.productName}</span>
                                </div>
                            </td>
                            <td class="px-4 py-3 text-sm text-yellow-600 font-semibold">${ratingText}</td>
                            <td class="px-4 py-3 text-sm truncate max-w-[28rem]" title="${(r.comment || '').replace(/"/g, '&quot;')}">${r.comment || '—'}</td>
                            <td class="px-4 py-3 text-sm">${r.author || 'Anonymous'}</td>
                            <td class="px-4 py-3 text-sm whitespace-nowrap">${dateString}</td>
                            <td class="px-4 py-3">
                                <button class="delete-review-btn text-red-500 hover:text-red-700" data-product-id="${r.productId}" data-review-idx="${r.reviewIdx}" title="Delete Review">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                            </td>
                        </tr>
                    `);
                });

                // Attach delete listeners & refresh icons
                document.querySelectorAll('.delete-review-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const productId = btn.getAttribute('data-product-id');
                        const reviewIdx = parseInt(btn.getAttribute('data-review-idx'), 10);
                        if (!productId || Number.isNaN(reviewIdx)) return;
                        if (!confirm('Are you sure you want to delete this review?')) return;
                        try {
                            const productRef = doc(db, 'products', productId);
                            const productSnap = await getDoc(productRef);
                            if (!productSnap.exists()) throw new Error('Product not found');
                            const data = productSnap.data();
                            if (!Array.isArray(data.reviews)) throw new Error('No reviews found');
                            data.reviews.splice(reviewIdx, 1);
                            await updateDoc(productRef, { reviews: data.reviews });
                            showToast('Review deleted!', 'success');
                            renderReviewsList();
                        } catch (err) {
                            showToast('Failed to delete review', 'error');
                        }
                    });
                });
                if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
            } catch (err) {
                if (tbody) tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-red-500">Failed to load reviews.</td></tr>';
            }
        };
        const loadAdminProfile = async (user) => {
            if (!user) return;
            document.getElementById('admin-profile-email').textContent = user.email;
            document.getElementById('dropdown-admin-email').textContent = user.email;

            const adminDoc = await getDoc(doc(db, "admins", user.uid));
            if (adminDoc.exists()) {
                const data = adminDoc.data();
                const name = data.name || 'Admin';
                const imageUrl = data.imageUrl || `https://placehold.co/32x32/e2e8f0/64748b?text=${name.charAt(0)}`;
                
                document.getElementById('admin-name').value = data.name || '';
                document.getElementById('admin-image').value = data.imageUrl || '';
                document.getElementById('header-admin-name').textContent = name;
                document.getElementById('header-admin-image').src = imageUrl;
                document.getElementById('dropdown-admin-name').textContent = name;
            }
        };

        const loadDashboardStats = async () => {
            try {
                const ordersSnapshot = await getDocs(query(collection(db, "orders")));
                const ordersData = ordersSnapshot.docs.map(doc => doc.data());
                
                const statusCounts = ordersData.reduce((acc, order) => {
                    // Ensure that the status is always retrieved, defaulting to 'pending' if missing (as intended)
                    const status = (order.status || 'pending').toLowerCase();
                    acc[status] = (acc[status] || 0) + 1;
                    return acc;
                }, {});

                // Filter for delivered orders to calculate Total Sales
                const deliveredOrdersData = ordersData.filter(order => order.status === 'delivered');
                const totalSales = deliveredOrdersData.reduce((sum, order) => sum + (order.totalAmount || 0), 0);
                
                const usersSnap = await getCountFromServer(collection(db, "users"));
                const productsSnap = await getCountFromServer(collection(db, "products"));
                const deliveryMenSnap = await getCountFromServer(collection(db, "deliveryMen"));
                
                // FIX: Perform an initial count of unseen SMS on load for immediate feedback.
                // The real-time listener will keep it updated afterwards.
                const chatsQuery = query(collection(db, "live_chats"));
                const chatsSnapshot = await getDocs(chatsQuery);
                const unseenSmsCount = chatsSnapshot.docs.filter(doc => !doc.data().isReadByAdmin).length;
                document.getElementById('total-unseen-sms').textContent = unseenSmsCount;
                
                // FIX: Fetch all coupons and filter client-side to avoid complex query permission issues.
                const allCouponsSnap = await getDocs(collection(db, "coupons"));
                const todayStr = new Date().toISOString().split('T')[0];
                let activeCouponsCount = 0;
                allCouponsSnap.forEach(doc => {
                    if (doc.data().expiryDate >= todayStr) {
                        activeCouponsCount++;
                    }
                });

                const productsData = (await getDocs(query(collection(db, "products")))).docs.map(d => d.data());
                // Calculate Total Stock Value: (Main Price * Stock) for all products
                const totalStockValue = productsData.reduce((sum, product) => sum + ((product.mainPrice || 0) * (product.stock || 0)), 0);
                const totalStockCount = productsData.reduce((sum, product) => sum + (product.stock || 0), 0);

                document.getElementById('total-orders').textContent = ordersData.length;
                document.getElementById('total-sale').textContent = `৳${totalSales.toFixed(2)}`;
                document.getElementById('total-users').textContent = usersSnap.data().count;
                document.getElementById('total-products-stat').textContent = productsSnap.data().count;
                document.getElementById('total-delivery-men').textContent = deliveryMenSnap.data().count;
                document.getElementById('total-active-coupons').textContent = activeCouponsCount;
                document.getElementById('total-pending').textContent = statusCounts.pending || 0;
                document.getElementById('total-confirmed').textContent = statusCounts.confirmed || 0;
                document.getElementById('total-shipped').textContent = statusCounts.shipped || 0;
                document.getElementById('total-out-for-delivery').textContent = statusCounts['out-for-delivery'] || 0;
                document.getElementById('total-delivered').textContent = statusCounts.delivered || 0;
                document.getElementById('total-cancelled').textContent = statusCounts.cancelled || 0;
                document.getElementById('total-stock-value').textContent = `৳${Math.round(totalStockValue)}`;
                document.getElementById('total-stock-count').textContent = totalStockCount;
            } catch (e) {
                console.error("Error loading dashboard stats", e);
                showToast("Failed to load dashboard stats!", 'error');
            }
        };

        const renderTable = (snapshot, bodyId, rowRenderer) => {
            const body = document.getElementById(bodyId);
            if (!body) return;
            body.innerHTML = '';
            
            // Client-side sorting: Newest first
            const sortedDocs = snapshot.docs.sort((a, b) => (b.data().createdAt?.toMillis() || 0) - (a.data().createdAt?.toMillis() || 0));

            if (snapshot.empty) {
                const colSpan = body.parentElement.querySelector('thead tr').children.length;
                body.innerHTML = `<tr><td colspan="${colSpan}" class="p-4 text-center text-text-secondary">No data found.</td></tr>`;
                return;
            }
            
            // Render rows with serial number (slNo)
            sortedDocs.forEach((doc, index) => body.insertAdjacentHTML('beforeend', rowRenderer(doc, index + 1)));
            lucide.createIcons();
        };

        const getStatusBadge = (status) => { 
            const colors = { pending: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300', confirmed: 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300', shipped: 'bg-purple-100 text-purple-800 dark:bg-purple-900/50 dark:text-purple-300', 'out-for-delivery': 'bg-orange-100 text-orange-800 dark:bg-orange-900/50 dark:text-orange-300', delivered: 'bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300', cancelled: 'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300' }; 
            
            // FIX: Use simple string manipulation to replace hyphens and capitalize words
            const text = (status || '').replace(/-/g, ' '); 
            const formattedText = text.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');

            return `<span class="px-2 py-1 font-semibold leading-tight rounded-full ${colors[status] || ''}">${formattedText}</span>`; 
        };
        
        // Updated renderOrderRow_Recent to include Sl. No. and respect the sorting (index is now slNo)
        const renderOrderRow_Recent = (doc, slNo) => { 
            const d = doc.data(); 
            const orderIdDisplay = d.orderId || doc.id.substring(0, 6); // Use d.orderId or fallback
            const isPending = d.status === 'pending';
            const rowClass = isPending ? 'pending-order' : 'text-text-primary';
            return `<tr class="${rowClass}"><td class="px-4 py-3 text-sm">${slNo}</td><td class="px-4 py-3 text-sm font-mono" title="Full ID: ${doc.id}">#${orderIdDisplay}</td><td class="px-4 py-3 text-sm">${d.userName || 'N/A'}</td><td class="px-4 py-3 text-sm">৳${d.totalAmount || 0}</td><td class="px-4 py-3 text-xs">${getStatusBadge(d.status)}</td></tr>`; 
        };
    const renderUserRow_Recent = doc => { const d = doc.data(); return `<tr class="text-text-primary"><td class="px-4 py-3 text-sm">${d.name || 'N/A'}</td><td class="px-4 py-3 text-sm">${d.email || 'N/A'}</td><td class="px-4 py-3 text-sm">${formatJoinDate(d.createdAt)}</td></tr>`; };
        
        const renderFilteredProducts = () => {
            const body = document.getElementById('all-products-body');
            body.innerHTML = '';
            // Base filter by category and subcategory
            let filteredProducts = allProducts.filter(doc => {
                const data = doc.data();
                const categoryMatch = currentProductCategoryFilter === 'all' || data.category === currentProductCategoryFilter;
                const subCategoryMatch = currentProductSubCategoryFilter === 'all' || data.subcategory === currentProductSubCategoryFilter;
                return categoryMatch && subCategoryMatch;
            });

            // If duplicate-only mode, further narrow using global duplicateIdSet
            if (showDuplicatesOnly) {
                filteredProducts = filteredProducts.filter(doc => duplicateIdSet.has(doc.id));
            }

            if (filteredProducts.length === 0) {
                const colSpan = body.parentElement.querySelector('thead th').parentElement.children.length;
                body.innerHTML = `<tr><td colspan="${colSpan}" class="p-4 text-center text-text-secondary">No products found.</td></tr>`;
                return;
            }
            filteredProducts.forEach((doc, idx) => body.insertAdjacentHTML('beforeend', renderProductRow_All(doc, idx + 1)));
            lucide.createIcons();
            // Update summary after rendering
            updateDuplicatesSummary(filteredProducts);
        };

        // Update duplicates summary badge
        const updateDuplicatesSummary = (filteredDocs) => {
            const el = document.getElementById('duplicates-summary');
            if (!el) return;
            if (!showDuplicatesOnly) { el.textContent = ''; return; }
            const count = Array.isArray(filteredDocs) ? filteredDocs.length : 0;
            el.textContent = count > 0 ? `Duplicate items: ${count}` : 'No duplicates found';
        };

        // Compute duplicates globally across allProducts using multiple heuristics
        const computeDuplicateSet = () => {
            const norm = (s) => String(s || '').trim().toLowerCase().replace(/\s+/g, ' ');
            const addGroupHits = (map, key, doc) => {
                if (!key) return;
                if (!map[key]) map[key] = [];
                map[key].push(doc);
            };
            const maps = { byModel: {}, bySku: {}, byNameCat: {}, byImage: {} };
            allProducts.forEach(doc => {
                const d = doc.data() || {};
                const model = norm(d.model);
                const sku = norm(d.sku || d.productId);
                const name = norm(d.name);
                const cat = norm(d.category);
                const sub = norm(d.subcategory);
                const img = norm(d.imageUrl);
                addGroupHits(maps.byModel, model ? `model:${model}` : '', doc);
                addGroupHits(maps.bySku, sku ? `sku:${sku}` : '', doc);
                addGroupHits(maps.byNameCat, (name && cat) ? `namecat:${name}|${cat}|${sub}` : '', doc);
                addGroupHits(maps.byImage, img ? `img:${img}` : '', doc);
            });
            const dup = new Set();
            Object.values(maps).forEach(groupMap => {
                Object.values(groupMap).forEach(arr => {
                    if (arr.length >= 2) arr.forEach(doc => dup.add(doc.id));
                });
            });
            duplicateIdSet = dup;
        };

        const renderProductFilters = () => {
            const filtersContainer = document.getElementById('product-category-filters');
            const counts = allProducts.reduce((acc, doc) => {
                const category = doc.data().category;
                if (category) acc[category] = (acc[category] || 0) + 1;
                return acc;
            }, {});
            let buttonsHtml = `<button class="category-filter-btn px-3 py-1 text-sm rounded-full ${currentProductCategoryFilter === 'all' ? 'bg-theme-primary text-white' : 'bg-gray-200 dark:bg-gray-700 text-text-primary'}" data-category="all">All <span class="ml-1 px-2 py-0.5 text-xs rounded-full bg-gray-400 dark:bg-gray-500 text-white">${allProducts.length}</span></button>`;
            for (const key in CATEGORY_MAP) {
                if (counts[key]) {
                     buttonsHtml += `<button class="category-filter-btn px-3 py-1 text-sm rounded-full ${currentProductCategoryFilter === key ? 'bg-theme-primary text-white' : 'bg-gray-200 dark:bg-gray-700 text-text-primary'}" data-category="${key}">${CATEGORY_MAP[key]} <span class="ml-1 px-2 py-0.5 text-xs rounded-full bg-gray-400 dark:bg-gray-500 text-white">${counts[key]}</span></button>`;
                }
            }
            filtersContainer.innerHTML = buttonsHtml;
        };
        
        const renderSubCategoryFilter = () => {
            const container = document.getElementById('product-subcategory-filter-container');
            const subCategories = SUB_CATEGORY_MAP[currentProductCategoryFilter];

            if (!subCategories || subCategories.length === 0) {
                container.innerHTML = '';
                container.classList.add('hidden');
                return;
            }

            const subCategoryCounts = allProducts
                .filter(doc => doc.data().category === currentProductCategoryFilter)
                .reduce((acc, doc) => {
                    const sub = doc.data().subcategory;
                    if (sub) acc[sub] = (acc[sub] || 0) + 1;
                    return acc;
                }, {});
            
            const totalInCategory = Object.values(subCategoryCounts).reduce((sum, count) => sum + count, 0);

            let optionsHtml = `<option value="all">All Sub-categories (${totalInCategory})</option>`;
            subCategories.forEach(sub => {
                if (subCategoryCounts[sub]) {
                    optionsHtml += `<option value="${sub}" ${currentProductSubCategoryFilter === sub ? 'selected' : ''}>${sub} (${subCategoryCounts[sub]})</option>`;
                }
            });

            container.innerHTML = `
                <select id="product-subcategory-select" class="w-full sm:w-auto px-3 py-1.5 text-sm rounded-full bg-gray-200 dark:bg-gray-700 text-text-primary border-transparent focus:border-theme-primary focus:ring-theme-primary">
                    ${optionsHtml}
                </select>
            `;
            container.classList.remove('hidden');
            
            document.getElementById('product-subcategory-select').addEventListener('change', (e) => {
                currentProductSubCategoryFilter = e.target.value;
                renderFilteredProducts();
            });
        };

        const renderProductRow_All = (doc, slNo) => { 
            const d = doc.data();
            const categoryName = CATEGORY_MAP[d.category] || d.category || 'N/A';
            const subCategoryName = d.subcategory || 'N/A';
            const isLowStock = d.stock < 5;
            const stockValue = d.stock !== undefined ? d.stock : 'N/A';
            const lowStockClass = isLowStock ? 'bg-yellow-100 dark:bg-yellow-900/20' : '';
            const lowStockIcon = isLowStock ? '<i data-lucide="alert-triangle" class="w-4 h-4 text-yellow-500 inline-block ml-2"></i>' : '';
            const isOfferHtml = (d.isOnOffer) ? `<span class="px-2 py-1 font-semibold leading-tight text-green-700 bg-green-100 rounded-full dark:bg-green-700 dark:text-green-100">Yes</span>` : `<span class="px-2 py-1 font-semibold leading-tight text-gray-700 bg-gray-100 rounded-full dark:bg-gray-700 dark:text-gray-100">No</span>`;
            const isRefundableHtml = d.isRefundable ? `<span class="px-2 py-1 font-semibold leading-tight text-blue-700 bg-blue-100 rounded-full dark:bg-blue-700 dark:text-blue-100">Yes</span>` : `<span class="px-2 py-1 font-semibold leading-tight text-gray-700 bg-gray-100 rounded-full dark:bg-gray-700 dark:text-gray-100">No</span>`;
            const productIdDisplay = d.model || d.productId || doc.id; // prefer model/code from form, then explicit productId, else doc id

            return `<tr class="text-text-primary ${lowStockClass}">
                <td class="px-4 py-3 text-sm">${slNo}</td>
                <td class="px-4 py-3 text-center"><input type="checkbox" class="row-select accent-theme-primary" data-id="${doc.id}" data-coll="products"></td>
                <td class="px-4 py-3"><img src="${d.imageUrl}" onerror="this.src='https://placehold.co/48x48/e2e8f0/64748b?text=Img'" class="h-12 w-12 object-cover rounded"></td>
                <td class="px-4 py-3 text-sm font-semibold">${d.name || 'N/A'}</td>
                <td class="px-4 py-3 text-sm font-mono" title="Full ID: ${doc.id}">${productIdDisplay}</td>
                <td class="px-4 py-3 text-sm">${categoryName}</td>
                <td class="px-4 py-3 text-sm">${subCategoryName}</td>
                <td class="px-4 py-3 text-sm">৳${d.mainPrice || 0}</td>
                <td class="px-4 py-3 text-sm">৳${d.offerPrice || 0}</td>
                <td class="px-4 py-3 text-sm">${stockValue}${lowStockIcon}</td>
                <td class="px-4 py-3 text-sm">${d.discount || 0}%</td>
                <td class="px-4 py-3 text-xs">${isOfferHtml}</td>
                <td class="px-4 py-3 text-xs">${isRefundableHtml}</td>
                <td class="px-4 py-3 flex items-center"><button class="edit-btn text-indigo-500 hover:text-indigo-700 mr-2" data-id="${doc.id}"><i data-lucide="edit" class="w-5 h-5"></i></button><button class="delete-btn text-red-500 hover:text-red-700" data-id="${doc.id}" data-coll="products"><i data-lucide="trash-2" class="w-5 h-5"></i></button></td>
            </tr>`; 
        };

        // --- Low Stock Products ---
        const LOW_STOCK_THRESHOLD = 5; // default threshold; can be made configurable later
        const renderLowStockProducts = () => {
            const body = document.getElementById('low-stock-body');
            const thresholdEl = document.getElementById('low-stock-threshold-display');
            if (thresholdEl) thresholdEl.textContent = String(LOW_STOCK_THRESHOLD);
            if (!body) return;
            body.innerHTML = '';

            const lowStockDocs = allProducts.filter(doc => {
                const s = Number(doc.data().stock ?? 0);
                return !Number.isNaN(s) && s < LOW_STOCK_THRESHOLD;
            });

            if (lowStockDocs.length === 0) {
                body.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-text-secondary">No low stock products.</td></tr>`;
                return;
            }

            lowStockDocs.forEach((doc, idx) => {
                const d = doc.data();
                const categoryName = CATEGORY_MAP[d.category] || d.category || 'N/A';
                const subCategoryName = d.subcategory || 'N/A';
                const stockValue = d.stock !== undefined ? d.stock : 'N/A';
                body.insertAdjacentHTML('beforeend', `
                    <tr class="text-text-primary">
                        <td class="px-4 py-3 text-sm">${idx + 1}</td>
                        <td class="px-4 py-3 text-center"><input type="checkbox" class="row-select accent-theme-primary" data-id="${doc.id}" data-coll="products"></td>
                        <td class="px-4 py-3"><img src="${d.imageUrl}" onerror="this.src='https://placehold.co/48x48/e2e8f0/64748b?text=Img'" class="h-12 w-12 object-cover rounded"></td>
                        <td class="px-4 py-3 text-sm font-semibold">${d.name || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm">${categoryName}</td>
                        <td class="px-4 py-3 text-sm">${subCategoryName}</td>
                        <td class="px-4 py-3 text-sm">${stockValue} <i data-lucide="alert-triangle" class="w-4 h-4 text-yellow-500 inline-block ml-1"></i></td>
                        <td class="px-4 py-3 flex items-center">
                            <button class="edit-btn text-indigo-500 hover:text-indigo-700 mr-2" data-id="${doc.id}"><i data-lucide="edit" class="w-5 h-5"></i></button>
                            <button class="delete-btn text-red-500 hover:text-red-700" data-id="${doc.id}" data-coll="products"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                        </td>
                    </tr>
                `);
            });
            lucide.createIcons();
        };
        const getDeliveryManDropdown = (deliveryMen, orderId, currentDeliveryManId) => {
            let options = deliveryMen
                .filter(doc => (doc.data().accountStatus || 'active') === 'active') // Filter for active delivery men
                .map(doc => {
                    const man = doc.data();
                    return `<option value="${doc.id}" ${doc.id === currentDeliveryManId ? 'selected' : ''}>${man.name}</option>`;
                }).join('');
            return `<select class="delivery-man-assign border rounded p-1 bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600" data-id="${orderId}"><option value="">Unassigned</option>${options}</select>`;
        };
        const getStatusDropdown = (id, currentStatus) => { 
            const statuses = ['pending', 'confirmed', 'shipped', 'out-for-delivery', 'delivered', 'cancelled']; 
            
            // Helper function for display text
            const getDisplayText = (s) => s.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');

            return `<select class="status-change border rounded p-1 bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600" data-id="${id}">
                ${statuses.map(s => `<option value="${s}" ${s === currentStatus ? 'selected' : ''}>${getDisplayText(s)}</option>`).join('')}
            </select>`; 
        };
        
        // Updated renderOrderRow_All to include Sl. No. and highlight pending orders
        const renderOrderRow_All = (doc, slNo) => {
            const d = doc.data();
            const orderIdDisplay = d.orderId || doc.id.substring(0, 6); // Use d.orderId or fallback
            const itemsHtml = d.items?.map(item => `<div class="whitespace-nowrap">${item.name} (x${item.quantity})</div>`).join('') || 'N/A';
            const isPending = d.status === 'pending';
            const rowClass = isPending ? 'pending-order' : 'text-text-primary';

            return `<tr class="${rowClass}">
                <td class="px-4 py-3 text-sm">${slNo}</td>
                <td class="px-4 py-3 text-center"><input type="checkbox" class="row-select accent-theme-primary" data-id="${doc.id}" data-coll="orders"></td>
                <td class="px-4 py-3 text-sm font-mono" title="Full ID: ${doc.id}">#${orderIdDisplay}</td>
                <td class="px-4 py-3 text-sm">${d.userName || 'N/A'}</td>
                <td class="px-4 py-3 text-sm">${d.userMobile || 'N/A'}</td>
                <td class="px-4 py-3 text-sm">${d.createdAt?.toDate().toLocaleString() || 'N/A'}</td>
                <td class="px-4 py-3 text-xs">${itemsHtml}</td>
                <td class="px-4 py-3 text-sm">৳${d.totalAmount || 0}</td>
                <td class="px-4 py-3 text-sm">${d.userLocation || 'N/A'}</td>
                <td class="px-4 py-3 text-sm">${d.paymentMethod || 'N/A'}</td>
                <td class="px-4 py-3 text-sm">৳${d.deliveryCharge || 0}</td>
                <td class="px-4 py-3 text-sm">${getDeliveryManDropdown(allDeliveryMen, doc.id, d.assignedDeliveryManId)}</td>
                <td class="px-4 py-3">${getStatusBadge(d.status)}</td>
                <td class="px-4 py-3 flex items-center space-x-2">
                   <button class="view-order-btn text-blue-500 hover:text-blue-700 p-1 rounded-full hover:bg-blue-100 dark:hover:bg-gray-700" data-id="${doc.id}" title="View Details"><i data-lucide="eye" class="w-5 h-5"></i></button>
                   <div class="relative">${getStatusDropdown(doc.id, d.status)}</div>
                   <button class="delete-btn text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 dark:hover:bg-gray-700" data-id="${doc.id}" data-coll="orders" title="Delete Order"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                </td>
            </tr>`;
        };
        const renderUserRow_All = doc => { 
            const d = doc.data(); 
            const isBlocked = d.isBlocked || false;
            const statusBadge = isBlocked
                ? `<span class="px-2 py-1 text-xs font-semibold leading-tight text-red-700 bg-red-100 rounded-full dark:bg-red-700 dark:text-red-100">Blocked</span>`
                : `<span class="px-2 py-1 text-xs font-semibold leading-tight text-green-700 bg-green-100 rounded-full dark:bg-green-700 dark:text-green-100">Active</span>`;

            const blockButtonIcon = isBlocked ? 'play' : 'lock';
            const blockButtonTitle = isBlocked ? 'Unblock User' : 'Block User';
            const blockButtonColor = isBlocked ? 'text-yellow-500 hover:text-yellow-700' : 'text-gray-500 hover:text-gray-700';

            const rowClass = isBlocked ? 'bg-red-50 dark:bg-red-900/10' : 'text-text-primary';

            return `<tr class="${rowClass}" data-uid="${doc.id}">
                <td class="px-4 py-3 text-sm flex items-center">
                    <img src="${d.photoURL || `https://placehold.co/32x32/e2e8f0/64748b?text=${(d.name || 'U').charAt(0)}`}" class="w-8 h-8 rounded-full object-cover mr-3">
                    <span>${d.name || 'N/A'}</span>
                </td>
                <td class="px-4 py-3 text-center"><input type="checkbox" class="row-select accent-theme-primary" data-id="${doc.id}" data-coll="users"></td>
                <td class="px-4 py-3 text-sm">${d.email || 'N/A'}</td>
                <td class="px-4 py-3 text-sm">${d.mobile || 'N/A'}</td>
                <td class="px-4 py-3 text-sm">${d.location || 'N/A'}</td>
                <td class="px-4 py-3 text-sm">${formatJoinDate(d.createdAt)}</td>
                <td class="px-4 py-3 text-xs font-mono">${doc.id}</td>
                <td class="px-4 py-3 text-xs">${statusBadge}</td>
                <td class="px-4 py-3 flex items-center space-x-2">
                      <button class="view-user-btn text-blue-500 hover:text-blue-700 p-1 rounded-full hover:bg-blue-100 dark:hover:bg-gray-700" data-id="${doc.id}" title="View Profile">
                          <i data-lucide="eye" class="w-5 h-5"></i>
                      </button>
                       <button class="block-user-btn ${blockButtonColor} p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700" data-id="${doc.id}" data-blocked="${isBlocked}" title="${blockButtonTitle}">
                           <i data-lucide="${blockButtonIcon}" class="w-5 h-5"></i>
                       </button>
                    <button class="delete-btn text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 dark:hover:bg-gray-700" data-id="${doc.id}" data-coll="users" title="Delete User">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                </td>
            </tr>`; 
        };
        
        const renderDeliveryManCard = (manDoc, stats) => {
            const d = manDoc.data();
            const manId = manDoc.id;
            const status = d.accountStatus || 'active';

            const {
                totalDelivered = 0,
                cashCollected = 0,
            } = stats[manId] || {};

            const statusBadgeColor = status === 'frozen' ? 'bg-yellow-500' : 'bg-green-500';
            const statusText = status.charAt(0).toUpperCase() + status.slice(1);

            return `
            <div class="bg-secondary p-6 rounded-lg shadow-md flex flex-col space-y-4 relative">
                <div class="absolute top-2 right-2 flex space-x-1">
                    <button class="view-delivery-man-btn p-2 rounded-full text-blue-400 dark:text-blue-300 hover:text-blue-300 dark:hover:text-blue-200 hover:bg-gray-100 dark:hover:bg-white/10" data-id="${manId}" title="View Details">
                        <i data-lucide="eye" class="w-5 h-5"></i>
                    </button>
                    <button class="account-status-toggle-btn p-2 rounded-full ${status === 'frozen' ? 'text-yellow-400' : 'text-green-400'} hover:text-yellow-300 dark:hover:text-yellow-300 hover:bg-gray-100 dark:hover:bg-white/10" data-id="${manId}" data-status="${status}" title="${status === 'frozen' ? 'Unfreeze Account' : 'Block/Freeze Account'}">
                        <i data-lucide="${status === 'frozen' ? 'play' : 'lock'}" class="w-5 h-5"></i>
                    </button>
                     <button class="delete-btn p-2 rounded-full text-red-500 dark:text-red-400 hover:text-red-400 dark:hover:text-red-300 hover:bg-gray-100 dark:hover:bg-white/10" data-id="${manId}" data-coll="deliveryMen" title="Delete Account">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <div class="flex-shrink-0">
                    <div class="flex items-center space-x-3 mb-2 pr-20">
                        <h4 class="text-xl font-bold text-primary">${d.name || 'N/A'}</h4>
                        <span class="text-xs font-bold px-2 py-1 ${statusBadgeColor} text-white rounded-full">${statusText}</span>
                    </div>
                    <p class="text-sm text-secondary">${d.email || 'N/A'}</p>
                    <p class="text-sm text-secondary">Phone: ${d.phone || 'N/A'}</p>
                </div>
                
                <div class="grid grid-cols-2 gap-4 text-center py-4 border-y border-color">
                    <div>
                        <p class="text-xs text-secondary uppercase tracking-wider">Total Delivered</p>
                        <p class="text-2xl font-semibold text-primary">${totalDelivered}</p>
                    </div>
                    <div>
                        <p class="text-xs text-secondary uppercase tracking-wider">Cash Collected</p>
                        <p class="text-2xl font-semibold text-primary">৳${Math.round(cashCollected)}</p>
                    </div>
                </div>
            </div>`;
        };

        const renderDeliverySection = async (deliveryMenSnapshot) => {
            const container = document.getElementById('delivery-man-cards-container');
            if (!container) return;
            container.innerHTML = '<div class="text-text-primary text-center xl:col-span-2">Calculating stats...</div>';

            try {
                // 1. Fetch all orders (needed to calculate stats for all delivery men)
                // We fetch all orders and filter/calculate client-side to prevent complex index/permission issues.
                const ordersQuery = query(collection(db, "orders"));
                const ordersSnapshot = await getDocs(ordersQuery);

                // 2. Process orders to calculate stats for each delivery man
                const deliveryStats = {};
                ordersSnapshot.docs.forEach(orderDoc => {
                    const order = orderDoc.data();
                    const manId = order.assignedDeliveryManId;
                    
                    // We only count orders that were successfully delivered and assigned
                    if (manId && order.status === 'delivered') {
                        if (!deliveryStats[manId]) {
                            deliveryStats[manId] = { totalDelivered: 0, cashCollected: 0 };
                        }
                        deliveryStats[manId].totalDelivered++;
                        // Assuming totalAmount includes everything collected
                        deliveryStats[manId].cashCollected += order.totalAmount || 0;
                    }
                });
                
                // 3. Render cards
                container.innerHTML = '';
                if (deliveryMenSnapshot.empty) {
                    container.innerHTML = '<p class="text-center text-text-secondary col-span-full">No delivery men have been added.</p>';
                    return;
                }
                
                deliveryMenSnapshot.forEach(manDoc => {
                    container.insertAdjacentHTML('beforeend', renderDeliveryManCard(manDoc, deliveryStats));
                });

                lucide.createIcons();
            } catch (error) {
                console.error("Error rendering delivery section:", error);
                container.innerHTML = '<p class="text-center text-red-500 col-span-full">Could not load delivery man data.</p>';
                showToast('Failed to load delivery section!', 'error');
            }
        };

        const renderBanners = (snapshot) => {
            const list = document.getElementById('banners-list');
            list.innerHTML = '';
            if (snapshot.empty) { list.innerHTML = `<p class="text-center text-text-secondary col-span-full">No banners have been added.</p>`; return; }
            
            const sortedDocs = snapshot.docs.sort((a, b) => (b.data().createdAt?.toMillis() || 0) - (a.data().createdAt?.toMillis() || 0));

            sortedDocs.forEach(doc => {
                const d = doc.data();
                list.insertAdjacentHTML('beforeend', `<div class="relative group"><img src="${d.imageUrl}" onerror="this.src='https://placehold.co/400x160/e2e8f0/64748b?text=Banner'" class="w-full h-40 object-cover rounded-lg shadow-md"><div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><button class="delete-btn text-white" data-id="${doc.id}" data-coll="banners"><i data-lucide="trash-2" class="w-8 h-8"></i></button></div></div>`);
            });
            lucide.createIcons();
        };

        // --- Side Promos Rendering ---
        const renderSidePromos = (snapshot) => {
            const list = document.getElementById('side-promos-list');
            if (!list) return;
            list.innerHTML = '';
            if (snapshot.empty) {
                list.innerHTML = `<p class="text-center text-text-secondary col-span-full">No side promos have been added.</p>`;
                return;
            }

            const sortedDocs = snapshot.docs.sort((a, b) => (b.data().createdAt?.toMillis?.() || 0) - (a.data().createdAt?.toMillis?.() || 0));
            sortedDocs.forEach(docSnap => {
                const d = docSnap.data();
                const linkOpen = d.link ? `<a href="${d.link}" target="_blank" class="absolute inset-0" aria-label="Open promo link"></a>` : '';
                const activeBadge = (d.active !== false)
                    ? '<span class="absolute top-2 left-2 text-[10px] font-semibold px-1.5 py-0.5 rounded bg-green-100 text-green-700 dark:bg-green-800/40 dark:text-green-300">Active</span>'
                    : '<span class="absolute top-2 left-2 text-[10px] font-semibold px-1.5 py-0.5 rounded bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300">Inactive</span>';
                list.insertAdjacentHTML('beforeend', `
                    <div>
                        <div class="relative group">
                            ${activeBadge}
                            <img src="${d.imageUrl}" onerror="this.src='https://placehold.co/400x160/e2e8f0/64748b?text=Side+Promo'" class="w-full h-40 object-cover rounded-lg shadow-md">
                            ${linkOpen}
                            <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <button class="delete-btn text-white" data-id="${docSnap.id}" data-coll="sidePromos" title="Delete">
                                    <i data-lucide="trash-2" class="w-8 h-8"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mt-2 text-sm text-text-primary">
                            ${d.title ? `<p class="font-semibold truncate" title="${d.title}">${d.title}</p>` : ''}
                            ${d.subtitle ? `<p class="text-xs text-text-secondary truncate" title="${d.subtitle}">${d.subtitle}</p>` : ''}
                            ${d.title_bn ? `<p class="font-semibold truncate" title="${d.title_bn}">${d.title_bn}</p>` : ''}
                            ${d.subtitle_bn ? `<p class="text-xs text-text-secondary truncate" title="${d.subtitle_bn}">${d.subtitle_bn}</p>` : ''}
                            ${(typeof d.order === 'number') ? `<p class="text-[11px] text-text-secondary mt-1">Order: ${d.order}</p>` : ''}
                        </div>
                    </div>
                `);
            });
            if (window.lucide?.createIcons) lucide.createIcons();
        };

        const renderCoupons = (snapshot) => {
            const rowRenderer = (doc) => {
                const d = doc.data();
                const now = new Date();
                const expiry = new Date(d.expiryDate);
                const isActive = expiry >= now;

                const valueText = d.type === 'percentage' ? `${d.value}%` : `৳${d.value}`;
                const statusBadge = isActive 
                    ? `<span class="px-2 py-1 text-xs font-semibold leading-tight text-green-700 bg-green-100 rounded-full dark:bg-green-700 dark:text-green-100">Active</span>`
                    : `<span class="px-2 py-1 text-xs font-semibold leading-tight text-gray-700 bg-gray-100 rounded-full dark:bg-gray-700 dark:text-gray-100">Expired</span>`;

                return `<tr class="text-text-primary">
                    <td class="px-4 py-3 text-sm font-semibold">${d.code}</td>
                    <td class="px-4 py-3 text-sm">${d.type}</td>
                    <td class="px-4 py-3 text-sm">${valueText}</td>
                    <td class="px-4 py-3 text-sm">${d.minSpend > 0 ? `৳${d.minSpend}` : 'N/A'}</td>
                    <td class="px-4 py-3 text-sm">${d.expiryDate}</td>
                    <td class="px-4 py-3 text-xs">${statusBadge}</td>
                    <td class="px-4 py-3 flex gap-2">
                        <button class="edit-coupon-btn text-blue-500 hover:text-blue-700" data-id="${doc.id}" data-coll="coupons">
                            <i data-lucide="edit-2" class="w-5 h-5"></i>
                        </button>
                        <button class="delete-btn text-red-500 hover:text-red-700" data-id="${doc.id}" data-coll="coupons">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </td>
                </tr>`;
            };
            renderTable(snapshot, 'all-coupons-body', rowRenderer);
        };
        
        const renderOrderFilters = () => {
            const filtersContainer = document.getElementById('order-status-filters');
            if (!filtersContainer) return;

            // Normalize status strings to canonical forms for consistent counting
            const normalizeStatus = (s) => {
                if (!s) return 'pending';
                const raw = String(s).trim().toLowerCase();
                if (raw === 'canceled') return 'cancelled';
                if (raw.replace(/\s+/g, '-') === 'out-for-delivery' || raw === 'out-for-delivery') return 'out-for-delivery';
                return raw.replace(/\s+/g, '-');
            };

            const counts = allOrders.reduce((acc, doc) => {
                const status = normalizeStatus(doc.data().status || 'pending');
                acc[status] = (acc[status] || 0) + 1;
                return acc;
            }, {});

            const getStatusDisplayText = (s) => s.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');

            // Always show the full set of filters in consistent order, even if count is 0
            const filterOrder = ['all', 'pending', 'confirmed', 'shipped', 'out-for-delivery', 'delivered', 'cancelled'];

            const buttonsHtml = filterOrder
                .map(status => {
                    const count = status === 'all' ? allOrders.length : (counts[status] || 0);
                    const isActive = currentOrderStatusFilter === status;
                    const activeClass = isActive ? 'bg-theme-primary text-white' : 'bg-gray-200 dark:bg-gray-700 text-text-primary';
                    return `<button class="order-status-filter-btn px-3 py-1 text-sm rounded-full ${activeClass}" data-status="${status}">${getStatusDisplayText(status)} <span class="ml-1 px-2 py-0.5 text-xs rounded-full bg-gray-400 dark:bg-gray-500 text-white">${count}</span></button>`;
                })
                .join('');

            filtersContainer.innerHTML = buttonsHtml;
        };

        const applyAndShowOrdersFilter = (status) => {
            currentOrderStatusFilter = status;
            showPage('orders');
            renderOrderFilters(); // Re-render filters to show active state
            renderFilteredOrders(); // Re-render table with the filter applied
        };


        // --- Product Form Logic ---
        const getProductFormHTML = (prefix) => {
            const categoryOptions = Object.entries(CATEGORY_MAP).map(([key, value]) => `<option value="${key}">${value}</option>`).join('');
            return `
            <input type="hidden" id="${prefix}product-id-hidden">
            <div class="p-4 border rounded-lg bg-gray-50/50 dark:bg-gray-800/50 border-color space-y-4">
                <h3 class="font-semibold text-lg text-text-primary">Category</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="${prefix}product-category" class="block text-text-primary font-medium mb-2">Category</label>
                        <select id="${prefix}product-category" required class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary">
                            <option value="">Select a category</option>${categoryOptions}
                        </select>
                    </div>
                    <div>
                        <label for="${prefix}product-subcategory" class="block text-text-primary font-medium mb-2">Sub-Category</label>
                        <select id="${prefix}product-subcategory" class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary hidden" disabled>
                            <option value="">Select sub-category</option>
                        </select>
                        <div id="${prefix}subcategory-info" class="text-xs text-text-secondary mt-1"></div>
                    </div>
                </div>
            </div>
            
            <div class="p-4 border rounded-lg bg-gray-50/50 dark:bg-gray-800/50 border-color space-y-4">
                <h3 class="font-semibold text-lg text-text-primary">Common Details</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label for="${prefix}product-name" class="block text-text-primary font-medium mb-2">Product Name</label><input type="text" id="${prefix}product-name" required class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary"></div>
                    <div><label for="${prefix}product-id" class="block text-text-primary font-medium mb-2">Model Number / Code</label><input type="text" id="${prefix}product-id" required class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary"></div>
                    <div><label for="${prefix}product-brand" class="block text-text-primary font-medium mb-2">Brand</label><input type="text" id="${prefix}product-brand" class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary"></div>
                    <div><label for="${prefix}product-warranty" class="block text-text-primary font-medium mb-2">Warranty</label><input type="text" id="${prefix}product-warranty" placeholder="e.g., 1 year, 2 years" class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div><label for="${prefix}product-main-price" class="block text-text-primary font-medium mb-2">Main Price (৳)</label><input type="number" id="${prefix}product-main-price" required class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary"></div>
                    <div><label for="${prefix}product-offer-price" class="block text-text-primary font-medium mb-2">Offer Price (৳)</label><input type="number" id="${prefix}product-offer-price" class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary"></div>
                    <div><label for="${prefix}product-discount" class="block text-text-primary font-medium mb-2">Discount (%)</label><input type="number" id="${prefix}product-discount" readonly class="w-full px-4 py-2 bg-gray-200 dark:bg-gray-600 border border-gray-300 dark:border-gray-600 rounded-lg"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label for="${prefix}product-stock" class="block text-text-primary font-medium mb-2">Stock Count</label><input type="number" id="${prefix}product-stock" required class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary" value="0"></div>
                    <div><label for="${prefix}product-rating" class="block text-text-primary font-medium mb-2">Rating (0-5)</label><input type="number" id="${prefix}product-rating" step="0.1" min="0" max="5" class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary" value="0"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-2 border-t border-color">
                    <div class="flex items-center justify-between">
                        <span class="text-text-primary font-medium">On Offer</span>
                        <label for="${prefix}product-on-offer" class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="${prefix}product-on-offer" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-600 peer-checked:bg-theme-primary peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
                        </label>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-text-primary font-medium">Refundable</span>
                        <label for="${prefix}product-refundable" class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="${prefix}product-refundable" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-600 peer-checked:bg-theme-primary peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
                        </label>
                    </div>
                </div>
                <div><label for="${prefix}product-main-image" class="block text-text-primary font-medium mb-2">Main Image URL</label><input type="url" id="${prefix}product-main-image" required class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary" placeholder="https://example.com/main-image.jpg"></div>
                <div>
                    <div class="flex items-center justify-between mb-2"><label class="block text-text-primary font-medium">Specifications</label><button type="button" id="${prefix}add-specification-btn" class="text-sm bg-theme-primary text-white py-1 px-3 rounded-lg hover:bg-theme-primary-hover">+ Add</button></div>
                    <div id="${prefix}specification-container" class="space-y-2"></div>
                </div>
                <div>
                    <div class="flex items-center justify-between mb-2"><label class="block text-text-primary font-medium">Thumbnail Images</label><button type="button" id="${prefix}add-thumbnail-btn" class="text-sm bg-theme-primary text-white py-1 px-3 rounded-lg hover:bg-theme-primary-hover">+ Add</button></div>
                    <div id="${prefix}thumbnail-container" class="space-y-2"></div>
                </div>
            </div>
            
            <div><label for="${prefix}product-details" class="block text-text-primary font-medium mb-2">Description</label><textarea id="${prefix}product-details" rows="4" class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></textarea></div>
            
            <button type="submit" class="w-full bg-theme-primary text-white font-bold py-3 px-4 rounded-lg disabled:bg-opacity-70 btn-glow">${prefix === 'edit-' ? 'Save Changes' : 'Add Product'}</button>
            `;
        }

        const createSpecificationInput = (container, key = '', value = '') => {
            const inputWrapper = document.createElement('div');
            inputWrapper.className = 'flex items-center space-x-2 spec-row';
            inputWrapper.innerHTML = `
                <input type="text" class="w-1/3 px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-sm spec-key" placeholder="e.g., Color" value="${key}">
                <input type="text" class="w-2/3 px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-sm spec-value" placeholder="e.g., Red" value="${value}">
                <button type="button" class="remove-spec-btn text-red-500 hover:text-red-700 p-1"><i data-lucide="x-circle" class="w-5 h-5"></i></button>
            `;
            container.appendChild(inputWrapper);
            lucide.createIcons();
        };

        const setupProductForm = (formElement, prefix) => {
            if (!formElement) return;
            formElement.innerHTML = getProductFormHTML(prefix);

            const mainPrice = document.getElementById(`${prefix}product-main-price`);
            const offerPrice = document.getElementById(`${prefix}product-offer-price`);
            const discount = document.getElementById(`${prefix}product-discount`);
            
            const calculateDiscount = () => {
                const main = parseFloat(mainPrice.value) || 0;
                const offer = parseFloat(offerPrice.value) || 0;
                discount.value = (main > 0 && offer > 0 && main > offer) ? Math.round(((main - offer) / main) * 100) : 0;
            };
            mainPrice.addEventListener('input', calculateDiscount);
            offerPrice.addEventListener('input', calculateDiscount);

            const categorySelect = document.getElementById(`${prefix}product-category`);
            const subCategorySelect = document.getElementById(`${prefix}product-subcategory`);
            const subCategoryInfo = document.getElementById(`${prefix}subcategory-info`);

            categorySelect.addEventListener('change', (e) => {
                const selectedCategory = e.target.value;
                const subCategories = SUB_CATEGORY_MAP[selectedCategory];
                
                subCategorySelect.innerHTML = '<option value="">Select sub-category</option>'; // Reset
                subCategoryInfo.innerHTML = ''; // Reset info text

                if (subCategories && subCategories.length > 0) {
                    subCategories.forEach(sub => {
                        const option = document.createElement('option');
                        option.value = sub;
                        option.textContent = sub;
                        subCategorySelect.appendChild(option);
                    });
                    subCategorySelect.disabled = false;
                    subCategorySelect.classList.remove('hidden');
                    subCategoryInfo.innerHTML = `Available: ${subCategories.join(', ')}`;
                } else {
                    subCategorySelect.disabled = true;
                    subCategorySelect.classList.add('hidden');
                }
            });

            document.getElementById(`${prefix}add-thumbnail-btn`).addEventListener('click', () => {
                const container = document.getElementById(`${prefix}thumbnail-container`);
                const inputWrapper = document.createElement('div');
                inputWrapper.className = 'flex items-center space-x-2';
                inputWrapper.innerHTML = `
                    <input type="url" class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg thumbnail-input" placeholder="https://example.com/image.jpg">
                    <button type="button" class="remove-thumbnail-btn text-red-500 hover:text-red-700 p-1"><i data-lucide="x-circle" class="w-5 h-5"></i></button>
                `;
                container.appendChild(inputWrapper);
                lucide.createIcons();
            });

            document.getElementById(`${prefix}add-specification-btn`).addEventListener('click', () => {
                const container = document.getElementById(`${prefix}specification-container`);
                createSpecificationInput(container);
            });
        };

        const getProductDataFromForm = (form, prefix) => {
            const thumbnailInputs = form.querySelectorAll(`#${prefix}thumbnail-container .thumbnail-input`);
            const thumbnails = Array.from(thumbnailInputs).map(input => input.value).filter(Boolean);
            
            const specification = {};
            const specRows = form.querySelectorAll(`#${prefix}specification-container .spec-row`);
            specRows.forEach(row => {
                const key = row.querySelector('.spec-key').value.trim();
                const value = row.querySelector('.spec-value').value.trim();
                if (key) {
                    specification[key] = value;
                }
            });

            return {
                name: form.querySelector(`#${prefix}product-name`).value,
                model: form.querySelector(`#${prefix}product-id`).value,
                brand: form.querySelector(`#${prefix}product-brand`).value,
                warranty: form.querySelector(`#${prefix}product-warranty`).value,
                mainPrice: parseFloat(form.querySelector(`#${prefix}product-main-price`).value) || 0,
                offerPrice: parseFloat(form.querySelector(`#${prefix}product-offer-price`).value) || 0,
                discount: parseFloat(form.querySelector(`#${prefix}product-discount`).value) || 0,
                stock: parseInt(form.querySelector(`#${prefix}product-stock`).value, 10) || 0,
                rating: parseFloat(form.querySelector(`#${prefix}product-rating`).value) || 0,
                imageUrl: form.querySelector(`#${prefix}product-main-image`).value,
                thumbnails,
                category: form.querySelector(`#${prefix}product-category`).value,
                subcategory: form.querySelector(`#${prefix}product-subcategory`).value,
                details: form.querySelector(`#${prefix}product-details`).value,
                specification: specification,
                isOnOffer: form.querySelector(`#${prefix}product-on-offer`).checked,
                isRefundable: form.querySelector(`#${prefix}product-refundable`).checked
            };
        };

        // --- Event Delegation & Handlers ---
        document.addEventListener('submit', async e => {
            e.preventDefault();
            const formId = e.target.id;
            const button = e.target.querySelector('button[type="submit"]');

            if (formId === 'add-product-form') {
                setButtonLoading(button, true, 'Adding...');
                try {
                    const productData = getProductDataFromForm(e.target, 'add-');
                    const newRef = await addDoc(collection(db, 'products'), { ...productData, createdAt: serverTimestamp() });
                    showToast(`Product added successfully! ID: ${newRef.id}`);
                    e.target.reset();
                    document.getElementById('add-thumbnail-container').innerHTML = '';
                    document.getElementById('add-specification-container').innerHTML = '';
                } catch (err) {
                    console.error("Error adding product: ", err);
                    showToast('Failed to add product!', 'error');
                } finally {
                    setButtonLoading(button, false);
                }
            } else if (formId === 'edit-product-form') {
                setButtonLoading(button, true, 'Saving...');
                try {
                    const productId = document.getElementById('edit-product-id-hidden').value;
                    const updatedData = getProductDataFromForm(e.target, 'edit-');
                    await updateDoc(doc(db, 'products', productId), updatedData);
                    showToast('Product updated successfully!');
                    showPage('products');
                } catch (err) {
                    console.error("Error updating product:", err);
                    showToast('Failed to update product!', 'error');
                } finally {
                    setButtonLoading(button, false);
                }
            } else if (formId === 'add-banner-form') {
                setButtonLoading(button, true, 'Adding...');
                try {
                    await addDoc(collection(db, 'banners'), { 
                        imageUrl: e.target['banner-image'].value, 
                        link: e.target['banner-link'].value, 
                        createdAt: serverTimestamp() 
                    });
                    showToast('Banner added successfully!');
                    e.target.reset();
                } catch(err) {
                    showToast('Failed to add banner!', 'error');
                } finally {
                    setButtonLoading(button, false);
                }
            } else if (formId === 'add-coupon-form') {
                setButtonLoading(button, true, 'Adding...');
                try {
                    const code = e.target['coupon-code'].value.toUpperCase();
                    const existingCouponQuery = query(collection(db, "coupons"), where("code", "==", code));
                    const existingCouponSnap = await getDocs(existingCouponQuery);

                    if (!existingCouponSnap.empty) {
                        throw new Error("Coupon code already exists.");
                    }
                    
                    await addDoc(collection(db, 'coupons'), {
                        code: code,
                        type: e.target['coupon-type'].value,
                        value: parseFloat(e.target['coupon-value'].value),
                        expiryDate: e.target['coupon-expiry'].value,
                        minSpend: parseFloat(e.target['coupon-min-spend'].value) || 0,
                        createdAt: serverTimestamp()
                    });
                    showToast('Coupon added successfully!');
                    e.target.reset();
                } catch (err) {
                    console.error("Error adding coupon:", err);
                    showToast(err.message || 'Failed to add coupon!', 'error');
                } finally {
                    setButtonLoading(button, false);
                }
            } else if (formId === 'add-side-promo-form') {
                setButtonLoading(button, true, 'Adding...');
                try {
                    const imageUrl = e.target['side-promo-image'].value;
                    const title = (e.target['side-promo-title']?.value || '').trim();
                    const title_bn = (e.target['side-promo-title-bn']?.value || '').trim();
                    const subtitle = (e.target['side-promo-subtitle']?.value || '').trim();
                    const subtitle_bn = (e.target['side-promo-subtitle-bn']?.value || '').trim();
                    const link = e.target['side-promo-link'].value;
                    const alt = (e.target['side-promo-alt']?.value || '').trim();
                    const order = parseInt(e.target['side-promo-order']?.value) || 0;
                    const active = e.target['side-promo-active'].checked;
                    await addDoc(collection(db, 'sidePromos'), {
                        imageUrl,
                        title,
                        title_bn,
                        subtitle,
                        subtitle_bn,
                        link,
                        alt,
                        order,
                        active,
                        createdAt: serverTimestamp()
                    });
                    showToast('Side promo added successfully!');
                    e.target.reset();
                    // default to active after reset
                    const activeInput = document.getElementById('side-promo-active');
                    if (activeInput) activeInput.checked = true;
                } catch (err) {
                    console.error('Error adding side promo:', err);
                    showToast('Failed to add side promo!', 'error');
                } finally {
                    setButtonLoading(button, false);
                }
            } else if (formId === 'add-delivery-man-form') {
                 setButtonLoading(button, true, 'Adding...');
                const email = e.target['delivery-man-email'].value;
                const password = e.target['delivery-man-password'].value;
                const name = e.target['delivery-man-name'].value;
                const phone = e.target['delivery-man-phone'].value;
                const vehicle = e.target['delivery-man-vehicle'].value;
                
                const tempAppName = `temp-app-${Date.now()}`;
                let secondaryApp;
                try {
                    secondaryApp = initializeApp(firebaseConfig, tempAppName);
                    const secondaryAuth = getAuth(secondaryApp);
                    
                    const userCredential = await createUserWithEmailAndPassword(secondaryAuth, email, password);
                    const newUserUid = userCredential.user.uid;

                    await setDoc(doc(db, 'deliveryMen', newUserUid), {
                        name: name,
                        email: email,
                        phone: phone,
                        vehicle: vehicle,
                        accountStatus: 'active',
                        createdAt: serverTimestamp()
                    });
                    
                    await signOut(secondaryAuth);
                    showToast('Delivery man added successfully!');
                    e.target.reset();
                } catch (err) {
                    console.error("Error adding delivery man: ", err);
                    showToast(err.code === 'auth/email-already-in-use' ? 'This email is already registered.' : `Failed to add delivery man!`, 'error');
                } finally {
                    if (secondaryApp) {
                        await deleteApp(secondaryApp).catch(e => console.error("Could not delete temp app", e));
                    }
                    setButtonLoading(button, false);
                }
            } else if(formId === 'profile-settings-form') {
                setButtonLoading(button, true, 'Saving...');
                try {
                    const user = auth.currentUser;
                    if (!user) throw new Error("User not found");
                    const newName = document.getElementById('admin-name').value;
                    const newImageUrl = document.getElementById('admin-image').value;
                    await updateDoc(doc(db, "admins", user.uid), { name: newName, imageUrl: newImageUrl });
                    await loadAdminProfile(user);
                    showToast("Profile updated successfully!");
                } catch(err) {
                    showToast("Failed to update profile!", 'error');
                } finally {
                    setButtonLoading(button, false);
                }
            } else if (formId === 'chat-message-form') {
                const input = document.getElementById('chat-message-input');
                const messageText = input.value.trim();

                if (messageText && currentChatUserId) {
                    input.value = ''; 
                    try {
                        const messageData = {
                            sender: 'admin',
                            text: messageText,
                            timestamp: serverTimestamp(),
                            adminId: auth.currentUser.uid
                        };
                        const chatRef = doc(db, 'live_chats', currentChatUserId);
                        
                        await addDoc(collection(chatRef, 'messages'), messageData);
                        
                        await updateDoc(chatRef, {
                            lastMessage: messageText,
                            lastMessageTimestamp: serverTimestamp(),
                            lastSender: 'admin',
                            isReadByAdmin: true,
                            isReadByUser: false
                        });
                    } catch (err) {
                        console.error("Error sending message:", err);
                        showToast("Failed to send message!", 'error');
                        input.value = messageText;
                    }
                }
            }
        });

        document.addEventListener('click', (e) => {
// Show edit coupon modal and populate fields
async function openEditCouponModal(couponId) {
    // Create modal if not exists
    let modal = document.getElementById('edit-coupon-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'edit-coupon-modal';
        modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
        modal.innerHTML = `
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-8 w-full max-w-md relative">
                <button id="edit-coupon-modal-close" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                <h2 class="text-xl font-bold mb-4 text-text-primary">Edit Coupon</h2>
                <form id="edit-coupon-form" class="space-y-4">
                    <input type="hidden" id="edit-coupon-id">
                    <div>
                        <label for="edit-coupon-code" class="block text-text-primary font-medium mb-2">Coupon Code</label>
                        <input type="text" id="edit-coupon-code" required class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border rounded-lg">
                    </div>
                    <div>
                        <label for="edit-coupon-type" class="block text-text-primary font-medium mb-2">Discount Type</label>
                        <select id="edit-coupon-type" required class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border rounded-lg">
                            <option value="percentage">Percentage</option>
                            <option value="fixed">Fixed Amount</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit-coupon-value" class="block text-text-primary font-medium mb-2">Value</label>
                        <input type="number" id="edit-coupon-value" required min="0" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border rounded-lg">
                    </div>
                    <div>
                        <label for="edit-coupon-expiry" class="block text-text-primary font-medium mb-2">Expiry Date</label>
                        <input type="date" id="edit-coupon-expiry" required class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border rounded-lg">
                    </div>
                    <div>
                        <label for="edit-coupon-min-spend" class="block text-text-primary font-medium mb-2">Minimum Spend</label>
                        <input type="number" id="edit-coupon-min-spend" min="0" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border rounded-lg">
                    </div>
                    <button type="submit" class="w-full bg-theme-primary text-white font-bold py-3 px-4 rounded-lg">Update Coupon</button>
                </form>
            </div>
        `;
        document.body.appendChild(modal);
        document.getElementById('edit-coupon-modal-close').onclick = () => modal.remove();
        document.getElementById('edit-coupon-form').onsubmit = handleEditCouponSubmit;
    }
    modal.classList.remove('hidden');
    // Fetch coupon data from Firestore
    const db = window.db;
    const docRef = db.collection ? db.collection('coupons').doc(couponId) : window.doc(db, 'coupons', couponId);
    let couponData;
    if (docRef.get) {
        couponData = (await docRef.get()).data();
    } else {
        couponData = (await window.getDoc(docRef)).data();
    }
    document.getElementById('edit-coupon-id').value = couponId;
    document.getElementById('edit-coupon-code').value = couponData.code || '';
    document.getElementById('edit-coupon-type').value = couponData.type || 'percentage';
    document.getElementById('edit-coupon-value').value = couponData.value || 0;
    document.getElementById('edit-coupon-expiry').value = couponData.expiryDate || '';
    document.getElementById('edit-coupon-min-spend').value = couponData.minSpend || 0;
}

// Handle edit coupon form submit
async function handleEditCouponSubmit(e) {
    e.preventDefault();
    const db = window.db;
    const couponId = document.getElementById('edit-coupon-id').value;
    const code = document.getElementById('edit-coupon-code').value.trim().toUpperCase();
    const type = document.getElementById('edit-coupon-type').value;
    const value = parseFloat(document.getElementById('edit-coupon-value').value);
    const expiryDate = document.getElementById('edit-coupon-expiry').value;
    const minSpend = parseFloat(document.getElementById('edit-coupon-min-spend').value) || 0;
    const docRef = db.collection ? db.collection('coupons').doc(couponId) : window.doc(db, 'coupons', couponId);
    try {
        if (docRef.update) {
            await docRef.update({ code, type, value, expiryDate, minSpend });
        } else {
            await window.updateDoc(docRef, { code, type, value, expiryDate, minSpend });
        }
        showToast('Coupon updated successfully!');
        document.getElementById('edit-coupon-modal').remove();
    } catch (err) {
        showToast('Failed to update coupon!', 'error');
        console.error(err);
    }
}
            const editCouponBtn = e.target.closest('.edit-coupon-btn');
            if (editCouponBtn) {
                const couponId = editCouponBtn.dataset.id;
                openEditCouponModal(couponId);
                return;
            }
            const navLink = e.target.closest('.nav-link');
            if(navLink) {
                e.preventDefault();
                const pageId = navLink.dataset.page;
                history.pushState({pageId}, '', `#${pageId}`);
                showPage(pageId);
                return;
            }

            // Chat search and unread toggle (click)
            const searchInput = e.target.closest('#chat-search-input');
            if (searchInput && lastChatsSnapshot) {
                renderChatList(lastChatsSnapshot);
                return;
            }

            const unreadToggle = e.target.closest('#chat-unread-toggle');
            if (unreadToggle && lastChatsSnapshot) {
                renderChatList(lastChatsSnapshot);
                return;
            }

            const statCard = e.target.closest('.stat-card[data-page]');
            if (statCard) {
                const page = statCard.dataset.page;
                const filter = statCard.dataset.filter;
                
                if (page === 'orders' && filter) {
                    applyAndShowOrdersFilter(filter);
                } else {
                    showPage(page);
                }
                return;
            }

            const orderStatusFilterBtn = e.target.closest('.order-status-filter-btn');
            if(orderStatusFilterBtn) {
                applyAndShowOrdersFilter(orderStatusFilterBtn.dataset.status);
                return;
            }
    
            const chatListItem = e.target.closest('.chat-list-item');
            if (chatListItem) {
                openChat(chatListItem.dataset.userId);
                return;
            }

            const themeOption = e.target.closest('.theme-option');
            if (themeOption) {
                applyTheme(themeOption.dataset.theme);
                return;
            }
            
            const deleteBtn = e.target.closest('.delete-btn');
            if (deleteBtn) {
                const collectionName = deleteBtn.dataset.coll;
                const id = deleteBtn.dataset.id;
                let title = "Are you sure?";
                let text = `Do you really want to delete this ${collectionName.slice(0,-1)}? This action cannot be undone.`;

                if (collectionName === 'users') {
                    title = "Delete User?";
                    text = "This only removes the user's data, not their authentication account. This action cannot be undone.";
                } else if (collectionName === 'deliveryMen') {
                    title = "Delete Delivery Man?";
                    text = "This will permanently delete the delivery man's data. Their login account will NOT be deleted. Consider 'Blocking' the account instead. This action is irreversible.";
                }

                showConfirmationModal(async () => {
                    try {
                        await deleteDoc(doc(db, collectionName, id));
                        showToast(`${collectionName.slice(0, -1)} deleted successfully!`);
                    } catch (err) {
                        showToast(`Failed to delete ${collectionName.slice(0, -1)}!`, 'error');
                        console.error(`Error deleting from ${collectionName}:`, err);
                    }
                }, title, text);
                return;
            }

            // Toggle Duplicates view
            const dupToggleBtn = e.target.closest('#products-toggle-duplicates');
            if (dupToggleBtn) {
                showDuplicatesOnly = !showDuplicatesOnly;
                dupToggleBtn.innerHTML = showDuplicatesOnly 
                    ? '<i data-lucide="list" class="w-4 h-4 mr-2"></i> Show All'
                    : '<i data-lucide="alert-triangle" class="w-4 h-4 mr-2"></i> Show Duplicates';
                renderFilteredProducts();
                if (window.lucide?.createIcons) lucide.createIcons();
                return;
            }
            
            // FIX: Product edit korar jonno button handler add kora hoyeche
            const editBtn = e.target.closest('.edit-btn');
            if (editBtn) {
                loadProductForEdit(editBtn.dataset.id);
                return;
            }

            if (e.target.closest('#new-order-alert-close-btn')) {
                hideNewOrderAlert();
            }

            if (e.target.closest('#new-message-alert-close-btn')) {
                hideNewMessageAlert();
            }

            if (e.target.closest('#view-full-chat-btn')) {
                const userId = e.target.closest('#view-full-chat-btn').dataset.id;
                if(userId) {
                    showPage('chat');
                    openChat(userId);
                }
                hideNewMessageAlert();
                return;
            }

            if (e.target.closest('#view-full-order-btn')) {
                const orderId = e.target.closest('#view-full-order-btn').dataset.id;
                if(orderId) {
                    showOrderDetails(orderId);
                }
                hideNewOrderAlert();
            }

            const accountStatusToggleBtn = e.target.closest('.account-status-toggle-btn');
            if (accountStatusToggleBtn) {
                const id = accountStatusToggleBtn.dataset.id;
                const currentStatus = accountStatusToggleBtn.dataset.status;
                const newStatus = currentStatus === 'active' ? 'frozen' : 'active';
                const actionText = newStatus === 'frozen' ? 'block' : 'unblock';
                const modalText = `Are you sure you want to ${actionText} this account? This prevents them from being assigned new orders.`;

                showConfirmationModal(async () => {
                    try {
                        await updateDoc(doc(db, "deliveryMen", id), { accountStatus: newStatus });
                        showToast(`Account ${actionText}ed successfully!`);
                    } catch (error) {
                        showToast(`Failed to ${actionText} account.`, 'error');
                        console.error(error);
                    }
                }, `Confirm ${actionText}`, modalText);
            }

            const viewDeliveryManBtn = e.target.closest('.view-delivery-man-btn');
            if(viewDeliveryManBtn) {
                showDeliveryManDetails(viewDeliveryManBtn.dataset.id);
            }

            const viewUserBtn = e.target.closest('.view-user-btn');
            if (viewUserBtn) {
                const uid = viewUserBtn.dataset.id;
                openUserProfile(uid);
                return;
            }

            const blockUserBtn = e.target.closest('.block-user-btn');
            if (blockUserBtn) {
                const userId = blockUserBtn.dataset.id;
                const isCurrentlyBlocked = blockUserBtn.dataset.blocked === 'true';
                const actionText = isCurrentlyBlocked ? 'unblock' : 'block';

                showConfirmationModal(async () => {
                    try {
                        await updateDoc(doc(db, "users", userId), { isBlocked: !isCurrentlyBlocked });
                        showToast(`User ${actionText}ed successfully!`);
                    } catch (error) {
                        console.error(`Error ${actionText}ing user:`, error);
                        showToast(`Failed to ${actionText} user!`, 'error');
                    }
                }, `Confirm ${actionText}`, `Are you sure you want to ${actionText} this user?`);
                return;
            }
            
            const deleteChatBtn = e.target.closest('.delete-chat-btn');
            if (deleteChatBtn) {
                e.stopPropagation(); // Prevent opening the chat
                const userId = deleteChatBtn.dataset.id;
                showConfirmationModal(async () => {
                    // Note: This only deletes the main chat document. The messages subcollection
                    // will remain in Firestore but will be inaccessible from the app.
                    // For a complete deletion, a Cloud Function is recommended.
                    try {
                        await deleteDoc(doc(db, 'live_chats', userId));
                        showToast('Chat deleted successfully!');
                        // After deletion, reset chat view if needed
                        if (currentChatUserId === userId) {
                            resetChatView();
                        }
                        // Remove chat item from UI immediately
                        const chatItem = document.querySelector(`.chat-list-item[data-user-id='${userId}']`);
                        if (chatItem) chatItem.remove();
                        // Optionally, re-fetch chat list if you have a function like renderChatList
                        if (typeof renderChatList === 'function') {
                            renderChatList();
                        }
                    } catch (error) {
                        console.error("Error deleting chat:", error);
                        showToast('Failed to delete chat! Check your security rules.', 'error');
                    }
                }, 'Delete Chat?', 'Are you sure you want to permanently delete this entire conversation? This action cannot be undone.');
                return;
            }

            const viewOrderBtn = e.target.closest('.view-order-btn');
            if (viewOrderBtn) {
                showOrderDetails(viewOrderBtn.dataset.id);
            }

            const categoryFilterBtn = e.target.closest('.category-filter-btn');
            if(categoryFilterBtn) {
                currentProductCategoryFilter = categoryFilterBtn.dataset.category;
                currentProductSubCategoryFilter = 'all'; // Reset sub-category on main category change
                renderProductFilters();
                renderSubCategoryFilter();
                renderFilteredProducts();
                return;
            }
            
            const removeBtn = e.target.closest('.remove-spec-btn, .remove-thumbnail-btn');
            if (removeBtn) {
                removeBtn.parentElement.remove();
            }
        });

        // Live Chat search filter (type to filter)
        document.addEventListener('input', (e) => {
            if (e.target && e.target.id === 'chat-search-input') {
                if (lastChatsSnapshot) renderChatList(lastChatsSnapshot);
            }
        });

        // Live Chat unread-only toggle
        document.addEventListener('change', (e) => {
            if (e.target && e.target.id === 'chat-unread-toggle') {
                if (lastChatsSnapshot) renderChatList(lastChatsSnapshot);
            }
        });

        document.addEventListener('change', async (e) => {
            if (e.target.id === 'dark-mode-toggle') {
                localStorage.theme = e.target.checked ? 'dark' : 'light';
                applyDarkMode(e.target.checked);
            }

            if (e.target.classList.contains('status-change')) {
                const orderId = e.target.dataset.id;
                const newStatus = e.target.value;
                const orderRef = doc(db, 'orders', orderId);

                try {
                    const orderDoc = await getDoc(orderRef);
                    if (!orderDoc.exists()) throw new Error("Order not found");
                    
                    const orderData = orderDoc.data();
                    const oldStatus = orderData.status;

                    if(oldStatus === newStatus) return;

                    const batch = writeBatch(db);
                    
                    const affectsStock = (status) => ['pending', 'shipped', 'out-for-delivery', 'delivered'].includes(status);

                    if (!affectsStock(oldStatus) && affectsStock(newStatus)) {
                        for (const item of orderData.items) {
                            const productRef = doc(db, 'products', item.productId);
                            batch.update(productRef, { stock: increment(-item.quantity) });
                        }
                    } else if (affectsStock(oldStatus) && !affectsStock(newStatus)) {
                        for (const item of orderData.items) {
                            const productRef = doc(db, 'products', item.productId);
                            batch.update(productRef, { stock: increment(item.quantity) });
                        }
                    }

                    batch.update(orderRef, { status: newStatus });
                    
                    await batch.commit();
                    showToast('Status updated successfully!');
                    if (!UI.orderDetailsModal.classList.contains('hidden')) {
                        showOrderDetails(orderId); 
                    }
                } catch (err) {
                    console.error("Failed to update status/stock: ", err);
                    showToast('Failed to update status!', 'error');
                    const docSnap = await getDoc(orderRef);
                    if (docSnap.exists()) {
                        e.target.value = docSnap.data().status; 
                    }
                }
            }

            if (e.target.classList.contains('delivery-man-assign')) {
                const orderId = e.target.dataset.id;
                const deliveryManId = e.target.value;
                const deliveryManName = deliveryManId ? e.target.options[e.target.selectedIndex].text : '';

                try {
                    const updateData = {
                        assignedDeliveryManId: deliveryManId,
                        assignedDeliveryManName: deliveryManName
                    };
                    
                    await updateDoc(doc(db, 'orders', orderId), updateData);
                    showToast('Delivery man assigned!');
                } catch(err) {
                    console.error("Failed to assign delivery man:", err);
                    showToast('Failed to assign delivery man!', 'error');
                }
            }
        });

        // Select All toggles per section
        document.addEventListener('change', (e) => {
            const id = e.target?.id;
            if (!id) return;
            const map = {
                'products-select-all': 'products-page',
                'low-stock-select-all': 'low-stock-page',
                'reviews-select-all': 'reviews-page',
                'orders-select-all': 'orders-page',
                'users-select-all': 'users-page',
            };
            const pageId = map[id];
            if (!pageId) return;
            const container = document.getElementById(pageId);
            if (!container) return;
            const checked = e.target.checked;
            container.querySelectorAll('input.row-select').forEach(cb => cb.checked = checked);
        });

        // Bulk delete selected per section
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('#products-delete-selected, #low-stock-delete-selected, #reviews-delete-selected, #orders-delete-selected, #users-delete-selected');
            if (!btn) return;

            const pageMap = {
                'products-delete-selected': 'products-page',
                'low-stock-delete-selected': 'low-stock-page',
                'reviews-delete-selected': 'reviews-page',
                'orders-delete-selected': 'orders-page',
                'users-delete-selected': 'users-page'
            };
            const pageId = pageMap[btn.id];
            const container = document.getElementById(pageId);
            if (!container) return;

            const selected = Array.from(container.querySelectorAll('input.row-select:checked'));
            if (selected.length === 0) { showToast('No items selected', 'warning'); return; }

            const doBulkDelete = async () => {
                const groups = { products: [], orders: [], users: [], review: [] };
                selected.forEach(cb => {
                    const coll = cb.dataset.coll;
                    if (coll === 'review') {
                        groups.review.push({ productId: cb.dataset.productId, reviewIdx: Number(cb.dataset.reviewIdx) });
                    } else if (groups[coll]) {
                        groups[coll].push(cb.dataset.id);
                    }
                });

                try {
                    // Delete products using writeBatch for speed (up to 500 per commit)
                    if (groups.products.length) {
                        const chunkSize = 450; // keep headroom for safety
                        for (let i = 0; i < groups.products.length; i += chunkSize) {
                            const chunk = groups.products.slice(i, i + chunkSize);
                            const batch = writeBatch(db);
                            chunk.forEach(pid => batch.delete(doc(db, 'products', pid)));
                            await batch.commit();
                        }
                    }

                    // Delete orders and users (usually smaller counts). If needed, we can batch similarly later.
                    for (const coll of ['orders', 'users']) {
                        const ids = groups[coll];
                        for (let i = 0; i < ids.length; i += 50) { // small concurrency-friendly chunks
                            const slice = ids.slice(i, i + 50);
                            await Promise.all(slice.map(id => deleteDoc(doc(db, coll, id))));
                        }
                    }
                    // Delete embedded reviews grouped by product
                    if (groups.review.length) {
                        const byProduct = groups.review.reduce((acc, r) => {
                            (acc[r.productId] ||= []).push(r.reviewIdx);
                            return acc;
                        }, {});
                        for (const [productId, idxs] of Object.entries(byProduct)) {
                            const pref = doc(db, 'products', productId);
                            const psnap = await getDoc(pref);
                            if (!psnap.exists()) continue;
                            const data = psnap.data();
                            if (!Array.isArray(data.reviews)) continue;
                            idxs.sort((a,b) => b - a).forEach(i => { if (i >= 0 && i < data.reviews.length) data.reviews.splice(i, 1); });
                            await updateDoc(pref, { reviews: data.reviews });
                        }
                    }

                    showToast('Selected items deleted successfully!');
                    // Clear selections
                    const selectAll = container.querySelector('input[id$="-select-all"]');
                    if (selectAll) selectAll.checked = false;
                    container.querySelectorAll('input.row-select').forEach(cb => cb.checked = false);
                    if (pageId === 'reviews-page') renderReviewsList();
                } catch (err) {
                    console.error('Bulk delete failed', err);
                    showToast('Failed to delete some items', 'error');
                }
            };

            showConfirmationModal(doBulkDelete, 'Delete selected?', `Are you sure you want to delete ${selected.length} selected item(s)? This action cannot be undone.`);
        });

        const loadProductForEdit = async (productId) => {
            try {
                const productDoc = await getDoc(doc(db, "products", productId));
                if (!productDoc.exists()) {
                    showToast("Product not found!", "error");
                    return;
                }
                const data = productDoc.data();
                const form = document.getElementById('edit-product-form');

                form.querySelector('#edit-product-id-hidden').value = productId;
                const docIdField = document.getElementById('edit-product-doc-id');
                if (docIdField) docIdField.value = productId;
                form.querySelector('#edit-product-name').value = data.name || '';
                form.querySelector('#edit-product-id').value = data.model || '';
                form.querySelector('#edit-product-brand').value = data.brand || '';
                form.querySelector('#edit-product-warranty').value = data.warranty || '';
                form.querySelector('#edit-product-main-price').value = data.mainPrice || 0;
                form.querySelector('#edit-product-offer-price').value = data.offerPrice || 0;
                form.querySelector('#edit-product-discount').value = data.discount || 0;
                form.querySelector('#edit-product-main-image').value = data.imageUrl || '';
                form.querySelector('#edit-product-stock').value = data.stock || 0;
                form.querySelector('#edit-product-rating').value = data.rating || 0;
                form.querySelector('#edit-product-details').value = data.details || '';
                
                const mainCategorySelect = form.querySelector('#edit-product-category');
                mainCategorySelect.value = data.category || '';
                // Manually trigger the change event to populate sub-categories
                mainCategorySelect.dispatchEvent(new Event('change')); 

                // Use a small delay to ensure the sub-category dropdown is populated before setting its value
                setTimeout(() => {
                    form.querySelector('#edit-product-subcategory').value = data.subcategory || '';
                }, 100);

                form.querySelector('#edit-product-on-offer').checked = data.isOnOffer || false;
                form.querySelector('#edit-product-refundable').checked = data.isRefundable || false;
                
                const thumbnailContainer = form.querySelector('#edit-thumbnail-container');
                thumbnailContainer.innerHTML = '';
                (data.thumbnails || []).forEach(url => {
                     const inputWrapper = document.createElement('div');
                    inputWrapper.className = 'flex items-center space-x-2';
                    inputWrapper.innerHTML = `
                        <input type="url" class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg thumbnail-input" value="${url}" placeholder="https://example.com/image.jpg">
                        <button type="button" class="remove-thumbnail-btn text-red-500 hover:text-red-700 p-1"><i data-lucide="x-circle" class="w-5 h-5"></i></button>
                    `;
                    thumbnailContainer.appendChild(inputWrapper);
                });

                const specContainer = form.querySelector('#edit-specification-container');
                specContainer.innerHTML = '';
                if(data.specification && typeof data.specification === 'object'){
                    for(const [key, value] of Object.entries(data.specification)){
                        createSpecificationInput(specContainer, key, value);
                    }
                }

                lucide.createIcons();
                showPage('edit-product');
            } catch (error) {
                console.error("Error loading product for edit:", error);
                showToast("Could not load product data.", "error");
            }
        };

        const showConfirmationModal = (callback, title = "Are you sure?", text = "This action cannot be undone.") => {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-text').textContent = text;
            confirmCallback = callback;
            UI.confirmationModal.classList.remove('hidden');
        };

        const hideConfirmationModal = () => {
            confirmCallback = null;
            UI.confirmationModal.classList.add('hidden');
        };

        const showOrderDetails = async (orderId) => {
            UI.orderDetailsContent.innerHTML = '<p>Loading...</p>';
            UI.orderDetailsModal.classList.remove('hidden');

            try {
                const orderDoc = await getDoc(doc(db, "orders", orderId));
                if (!orderDoc.exists()) {
                    UI.orderDetailsContent.innerHTML = '<p class="text-red-500">Order not found.</p>';
                    return;
                }

                const data = orderDoc.data();
                const orderIdDisplay = data.orderId || orderDoc.id.substring(0, 6); // Use d.orderId or fallback
                const itemsHtml = data.items?.map(item => `
                    <div class="flex items-center justify-between py-2 border-b border-color">
                        <div class="flex items-center">
                            <img src="${item.imageUrl || item.image}" onerror="this.src='https://placehold.co/40x40/e2e8f0/64748b?text=Img'" class="w-10 h-10 object-cover rounded mr-4">
                            <div>
                                <p class="font-semibold text-text-primary">${item.name}</p>
                                <p class="text-sm text-text-secondary">Qty: ${item.quantity}</p>
                            </div>
                        </div>
                        <p class="text-text-primary">৳${((item.price || 0) * (item.quantity || 1)).toFixed(2)}</p>
                    </div>
                `).join('') || '<div>No items found.</div>';
        
                const deliveryManName = data.assignedDeliveryManId ? (allDeliveryMen.find(d => d.id === data.assignedDeliveryManId)?.data().name || 'N/A') : 'Unassigned';

                // Get the status dropdown for quick actions in the modal
                const statusDropdownHtml = getStatusDropdown(orderId, data.status);

                UI.orderDetailsContent.innerHTML = `
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                        <div><strong class="text-text-secondary">Order ID:</strong> <span class="font-mono" title="Full ID: ${orderDoc.id}">#${orderIdDisplay}</span></div>
                        <div><strong class="text-text-secondary">Date:</strong> ${data.createdAt?.toDate().toLocaleString() || 'N/A'}</div>
                        <div><strong class="text-text-secondary">Customer:</strong> ${data.userName || 'N/A'}</div>
                        <div><strong class="text-text-secondary">Mobile:</strong> ${data.userMobile || 'N/A'}</div>
                        <div class="sm:col-span-2"><strong class="text-text-secondary">Location:</strong> ${data.userLocation || 'N/A'}</div>
                        <div><strong class="text-text-secondary">Payment:</strong> ${data.paymentMethod || 'N/A'}</div>
                        <div><strong class="text-text-secondary">Status:</strong> ${getStatusBadge(data.status)}</div>
                        <div class="flex items-center space-x-2"><strong class="text-text-secondary">Change Status:</strong> ${statusDropdownHtml}</div>
                        <div><strong class="text-text-secondary">Assigned To:</strong> ${deliveryManName}</div>
                        <div><strong class="text-text-secondary">Delivery Charge:</strong> ৳${data.deliveryCharge || 0}</div>
                    </div>
                    <div class="mt-4">
                        <h4 class="font-semibold text-text-primary mb-2">Items Ordered</h4>
                        <div class="space-y-2">${itemsHtml}</div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-color text-right">
                        <strong class="text-lg text-text-primary">Total: ৳${(data.totalAmount || 0).toFixed(2)}</strong>
                    </div>
                `;
                lucide.createIcons();
            } catch (error) {
                console.error("Error fetching order details:", error);
                UI.orderDetailsContent.innerHTML = '<p class="text-red-500">Could not load order details.</p>';
                showToast("Error fetching order details!", 'error');
            }
        };

        // Open User Profile modal by UID and render details + recent summary
        const openUserProfile = async (uid) => {
            try {
                UI.userProfileModalContent.innerHTML = '<p>Loading...</p>';
                UI.userProfileModal.classList.remove('hidden');

                const userRef = doc(db, 'users', uid);
                const userSnap = await getDoc(userRef);
                if (!userSnap.exists()) {
                    UI.userProfileModalContent.innerHTML = '<p class="text-red-500">User not found.</p>';
                    return;
                }
                const u = userSnap.data();
                const avatar = u.photoURL || `https://placehold.co/64x64/e2e8f0/64748b?text=${(u.name || 'U').charAt(0)}`;
                const created = formatJoinDate(u.createdAt);

                const formatCurrency = (n) => `৳${Number(n || 0).toLocaleString('en-US', { maximumFractionDigits: 2 })}`;
                const statusKey = (s) => {
                    if (!s) return 'pending';
                    const raw = String(s).trim().toLowerCase();
                    return (raw === 'canceled') ? 'cancelled' : raw.replace(/\s+/g, '-');
                };
                const toMillis = (ts) => ts?.toMillis?.() || ts?.toDate?.()?.getTime?.() || (typeof ts === 'number' ? ts : 0);

                // Gather orders from memory; if empty, fetch directly by UID
                let userOrders = (allOrders || []).filter(o => (o.data()?.userId || o.data()?.uid || o.data()?.userUID) === uid);
                if (userOrders.length === 0) {
                    const ordersCol = collection(db, 'orders');
                    const results = [];
                    for (const f of ['userId', 'uid', 'userUID']) {
                        try {
                            const snap = await getDocs(query(ordersCol, where(f, '==', uid)));
                            snap.forEach(d => results.push(d));
                        } catch { /* ignore field/index issues */ }
                    }
                    const seen = new Set();
                    userOrders = results.filter(d => !seen.has(d.id) && (seen.add(d.id) || true)).map(d => ({ id: d.id, data: () => d.data() }));
                }

                userOrders.sort((a, b) => toMillis(b.data().createdAt) - toMillis(a.data().createdAt));
                const totalOrders = userOrders.length;
                const totalSpent = userOrders.reduce((sum, o) => sum + Number(o.data()?.totalAmount || 0), 0);
                const lastOrder = userOrders[0];
                const lastOrderAt = lastOrder ? (lastOrder.data().createdAt ? new Date(toMillis(lastOrder.data().createdAt)).toLocaleString() : 'N/A') : 'N/A';

                const statusCounts = userOrders.reduce((acc, o) => {
                    const k = statusKey(o.data()?.status);
                    acc[k] = (acc[k] || 0) + 1;
                    return acc;
                }, {});
                const statusOrder = ['pending', 'confirmed', 'shipped', 'out-for-delivery', 'delivered', 'cancelled'];
                const statusBadgesHtml = statusOrder.map(k => {
                    const count = statusCounts[k] || 0;
                    const label = k.replace(/-/g,' ');
                    return `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-gray-100 dark:bg-gray-700 text-text-secondary mr-1 mb-1">${label}: <strong class="ml-1 text-text-primary">${count}</strong></span>`;
                }).join('');

                // Product insights by name
                const productNameCounts = {};
                userOrders.forEach(o => (o.data()?.items || []).forEach(it => {
                    const name = (it.name || it.productName || it.title || it.productId || 'Item').toString();
                    productNameCounts[name] = (productNameCounts[name] || 0) + (Number(it.quantity) || 1);
                }));
                const distinctProducts = Object.keys(productNameCounts).length;
                const topProductsList = Object.entries(productNameCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .map(([name, qty]) => `<li class="flex justify-between"><span class="truncate max-w-[70%]">${name}</span> <span class="text-text-secondary">x${qty}</span></li>`) 
                    .join('') || '<li class="text-text-secondary">No products</li>';

                const recentOrdersList = (userOrders.slice(0, 3).map(o => {
                    const d = o.data();
                    const oid = d.orderId || o.id || '';
                    const amt = formatCurrency(d.totalAmount || 0);
                    const when = d.createdAt ? new Date(toMillis(d.createdAt)).toLocaleString() : 'N/A';
                    const st = statusKey(d.status).replace(/-/g, ' ');
                    return `<li class=\"flex justify-between text-sm\"><span class=\"font-mono\">#${oid}</span><span class=\"text-text-secondary\">${when}</span><span>${amt}</span><span class=\"text-text-secondary\">${st}</span></li>`;
                }).join('')) || '<li class="text-text-secondary">No recent orders</li>';

                // Wishlist (best-effort)
                let wishlistItems = [];
                try {
                    const wlSnap = await getDocs(collection(db, `users/${uid}/wishlist`));
                    wishlistItems = wlSnap.docs.map(d => d.data());
                } catch { /* ignore if missing */ }
                const wishlistCount = wishlistItems.length;
                const wishlistListHtml = wishlistItems.slice(0, 5)
                    .map(w => `<li class=\"truncate\">${w.name || w.productName || w.productId || 'Item'}</li>`)
                    .join('') || '<li class="text-text-secondary">No wishlist items</li>';

                UI.userProfileModalContent.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <img src="${avatar}" class="w-16 h-16 rounded-full object-cover" />
                        <div>
                            <div class="text-lg font-semibold text-text-primary">${u.name || 'N/A'}</div>
                            <div class="text-sm text-text-secondary">${u.email || ''}</div>
                            <div class="text-sm text-text-secondary">${u.mobile || ''}</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div><span class="text-text-secondary">UID:</span> <span class="font-mono">${uid}</span></div>
                        <div><span class="text-text-secondary">Joined:</span> ${created}</div>
                        <div><span class="text-text-secondary">Location:</span> ${u.location || 'N/A'}</div>
                        <div class="flex items-center gap-2"><span class="text-text-secondary">Status:</span> ${(u.isBlocked ? '<span class="px-2 py-0.5 rounded bg-red-100 text-red-700 text-xs">Blocked</span>' : '<span class="px-2 py-0.5 rounded bg-green-100 text-green-700 text-xs">Active</span>')}
                            <button id="profile-block-toggle" class="ml-auto px-2 py-1 text-xs rounded ${u.isBlocked ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}" data-id="${uid}" data-blocked="${!!u.isBlocked}">
                                ${u.isBlocked ? 'Unblock' : 'Block'}
                            </button>
                        </div>
                    </div>
                    <div class="mt-3 p-3 rounded border border-color bg-gray-50/50 dark:bg-gray-800/40">
                        <div class="font-semibold text-text-primary mb-2">Order Summary</div>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div><span class="text-text-secondary">Total Orders:</span> ${totalOrders}</div>
                            <div><span class="text-text-secondary">Total Spent:</span> ${formatCurrency(totalSpent)}</div>
                            <div class="col-span-2"><span class="text-text-secondary">Last Order:</span> ${lastOrderAt}</div>
                        </div>
                        <div class="mt-2">${statusBadgesHtml}</div>
                        <div class="mt-2">
                            <div class="text-sm text-text-secondary">Distinct Products Ordered: ${distinctProducts}</div>
                            <div class="text-sm text-text-secondary">Top products:</div>
                            <ul class="list-disc list-inside text-sm">${topProductsList}</ul>
                        </div>
                        <div class="mt-2">
                            <div class="text-sm font-medium text-text-primary">Recent Orders</div>
                            <ul class="space-y-1">${recentOrdersList}</ul>
                        </div>
                    </div>
                    <div class="mt-3 p-3 rounded border border-color bg-gray-50/50 dark:bg-gray-800/40">
                        <div class="font-semibold text-text-primary mb-2">Wishlist</div>
                        <div class="text-sm text-text-secondary mb-1">Items: ${wishlistCount}</div>
                        <ul class="list-disc list-inside text-sm">${wishlistListHtml}</ul>
                    </div>
                `;

                // Wire modal block/unblock toggle
                const toggleBtn = document.getElementById('profile-block-toggle');
                if (toggleBtn) {
                    toggleBtn.addEventListener('click', async () => {
                        const id = toggleBtn.dataset.id;
                        const currentlyBlocked = toggleBtn.dataset.blocked === 'true';
                        const actionText = currentlyBlocked ? 'unblock' : 'block';
                        try {
                            await updateDoc(doc(db, 'users', id), { isBlocked: !currentlyBlocked });
                            showToast(`User ${actionText}ed successfully!`);
                            toggleBtn.dataset.blocked = String(!currentlyBlocked);
                            toggleBtn.textContent = !currentlyBlocked ? 'Unblock' : 'Block';
                            toggleBtn.classList.toggle('bg-green-600', !currentlyBlocked);
                            toggleBtn.classList.toggle('bg-red-600', currentlyBlocked);
                        } catch (err) {
                            console.error('Failed to toggle block:', err);
                            showToast(`Failed to ${actionText} user!`, 'error');
                        }
                    });
                }
            } catch (err) {
                console.error('Failed to open user profile', err);
                UI.userProfileModalContent.innerHTML = '<p class="text-red-500">Failed to load user profile.</p>';
            }
        };

        // Modal close wiring for user profile
        UI.userProfileModalCloseBtn.addEventListener('click', () => UI.userProfileModal.classList.add('hidden'));

        UI.orderDetailsCloseBtn.addEventListener('click', () => UI.orderDetailsModal.classList.add('hidden'));

        document.getElementById('modal-confirm-btn').addEventListener('click', () => {
            if (typeof confirmCallback === 'function') {
                confirmCallback();
            }
            hideConfirmationModal();
        });

        document.getElementById('modal-cancel-btn').addEventListener('click', hideConfirmationModal);
        
        const showDeliveryManDetails = async (deliveryManId) => {
            UI.deliveryManDetailsContent.innerHTML = '<p>Loading...</p>';
            UI.deliveryManDetailsModal.classList.remove('hidden');
            try {
                const manDoc = await getDoc(doc(db, "deliveryMen", deliveryManId));
                if (!manDoc.exists()) throw new Error("Delivery man not found");
                
                const data = manDoc.data();
                // Fetch all orders assigned to this man
                const assignedOrdersQuery = query(collection(db, "orders"), where("assignedDeliveryManId", "==", deliveryManId));
                const ordersSnapshot = await getDocs(assignedOrdersQuery);
                
                let totalDeliveredCount = 0, totalProductsDelivered = 0, totalCashCollectedCOD = 0, totalNormalDeliveredCount = 0, subTotalDelivered = 0, grandTotalCollected = 0;
                let currentlyAssignedOrdersHtml = '';
                let deliveryHistoryHtml = '';
                
                const deliveredOrders = [];

                ordersSnapshot.docs.forEach(orderDoc => {
                    const order = orderDoc.data();
                    
                    if (order.status === 'delivered') {
                        totalDeliveredCount++;
                        const orderSubTotal = order.items?.reduce((sum, item) => sum + (item.price * item.quantity), 0) || 0;
                        subTotalDelivered += orderSubTotal;
                        grandTotalCollected += order.totalAmount || 0;

                        if(order.items && Array.isArray(order.items)){
                            totalProductsDelivered += order.items.reduce((sum, item) => sum + item.quantity, 0);
                        }

                        if (order.paymentMethod === 'Cash on Delivery') {
                            totalCashCollectedCOD += order.totalAmount || 0;
                        } else {
                            totalNormalDeliveredCount++;
                        }
                        
                        // Add to delivered list for history
                        deliveredOrders.push({ id: orderDoc.id, data: order });
                        
                    } else if (order.status !== 'cancelled') {
                        // Current/Pending/Shipped orders
                        currentlyAssignedOrdersHtml += `<li class="flex justify-between items-center text-sm"><span>ID: #${(order.orderId || orderDoc.id.substring(0, 6))}</span> ${getStatusBadge(order.status)}</li>`;
                    }
                });

                // Sort delivered orders by creation date (most recent first)
                deliveredOrders.sort((a, b) => (b.data.createdAt?.toMillis() || 0) - (a.data.createdAt?.toMillis() || 0));
                
                if (deliveredOrders.length > 0) {
                     deliveredOrders.slice(0, 5).forEach(order => {
                        const date = order.data.createdAt?.toDate().toLocaleDateString() || 'N/A';
                        const orderIdDisplay = order.data.orderId || order.id.substring(0, 6);
                        deliveryHistoryHtml += `
                            <li class="flex justify-between items-center text-sm py-1 border-b border-color/50">
                                <span class="font-mono" title="Full ID: ${order.id}">Order ID: #${orderIdDisplay}</span>
                                <span class="font-semibold text-text-primary">৳${(order.data.totalAmount || 0).toFixed(2)} (${date})</span>
                            </li>
                        `;
                    });
                } else {
                    deliveryHistoryHtml = '<p class="text-text-secondary text-sm">No delivered orders found in history.</p>';
                }


                if (currentlyAssignedOrdersHtml === '') {
                    currentlyAssignedOrdersHtml = '<p class="text-text-secondary text-sm">No currently assigned orders.</p>';
                }


                UI.deliveryManDetailsContent.innerHTML = `
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm pb-4 border-b border-color">
                        <div><strong class="text-text-secondary">Name:</strong> ${data.name}</div>
                        <div><strong class="text-text-secondary">Email:</strong> ${data.email}</div>
                        <div><strong class="text-text-secondary">Phone:</strong> ${data.phone}</div>
                        <div><strong class="text-text-secondary">Vehicle:</strong> ${data.vehicle || 'N/A'}</div>
                        <div><strong class="text-text-secondary">Status:</strong> ${getStatusBadge(data.accountStatus || 'active')}</div>
                    </div>
                    <div class="mt-4">
                        <h4 class="font-semibold text-text-primary mb-2">Performance Summary</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                            <div><strong class="text-text-secondary">Total Orders Delivered:</strong> ${totalDeliveredCount}</div>
                            <div><strong class="text-text-secondary">Total Products Delivered:</strong> ${totalProductsDelivered}</div>
                            <div><strong class="text-text-secondary">Normal Deliveries:</strong> ${totalNormalDeliveredCount}</div>
                            <div><strong class="text-text-secondary">COD Deliveries:</strong> ${totalDeliveredCount - totalNormalDeliveredCount}</div>
                            <div><strong class="text-text-secondary">Sub-Total Delivered:</strong> ৳${subTotalDelivered.toFixed(2)}</div>
                            <div><strong class="text-text-secondary">Grand Total Collected:</strong> ৳${grandTotalCollected.toFixed(2)}</div>
                            <div class="sm:col-span-2"><strong class="text-text-secondary">Total Cash Collected (COD):</strong> ৳${totalCashCollectedCOD.toFixed(2)}</div>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-color">
                        <h4 class="font-semibold text-text-primary mb-2">Currently Assigned Orders (${ordersSnapshot.docs.length - totalDeliveredCount})</h4>
                        <ul class="space-y-2">${currentlyAssignedOrdersHtml}</ul>
                    </div>
                    <div class="mt-4 pt-4 border-t border-color">
                        <h4 class="font-semibold text-text-primary mb-2">Delivery History (Last 5)</h4>
                        <ul class="space-y-1">${deliveryHistoryHtml}</ul>
                    </div>
                `;
                 lucide.createIcons();
            } catch(error) {
                console.error("Error fetching delivery man details:", error);
                UI.deliveryManDetailsContent.innerHTML = `<p class="text-red-500">Could not load details.</p>`;
            }
        };

        UI.deliveryManModalCloseBtn.addEventListener('click', () => UI.deliveryManDetailsModal.classList.add('hidden'));

        UI.userProfileModalCloseBtn.addEventListener('click', () => UI.userProfileModal.classList.add('hidden'));

        // --- Live Chat Logic ---
        const renderChatList = (chats) => {
            const container = document.getElementById('chat-list-container');
            container.innerHTML = '';
            if (chats.length === 0) {
                container.innerHTML = '<p class="p-4 text-center text-text-secondary">No active conversations.</p>';
                return;
            }

            const unreadChatsExist = chats.some(chat => {
                const lastMs = chat.lastMessageTimestamp?.toMillis?.() || chat.lastMessageTimestamp?.toDate?.().getTime?.() || 0;
                const openedMs = chat.lastOpenedByAdminAt?.toMillis?.() || chat.lastOpenedByAdminAt?.toDate?.().getTime?.() || 0;
                return chat.lastSender === 'user' && lastMs > openedMs;
            });
            document.getElementById('chat-notification-bubble').classList.toggle('hidden', !unreadChatsExist);

            // Apply search and unread-only filters
            const searchEl = document.getElementById('chat-search-input');
            const unreadOnlyEl = document.getElementById('chat-unread-toggle');
            const q = (searchEl?.value || '').toLowerCase().trim();
            const unreadOnly = !!unreadOnlyEl?.checked;

            const filtered = chats.filter(chat => {
                const lastMs = chat.lastMessageTimestamp?.toMillis?.() || chat.lastMessageTimestamp?.toDate?.().getTime?.() || 0;
                const openedMs = chat.lastOpenedByAdminAt?.toMillis?.() || chat.lastOpenedByAdminAt?.toDate?.().getTime?.() || 0;
                const isUnread = chat.lastSender === 'user' && lastMs > openedMs;
                if (unreadOnly && !isUnread) return false;
                const userData = allUsersMap.get(chat.userId);
                const name = (userData?.name || chat.userName || 'unknown').toLowerCase();
                const text = (chat.lastMessage || '').toLowerCase();
                return !q || name.includes(q) || text.includes(q);
            });

            if (filtered.length === 0) {
                container.innerHTML = '<p class="p-4 text-center text-text-secondary">No conversations match your filters.</p>';
                return;
            }

            filtered.forEach(chat => {
                const isActive = chat.userId === currentChatUserId;
                const lastMs = chat.lastMessageTimestamp?.toMillis?.() || chat.lastMessageTimestamp?.toDate?.().getTime?.() || 0;
                const openedMs = chat.lastOpenedByAdminAt?.toMillis?.() || chat.lastOpenedByAdminAt?.toDate?.().getTime?.() || 0;
                const isUnread = chat.lastSender === 'user' && lastMs > openedMs;
                const userData = allUsersMap.get(chat.userId);
                const userName = userData?.name || chat.userName || 'Unknown User';
                const userAvatar = userData?.photoURL || 'https://placehold.co/40x40/e2e8f0/64748b?text=U';


                const isLastFromAdmin = chat.lastSender === 'admin';
                const readTick = isLastFromAdmin ? (chat.isReadByUser ? '<span class="ml-1 text-cyan-500">✔✔</span>' : '<span class="ml-1 text-gray-400">✔</span>') : '';
                const itemHtml = `
                    <div class="chat-list-item group cursor-pointer flex items-center p-4 border-b border-color ${isActive ? 'bg-theme-bg-light' : (isUnread ? 'unread-chat' : 'hover:bg-gray-100 dark:hover:bg-gray-700')}" data-user-id="${chat.userId}">
                        <div class="relative">
                            <img src="${userAvatar}" onerror="this.src='https://placehold.co/40x40/e2e8f0/64748b?text=U'" class="w-10 h-10 rounded-full object-cover">
                            ${isUnread ? '<span class="absolute top-0 right-0 block h-2.5 w-2.5 rounded-full bg-red-500 ring-2 ring-white dark:ring-gray-800"></span>' : ''}
                        </div>
                        <div class="ml-3 flex-1 overflow-hidden">
                            <p class="font-semibold text-text-primary truncate ${isUnread ? 'font-bold' : ''}">${userName}</p>
                            <p class="text-xs truncate ${isUnread ? 'font-semibold text-text-primary dark:text-gray-200' : 'text-text-secondary'}">${chat.lastMessage || 'No messages yet.'} ${readTick}</p>
                        </div>
                        <div class="flex flex-col items-end space-y-1 text-right">
                             <div class="text-xs text-text-secondary whitespace-nowrap">
                                 ${formatTimestamp(chat.lastMessageTimestamp)}
                             </div>
                             <button class="delete-chat-btn text-red-500 hover:text-red-700 p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity focus:opacity-100" data-id="${chat.userId}" title="Delete Conversation">
                                 <i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i>
                             </button>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', itemHtml);
            });
            // Refresh icons for newly inserted items
            if (window.lucide?.createIcons) lucide.createIcons();
        };

        const renderMessages = (messages) => {
            const container = document.getElementById('messages-container');
            container.innerHTML = '';
            let lastMessageDateString = null;

            // Ensure messages are sorted by timestamp on the client-side as a safeguard.
            // This prevents messages from appearing out of order due to latency.
            const getMs = (t) => {
                try {
                    if (!t) return 0;
                    if (typeof t.toMillis === 'function') return t.toMillis();
                    if (typeof t.toDate === 'function') return t.toDate().getTime();
                    if (t instanceof Date) return t.getTime();
                    if (typeof t === 'number') return t < 1e12 ? t * 1000 : t; // tolerate seconds
                    if (typeof t === 'string') { const d = new Date(t); if (!isNaN(d)) return d.getTime(); }
                } catch {}
                return 0;
            };

            const sortedMessages = messages
                .filter(msg => msg && msg.text)
                .sort((a, b) => getMs(a.timestamp) - getMs(b.timestamp));

            sortedMessages.forEach(msg => {
                // The filter above makes this check redundant, but it's kept for safety
                const ms = getMs(msg.timestamp);
                if (!ms) return;
                const messageDate = new Date(ms);
                const messageDateString = messageDate.toDateString();

                if (messageDateString !== lastMessageDateString) {
                    const dividerHtml = `
                        <div class="flex justify-center my-4">
                            <span class="px-3 py-1 text-xs font-semibold text-gray-500 bg-gray-200 dark:bg-gray-700 dark:text-gray-400 rounded-full">
                                ${formatDateDivider(messageDate)}
                            </span>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', dividerHtml);
                    lastMessageDateString = messageDateString;
                }
                
                const isFromAdmin = msg.sender === 'admin';
                const messageTime = messageDate.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: true });

                // Display the user's name above their messages, similar to the provided screenshot.
                const senderNameHtml = !isFromAdmin ? `<p class="text-xs text-text-secondary mb-1">${document.getElementById('chat-header-name').textContent || 'User'}</p>` : '';

                const isLast = sortedMessages[sortedMessages.length - 1] === msg;
                const ticks = isFromAdmin ? (msg.isReadByUser ? '✔✔' : '✔') : '';
                const messageHtml = `
                       <div class="flex flex-col ${isFromAdmin ? 'items-end' : 'items-start'}">
                           ${senderNameHtml}
                           <div class="max-w-xs md:max-w-md p-3 rounded-xl ${isFromAdmin ? 'bg-theme-primary text-white rounded-br-none' : 'bg-white dark:bg-gray-700 text-text-primary rounded-bl-none shadow-md'}">
                               <p class="text-sm whitespace-pre-wrap break-words">${msg.text}</p>
                               <p class="text-[10px] ${isFromAdmin ? 'text-white/70' : 'text-black/50 dark:text-white/50'} mt-1 text-right">${messageTime} ${isFromAdmin ? `<span>${ticks}</span>` : ''}</p>
                           </div>
                       </div>
                `;
                container.insertAdjacentHTML('beforeend', messageHtml);
            });
            // Scroll to the latest message
            container.scrollTop = container.scrollHeight;
        };
        
        const resetChatView = () => {
            if (unsubscribeMessages) {
                unsubscribeMessages();
                unsubscribeMessages = null;
            }
            currentChatUserId = null;

            document.getElementById('chat-window-placeholder').classList.remove('hidden');
            const chatWindowMain = document.getElementById('chat-window-main');
            chatWindowMain.classList.add('hidden');
            chatWindowMain.classList.remove('flex');

            // Remove active state from all chat list items
            const items = document.querySelectorAll('#chat-list-container .chat-list-item');
            items.forEach(item => {
                item.classList.remove('bg-theme-bg-light');
                item.classList.add('hover:bg-gray-100', 'dark:hover:bg-gray-700');
            });
            setupChatInputEnhancements();
        };

        const openChat = async (userId) => {
            if (currentChatUserId === userId) return; // Don't re-open the same chat
            
            // Clear previous message listener
            if (unsubscribeMessages) unsubscribeMessages();
            
            currentChatUserId = userId; // Set the new current user

            // --- Mark chat as read on open ---
            try {
                await updateDoc(doc(db, 'live_chats', userId), { isReadByAdmin: true, lastOpenedByAdminAt: serverTimestamp() });
            } catch (error) {
                // This is a non-critical error, so we just log it. The chat will still open.
                console.error("Could not mark chat as read on open:", error);
            }

            // Show the main chat window
            document.getElementById('chat-window-placeholder').classList.add('hidden');
            const chatWindowMain = document.getElementById('chat-window-main');
            chatWindowMain.classList.remove('hidden');
            chatWindowMain.classList.add('flex');
            setupChatInputEnhancements();
            
            // --- Populate Header & Add Click Listener ---
            const chatHeader = document.getElementById('chat-header');
            const headerAvatar = document.getElementById('chat-header-avatar');
            const headerName = document.getElementById('chat-header-name');
            const headerStatus = document.getElementById('chat-header-status');
            const headerBlockedBadge = document.getElementById('chat-header-blocked-badge');
            const headerBlockBtn = document.getElementById('chat-header-block-btn');
            const headerDeleteBtn = document.getElementById('chat-header-delete-btn');
            const blockedBanner = document.getElementById('chat-blocked-banner');
            const messageInput = document.getElementById('chat-message-input');

            const userDoc = await getDoc(doc(db, 'users', userId));
            if (userDoc.exists()) {
                const userData = userDoc.data();
                headerName.textContent = userData.name || 'Unknown User';
                headerAvatar.src = userData.photoURL || `https://placehold.co/40x40/e2e8f0/64748b?text=${(userData.name || 'U').charAt(0)}`;
                const isBlocked = !!userData.isBlocked;
                headerBlockedBadge.classList.toggle('hidden', !isBlocked);
                headerBlockBtn.dataset.id = userId;
                headerBlockBtn.dataset.blocked = String(isBlocked);
                headerBlockBtn.title = isBlocked ? 'Unblock user' : 'Block user';
                blockedBanner.classList.toggle('hidden', !isBlocked);
                messageInput.disabled = isBlocked;
                headerStatus.textContent = userData.lastSeen ? `Last seen ${formatJoinDate(userData.lastSeen, true)}` : 'Online status unavailable';
            } else {
                 headerName.textContent = 'User (Not Found)';
                 headerAvatar.src = 'https://placehold.co/40x40';
                 headerBlockedBadge.classList.add('hidden');
                 blockedBanner.classList.add('hidden');
                 messageInput.disabled = false;
                 headerStatus.textContent = 'User record missing';
            }
            
            // To safely replace event listeners, clone and replace the node.
            const newHeader = chatHeader.cloneNode(true); // true to clone children
            chatHeader.parentNode.replaceChild(newHeader, chatHeader);
            newHeader.querySelector('.view-profile-btn')?.addEventListener('click', (ev) => { ev.stopPropagation(); showUserProfileModal(userId); });
            newHeader.querySelector('#chat-header-delete-btn')?.addEventListener('click', (ev) => {
                ev.stopPropagation();
                showConfirmationModal(async () => {
                    try {
                        await deleteDoc(doc(db, 'live_chats', userId));
                        showToast('Chat deleted successfully!');
                        if (currentChatUserId === userId) resetChatView();
                    } catch (e) {
                        showToast('Failed to delete chat!', 'error');
                        console.error(e);
                    }
                }, 'Delete Chat?', 'Are you sure you want to permanently delete this entire conversation? This action cannot be undone.');
            });
            newHeader.querySelector('#chat-header-block-btn')?.addEventListener('click', async (ev) => {
                ev.stopPropagation();
                const btn = ev.currentTarget;
                const isBlocked = btn.getAttribute('data-blocked') === 'true';
                const actionText = isBlocked ? 'unblock' : 'block';
                showConfirmationModal(async () => {
                    try {
                        await updateDoc(doc(db, 'users', userId), { isBlocked: !isBlocked });
                        showToast(`User ${actionText}ed successfully!`);
                        // Reflect immediately in UI
                        headerBlockedBadge.classList.toggle('hidden', isBlocked);
                        btn.setAttribute('data-blocked', String(!isBlocked));
                        btn.title = !isBlocked ? 'Unblock user' : 'Block user';
                        blockedBanner.classList.toggle('hidden', isBlocked);
                        messageInput.disabled = !isBlocked;
                    } catch (e) {
                        showToast(`Failed to ${actionText} user!`, 'error');
                        console.error(e);
                    }
                }, `Confirm ${actionText}`, `Are you sure you want to ${actionText} this user?`);
            });
            
            // --- Listen for new messages ---
            // The chat is now marked as read on open.
            const messagesQuery = query(collection(db, `live_chats/${userId}/messages`), orderBy('timestamp'));
            unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
                const messages = snapshot.docs.map(doc => doc.data());
                renderMessages(messages);
                // After messages load, if the chat is open, mark read flag in UI elements
                try {
                    updateDoc(doc(db, 'live_chats', userId), { isReadByAdmin: true });
                } catch (e) {
                    console.warn('Failed to update read flag after opening chat', e);
                }
                // Hide side chat red dot if there are no unread chats left
                const remainingUnread = (lastChatsSnapshot || []).some(c => !c.isReadByAdmin && c.userId !== userId);
                if (!remainingUnread) {
                    const chatBubble = document.getElementById('chat-notification-bubble');
                    if (chatBubble) chatBubble.classList.add('hidden');
                }
                // Update header last activity time based on last message
                const last = messages[messages.length - 1];
                if (last?.timestamp?.toDate) {
                    headerStatus.textContent = `Last message ${formatJoinDate(last.timestamp, true)}`;
                }
            }, handleSnapshotError('Chat Messages'));
            
            // --- Update Active State in Chat List ---
            const items = document.querySelectorAll('#chat-list-container .chat-list-item');
            items.forEach(item => {
                const isActive = item.dataset.userId === currentChatUserId;
                item.classList.toggle('bg-theme-bg-light', isActive);
                if (!isActive) {
                    item.classList.add('hover:bg-gray-100', 'dark:hover:bg-gray-700');
                } else {
                    item.classList.remove('hover:bg-gray-100', 'dark:hover:bg-gray-700');
                }
            });
            setupChatInputEnhancements();
        };

        const showUserProfileModal = (userId) => {
            UI.userProfileModalContent.innerHTML = '<p>Loading...</p>';
            UI.userProfileModal.classList.remove('hidden');

            const userData = allUsersMap.get(userId);

            if (!userData) {
                UI.userProfileModalContent.innerHTML = '<p class="text-red-500">User details not found.</p>';
                return;
            }

            const profilePic = userData.photoURL || `https://placehold.co/80x80/e2e8f0/64748b?text=${(userData.name || 'U').charAt(0)}`;

            const isBlocked = userData.isBlocked || false;
            const blockButtonText = isBlocked ? 'Unblock User' : 'Block User';
            const blockButtonClasses = isBlocked 
                ? 'bg-green-500 hover:bg-green-600 focus:ring-green-400' 
                : 'bg-red-600 hover:bg-red-700 focus:ring-red-500';

            UI.userProfileModalContent.innerHTML = `
                <div class="flex flex-col items-center text-center">
                    <img src="${profilePic}" onerror="this.src='https://placehold.co/80x80/e2e8f0/64748b?text=U'" class="w-20 h-20 rounded-full object-cover mb-4 border-2 border-theme-primary">
                    <h4 class="text-lg font-bold text-text-primary">${userData.name || 'N/A'}</h4>
                    <p class="text-sm text-text-secondary">${userData.email || 'N/A'}</p>
                </div>
                <div class="mt-4 pt-4 border-t border-color space-y-2 text-sm">
                    <div><strong class="text-text-secondary w-24 inline-block">Mobile:</strong> <span class="text-text-primary">${userData.mobile || 'N/A'}</span></div>
                    <div><strong class="text-text-secondary w-24 inline-block">Location:</strong> <span class="text-text-primary">${userData.location || 'N/A'}</span></div>
                    <div><strong class="text-text-secondary w-24 inline-block">Joined:</strong> <span class="text-text-primary">${userData.createdAt?.toDate().toLocaleDateString() || 'N/A'}</span></div>
                </div>
                <div class="mt-4 pt-4 border-t border-color">
                    <button id="modal-block-user-btn" 
                            data-id="${userId}" 
                            data-blocked="${isBlocked}" 
                            class="w-full py-2 px-4 text-white font-semibold rounded-lg ${blockButtonClasses} focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800">
                        ${blockButtonText}
                    </button>
                </div>
            `;
        };

        // --- Notification Logic ---
        const handleNotificationClick = (alpineData) => {
            alpineData.notificationsOpen = !alpineData.notificationsOpen;
            if (alpineData.notificationsOpen && notifications.length > 0) {
                setTimeout(() => {
                    notifications = [];
                    updateNotificationUI();
                }, 2000);
            }
        };
        window.handleNotificationClick = handleNotificationClick;

        const addNotification = (text, page) => {
            notifications.unshift({ text, page });
            updateNotificationUI();
        };

        // Update bell icon badge and dropdown list
        const updateNotificationUI = () => {
            const count = notifications.length;
            const badge = UI.notificationCountBadge;
            const list = UI.notificationList;
            if (!badge || !list) return;
            if (count > 0) {
                badge.textContent = count > 9 ? '9+' : String(count);
                badge.classList.remove('hidden');
                list.innerHTML = notifications.map(n => `
                    <div class="p-2 border-b border-color hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer" data-page="${n.page}">
                        <p class="text-sm text-text-primary">${n.text}</p>
                    </div>
                `).join('');
            } else {
                badge.classList.add('hidden');
                list.innerHTML = '<p class="p-2 text-text-secondary text-sm">No new notifications</p>';
            }
        };

        const listenForNotifications = () => {
            const startTime = new Date();
            const unsub = onSnapshot(query(collection(db, "orders"), where("createdAt", ">", startTime)), (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === "added") {
                        const orderData = change.doc.data();
                        const orderId = change.doc.id;
                        // Show new order alert popup
                        showNewOrderAlert(orderData, orderId);
                        // Add notification to bell icon
                        addNotification(`New order from ${orderData.userName || 'Customer'} (৳${orderData.totalAmount || 0})`, 'orders');
                        // Note: Do not toggle the chat bubble for orders; it's reserved for chat unread
                    }
                });
            }, handleSnapshotError('Order Notifications'));
            unsubscribeListeners.push(unsub);
        };
        
        const showNewOrderAlert = async (orderData, orderId) => {
            await playSound('newOrder');
            const content = document.getElementById('new-order-alert-content');
            content.innerHTML = `<p><strong class="font-semibold text-text-secondary">Customer:</strong> ${orderData.userName || 'N/A'}</p><p><strong class="font-semibold text-text-secondary">Total:</strong> ৳${orderData.totalAmount || 0}</p>`;
            document.getElementById('view-full-order-btn').dataset.id = orderId;
            UI.newOrderAlert.classList.remove('hidden', 'translate-x-full');
            UI.newOrderAlert.classList.add('translate-x-0');
            lucide.createIcons();
        };

        const hideNewOrderAlert = () => {
            UI.newOrderAlert.classList.remove('translate-x-0');
            UI.newOrderAlert.classList.add('translate-x-full');
            setTimeout(() => UI.newOrderAlert.classList.add('hidden'), 300);
        };
        
        const showNewMessageAlert = async (chatData, userId) => {
            await playSound('newMessage');
            const content = document.getElementById('new-message-alert-content');
            content.innerHTML = `<p><strong class="font-semibold text-text-secondary">From:</strong> ${chatData.userName || 'N/A'}</p><p class="truncate"><strong class="font-semibold text-text-secondary">Message:</strong> ${chatData.lastMessage || ''}</p>`;
            document.getElementById('view-full-chat-btn').dataset.id = userId;
            UI.newMessageAlert.classList.remove('hidden', 'translate-x-full');
            UI.newMessageAlert.classList.add('translate-x-0');
            lucide.createIcons();
        };

        const hideNewMessageAlert = () => {
            UI.newMessageAlert.classList.remove('translate-x-0');
            UI.newMessageAlert.classList.add('translate-x-full');
            setTimeout(() => UI.newMessageAlert.classList.add('hidden'), 300);
        };
        
        const manualDataRefresh = async (event) => {
            const button = event.currentTarget;
            if (!button) return;

            const icon = button.querySelector('svg');
            
            if (icon) {
                icon.classList.add('animate-spin');
            }
            button.disabled = true;

            showToast("Refreshing data...");
            await loadDashboardStats();
            showToast("Data refreshed successfully!");
            
            // Using a timeout to ensure the user sees the spin animation
            setTimeout(() => {
                if (icon) {
                    icon.classList.remove('animate-spin');
                }
                button.disabled = false;
            }, 500);
        };

        // --- Data Listeners Setup ---
        const setupDataListeners = () => {
            cleanupListeners(); // Clear any existing listeners
            
            // Recent Data for Dashboard
            const unsubOrders = onSnapshot(collection(db, "orders"), snap => {
                // Client-side sorting: Newest first
                const sortedDocs = snap.docs.sort((a, b) => (b.data().createdAt?.toMillis() || 0) - (a.data().createdAt?.toMillis() || 0)).slice(0, 5);
                const slicedSnapshot = { empty: sortedDocs.length === 0, docs: sortedDocs, forEach: cb => sortedDocs.forEach(cb) };
                renderTable(slicedSnapshot, 'recent-orders-body', renderOrderRow_Recent);
            }, handleSnapshotError('Recent Orders'));

            // Filter the users collection to exclude deliveryMen based on UID if they somehow exist
            const unsubUsers = onSnapshot(collection(db, "users"), snap => {
                const sortedDocs = snap.docs.sort((a, b) => (b.data().createdAt?.toMillis() || 0) - (a.data().createdAt?.toMillis() || 0)).filter(doc => !allDeliveryMen.some(man => man.id === doc.id)).slice(0, 5);
                const slicedSnapshot = { empty: sortedDocs.length === 0, docs: sortedDocs, forEach: cb => sortedDocs.forEach(cb) };
                renderTable(slicedSnapshot, 'recent-users-body', renderUserRow_Recent);
            }, handleSnapshotError('Recent Users'));

            // Full Data for Pages (All sorted client-side)
            const unsubAllProducts = onSnapshot(collection(db, "products"), snap => {
                allProducts = snap.docs.sort((a, b) => (b.data().createdAt?.toMillis() || 0) - (a.data().createdAt?.toMillis() || 0));
                computeDuplicateSet(); // refresh duplicates globally whenever products change
                renderProductFilters();
                renderSubCategoryFilter();
                renderFilteredProducts();
                if (typeof renderLowStockProducts === 'function') renderLowStockProducts();
                // Sidebar badge: count of out-of-stock items (stock === 0)
                const outOfStock = allProducts.filter(d => Number(d.data().stock ?? 0) === 0).length;
                const oosBadge = document.getElementById('out-of-stock-badge');
                if (oosBadge) {
                    if (outOfStock > 0) {
                        oosBadge.textContent = String(outOfStock);
                        oosBadge.classList.remove('hidden');
                    } else {
                        oosBadge.classList.add('hidden');
                    }
                }
                // Dashboard card: Low Stock count (< threshold)
                const lowStockCount = allProducts.filter(d => {
                    const s = Number(d.data().stock ?? 0);
                    return !Number.isNaN(s) && s < (typeof LOW_STOCK_THRESHOLD !== 'undefined' ? LOW_STOCK_THRESHOLD : 5);
                }).length;
                const lowStockEl = document.getElementById('total-low-stock');
                if (lowStockEl) lowStockEl.textContent = String(lowStockCount);
            }, handleSnapshotError('All Products'));
            
            const unsubAllOrders = onSnapshot(collection(db, "orders"), snap => {
                // Client-side sorting: Newest first, store all orders, then render
                allOrders = snap.docs.sort((a, b) => (b.data().createdAt?.toMillis() || 0) - (a.data().createdAt?.toMillis() || 0));
                renderOrderFilters();
                renderFilteredOrders();
                // Sidebar badge: count of pending orders
                const pendingCount = allOrders.filter(doc => (doc.data().status || 'pending').toLowerCase() === 'pending').length;
                const pendingBadge = document.getElementById('pending-orders-badge');
                if (pendingBadge) {
                    if (pendingCount > 0) {
                        pendingBadge.textContent = String(pendingCount);
                        pendingBadge.classList.remove('hidden');
                    } else {
                        pendingBadge.classList.add('hidden');
                    }
                }
            }, handleSnapshotError('All Orders'));

            const unsubAllUsers = onSnapshot(collection(db, "users"), snap => {
                 // Filter the users collection to exclude deliveryMen and populate user map
                 allUsersMap.clear();
                 snap.docs.forEach(doc => allUsersMap.set(doc.id, doc.data()));
                 initialUsersLoadComplete = true;

                 // If chat data arrived first, render it now that we have user names.
                 if (lastChatsSnapshot) {
                     renderChatList(lastChatsSnapshot);
                 }

                 const sortedDocs = snap.docs.sort((a, b) => (b.data().createdAt?.toMillis() || 0) - (a.data().createdAt?.toMillis() || 0)).filter(doc => !allDeliveryMen.some(man => man.id === doc.id));
                renderTable({ ...snap, docs: sortedDocs, forEach: cb => sortedDocs.forEach(cb) }, 'all-users-body', renderUserRow_All);
            }, handleSnapshotError('All Users'));
            
            const unsubBanners = onSnapshot(collection(db, "banners"), snap => {
                renderBanners(snap);
            }, handleSnapshotError('Banners'));

            const unsubSidePromos = onSnapshot(collection(db, "sidePromos"), snap => {
                renderSidePromos(snap);
            }, handleSnapshotError('Side Promos'));

            const unsubCoupons = onSnapshot(collection(db, "coupons"), snap => {
                renderCoupons(snap);
            }, handleSnapshotError('Coupons'));
            
            const unsubDeliveryMen = onSnapshot(collection(db, "deliveryMen"), 
                snap => {
                    const sortedDocs = snap.docs.sort((a, b) => (b.data().createdAt?.toMillis() || 0) - (a.data().createdAt?.toMillis() || 0));
                    allDeliveryMen = sortedDocs; // keep this for the orders page dropdown
                    renderDeliverySection({ ...snap, docs: sortedDocs, forEach: cb => sortedDocs.forEach(cb) });
                }, 
                handleSnapshotError('Delivery Men')
            );
            
            const unsubChats = onSnapshot(query(collection(db, "live_chats")), (snapshot) => {
                let chats = snapshot.docs.map(doc => ({ userId: doc.id, ...doc.data() }));
                
                // FIX: Make unseen count consistent with UI highlighting (!isReadByAdmin).
                // This correctly counts chats where the flag is `false` OR missing entirely.
                const unseenSmsCount = chats.filter(chat => {
                    const lastMs = chat.lastMessageTimestamp?.toMillis?.() || chat.lastMessageTimestamp?.toDate?.().getTime?.() || 0;
                    const openedMs = chat.lastOpenedByAdminAt?.toMillis?.() || chat.lastOpenedByAdminAt?.toDate?.().getTime?.() || 0;
                    return chat.lastSender === 'user' && lastMs > openedMs;
                }).length;
                document.getElementById('total-unseen-sms').textContent = unseenSmsCount;
                const unseenBadge = document.getElementById('unseen-sms-badge');
                if (unseenBadge) {
                    if (unseenSmsCount > 0) {
                        unseenBadge.textContent = String(unseenSmsCount);
                        unseenBadge.classList.remove('hidden');
                    } else {
                        unseenBadge.classList.add('hidden');
                    }
                }

                // FIX: Client-side sorting to handle chats without lastMessageTimestamp
                chats.sort((a, b) => {
                    const timeA = a.lastMessageTimestamp?.toMillis() || a.createdAt?.toMillis() || 0;
                    const timeB = b.lastMessageTimestamp?.toMillis() || b.createdAt?.toMillis() || 0;
                    return timeB - timeA;
                });

                lastChatsSnapshot = chats; 
                
                // Only render if we have user data. Otherwise, the user listener will handle it.
                if(initialUsersLoadComplete) {
                    renderChatList(chats);
                }

                if (initialChatLoadComplete) {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === "modified" || change.type === "added") { // Listen for added chats too
                            const chatData = change.doc.data();
                            const lastMs = chatData.lastMessageTimestamp?.toMillis?.() || chatData.lastMessageTimestamp?.toDate?.().getTime?.() || 0;
                            const openedMs = chatData.lastOpenedByAdminAt?.toMillis?.() || chatData.lastOpenedByAdminAt?.toDate?.().getTime?.() || 0;
                            const hasUnread = chatData.lastSender === 'user' && lastMs > openedMs;
                            if (hasUnread && currentChatUserId !== change.doc.id) {
                                const userData = allUsersMap.get(change.doc.id);
                                const userName = userData?.name || chatData.userName || 'A user';
                                addNotification(`New message from: ${userName}`, 'chat');
                                showNewMessageAlert({ ...chatData, userName }, change.doc.id);
                                // Show side menu chat red dot
                                const chatBubble = document.getElementById('chat-notification-bubble');
                                if (chatBubble) chatBubble.classList.remove('hidden');
                            }
                        }
                    });
                } else {
                    initialChatLoadComplete = true;
                }
            }, handleSnapshotError('Live Chats'));

            listenForNotifications();
            
            unsubscribeListeners.push(unsubOrders, unsubUsers, unsubAllProducts, unsubAllOrders, unsubAllUsers, unsubBanners, unsubSidePromos, unsubCoupons, unsubDeliveryMen, unsubChats);
        };

        // Enhance message textarea UX: autosize and Enter-to-send
        const setupChatInputEnhancements = () => {
            const ta = document.getElementById('chat-message-input');
            if (!ta) return;
            if (ta.dataset.enhanced === 'true') return; // prevent duplicate listeners
            const autosize = () => {
                ta.style.height = 'auto';
                ta.style.height = Math.min(200, ta.scrollHeight) + 'px';
            };
            ta.addEventListener('input', autosize);
            autosize();
            ta.addEventListener('keydown', (ev) => {
                if (ev.key === 'Enter' && !ev.shiftKey) {
                    ev.preventDefault();
                    const form = document.getElementById('chat-message-form');
                    if (form) form.requestSubmit();
                }
            });
            ta.dataset.enhanced = 'true';
        };

        // --- Settings Page Logic ---
        const setupSettingsPage = () => {
            const timezoneSelector = document.getElementById('timezone-selector');
            if (!timezoneSelector) return;

            const savedTimeZone = localStorage.getItem('adminTimeZone') || 'Asia/Riyadh'; // Default to Riyadh

            const customTimezones = {
                'Asia/Dhaka': 'Dhaka, Bangladesh',
                'Asia/Riyadh': 'Riyadh, Saudi Arabia',
                'Asia/Singapore': 'Singapore',
                'Europe/Rome': 'Rome, Italy'
            };

            timezoneSelector.innerHTML = Object.entries(customTimezones).map(([tzValue, tzDisplay]) =>
                `<option value="${tzValue}" ${tzValue === savedTimeZone ? 'selected' : ''}>${tzDisplay}</option>`
            ).join('');
            
            // Set a default if the saved timezone is not in our custom list
            if (!customTimezones[savedTimeZone]) {
                localStorage.setItem('adminTimeZone', 'Asia/Riyadh');
                timezoneSelector.value = 'Asia/Riyadh';
            }

            timezoneSelector.addEventListener('change', (e) => {
                const newTimeZone = e.target.value;
                localStorage.setItem('adminTimeZone', newTimeZone);
                const displayName = customTimezones[newTimeZone] || newTimeZone;
                showToast(`Time zone set to ${displayName}`);
                updateClock(); // Update immediately on change
            });
        };
        // --- BULK UPLOAD EVENT LISTENERS ---
const bulkUploadBtn = document.getElementById('bulk-upload-btn');
const csvFileInput = document.getElementById('csv-file-input');

if (bulkUploadBtn && csvFileInput) {
    // 1. আপলোড বাটন ক্লিক করলে ফাইল সিলেক্ট করার অপশন চালু করা
    bulkUploadBtn.addEventListener('click', () => {
        csvFileInput.click();
    });

    // 2. ফাইল সিলেক্ট হলে প্রক্রিয়া শুরু করা
    csvFileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;

        // শুধু CSV ফাইল কিনা, চেক করা
        if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
            showToast("Please select a valid CSV file.", "error");
            event.target.value = null; // ফাইল রিসেট করা
            return;
        }

        const button = bulkUploadBtn;
        setButtonLoading(button, true, 'Processing...');

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const csvText = e.target.result;
                const productsArray = parseCSV(csvText);
                
                if (productsArray.length > 0) {
                    await saveBulkProducts(productsArray);
                } else {
                    showToast("No valid data found or CSV is empty.", "warning");
                }
            } catch (error) {
                console.error("CSV Processing Error:", error);
                showToast("An error occurred during bulk upload.", "error");
            } finally {
                setButtonLoading(button, false);
                event.target.value = null; // ফাইল ইনপুট রিসেট করা
            }
        };
        reader.readAsText(file);
    });
}

        // --- Main Initialization ---
    const initializeAdminPanel = (user) => {
            const pageId = window.location.hash.substring(1) || 'dashboard';
            showPage(pageId);
            // Keep quick-section-select in sync and wire navigation
            const quickSel = document.getElementById('quick-section-select');
            if (quickSel) {
                quickSel.value = pageId;
                quickSel.addEventListener('change', (e) => {
                    const val = e.target.value;
                    history.pushState({pageId: val}, '', `#${val}`);
                    showPage(val);
                });
            }
            const addForm = document.getElementById('add-product-form');
            const editForm = document.getElementById('edit-product-form');
            setupProductForm(addForm, 'add-');
            setupProductForm(editForm, 'edit-');
            document.getElementById('order-search-input').addEventListener('input', renderFilteredOrders);
            document.getElementById('manual-refresh-button').addEventListener('click', manualDataRefresh);
            // Listen for reviews only when reviews page is shown
            function handleReviewsPage() {
                renderReviewsList();
            }
            document.querySelectorAll('.nav-link[data-page="reviews"]').forEach(link => {
                link.addEventListener('click', handleReviewsPage);
            });
            
            loadAdminProfile(user);
            setupDataListeners();
            loadDashboardStats();
            startClock();
            setupSettingsPage();
            lucide.createIcons();

            window.onpopstate = (event) => {
                if (event.state && event.state.pageId) {
                    showPage(event.state.pageId);
                }
            };
        };

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            initializeAppearance();
            // Global search: try orders, users, products, deliveryMen by id or key
            const globalSearchInput = document.getElementById('global-search-input');
            if (globalSearchInput) {
                const doGlobalSearch = async (raw) => {
                    const term = (raw || '').trim();
                    if (!term) return;
                    try {
                        // Orders by doc id or orderId
                        const ordersCol = collection(db, 'orders');
                        const orderDoc = await getDoc(doc(db, 'orders', term));
                        if (orderDoc.exists()) {
                            // Navigate to Orders page
                            showPage('orders');
                            // Pre-fill order search box for easier focus
                            const orderInput = document.getElementById('order-search-input');
                            if (orderInput) {
                                orderInput.value = orderDoc.id;
                                renderFilteredOrders();
                            }
                            return;
                        }
                        // Try matching by orderId field using a query (faster than scanning)
                        try {
                            const byOrderIdSnap = await getDocs(query(ordersCol, where('orderId', '==', term)));
                            if (!byOrderIdSnap.empty) {
                                showPage('orders');
                                const orderInput = document.getElementById('order-search-input');
                                if (orderInput) {
                                    orderInput.value = byOrderIdSnap.docs[0].data().orderId;
                                    renderFilteredOrders();
                                }
                                return;
                            }
                        } catch (innerErr) {
                            // As a fallback (e.g., if query fails for some reason), do a minimal scan
                            console.warn('orderId query failed, falling back to scan:', innerErr);
                            const ordersSnap = await getDocs(ordersCol);
                            const byOrderId = ordersSnap.docs.find(d => (d.data().orderId || '').toString() === term);
                            if (byOrderId) {
                                showPage('orders');
                                const orderInput = document.getElementById('order-search-input');
                                if (orderInput) {
                                    orderInput.value = byOrderId.data().orderId;
                                    renderFilteredOrders();
                                }
                                return;
                            }
                        }

                        // Users by uid (doc id)
                        const userDoc = await getDoc(doc(db, 'users', term));
                        if (userDoc.exists()) {
                            // Open user profile modal with full info
                            await openUserProfile(term);
                            return;
                        }

                        // Products by document id or business Product ID (model/productId)
                        const productDoc = await getDoc(doc(db, 'products', term));
                        if (productDoc.exists()) {
                            // Open directly in edit view for convenience
                            await loadProductForEdit(productDoc.id);
                            return;
                        }
                        const productsCol = collection(db, 'products');
                        // Try exact match on model
                        try {
                            const byModelSnap = await getDocs(query(productsCol, where('model', '==', term)));
                            if (!byModelSnap.empty) {
                                await loadProductForEdit(byModelSnap.docs[0].id);
                                return;
                            }
                            // Try exact match on productId field if present
                            const byPidSnap = await getDocs(query(productsCol, where('productId', '==', term)));
                            if (!byPidSnap.empty) {
                                await loadProductForEdit(byPidSnap.docs[0].id);
                                return;
                            }
                        } catch (prodQueryErr) {
                            console.warn('Product id query failed, falling back to scan:', prodQueryErr);
                        }
                        // Fallback: scan and match case-insensitively or substring
                        const productsSnap = await getDocs(productsCol);
                        const lowerTerm = term.toLowerCase();
                        const foundProd = productsSnap.docs.find(d => {
                            const data = d.data();
                            const model = (data.model || '').toString();
                            const pid = (data.productId || '').toString();
                            return model.toLowerCase() === lowerTerm || pid.toLowerCase() === lowerTerm || model.toLowerCase().includes(lowerTerm) || pid.toLowerCase().includes(lowerTerm);
                        });
                        if (foundProd) {
                            await loadProductForEdit(foundProd.id);
                            return;
                        }

                        // Delivery man by id
                        const dmDoc = await getDoc(doc(db, 'deliveryMen', term));
                        if (dmDoc.exists()) {
                            showPage('delivery');
                            return;
                        }

                        showToast('No matching record found', 'warning');
                    } catch (e) {
                        console.error('Global search error', e);
                        showToast('Search failed. Check permissions or try again.', 'error');
                    }
                };

                // Fire on Enter (use keydown for better cross-browser reliability)
                globalSearchInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        doGlobalSearch(globalSearchInput.value);
                    }
                });
            }
            // Initialize AudioContext and Speech Synthesis on first user interaction to comply with browser policies
            const primeAudioAndSpeech = () => {
                initAudio();
                // Prime the speech synthesis engine by getting voices list
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.getVoices();
                }
                // Remove the listeners after the first interaction to avoid re-triggering
                document.body.removeEventListener('click', primeAudioAndSpeech);
                document.body.removeEventListener('keydown', primeAudioAndSpeech);
            };

            document.body.addEventListener('click', primeAudioAndSpeech);
            document.body.addEventListener('keydown', primeAudioAndSpeech);
        });

    </script>
</body>
</html>

<!DOCTYPE html><html lang="en" class="theme-indigo"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <!-- FAVICON FIX: Added a placeholder favicon link to prevent 404 error -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚡</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
    <style>
        
        :root {
            --c-table-header-bg: #f8fafc;
            --c-table-header-text: #1f2937;
            --c-table-header-border: rgba(148, 163, 184, 0.45);
            --c-table-row-bg: rgba(255, 255, 255, 0.92);
            --c-table-row-alt-bg: rgba(241, 245, 249, 0.95);
            --c-table-row-hover-bg: rgba(79, 70, 229, 0.12);
            --c-table-row-border: rgba(148, 163, 184, 0.35);
        }
        
        html.dark {
            /* Dark Mode Colors */
            --c-bg-primary: #111827; /* gray-900 */
            --c-bg-secondary: #1f2937; /* gray-800 */
            --c-text-primary: #f3f4f6; /* light gray */
            --c-text-secondary: #d1d5db; /* gray-300 */
            --c-border: #374151; /* gray-700 */
            --c-table-header-bg: rgba(79, 70, 229, 0.22);
            --c-table-header-text: #f9fafb;
            --c-table-header-border: rgba(129, 140, 248, 0.45);
            --c-table-row-bg: rgba(17, 24, 39, 0.82);
            --c-table-row-alt-bg: rgba(30, 41, 59, 0.78);
            --c-table-row-hover-bg: rgba(99, 102, 241, 0.32);
            --c-table-row-border: rgba(129, 140, 248, 0.35);
        }
        
        html {
            font-size: var(--admin-font-size, 100%);
        }
        
        body { 
            font-family: 'Inter', sans-serif;
            background-color: var(--c-bg-primary);
            color: var(--c-text-primary);
        }
        
        .text-resize-btn {
            padding: 0.35rem 0.75rem;
            border-radius: 9999px;
            border: 1px solid var(--c-border);
            background-color: transparent;
            color: var(--c-text-primary);
            font-weight: 600;
            font-size: 0.85rem;
            line-height: 1;
            transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
        }
        
        .text-resize-btn:hover:not(:disabled),
        .text-resize-btn:focus-visible:not(:disabled) {
            background-color: var(--c-primary);
            border-color: var(--c-primary);
            color: #ffffff;
            box-shadow: 0 0 0 2px color-mix(in srgb, var(--c-primary) 25%, transparent 75%);
        }
        
        .text-resize-btn:disabled {
            opacity: 0.45;
            cursor: not-allowed;
        }
        
        .text-resize-display {
            font-variant-numeric: tabular-nums;
            font-size: 0.75rem;
        }
        
        .admin-sticky-header {
            position: sticky;
            top: 0;
            z-index: 60;
            backdrop-filter: blur(16px);
            background-color: var(--c-bg-secondary);
            box-shadow: 0 1px 0 rgba(15, 23, 42, 0.08);
        }
        
        html.dark .admin-sticky-header {
            box-shadow: 0 1px 0 rgba(15, 23, 42, 0.4);
        }
        
        .admin-sticky-footer {
            position: sticky;
            bottom: 0;
            z-index: 60;
        }
        
        #header-live-visitors {
            transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
        }
        
        html.dark #header-live-visitors {
            background-color: rgba(30, 41, 59, 0.9);
            border-color: rgba(100, 116, 139, 0.7);
            color: #f8fafc;
        }
        
        html.dark #header-live-visitors span,
        html.dark #header-live-visitors svg,
        html.dark #header-live-visitors .lucide {
            color: inherit;
            stroke: currentColor;
        }
        
        .dashboard-clock-pill {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.85rem;
            border-radius: 9999px;
            border: 1px solid var(--c-border);
            background-color: rgba(15, 23, 42, 0.04);
            font-size: 0.8rem;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
            letter-spacing: 0.01em;
            transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
        }
        
        html.dark .dashboard-clock-pill {
            background-color: rgba(15, 23, 42, 0.35);
            border-color: rgba(148, 163, 184, 0.5);
            color: #e2e8f0;
        }
        
        .dashboard-clock-dot {
            width: 0.55rem;
            height: 0.55rem;
            border-radius: 9999px;
            background: #16a34a;
            box-shadow: 0 0 0 0 rgba(22, 163, 74, 0.45);
            animation: clock-dot-pulse 2s infinite;
        }
        
        html.dark .dashboard-clock-dot {
            background: #4ade80;
            box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.45);
        }
        
        .bg-primary { background-color: var(--c-bg-primary); }
        
        .bg-secondary { background-color: var(--c-bg-secondary); }
        
        .border-color { border-color: var(--c-border); }
        
        .sidebar { transition: transform 0.3s ease-in-out; }
        
        .main-content { transition: margin-left 0.3s ease-in-out; }
        
        .stat-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        
        .stat-card:hover { transform: translateY(-5px); }
        
        #new-order-alert { transition: transform 0.3s ease-in-out; }
        
        .theme-indigo {
            --c-primary: #4f46e5; --c-primary-hover: #4338ca; --c-ring: #4f46e5;
            --c-text-theme: #4f46e5; --c-bg-light: #e0e7ff;
        }
        
        .nav-link.active { background-color: var(--c-primary); color: white; }
        
        .bg-theme-primary { background-color: var(--c-primary); }
        
        .text-theme-primary { color: var(--c-text-theme); }
        
        .peer:checked ~ .peer-checked\:bg-theme-primary { background-color: var(--c-primary); }
        
        html.dark .pending-order {
            background-color: #2b2b23; /* Darker yellow/gray for dark mode */
        }
        
        html.dark .unread-chat {
            background-color: #3730a3; /* indigo-800 */
        }
        
        .btn-glow {
            --glow-color: var(--c-primary);
            --glow-ring-color: var(--c-ring);
            box-shadow: 0 0 3px rgba(255,255,255,0.3), 0 0 8px var(--glow-color), 0 0 12px var(--glow-ring-color);
            transition: all 0.2s ease-in-out;
            border: 1px solid color-mix(in srgb, var(--glow-color) 70%, white 30%);
        }
        
        .btn-glow:hover {
            box-shadow: 0 0 4px rgba(255,255,255,0.4), 0 0 12px var(--glow-color), 0 0 20px var(--glow-ring-color);
            transform: translateY(-1px);
        }
        
        .btn-glow-red {
            --glow-color: #dc2626; /* red-600 */
            --glow-ring-color: #f87171; /* red-400 */
            box-shadow: 0 0 3px rgba(255,255,255,0.3), 0 0 8px var(--glow-color), 0 0 12px var(--glow-ring-color);
            transition: all 0.2s ease-in-out;
            border: 1px solid var(--glow-ring-color);
        }
        
        .btn-glow-red:hover {
            box-shadow: 0 0 4px rgba(255,255,255,0.4), 0 0 12px var(--glow-color), 0 0 20px var(--glow-ring-color);
            transform: translateY(-1px);
        }
        
        .btn-glow-green {
            --glow-color: #16a34a; /* green-600 */
            --glow-ring-color: #4ade80; /* green-400 */
            box-shadow: 0 0 3px rgba(255,255,255,0.3), 0 0 8px var(--glow-color), 0 0 12px var(--glow-ring-color);
            transition: all 0.2s ease-in-out;
            border: 1px solid var(--glow-ring-color);
        }
        
        .btn-glow-green:hover {
            box-shadow: 0 0 4px rgba(255,255,255,0.4), 0 0 12px var(--glow-color), 0 0 20px var(--glow-ring-color);
            transform: translateY(-1px);
        }
        
        .welcome-animate { animation: welcome-pop 0.9s ease-out forwards; }
        
        .welcome-glow { text-shadow: 0 0 30px rgba(79, 70, 229, 0.6), 0 0 60px rgba(79, 70, 229, 0.35); }
        
        html.dark {
            --c-input-bg: rgba(17, 24, 39, 0.85);
            --c-input-border-strong: rgba(129, 140, 248, 0.6);
            --c-input-text: #f9fafb;
        }
        
        .bg-secondary table {
            background-color: var(--c-bg-primary);
            border: 1px solid var(--c-table-header-border);
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px -18px rgba(15, 23, 42, 0.35);
            overflow: hidden;
        }
        
        html.dark .bg-secondary table {
            background-color: rgba(17, 24, 39, 0.9);
            border-color: var(--c-table-header-border);
            box-shadow: 0 16px 30px -20px rgba(15, 23, 42, 0.8);
        }
        
        .bg-secondary table thead tr {
            background-color: var(--c-table-header-bg) !important;
        }
        
        .bg-secondary table thead th {
            color: var(--c-table-header-text) !important;
            border-bottom: 1px solid var(--c-table-header-border) !important;
            letter-spacing: 0.08em;
        }
        
        .bg-secondary table tbody tr:nth-child(even) {
            background-color: color-mix(in srgb, var(--c-table-header-bg) 35%, transparent 65%);
        }
        
        html.dark .bg-secondary table tbody tr:nth-child(even) {
            background-color: rgba(99, 102, 241, 0.18);
        }
        
        .bg-secondary table tbody tr:hover {
            background-color: color-mix(in srgb, var(--c-table-header-bg) 50%, var(--c-bg-primary) 50%);
        }
        
        html.dark .bg-secondary table tbody tr:hover {
            background-color: rgba(99, 102, 241, 0.25);
        }
        
        .bg-secondary table tbody td {
            border-bottom: 1px solid color-mix(in srgb, var(--c-table-header-border) 40%, transparent 60%);
        }
        
        html.dark .bg-secondary table tbody td {
            border-bottom-color: rgba(129, 140, 248, 0.35);
        }
        
        .bg-secondary input:not([type="checkbox"]):not([type="radio"]),
        .bg-secondary select,
        .bg-secondary textarea {
            background-color: var(--c-input-bg) !important;
            border: 1px solid var(--c-input-border-strong) !important;
            border-radius: 0.75rem;
            box-shadow: 0 6px 18px -12px rgba(15, 23, 42, 0.35);
            color: var(--c-input-text) !important;
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
        }
        
        html.dark .bg-secondary input:not([type="checkbox"]):not([type="radio"]),
        html.dark .bg-secondary select,
        html.dark .bg-secondary textarea {
            box-shadow: 0 12px 24px -18px rgba(0, 0, 0, 0.9);
        }
        
        .bg-secondary input:not([type="checkbox"]):not([type="radio"]):focus,
        .bg-secondary select:focus,
        .bg-secondary textarea:focus {
            background-color: color-mix(in srgb, var(--c-input-bg) 90%, white 10%);
            border-color: var(--c-primary) !important;
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--c-primary) 25%, transparent 75%), 0 8px 20px -12px rgba(79, 70, 229, 0.45);
        }
        
        html.dark .bg-secondary input:not([type="checkbox"]):not([type="radio"]):focus,
        html.dark .bg-secondary select:focus,
        html.dark .bg-secondary textarea:focus {
            background-color: rgba(17, 24, 39, 0.95);
            box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.45), 0 18px 30px -20px rgba(99, 102, 241, 0.75);
        }</style>
</head>
<body class="bg-primary">

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="flex items-center justify-center min-h-screen">
        <div class="w-16 h-16 border-4 border-t-4 border-gray-200 border-t-indigo-600 rounded-full animate-spin"></div>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="flex items-center justify-center min-h-screen hidden bg-cover bg-center" style="background-image: url('https://github.com/tangailbuzzbd-svg/TangailBuzz-Picture-/blob/main/vecteezy_ai-generated-empty-wooden-table-on-the-natural-background_40890255.jpg?raw=true');">
        <div class="w-full max-w-sm relative">
            <img id="login-profile-pic" src="https://github.com/tangailbuzzbd-svg/TangailBuzz-Picture-/blob/main/WhatsApp%20Image%202025-07-30%20at%2019.29.33_9f8c7d06.jpg?raw=true" alt="Profile" class="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-24 h-24 rounded-full border-4 border-white/40 dark:border-gray-500 shadow-lg z-10">
            <div class="p-8 pt-16 space-y-6 bg-white/5 dark:bg-gray-900/20 backdrop-blur-xl border border-white/10 rounded-2xl shadow-2xl">
                <h2 class="text-2xl font-bold text-center text-white">Tangail Buzz Admin</h2>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="email" class="text-sm font-medium text-white block mb-1">Enter Your Email</label>
                        <input type="email" id="email" name="email" required="" class="w-full px-4 py-2 bg-white/25 dark:bg-gray-700/30 border-0 border-b-2 border-white/30 text-white placeholder-gray-300 focus:ring-0 focus:border-white transition">
                    </div>
                    <div>
                        <label for="password" class="text-sm font-medium text-white block mb-1">Enter Your Password</label>
                        <input type="password" id="password" name="password" required="" class="w-full px-4 py-2 bg-white/25 dark:bg-gray-700/30 border-0 border-b-2 border-white/30 text-white placeholder-gray-300 focus:ring-0 focus:border-white transition">
                    </div>
                    
                    <p id="login-error" class="text-sm text-red-300"></p>
                    <button type="submit" class="w-full py-3 font-semibold text-white bg-green-500 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-400 disabled:bg-green-400 btn-glow-green">LOGIN</button>
                </form>
            </div>
        </div>
    </div>

    <!-- PIN Verification Screen -->
    <div id="pin-verification-screen" class="flex items-center justify-center min-h-screen hidden bg-cover bg-center" style="background-image: url('https://github.com/tangailbuzzbd-svg/TangailBuzz-Picture-/blob/main/vecteezy_ai-generated-empty-wooden-table-on-the-natural-background_40890255.jpg?raw=true');">
    <div class="w-full max-w-sm p-8 space-y-6 bg-white/5 dark:bg-gray-900/20 backdrop-blur-xl border border-white/10 rounded-2xl shadow-2xl">
            <h2 class="text-2xl font-bold text-center text-white">Enter Security PIN</h2>
            <form id="pin-verification-form" class="space-y-4">
                <div>
                    <label for="pin-input" class="text-sm font-medium text-white block mb-1">Your 4-Digit PIN</label>
                    <input type="password" id="pin-input" name="pin" required="" maxlength="4" pattern="\d{4}" class="w-full px-4 py-2 bg-white/25 dark:bg-gray-700/30 border-0 border-b-2 border-white/30 text-white text-center text-2xl tracking-[1em] focus:ring-0 focus:border-white transition">
                </div>
                <p id="pin-error" class="text-sm text-red-300"></p>
                <button type="submit" class="w-full py-3 font-semibold text-white bg-green-500 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-400 disabled:bg-green-400 btn-glow-green">VERIFY</button>
            </form>
        </div>
    </div>

    <!-- Welcome Overlay (shown only after successful login) -->
    <div id="welcome-overlay" class="fixed inset-0 z-[1000] hidden bg-black/70 backdrop-blur-xl flex items-center justify-center transition-opacity duration-700 opacity-0">
        <div class="text-center px-6">
            <img src="https://github.com/tangailbuzzbd-svg/TangailBuzz-Picture-/blob/main/gdrg_upscaled%20(1).png?raw=true" alt="Logo" class="mx-auto mb-8 w-40 h-40 sm:w-48 sm:h-48 object-contain drop-shadow-lg welcome-animate" style="animation-delay: 50ms;">
            <h1 class="text-white text-5xl sm:text-6xl md:text-7xl lg:text-8xl font-extrabold tracking-tight welcome-animate welcome-glow" style="animation-delay: 150ms;">Welcome to New World</h1>
            <p class="mt-4 text-white/80 text-xl sm:text-2xl welcome-animate" style="animation-delay: 250ms;">Tangail Buzz Admin</p>
            <p class="mt-8 text-sm sm:text-base text-white/70">Click anywhere or press Enter to continue</p>
        </div>
    </div>

 
     <!-- Admin Panel -->
     <div id="admin-panel" class="hidden">
         <div class="flex min-h-screen" x-data="{ sidebarOpen: window.innerWidth >= 1024, isDesktop: window.innerWidth >= 1024 }" x-init="$watch('sidebarOpen', value => { document.body.classList.toggle('overflow-hidden', value &amp;&amp; !isDesktop); })" @resize.window="isDesktop = window.innerWidth >= 1024; if (isDesktop) { sidebarOpen = true; } else { sidebarOpen = false; }" @keydown.window.escape="if (!isDesktop) sidebarOpen = false">
            <!-- Sidebar -->
            <aside class="sidebar fixed inset-y-0 left-0 z-30 w-64 bg-secondary transform transition-transform duration-300 ease-in-out overflow-y-auto lg:translate-x-0" :class="{'translate-x-0': sidebarOpen, '-translate-x-full': !sidebarOpen}">
                <div class="flex items-center justify-between h-20 px-6 border-b border-color">
                    <h1 class="text-2xl font-bold text-theme-primary">Admin</h1>
                </div>
                <nav class="mt-6" @click="if (!isDesktop &amp;&amp; $event.target.closest('a')) sidebarOpen = false">
                    <a href="#dashboard" class="nav-link flex items-center px-6 py-3 text-text-primary hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-theme-primary active" data-page="dashboard"><i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i><span>Dashboard</span></a>
                    <a href="#products" class="nav-link flex items-center px-6 py-3 text-text-primary hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-theme-primary" data-page="products"><i data-lucide="package" class="w-5 h-5 mr-3"></i><span>Products</span></a>
                    <a href="#low-stock" class="nav-link flex items-center px-6 py-3 text-text-primary hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-theme-primary" data-page="low-stock"><i data-lucide="alert-triangle" class="w-5 h-5 mr-3"></i><span>Low Stock</span></a>
                    <a href="#top-sales" class="nav-link flex items-center px-6 py-3 text-text-primary hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-theme-primary" data-page="top-sales"><i data-lucide="trending-up" class="w-5 h-5 mr-3"></i><span>Top Sales</span></a>
                    <a href="#top-rated" class="nav-link flex items-center px-6 py-3 text-text-primary hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-theme-primary" data-page="top-rated"><i data-lucide="star" class="w-5 h-5 mr-3"></i><span>Top Rated</span></a>
                    <a href="#reports" class="nav-link flex items-center px-6 py-3 text-text-primary hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-theme-primary" data-page="reports"><i data-lucide="bar-chart-3" class="w-5 h-5 mr-3"></i><span>Reports</span></a>
                    <a href="#flash-sale" class="nav-link flex items-center px-6 py-3 text-text-primary hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-theme-primary" data-page="flash-sale"><i data-lucide="zap" class="w-5 h-5 mr-3"></i><span>Flash Sale</span></a>
                    <a href="#mega-sale" class="nav-link flex items-center px-6 py-3 text-text-primary hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-theme-primary" data-page="mega-sale"><i data-lucide="flame" class="w-5 h-5 mr-3"></i><span>Mega Sale</span></a>
                    <a href="#add-product" class="nav-link flex items-center px-6 py-3 text-text-primary hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-theme-primary" data-page="add-product"><i data-lucide="plus-circle" class="w-5 h-5 mr-3"></i><span>Add Product</span></a>
                    <a href="#reviews" class="nav-link flex items-center px-6 py-3 text-text-primary hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-theme-primary" data-page="reviews"><i data-lucide="star" class="w-5 h-5 mr-3"></i><span>Reviews &amp; Ratings</span></a>
                    <a href="#banners" class="nav-link flex items-center px-6 py-3 text-text-primary hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-theme-primary" data-page="banners"><i data-lucide="image" class="w-5 h-5 mr-3"></i><span>Banners</span></a>
                    <a href="#side-promo" class="nav-link flex items-center px-6 py-3 text-text-primary hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-theme-primary" data-page="side-promo">
                        <i data-lucide="image-plus" class="w-5 h-5 mr-3"></i>
                        <span>Side Promo</span>
                    </a>
                    <a href="#coupons" class="nav-link flex items-center px-6 py-3 text-text-primary hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-theme-primary" data-page="coupons"><i data-lucide="ticket-percent" class="w-5 h-5 mr-3"></i><span>Coupons</span></a>
                    <a href="#orders" class="nav-link flex items-center px-6 py-3 text-text-primary hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-theme-primary" data-page="orders"><i data-lucide="shopping-cart" class="w-5 h-5 mr-3"></i><span>Orders</span><span id="pending-orders-badge" class="ml-auto text-xs font-bold text-white bg-red-500 rounded-full px-2 py-0.5 hidden">0</span></a>
                    <a href="#users" class="nav-link flex items-center px-6 py-3 text-text-primary hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-theme-primary" data-page="users"><i data-lucide="users" class="w-5 h-5 mr-3"></i><span>Users</span></a>
                    <a href="#delivery" class="nav-link flex items-center px-6 py-3 text-text-primary hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-theme-primary" data-page="delivery"><i data-lucide="truck" class="w-5 h-5 mr-3"></i><span>Delivery</span></a>
                    <a href="#chat" class="nav-link flex items-center px-6 py-3 text-text-primary hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-theme-primary relative" data-page="chat">
                        <i data-lucide="message-square" class="w-5 h-5 mr-3"></i>
                        <span>Live Chat</span>
                        <span id="unseen-sms-badge" class="ml-auto text-xs font-bold text-white bg-red-500 rounded-full px-2 py-0.5 hidden">0</span>
                        <span id="chat-notification-bubble" class="absolute left-4 top-2 w-2 h-2 bg-red-500 rounded-full hidden animate-pulse"></span>
                    </a>
                    <a href="#settings" class="nav-link flex items-center px-6 py-3 text-text-primary hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-theme-primary" data-page="settings"><i data-lucide="settings" class="w-5 h-5 mr-3"></i><span>Settings</span></a>
                </nav>
            </aside>

            <div x-show="sidebarOpen &amp;&amp; !isDesktop" x-transition.opacity="" class="fixed inset-0 z-20 bg-black/50 lg:hidden" @click="sidebarOpen = false" x-cloak=""></div>

            <!-- Main Content -->
            <div class="main-content flex-1 flex h-screen min-h-0 flex-col overflow-hidden transition-all duration-300 ease-in-out ml-0" :class="{'lg:ml-64': sidebarOpen &amp;&amp; isDesktop}">
                <header class="admin-sticky-header bg-secondary flex flex-wrap items-center justify-between gap-3 px-4 py-4 border-b border-color sm:flex-nowrap sm:px-6">
                    <button @click="sidebarOpen = !sidebarOpen" class="text-text-secondary focus:outline-none lg:hidden"><i data-lucide="menu" class="w-6 h-6"></i></button>
                    <div class="text-lg font-semibold text-text-primary flex-1 sm:text-2xl" id="page-title">Dashboard</div>
                    <div class="flex items-center gap-3 ml-auto w-full flex-wrap sm:w-auto sm:justify-end">
                        <!-- Global Search -->
                        <div class="hidden md:flex items-center relative w-full md:w-72">
                            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-text-secondary"></i>
                            <input id="global-search-input" type="text" placeholder="Search by Order/User/Product/Delivery ID..." class="w-full pl-10 pr-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary">
                        </div>
                        <!-- Quick section select -->
                        <div class="w-full sm:w-auto">
                            <select id="quick-section-select" class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-theme-primary sm:w-auto">
                                <option value="dashboard">Dashboard</option>
                                <option value="products">Products</option>
                                <option value="flash-sale">Flash Sale</option>
                                <option value="mega-sale">Mega Sale</option>
                                <option value="low-stock">Low Stock</option>
                                <option value="reports">Reports</option>
                                <option value="reviews">Reviews</option>
                                <option value="orders">All Orders</option>
                                <option value="users">All Users</option>
                                <option value="add-product">Add Product</option>
                            </select>
                        </div>
                        <!-- Live Visitors Header Badge -->
                        <button id="header-live-visitors" type="button" class="hidden sm:flex items-center gap-2 rounded-full border border-color bg-white/90 px-3 py-1.5 text-sm font-medium text-text-secondary transition-colors hover:border-theme-primary hover:text-theme-primary dark:hover:text-theme-primary focus:outline-none focus:ring-2 focus:ring-theme-primary">
                            <i data-lucide="activity" class="w-4 h-4"></i>
                            <span class="uppercase tracking-wide text-xs text-text-secondary dark:text-slate-200">Live Visitors</span>
                            <span id="header-live-visitors-count" class="text-base font-semibold text-text-primary dark:text-white">0</span>
                        </button>
                        <!-- Manual Refresh Button -->
                        <div class="flex items-center space-x-2">
                            <button id="manual-refresh-button" class="text-text-secondary focus:outline-none" title="Refresh Data">
                                <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                            </button>
                            <span id="dashboard-last-updated" class="dashboard-clock-pill hidden sm:inline-flex text-text-secondary">
                                <span class="dashboard-clock-dot" aria-hidden="true"></span>
                                <span class="uppercase tracking-wide text-[0.7rem]">Live</span>
                                <span id="dashboard-last-updated-time" class="text-xs"></span>
                            </span>
                        </div>
                        <!-- Notification Bell -->
                        <div x-data="{ notificationsOpen: false }" class="relative">
                            <button @click="handleNotificationClick($data)" class="relative text-text-secondary focus:outline-none">
                                <i data-lucide="bell" class="w-6 h-6"></i>
                                <span id="notification-count" class="absolute -top-1 -right-1 flex items-center justify-center w-4 h-4 text-xs font-bold text-white bg-red-500 rounded-full hidden"></span>
                            </button>
                            <div x-show="notificationsOpen" @click.away="notificationsOpen = false" x-cloak="" class="absolute right-0 mt-2 w-80 bg-secondary rounded-lg shadow-xl overflow-hidden z-10">
                                <div class="py-2 px-4 text-sm font-semibold text-text-primary border-b border-color">Notifications</div>
                                <div id="notification-list" class="max-h-64 overflow-y-auto">
                                    <p class="p-4 text-sm text-text-secondary">No new notifications.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Profile Dropdown -->
                        <div x-data="{ profileOpen: false }" class="relative ml-4">
                            <button @click="profileOpen = !profileOpen" class="flex items-center space-x-2 focus:outline-none">
                                <span id="header-admin-name" class="hidden sm:inline text-sm font-medium text-text-primary">Admin</span>
                                <img id="header-admin-image" class="w-8 h-8 rounded-full object-cover" src="https://placehold.co/32x32/e2e8f0/64748b?text=A" alt="Admin Profile">
                            </button>
                            <div x-show="profileOpen" @click.away="profileOpen = false" x-cloak="" class="absolute right-0 mt-2 w-48 bg-secondary rounded-lg shadow-xl overflow-hidden z-10">
                                <div class="px-4 py-2 border-b border-color">
                                    <p id="dropdown-admin-name" class="text-sm font-semibold text-text-primary">Admin</p>
                                    <p id="dropdown-admin-email" class="text-xs text-text-secondary truncate">email@example.com</p>
                                </div>
                                <a href="#settings" @click="profileOpen = false" class="nav-link block px-4 py-2 text-sm text-text-primary hover:bg-gray-100 dark:hover:bg-gray-600" data-page="settings">Settings</a>
                                <button id="logout-button" class="w-full text-left block px-4 py-2 text-sm text-red-600 hover:bg-gray-100 dark:text-red-400 dark:hover:bg-gray-600">Logout</button>
                            </div>
                        </div>
                    </div>
                </header>

                <main class="flex-1 min-h-0 overflow-y-auto overflow-x-hidden px-4 pt-6 pb-24 bg-primary sm:px-6">
                    <!-- Dashboard Page -->
                    <div id="dashboard-page" class="page-content">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                            <!-- RE-ORGANIZED: Stat Cards for better logical flow -->
                            
                            <!-- Group 1: Key Financial & Inventory Metrics -->
                            <div class="stat-card bg-gradient-to-br from-purple-600 to-blue-500 text-white p-4 rounded-lg shadow-lg flex items-center space-x-4 cursor-pointer" data-page="orders" data-filter="delivered" title="Shudhu 'Delivered' order theke total sale hishab kora hoyeche">
                                <div class="bg-white/20 rounded-full p-3 flex-shrink-0"><i data-lucide="dollar-sign" class="w-8 h-8"></i></div>
                                <div><p class="text-sm font-medium text-blue-100">Total Sales</p><p class="text-3xl font-bold" id="total-sale">৳0</p></div>
                            </div>
                            <div class="stat-card bg-gradient-to-br from-rose-500 to-amber-400 text-white p-4 rounded-lg shadow-lg flex items-center space-x-4 cursor-pointer" data-page="orders" data-filter="delivered" title="Delivered অর্ডার থেকে মোট লাভের হিসাব">
                                <div class="bg-white/20 rounded-full p-3 flex-shrink-0"><i data-lucide="trending-up" class="w-8 h-8"></i></div>
                                <div><p class="text-sm font-medium text-amber-100">Total Profit</p><p class="text-3xl font-bold" id="total-profit">৳0</p></div>
                            </div>
                            <div class="stat-card bg-gradient-to-br from-green-500 to-teal-400 text-white p-4 rounded-lg shadow-lg flex items-center space-x-4 cursor-pointer" data-page="orders" data-filter="all">
                                <div class="bg-white/20 rounded-full p-3 flex-shrink-0"><i data-lucide="shopping-bag" class="w-8 h-8"></i></div>
                                <div><p class="text-sm font-medium text-teal-100">Total Orders</p><p class="text-3xl font-bold" id="total-orders">0</p></div>
                            </div>
                            <div class="stat-card bg-gradient-to-br from-teal-400 to-cyan-600 text-white p-4 rounded-lg shadow-lg flex items-center space-x-4 cursor-pointer" title="Total value of all products currently in stock">
                               <div class="bg-white/20 rounded-full p-3 flex-shrink-0"><i data-lucide="database" class="w-8 h-8"></i></div>
                               <div><p class="text-sm font-medium text-cyan-100">Total Stock Cost</p><p class="text-3xl font-bold" id="total-stock-value">৳0</p></div>
                           </div>
                            <div class="stat-card bg-gradient-to-br from-lime-500 to-emerald-500 text-white p-4 rounded-lg shadow-lg flex items-center space-x-4 cursor-pointer" data-page="products" title="Total units of all products currently in stock">
                                <div class="bg-white/20 rounded-full p-3 flex-shrink-0"><i data-lucide="layers" class="w-8 h-8"></i></div>
                                <div><p class="text-sm font-medium text-emerald-100">Total Stock</p><p class="text-3xl font-bold" id="total-stock-count">0</p></div>
                            </div>
                           
                            <!-- Group 2: Order Status Breakdown -->
                            <div class="stat-card bg-gradient-to-br from-yellow-400 to-orange-400 text-white p-4 rounded-lg shadow-lg flex items-center space-x-4 cursor-pointer" data-page="orders" data-filter="pending">
                                <div class="bg-white/20 rounded-full p-3 flex-shrink-0"><i data-lucide="clock" class="w-8 h-8"></i></div>
                                <div><p class="text-sm font-medium text-orange-100">Pending Orders</p><p class="text-3xl font-bold" id="total-pending">0</p></div>
                            </div>
                            <div class="stat-card bg-gradient-to-br from-emerald-500 to-green-600 text-white p-4 rounded-lg shadow-lg flex items-center space-x-4 cursor-pointer" data-page="orders" data-filter="confirmed">
                                <div class="bg-white/20 rounded-full p-3 flex-shrink-0"><i data-lucide="check-circle" class="w-8 h-8"></i></div>
                                <div><p class="text-sm font-medium text-green-100">Confirmed Orders</p><p class="text-3xl font-bold" id="total-confirmed">0</p></div>
                            </div>
                            <div class="stat-card bg-gradient-to-br from-sky-500 to-indigo-500 text-white p-4 rounded-lg shadow-lg flex items-center space-x-4 cursor-pointer" data-page="orders" data-filter="shipped">
                                <div class="bg-white/20 rounded-full p-3 flex-shrink-0"><i data-lucide="ship" class="w-8 h-8"></i></div>
                                <div><p class="text-sm font-medium text-indigo-100">Shipped Orders</p><p class="text-3xl font-bold" id="total-shipped">0</p></div>
                            </div>
                            <div class="stat-card bg-gradient-to-br from-orange-400 to-red-500 text-white p-4 rounded-lg shadow-lg flex items-center space-x-4 cursor-pointer" data-page="orders" data-filter="out-for-delivery">
                                <div class="bg-white/20 rounded-full p-3 flex-shrink-0"><i data-lucide="truck" class="w-8 h-8"></i></div>
                                <div><p class="text-sm font-medium text-red-100">Out for Delivery</p><p class="text-3xl font-bold" id="total-out-for-delivery">0</p></div>
                            </div>
                            <div class="stat-card bg-gradient-to-br from-violet-500 to-fuchsia-500 text-white p-4 rounded-lg shadow-lg flex items-center space-x-4 cursor-pointer" data-page="orders" data-filter="delivered">
                                <div class="bg-white/20 rounded-full p-3 flex-shrink-0"><i data-lucide="package-check" class="w-8 h-8"></i></div>
                                <div><p class="text-sm font-medium text-fuchsia-100">Delivered Orders</p><p class="text-3xl font-bold" id="total-delivered">0</p></div>
                            </div>
                            <div class="stat-card bg-gradient-to-br from-rose-500 to-red-600 text-white p-4 rounded-lg shadow-lg flex items-center space-x-4 cursor-pointer" data-page="orders" data-filter="cancelled">
                                <div class="bg-white/20 rounded-full p-3 flex-shrink-0"><i data-lucide="x-circle" class="w-8 h-8"></i></div>
                                <div><p class="text-sm font-medium text-red-100">Cancelled Orders</p><p class="text-3xl font-bold" id="total-cancelled">0</p></div>
                            </div>

                            <!-- Group 3: Platform Metrics -->
                            <div class="stat-card bg-gradient-to-br from-pink-500 to-rose-500 text-white p-4 rounded-lg shadow-lg flex items-center space-x-4 cursor-pointer" data-page="products">
                                <div class="bg-white/20 rounded-full p-3 flex-shrink-0"><i data-lucide="archive" class="w-8 h-8"></i></div>
                                <div><p class="text-sm font-medium text-rose-100">Total Products</p><p class="text-3xl font-bold" id="total-products-stat">0</p></div>
                            </div>
                             <div class="stat-card bg-gradient-to-br from-red-500 to-orange-500 text-white p-4 rounded-lg shadow-lg flex items-center space-x-4 cursor-pointer" data-page="users">
                                <div class="bg-white/20 rounded-full p-3 flex-shrink-0"><i data-lucide="users" class="w-8 h-8"></i></div>
                                <div><p class="text-sm font-medium text-orange-100">Total Users</p><p class="text-3xl font-bold" id="total-users">0</p></div>
                            </div>
                            <div class="stat-card bg-gradient-to-br from-indigo-500 to-violet-500 text-white p-4 rounded-lg shadow-lg flex items-center space-x-4 cursor-pointer" data-page="delivery">
                                <div class="bg-white/20 rounded-full p-3 flex-shrink-0"><i data-lucide="user-check" class="w-8 h-8"></i></div>
                                <div><p class="text-sm font-medium text-violet-100">Total Delivery Men</p><p class="text-3xl font-bold" id="total-delivery-men">0</p></div>
                            </div>
                            <div class="stat-card bg-gradient-to-br from-red-600 to-rose-600 text-white p-4 rounded-lg shadow-lg flex items-center space-x-4 cursor-pointer" data-page="low-stock" title="Products with stock below threshold">
                                <div class="bg-white/20 rounded-full p-3 flex-shrink-0"><i data-lucide="alert-triangle" class="w-8 h-8"></i></div>
                                <div><p class="text-sm font-medium text-rose-100">Low Stock</p><p class="text-3xl font-bold" id="total-low-stock">0</p></div>
                            </div>
                            <div class="stat-card bg-gradient-to-br from-cyan-500 to-sky-500 text-white p-4 rounded-lg shadow-lg flex items-center space-x-4 cursor-pointer" data-page="coupons">
                                <div class="bg-white/20 rounded-full p-3 flex-shrink-0"><i data-lucide="ticket-percent" class="w-8 h-8"></i></div>
                                <div><p class="text-sm font-medium text-sky-100">Active Coupons</p><p class="text-3xl font-bold" id="total-active-coupons">0</p></div>
                            </div>
                            <div class="stat-card bg-gradient-to-br from-amber-500 to-yellow-400 text-white p-4 rounded-lg shadow-lg flex items-center space-x-4 cursor-pointer" data-page="chat">
                                <!-- LUCIDE ICON FIX: Changed "mail-unread" to "inbox" -->
                                <div class="bg-white/20 rounded-full p-3 flex-shrink-0"><i data-lucide="inbox" class="w-8 h-8"></i></div>
                                <div><p class="text-sm font-medium text-yellow-100">Total Unseen SMS</p><p class="text-3xl font-bold" id="total-unseen-sms">0</p></div>
                            </div>
                            <!-- Live Visitors (Realtime website visitors within last 2 minutes) -->
                            <div id="live-visitors-card" class="stat-card bg-gradient-to-br from-blue-600 to-cyan-500 text-white p-4 rounded-lg shadow-lg flex items-center space-x-4 cursor-pointer" title="People currently browsing (active in last 2 minutes)">
                                <div class="bg-white/20 rounded-full p-3 flex-shrink-0"><i data-lucide="activity" class="w-8 h-8"></i></div>
                                <div>
                                    <p class="text-sm font-medium text-blue-100">Live Visitors</p>
                                    <p class="text-3xl font-bold" id="live-visitors">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
                            <div class="bg-secondary p-6 rounded-lg shadow-md"><h3 class="text-xl font-semibold text-text-primary mb-4">Recent Orders</h3><div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="text-xs font-semibold tracking-wide text-text-secondary uppercase border-b border-color bg-gray-50 dark:bg-gray-700"><th class="px-4 py-3">Sl. No.</th><th class="px-4 py-3">Order ID</th><th class="px-4 py-3">Customer</th><th class="px-4 py-3">Amount</th><th class="px-4 py-3">Status</th></tr></thead><tbody class="divide-y border-color" id="recent-orders-body"><tr class="text-text-primary"><td colspan="5" class="px-4 py-3 text-center">Loading...</td></tr></tbody></table></div></div>
                            <div class="bg-secondary p-6 rounded-lg shadow-md"><h3 class="text-xl font-semibold text-text-primary mb-4">New Users</h3><div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="text-xs font-semibold tracking-wide text-text-secondary uppercase border-b border-color bg-gray-50 dark:bg-gray-700"><th class="px-4 py-3">User</th><th class="px-4 py-3">Email</th><th class="px-4 py-3">Join Date</th></tr></thead><tbody class="divide-y border-color" id="recent-users-body"><tr class="text-text-primary"><td colspan="3" class="px-4 py-3 text-center">Loading...</td></tr></tbody></table></div></div>
                        </div>

                        <div class="bg-secondary p-6 rounded-lg shadow-md mt-6">
                            <div class="flex flex-col gap-3">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-xl font-semibold text-text-primary">Dashboard Metrics</h3>
                                    <div class="flex items-center gap-2">
                                        <select id="ordersChartDays" class="px-3 py-1.5 text-sm rounded-md bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-theme-primary">
                                            <option value="1">Last 1 day</option>
                                            <option value="7" selected="">Last 7 days</option>
                                            <option value="30">Last 1 month</option>
                                            <option value="180">Last 6 months</option>
                                            <option value="365">Last 1 year</option>
                                        </select>
                                        <button id="downloadMetricsExcel" class="px-3 py-1.5 text-sm rounded-md bg-theme-primary text-white btn-glow" title="Download Excel">Download Excel</button>
                                    </div>
                                </div>
                                <div class="flex flex-wrap gap-3 text-sm">
                                    <label class="inline-flex items-center gap-2 select-none"><input id="metric-orders" type="checkbox" class="accent-theme-primary" checked=""> <span>Orders</span></label>
                                    <label class="inline-flex items-center gap-2 select-none"><input id="metric-delivered" type="checkbox" class="accent-theme-primary" checked=""> <span>Delivered</span></label>
                                    <label class="inline-flex items-center gap-2 select-none"><input id="metric-ofd" type="checkbox" class="accent-theme-primary"> <span>Out for Delivery</span></label>
                                    <label class="inline-flex items-center gap-2 select-none"><input id="metric-users" type="checkbox" class="accent-theme-primary"> <span>New Users</span></label>
                                    <label class="inline-flex items-center gap-2 select-none"><input id="metric-products" type="checkbox" class="accent-theme-primary"> <span>New Products</span></label>
                                    <label class="inline-flex items-center gap-2 select-none"><input id="metric-sales" type="checkbox" class="accent-theme-primary" checked=""> <span>Sales Amount</span></label>
                                    <label class="inline-flex items-center gap-2 select-none"><input id="metric-profit" type="checkbox" class="accent-theme-primary" checked=""> <span>Profit</span></label>
                                </div>
                                <div class="h-72">
                                    <canvas id="ordersChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Live Chat Page -->
                    <div id="chat-page" class="page-content hidden">
                        <div class="h-[calc(100vh-10rem)] bg-secondary rounded-lg shadow-md flex">
                            <!-- Chat List -->
                            <div class="w-1/3 border-r border-color flex flex-col">
                                <div class="p-4 border-b border-color">
                                    <h3 class="text-lg font-semibold text-text-primary">Conversations</h3>
                                    <div class="mt-3 flex items-center gap-2">
                                        <div class="relative flex-1">
                                            <input id="chat-search-input" type="text" placeholder="Search name or message..." class="w-full pl-9 pr-3 py-2 text-sm bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-theme-primary">
                                            <i data-lucide="search" class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-text-secondary"></i>
                                        </div>
                                        <label class="flex items-center gap-2 text-xs text-text-secondary select-none">
                                            <input id="chat-unread-toggle" type="checkbox" class="accent-theme-primary">
                                            Unread only
                                        </label>
                                    </div>
                                </div>
                                <div id="chat-list-container" class="flex-1 overflow-y-auto">
                                    <p class="p-4 text-center text-text-secondary">Loading chats...</p>
                                </div>
                            </div>
                            <!-- Chat Window -->
                            <div class="w-2/3 flex flex-col">
                                <div id="chat-window-placeholder" class="flex flex-col items-center justify-center h-full text-center text-text-secondary">
                                    <i data-lucide="message-square" class="w-16 h-16 mb-4"></i>
                                    <h3 class="text-xl font-semibold">Select a conversation</h3>
                                    <p>Choose a user from the list to start chatting.</p>
                                </div>
                                <div id="chat-window-main" class="hidden flex-col h-full">
                                    <!-- Chat Header -->
                                <div id="chat-header" class="p-4 border-b border-color flex items-center justify-between cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors">
                                    <div class="flex items-center gap-3">
                                        <img id="chat-header-avatar" src="https://placehold.co/40x40" class="w-10 h-10 rounded-full object-cover">
                                        <div>
                                            <div class="flex items-center gap-2">
                                                <h3 id="chat-header-name" class="font-semibold text-text-primary">User Name</h3>
                                                <span id="chat-header-blocked-badge" class="hidden text-[10px] font-semibold px-1.5 py-0.5 rounded bg-red-100 text-red-700 dark:bg-red-800/40 dark:text-red-300">Blocked</span>
                                            </div>
                                            <p id="chat-header-status" class="text-xs text-text-secondary">Last update: —</p>
                                        </div>
                                    </div>
                                    <div id="chat-header-actions" class="flex items-center gap-1 px-1">
                                        <button class="view-profile-btn p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700" title="View Profile">
                                            <i data-lucide="id-card" class="w-4 h-4"></i>
                                        </button>
                                        <button id="chat-header-block-btn" class="block-user-btn p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700" data-id="" data-blocked="false" title="Block/Unblock">
                                            <i data-lucide="ban" class="w-4 h-4"></i>
                                        </button>
                                        <button id="chat-header-delete-btn" class="delete-chat-btn p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 text-red-600" data-id="" title="Delete Conversation">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                                <!-- Messages -->
                                <div id="messages-container" class="flex-1 p-4 overflow-y-auto space-y-4">
                                    <!-- Messages will be injected here -->
                                    </div>
                                    <!-- Message Input -->
                                    <div class="p-4 border-t border-color">
                                        <div id="chat-blocked-banner" class="hidden mb-2 text-xs text-red-600 bg-red-50 dark:bg-red-900/30 dark:text-red-300 px-3 py-2 rounded-md">User is blocked. Messaging is disabled.</div>
                                        <form id="chat-message-form" class="flex items-end gap-2">
                                            <textarea id="chat-message-input" rows="1" placeholder="Type a message (Enter to send, Shift+Enter for new line)" autocomplete="off" class="resize-none w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-theme-primary"></textarea>
                                            <button type="submit" class="p-3 bg-theme-primary text-white rounded-md disabled:bg-opacity-70 flex-shrink-0 btn-glow" title="Send">
                                                <i data-lucide="send" class="w-5 h-5"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Products Page -->
                    <div id="products-page" class="page-content hidden">
                        <div class="bg-secondary p-6 rounded-lg shadow-md">
                            <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                                <h3 class="text-xl font-semibold text-text-primary">All Products</h3>
                                <div class="flex flex-wrap items-center gap-4 mt-2 sm:mt-0">
				<button id="bulk-upload-btn" class="bg-theme-primary text-white font-bold py-2 px-4 rounded-lg disabled:bg-opacity-70 btn-glow flex items-center space-x-2">
    <i data-lucide="upload-cloud" class="w-5 h-5"></i>
    <span>Bulk Upload (CSV)</span>
</button>
<button id="download-template-btn" class="flex items-center gap-2 rounded-lg border border-color px-4 py-2 text-sm font-semibold text-theme-primary hover:border-theme-primary hover:bg-theme-primary/10 focus:outline-none focus:ring-2 focus:ring-theme-primary" title="Download CSV template">
    <i data-lucide="download" class="w-4 h-4"></i>
    <span>Download Template</span>
</button>
<input type="file" id="csv-file-input" accept=".csv" class="hidden">
                                    <!-- Category Filters -->
                                    <div id="product-category-filters" class="flex flex-wrap items-center gap-2">
                                        <!-- Filter buttons will be dynamically inserted here -->
                                    </div>
                                    <!-- Sub-Category Filter Dropdown -->
                                    <div id="product-subcategory-filter-container" class="hidden">
                                        <!-- Dropdown will be inserted here by JS -->
                                    </div>
                                    <!-- Bulk actions -->
                                    <div class="flex items-center gap-3">
                                        <label class="inline-flex items-center text-sm select-none">
                                            <input id="products-select-all" type="checkbox" class="mr-2 accent-theme-primary">
                                            Select All
                                        </label>
                                        <button id="products-delete-selected" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-3 rounded-lg btn-glow-red" title="Delete selected products">Delete Selected</button>
                                    </div>
                                    <!-- Duplicates Detector (top-right) -->
                                    <div class="ml-auto flex items-center gap-2 order-last">
                                        <button id="products-toggle-duplicates" class="bg-amber-500 hover:bg-amber-600 text-white font-semibold py-2 px-3 rounded-lg btn-glow" title="Show only duplicated products">
                                            <i data-lucide="alert-triangle" class="w-4 h-4 mr-2"></i>
                                            Show Duplicates
                                        </button>
                                        <span id="duplicates-summary" class="text-xs text-text-secondary"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead>
                                        <tr class="text-xs font-semibold tracking-wide text-text-secondary uppercase border-b border-color bg-gray-50 dark:bg-gray-700">
                                            <th class="px-4 py-3">#</th>
                                            <th class="px-4 py-3 text-center">Select</th>
                                            <th class="px-4 py-3">Image</th>
                                            <th class="px-4 py-3">Name</th>
                                            <th class="px-4 py-3">Product ID</th>
                                            <th class="px-4 py-3">Category</th>
                                            <th class="px-4 py-3">Sub-Category</th>
                                            <th class="px-4 py-3">Main Price</th>
                                            <th class="px-4 py-3">Offer Price</th>
                                            <th class="px-4 py-3">Stock</th>
                                            <th class="px-4 py-3">Offer %</th>
                                            <th class="px-4 py-3">On Offer</th>
                                            <th class="px-4 py-3">Refundable</th>
                                            <th class="px-4 py-3">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y border-color" id="all-products-body"><tr class="text-text-primary"><td colspan="14" class="px-4 py-3 text-center">Loading...</td></tr></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Low Stock Page -->
                    <div id="low-stock-page" class="page-content hidden">
                        <div class="bg-secondary p-6 rounded-lg shadow-md">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-semibold text-text-primary">Low Stock Products</h3>
                                <div class="flex items-center gap-4">
                                    <span class="text-sm text-text-secondary">Threshold: <span id="low-stock-threshold-display">5</span></span>
                                    <label class="inline-flex items-center text-sm select-none">
                                        <input id="low-stock-select-all" type="checkbox" class="mr-2 accent-theme-primary">
                                        Select All
                                    </label>
                                    <button id="low-stock-delete-selected" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-3 rounded-lg btn-glow-red" title="Delete selected low-stock products">Delete Selected</button>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead>
                                        <tr class="text-xs font-semibold tracking-wide text-text-secondary uppercase border-b border-color bg-gray-50 dark:bg-gray-700">
                                            <th class="px-4 py-3">#</th>
                                            <th class="px-4 py-3 text-center">Select</th>
                                            <th class="px-4 py-3">Image</th>
                                            <th class="px-4 py-3">Name</th>
                                            <th class="px-4 py-3">Category</th>
                                            <th class="px-4 py-3">Sub-Category</th>
                                            <th class="px-4 py-3">Stock</th>
                                            <th class="px-4 py-3">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y border-color" id="low-stock-body">
                                        <tr class="text-text-primary"><td colspan="8" class="px-4 py-3 text-center">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Reports Page -->
                    <div id="reports-page" class="page-content hidden">
                        <div class="bg-secondary p-6 rounded-lg shadow-md space-y-6">
                            <div class="flex flex-col gap-4 lg:flex-row lg:items-end lg:justify-between">
                                <div>
                                    <h2 class="text-2xl font-semibold text-text-primary">Financial Reports</h2>
                                    <p class="text-sm text-text-secondary">Select a date range to review sales, cost, and profit.</p>
                                </div>
                                <div class="flex flex-wrap items-center gap-3">
                                    <div class="flex items-center gap-2">
                                        <label for="reports-start-date" class="text-sm text-text-secondary">From</label>
                                        <input type="date" id="reports-start-date" class="rounded-lg border border-color bg-white/80 px-3 py-2 text-sm text-text-primary focus:border-theme-primary focus:outline-none focus:ring-2 focus:ring-theme-primary dark:bg-gray-800/80">
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <label for="reports-end-date" class="text-sm text-text-secondary">To</label>
                                        <input type="date" id="reports-end-date" class="rounded-lg border border-color bg-white/80 px-3 py-2 text-sm text-text-primary focus:border-theme-primary focus:outline-none focus:ring-2 focus:ring-theme-primary dark:bg-gray-800/80">
                                    </div>
                                    <button id="reports-apply-btn" class="inline-flex items-center rounded-lg bg-theme-primary px-4 py-2 text-sm font-semibold text-white shadow hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-theme-primary">Apply</button>
                                    <button id="reports-reset-btn" class="inline-flex items-center rounded-lg border border-color px-4 py-2 text-sm font-semibold text-text-secondary hover:border-theme-primary hover:text-theme-primary focus:outline-none focus:ring-2 focus:ring-theme-primary">Reset</button>
                                </div>
                            </div>

                            <div class="grid gap-4 md:grid-cols-3">
                                <div class="rounded-2xl border border-color bg-white/70 p-5 shadow-sm dark:bg-gray-800/60">
                                    <p class="text-sm font-medium text-text-secondary">Total Sales</p>
                                    <p id="reports-total-sales" class="mt-2 text-2xl font-bold text-emerald-500">৳0.00</p>
                                </div>
                                <div class="rounded-2xl border border-color bg-white/70 p-5 shadow-sm dark:bg-gray-800/60">
                                    <p class="text-sm font-medium text-text-secondary">Total Cost</p>
                                    <p id="reports-total-cost" class="mt-2 text-2xl font-bold text-rose-500">৳0.00</p>
                                </div>
                                <div class="rounded-2xl border border-color bg-white/70 p-5 shadow-sm dark:bg-gray-800/60">
                                    <p class="text-sm font-medium text-text-secondary">Total Profit</p>
                                    <p id="reports-total-profit" class="mt-2 text-2xl font-bold text-theme-primary">৳0.00</p>
                                    <p id="reports-profit-badge" class="mt-1 text-xs font-semibold uppercase tracking-wide text-text-secondary">0 Orders</p>
                                </div>
                            </div>

                            <div class="rounded-2xl border border-color bg-white/70 p-5 shadow-sm dark:bg-gray-800/60">
                                <div class="flex flex-wrap items-center justify-between gap-3">
                                    <div>
                                        <h3 class="text-lg font-semibold text-text-primary">Orders Breakdown</h3>
                                        <p id="reports-orders-summary" class="text-sm text-text-secondary">No data for the selected range.</p>
                                    </div>
                                    <button id="reports-export-btn" class="inline-flex items-center rounded-lg border border-color px-3 py-1.5 text-xs font-semibold text-text-secondary hover:border-theme-primary hover:text-theme-primary focus:outline-none focus:ring-2 focus:ring-theme-primary">
                                        <i data-lucide="download" class="mr-2 h-4 w-4"></i>
                                        Export CSV
                                    </button>
                                </div>
                                <div class="mt-4 overflow-x-auto">
                                    <table class="min-w-full text-left text-sm">
                                        <thead class="text-xs uppercase tracking-wide text-text-secondary">
                                            <tr>
                                                <th class="px-3 py-2">Order</th>
                                                <th class="px-3 py-2">Date</th>
                                                <th class="px-3 py-2">Status</th>
                                                <th class="px-3 py-2 text-right">Sale</th>
                                                <th class="px-3 py-2 text-right">Cost</th>
                                                <th class="px-3 py-2 text-right">Profit</th>
                                            </tr>
                                        </thead>
                                        <tbody id="reports-table-body" class="divide-y divide-gray-200 text-text-primary dark:divide-gray-700"></tbody>
                                    </table>
                                    <p id="reports-empty-state" class="py-6 text-center text-sm text-text-secondary hidden">No delivered orders found for the selected range.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Top Sales Page -->
                    <div id="top-sales-page" class="page-content hidden">
                        <div class="bg-secondary p-6 rounded-lg shadow-md">
                            <div class="flex flex-wrap items-center justify-between mb-4 gap-3">
                                <h3 class="text-xl font-semibold text-text-primary">Top Selling Products</h3>
                                <div class="flex items-center gap-3 text-sm">
                                    <label for="top-sales-range" class="text-text-secondary">Range</label>
                                    <select id="top-sales-range" class="border border-color rounded px-2 py-1 bg-primary text-text-primary">
                                        <option value="7">Last 7 days</option>
                                        <option value="30" selected="">Last 30 days</option>
                                        <option value="90">Last 90 days</option>
                                        <option value="180">Last 180 days</option>
                                        <option value="365">Last 365 days</option>
                                        <option value="all">All time</option>
                                    </select>
                                    <button id="top-sales-export" class="bg-theme-primary hover:bg-theme-primary-hover text-white font-semibold py-2 px-3 rounded-lg btn-glow" title="Export CSV"><i data-lucide="download" class="w-4 h-4 mr-1"></i>Export</button>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead>
                                        <tr class="text-xs font-semibold tracking-wide text-text-secondary uppercase border-b border-color bg-gray-50 dark:bg-gray-700">
                                            <th class="px-4 py-3">#</th>
                                            <th class="px-4 py-3">Product</th>
                                            <th class="px-4 py-3">Product ID</th>
                                            <th class="px-4 py-3">Category</th>
                                            <th class="px-4 py-3">Units Sold</th>
                                            <th class="px-4 py-3">Revenue</th>
                                            <th class="px-4 py-3">Stock</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y border-color" id="top-sales-body">
                                        <tr class="text-text-primary"><td colspan="7" class="px-4 py-3 text-center">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Top Rated Page -->
                    <div id="top-rated-page" class="page-content hidden">
                        <div class="bg-secondary p-6 rounded-lg shadow-md">
                            <div class="flex flex-wrap items-center justify-between mb-4 gap-3">
                                <h3 class="text-xl font-semibold text-text-primary">Top Rated Products</h3>
                                <div class="flex flex-wrap items-center gap-3 text-sm">
                                    <label for="top-rated-min-rating" class="text-text-secondary">Min Rating</label>
                                    <select id="top-rated-min-rating" class="border border-color rounded px-2 py-1 bg-primary text-text-primary">
                                        <option value="0">All</option>
                                        <option value="3">3 ★ &amp; up</option>
                                        <option value="3.5">3.5 ★ &amp; up</option>
                                        <option value="4">4 ★ &amp; up</option>
                                        <option value="4.5">4.5 ★ &amp; up</option>
                                        <option value="4.8">4.8 ★ &amp; up</option>
                                    </select>
                                    <label for="top-rated-min-reviews" class="text-text-secondary">Min Reviews</label>
                                    <select id="top-rated-min-reviews" class="border border-color rounded px-2 py-1 bg-primary text-text-primary">
                                        <option value="0">All</option>
                                        <option value="5">5+</option>
                                        <option value="10">10+</option>
                                        <option value="25">25+</option>
                                        <option value="50">50+</option>
                                    </select>
                                    <button id="top-rated-export" class="bg-theme-primary hover:bg-theme-primary-hover text-white font-semibold py-2 px-3 rounded-lg btn-glow" title="Export CSV"><i data-lucide="download" class="w-4 h-4 mr-1"></i>Export</button>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead>
                                        <tr class="text-xs font-semibold tracking-wide text-text-secondary uppercase border-b border-color bg-gray-50 dark:bg-gray-700">
                                            <th class="px-4 py-3">#</th>
                                            <th class="px-4 py-3">Product</th>
                                            <th class="px-4 py-3">Product ID</th>
                                            <th class="px-4 py-3">Category</th>
                                            <th class="px-4 py-3">Rating</th>
                                            <th class="px-4 py-3">Reviews</th>
                                            <th class="px-4 py-3">Stock</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y border-color" id="top-rated-body">
                                        <tr class="text-text-primary"><td colspan="7" class="px-4 py-3 text-center">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Flash Sale Page -->
                    <div id="flash-sale-page" class="page-content hidden">
                        <div class="bg-secondary p-6 rounded-lg shadow-md">
                            <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
                                <div>
                                    <h3 class="text-xl font-semibold text-text-primary">Flash Sale Products</h3>
                                    <p class="text-sm text-text-secondary">Track upcoming, live, and expired flash deals at a glance.</p>
                                </div>
                                <div class="flex flex-wrap items-center gap-2 text-xs sm:text-sm">
                                    <span class="px-2 py-1 rounded-full bg-gray-100 dark:bg-gray-700 text-text-secondary">Total: <span id="flash-sale-summary-total">0</span></span>
                                    <span class="px-2 py-1 rounded-full bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300">Live: <span id="flash-sale-summary-active">0</span></span>
                                    <span class="px-2 py-1 rounded-full bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300">Upcoming: <span id="flash-sale-summary-upcoming">0</span></span>
                                    <span class="px-2 py-1 rounded-full bg-gray-200 text-gray-700 dark:bg-gray-800 dark:text-gray-200">Ended: <span id="flash-sale-summary-ended">0</span></span>
                                </div>
                                <button id="flash-sale-add-product" class="bg-theme-primary hover:bg-theme-primary-hover text-white font-semibold py-2 px-4 rounded-lg btn-glow flex items-center gap-2">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                    <span>New Flash Sale Product</span>
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead>
                                        <tr class="text-xs font-semibold tracking-wide text-text-secondary uppercase border-b border-color bg-gray-50 dark:bg-gray-700">
                                            <th class="px-4 py-3">#</th>
                                            <th class="px-4 py-3">Product</th>
                                            <th class="px-4 py-3">Model</th>
                                            <th class="px-4 py-3">Flash Price</th>
                                            <th class="px-4 py-3">Window</th>
                                            <th class="px-4 py-3">Status</th>
                                            <th class="px-4 py-3">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="flash-sale-body" class="divide-y border-color">
                                        <tr><td colspan="7" class="px-4 py-6 text-center text-text-secondary">Loading flash sale products...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Mega Sale Page -->
                    <div id="mega-sale-page" class="page-content hidden">
                        <div class="bg-secondary p-6 rounded-lg shadow-md">
                            <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
                                <div>
                                    <h3 class="text-xl font-semibold text-text-primary">Mega Sale Products</h3>
                                    <p class="text-sm text-text-secondary">Curate the high-impact offers that appear in the Mega Sale spotlight.</p>
                                </div>
                                <button id="mega-sale-add-product" class="bg-theme-primary hover:bg-theme-primary-hover text-white font-semibold py-2 px-4 rounded-lg btn-glow flex items-center gap-2">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                    <span>New Mega Sale Product</span>
                                </button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead>
                                        <tr class="text-xs font-semibold tracking-wide text-text-secondary uppercase border-b border-color bg-gray-50 dark:bg-gray-700">
                                            <th class="px-4 py-3">#</th>
                                            <th class="px-4 py-3">Product</th>
                                            <th class="px-4 py-3">Product ID</th>
                                            <th class="px-4 py-3">Category</th>
                                            <th class="px-4 py-3">Offer Pricing</th>
                                            <th class="px-4 py-3">Status</th>
                                            <th class="px-4 py-3">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="mega-sale-body" class="divide-y border-color">
                                        <tr><td colspan="7" class="px-4 py-6 text-center text-text-secondary">Mega sale products will appear here once configured.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Add Product Page -->
                    <!-- Reviews & Ratings Page -->
                    <div id="reviews-page" class="page-content hidden">
                        <div class="bg-secondary p-6 rounded-lg shadow-md">
                            <div class="flex flex-wrap items-center justify-between mb-4 gap-3">
                                <h3 class="text-xl font-semibold text-text-primary">Product Reviews &amp; Ratings</h3>
                                <div class="flex items-center gap-2 text-sm">
                                    <span class="px-2 py-1 rounded-full bg-gray-100 dark:bg-gray-700 text-text-secondary">Total: <span id="reviews-summary-total">0</span></span>
                                    <span class="px-2 py-1 rounded-full bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300">Avg: <span id="reviews-summary-avg">0.0</span> ★</span>
                                    <span class="hidden sm:inline-block w-px h-5 bg-gray-300 dark:bg-gray-600 mx-1"></span>
                                    <label class="inline-flex items-center text-sm select-none">
                                        <input id="reviews-select-all" type="checkbox" class="mr-2 accent-theme-primary">
                                        Select All
                                    </label>
                                    <button id="reviews-delete-selected" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-3 rounded-lg btn-glow-red" title="Delete selected reviews">Delete Selected</button>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead>
                                        <tr class="text-xs font-semibold tracking-wide text-text-secondary uppercase border-b border-color bg-gray-50 dark:bg-gray-700">
                                            <th class="px-4 py-3">#</th>
                                            <th class="px-4 py-3 text-center">Select</th>
                                            <th class="px-4 py-3">Product</th>
                                            <th class="px-4 py-3">Rating</th>
                                            <th class="px-4 py-3">Comment</th>
                                            <th class="px-4 py-3">Author</th>
                                            <th class="px-4 py-3">Date</th>
                                            <th class="px-4 py-3">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y border-color" id="reviews-body">
                                        <tr class="text-text-primary"><td colspan="8" class="px-4 py-3 text-center">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div id="add-product-page" class="page-content hidden">
                        <div class="bg-secondary p-8 rounded-lg shadow-md max-w-4xl mx-auto">
                            <h2 class="text-2xl font-bold mb-6 text-text-primary">Add New Product</h2>
                            <form id="add-product-form" class="space-y-6">
                                <!-- Reusable form content will be injected here by JS -->
                            </form>
                        </div>
                    </div>

                    <!-- Edit Product Page -->
                    <div id="edit-product-page" class="page-content hidden">
                        <div class="bg-secondary p-8 rounded-lg shadow-md max-w-4xl mx-auto">
                            <h2 class="text-2xl font-bold mb-6 text-text-primary">Edit Product</h2>
                            <form id="edit-product-form" class="space-y-6">
                                 <!-- Reusable form content will be injected here by JS -->
                                 <div class="p-4 border rounded-lg bg-gray-50/50 dark:bg-gray-800/50 border-color">
                                     <label class="block text-text-primary font-medium mb-1">Document ID</label>
                                     <input id="edit-product-doc-id" type="text" class="w-full px-4 py-2 bg-gray-200 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-sm font-mono" readonly="" value="">
                                 </div>
                            </form>
                        </div>
                    </div>

                    <!-- Banners Page -->
                    <div id="banners-page" class="page-content hidden">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg-col-span-1"><div class="bg-secondary p-8 rounded-lg shadow-md"><h2 class="text-2xl font-bold mb-6 text-text-primary">Add New Banner</h2><form id="add-banner-form"><div class="mb-4"><label for="banner-image" class="block text-text-primary font-medium mb-2">Banner Image URL</label><input type="url" id="banner-image" required="" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary" placeholder="https://example.com/banner.jpg"></div><div class="mb-4"><label for="banner-link" class="block text-text-primary font-medium mb-2">Link (Optional)</label><input type="url" id="banner-link" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary" placeholder="/products/promo"></div><button type="submit" class="w-full bg-theme-primary text-white font-bold py-3 px-4 rounded-lg disabled:bg-opacity-70 btn-glow">Add Banner</button></form></div></div>
                            <div class="lg-col-span-2"><div class="bg-secondary p-6 rounded-lg shadow-md"><h3 class="text-xl font-semibold text-text-primary mb-4">Current Banners</h3><div id="banners-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="text-text-primary">Loading...</div></div></div></div>
                        </div>
                    </div>

                    <!-- Side Promo Page -->
                    <div id="side-promo-page" class="page-content hidden">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-1">
                                <div class="bg-secondary p-8 rounded-lg shadow-md">
                                    <h2 class="text-2xl font-bold mb-6 text-text-primary">Add Side Promo</h2>
                                    <form id="add-side-promo-form" class="space-y-4">
                                        <div>
                                            <label for="side-promo-image" class="block text-text-primary font-medium mb-2">Image URL</label>
                                            <input type="url" id="side-promo-image" required="" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary" placeholder="https://example.com/side-promo.jpg">
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label for="side-promo-title" class="block text-text-primary font-medium mb-2">Title (EN)</label>
                                                <input type="text" id="side-promo-title" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary" placeholder="e.g., Smart Prices on Accessories">
                                            </div>
                                            <div>
                                                <label for="side-promo-title-bn" class="block text-text-primary font-medium mb-2">Title (BN)</label>
                                                <input type="text" id="side-promo-title-bn" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary" placeholder="উদাহরণ: স্মার্ট প্রাইসেস অন অ্যাকসেসরিজ">
                                            </div>
                                            <div>
                                                <label for="side-promo-subtitle" class="block text-text-primary font-medium mb-2">Subtitle (EN)</label>
                                                <input type="text" id="side-promo-subtitle" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary" placeholder="e.g., Up to 70% off">
                                            </div>
                                            <div>
                                                <label for="side-promo-subtitle-bn" class="block text-text-primary font-medium mb-2">Subtitle (BN)</label>
                                                <input type="text" id="side-promo-subtitle-bn" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary" placeholder="উদাহরণ: সর্বোচ্চ ৭০% ছাড়">
                                            </div>
                                        </div>
                                        <div>
                                            <label for="side-promo-link" class="block text-text-primary font-medium mb-2">Link (Optional)</label>
                                            <input type="url" id="side-promo-link" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary" placeholder="/products/special">
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label for="side-promo-alt" class="block text-text-primary font-medium mb-2">Alt Text (Optional)</label>
                                                <input type="text" id="side-promo-alt" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary" placeholder="Accessible image description">
                                            </div>
                                            <div>
                                                <label for="side-promo-order" class="block text-text-primary font-medium mb-2">Order (Optional)</label>
                                                <input type="number" id="side-promo-order" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary" placeholder="0">
                                            </div>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span class="text-text-primary font-medium">Active</span>
                                            <label for="side-promo-active" class="relative inline-flex items-center cursor-pointer">
                                                <input type="checkbox" id="side-promo-active" class="sr-only peer" checked="">
                                                <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-600 peer-checked:bg-theme-primary peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
                                            </label>
                                        </div>
                                        <button type="submit" class="w-full bg-theme-primary text-white font-bold py-3 px-4 rounded-lg disabled:bg-opacity-70 btn-glow">Add Side Promo</button>
                                    </form>
                                </div>
                            </div>
                            <div class="lg:col-span-2">
                                <div class="bg-secondary p-6 rounded-lg shadow-md">
                                    <h3 class="text-xl font-semibold text-text-primary mb-4">Current Side Promos</h3>
                                    <div id="side-promos-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="text-text-primary">Loading...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Coupons Page -->
                    <div id="coupons-page" class="page-content hidden">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-1">
                                <div class="bg-secondary p-8 rounded-lg shadow-md">
                                    <h2 class="text-2xl font-bold mb-6 text-text-primary">Add New Coupon</h2>
                                    <form id="add-coupon-form" class="space-y-4">
                                        <div>
                                            <label for="coupon-code" class="block text-text-primary font-medium mb-2">Coupon Code</label>
                                            <input type="text" id="coupon-code" required="" placeholder="e.g., SUMMER25" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary uppercase">
                                        </div>
                                        <div>
                                            <label for="coupon-type" class="block text-text-primary font-medium mb-2">Discount Type</label>
                                            <select id="coupon-type" required="" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary">
                                                <option value="percentage">Percentage</option>
                                                <option value="fixed">Fixed Amount</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="coupon-value" class="block text-text-primary font-medium mb-2">Value (e.g., 25 or 100)</label>
                                            <input type="number" id="coupon-value" required="" min="0" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary">
                                        </div>
                                        <div>
                                            <label for="coupon-expiry" class="block text-text-primary font-medium mb-2">Expiry Date</label>
                                            <input type="date" id="coupon-expiry" required="" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary">
                                        </div>
                                        <div>
                                            <label for="coupon-min-spend" class="block text-text-primary font-medium mb-2">Minimum Spend (Optional)</label>
                                            <input type="number" id="coupon-min-spend" min="0" placeholder="e.g., 500" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary">
                                        </div>
                                        <button type="submit" class="w-full bg-theme-primary text-white font-bold py-3 px-4 rounded-lg disabled:bg-opacity-70 btn-glow">Add Coupon</button>
                                    </form>
                                </div>
                            </div>
                            <div class="lg:col-span-2">
                                <div class="bg-secondary p-6 rounded-lg shadow-md">
                                    <h3 class="text-xl font-semibold text-text-primary mb-4">All Coupons</h3>
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-left">
                                            <thead>
                                                <tr class="text-xs font-semibold tracking-wide text-text-secondary uppercase border-b border-color bg-gray-50 dark:bg-gray-700">
                                                    <th class="px-4 py-3">Code</th>
                                                    <th class="px-4 py-3">Type</th>
                                                    <th class="px-4 py-3">Value</th>
                                                    <th class="px-4 py-3">Min. Spend</th>
                                                    <th class="px-4 py-3">Expires</th>
                                                    <th class="px-4 py-3">Status</th>
                                                    <th class="px-4 py-3">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y border-color" id="all-coupons-body">
                                                <tr class="text-text-primary"><td colspan="7" class="px-4 py-3 text-center">Loading...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Orders Page -->
                    <div id="orders-page" class="page-content hidden">
                         <div class="bg-secondary p-6 rounded-lg shadow-md">
                             <div class="flex flex-col sm:flex-row justify-between items-start mb-4 gap-4">
                                 <h3 class="text-xl font-semibold text-text-primary">All Orders</h3>
                                 <div class="flex flex-col sm:items-end gap-4 w-full sm:w-auto">
                                     <div id="order-status-filters" class="flex flex-wrap items-center justify-start sm:justify-end gap-2">
                                         <!-- Filter buttons will be dynamically inserted here -->
                                     </div>
                                     <div class="relative w-full sm:w-72">
                                         <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-text-secondary"></i>
                                         <input type="text" id="order-search-input" placeholder="Search by Order ID..." class="w-full pl-10 pr-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary">
                                     </div>
                                     <div class="flex items-center gap-3 self-start sm:self-end">
                                         <label class="inline-flex items-center text-sm select-none">
                                             <input id="orders-select-all" type="checkbox" class="mr-2 accent-theme-primary">
                                             Select All
                                         </label>
                                         <button id="orders-delete-selected" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-3 rounded-lg btn-glow-red" title="Delete selected orders">Delete Selected</button>
                                     </div>
                                 </div>
                             </div>
                             <div class="overflow-x-auto">
                                 <table class="w-full text-left">
                                     <thead><tr class="text-xs font-semibold tracking-wide text-text-secondary uppercase border-b border-color bg-gray-50 dark:bg-gray-700"><th class="px-4 py-3">Sl. No.</th><th class="px-4 py-3 text-center">Select</th><th class="px-4 py-3">Order ID</th><th class="px-4 py-3">Customer Name</th><th class="px-4 py-3">Mobile</th><th class="px-4 py-3">Date &amp; Time</th><th class="px-4 py-3">Items</th><th class="px-4 py-3">Amount</th><th class="px-4 py-3">Location</th><th class="px-4 py-3">Payment Method</th><th class="px-4 py-3">Delivery Charge</th><th class="px-4 py-3">Assign Delivery Man</th><th class="px-4 py-3">Status</th><th class="px-4 py-3">Actions</th></tr></thead>
                                     <tbody class="divide-y border-color" id="all-orders-body"><tr class="text-text-primary"><td colspan="14" class="px-4 py-3 text-center">Loading...</td></tr></tbody>
                                 </table>
                             </div>
                         </div>
                    </div>
                    
                    <!-- Users Page -->
                    <div id="users-page" class="page-content hidden">
                        <div class="bg-secondary p-6 rounded-lg shadow-md">
                            <div class="flex items-center justify-between mb-4 gap-3">
                                <h3 class="text-xl font-semibold text-text-primary">All Users</h3>
                                <div class="flex items-center gap-3">
                                    <label class="inline-flex items-center text-sm select-none">
                                        <input id="users-select-all" type="checkbox" class="mr-2 accent-theme-primary">
                                        Select All
                                    </label>
                                    <button id="users-delete-selected" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-3 rounded-lg btn-glow-red" title="Delete selected users">Delete Selected</button>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead><tr class="text-xs font-semibold tracking-wide text-text-secondary uppercase border-b border-color bg-gray-50 dark:bg-gray-700"><th class="px-4 py-3">User</th><th class="px-4 py-3 text-center">Select</th><th class="px-4 py-3">Email</th><th class="px-4 py-3">Mobile</th><th class="px-4 py-3">Location</th><th class="px-4 py-3">Join Date</th><th class="px-4 py-3">UID</th><th class="px-4 py-3">Status</th><th class="px-4 py-3">Actions</th></tr></thead>
                                    <tbody class="divide-y border-color" id="all-users-body"><tr class="text-text-primary"><td colspan="9" class="px-4 py-3 text-center">Loading...</td></tr></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Delivery Page -->
                    <div id="delivery-page" class="page-content hidden">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                             <div class="lg:col-span-1">
                                 <div class="bg-secondary p-8 rounded-lg shadow-md">
                                     <h2 class="text-2xl font-bold mb-6 text-text-primary">Add Delivery Man</h2>
                                     <form id="add-delivery-man-form" class="space-y-4">
                                         <div>
                                             <label for="delivery-man-name" class="block text-text-primary font-medium mb-2">Name</label>
                                             <input type="text" id="delivery-man-name" required="" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary">
                                         </div>
                                         <div>
                                             <label for="delivery-man-email" class="block text-text-primary font-medium mb-2">Email</label>
                                             <input type="email" id="delivery-man-email" required="" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary">
                                         </div>
                                         <div>
                                             <label for="delivery-man-password" class="block text-text-primary font-medium mb-2">Password</label>
                                             <input type="password" id="delivery-man-password" required="" minlength="6" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary">
                                         </div>
                                         <div>
                                             <label for="delivery-man-phone" class="block text-text-primary font-medium mb-2">Phone Number</label>
                                             <input type="tel" id="delivery-man-phone" required="" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary">
                                         </div>
                                         <div>
                                             <label for="delivery-man-vehicle" class="block text-text-primary font-medium mb-2">Vehicle Details (e.g., Bike, Cycle)</label>
                                             <input type="text" id="delivery-man-vehicle" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary">
                                         </div>
                                         <button type="submit" class="w-full bg-theme-primary text-white font-bold py-3 px-4 rounded-lg disabled:bg-opacity-70 btn-glow">Add Delivery Man</button>
                                     </form>
                                 </div>
                             </div>
                            <div class="lg:col-span-2">
                                <div class="bg-secondary p-6 rounded-lg shadow-md">
                                    <h3 class="text-xl font-semibold text-text-primary mb-4">All Delivery Men</h3>
                                    <div id="delivery-man-cards-container" class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                                        <div class="text-text-primary text-center xl:col-span-2">Loading...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- Settings Page -->
                    <div id="settings-page" class="page-content hidden">
                        <div class="max-w-4xl mx-auto space-y-8">
                            <!-- Profile Settings -->
                            <div class="bg-secondary p-6 rounded-lg shadow-md">
                                <h3 class="text-xl font-semibold text-text-primary mb-4">Profile Settings</h3>
                                <form id="profile-settings-form" class="space-y-4">
                                    <div>
                                        <label for="admin-name" class="block text-text-primary font-medium mb-2">Name</label>
                                        <input type="text" id="admin-name" class="w-full px-4 py-2 border rounded-lg bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-text-primary">
                                    </div>
                                    <div>
                                        <label for="admin-image" class="block text-text-primary font-medium mb-2">Profile Picture URL</label>
                                        <input type="url" id="admin-image" class="w-full px-4 py-2 border rounded-lg bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-text-primary">
                                    </div>
                                     <p class="text-sm text-text-secondary">Your Email: <span id="admin-profile-email" class="font-semibold"></span></p>
                                    <div class="flex justify-end">
                                        <button type="submit" class="bg-theme-primary text-white font-bold py-2 px-4 rounded-lg disabled:bg-opacity-70 btn-glow">Save Changes</button>
                                    </div>
                                </form>
                            </div>

                             <!-- Theme Settings -->
                            <div class="bg-secondary p-6 rounded-lg shadow-md">
                                <h3 class="text-xl font-semibold text-text-primary mb-4">Theme</h3>
                                <div id="theme-selector" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4">
                                    <div class="theme-option cursor-pointer" data-theme="indigo">
                                        <div class="w-full h-16 rounded-lg bg-indigo-600 flex items-center justify-center relative border-4 border-transparent"><i data-lucide="check-circle" class="w-8 h-8 text-white hidden theme-check"></i></div>
                                        <p class="text-center text-sm mt-2 text-text-primary">Indigo</p>
                                    </div>
                                    <div class="theme-option cursor-pointer" data-theme="forest">
                                        <div class="w-full h-16 rounded-lg bg-green-600 flex items-center justify-center relative border-4 border-transparent"><i data-lucide="check-circle" class="w-8 h-8 text-white hidden theme-check"></i></div>
                                        <p class="text-center text-sm mt-2 text-text-primary">Forest</p>
                                    </div>
                                    <div class="theme-option cursor-pointer" data-theme="crimson">
                                        <div class="w-full h-16 rounded-lg bg-red-600 flex items-center justify-center relative border-4 border-transparent"><i data-lucide="check-circle" class="w-8 h-8 text-white hidden theme-check"></i></div>
                                        <p class="text-center text-sm mt-2 text-text-primary">Crimson</p>
                                    </div>
                                    <div class="theme-option cursor-pointer" data-theme="ocean">
                                        <div class="w-full h-16 rounded-lg bg-sky-600 flex items-center justify-center relative border-4 border-transparent"><i data-lucide="check-circle" class="w-8 h-8 text-white hidden theme-check"></i></div>
                                        <p class="text-center text-sm mt-2 text-text-primary">Ocean</p>
                                    </div>
                                    <div class="theme-option cursor-pointer" data-theme="royal">
                                        <div class="w-full h-16 rounded-lg bg-purple-600 flex items-center justify-center relative border-4 border-transparent"><i data-lucide="check-circle" class="w-8 h-8 text-white hidden theme-check"></i></div>
                                        <p class="text-center text-sm mt-2 text-text-primary">Royal</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Appearance Settings -->
                            <div class="bg-secondary p-6 rounded-lg shadow-md">
                                <h3 class="text-xl font-semibold text-text-primary mb-4">Appearance</h3>
                                <div class="flex items-center justify-between">
                                    <span class="text-text-primary">Dark Mode</span>
                                    <label for="dark-mode-toggle" class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="dark-mode-toggle" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-600 peer-checked:bg-theme-primary peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
                                    </label>
                                </div>
                                <div class="mt-6 pt-4 border-t border-color">
                                    <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                                        <div>
                                            <span class="text-text-primary font-medium">Interface Text Size</span>
                                            <p class="text-xs text-text-secondary mt-1">Adjust the global font scale for easier reading.</p>
                                        </div>
                                        <div class="flex flex-wrap items-center gap-2">
                                            <span class="text-xs uppercase tracking-wide text-text-secondary">Text size</span>
                                            <button type="button" id="font-size-decrease" class="text-resize-btn">A-</button>
                                            <button type="button" id="font-size-reset" class="text-resize-btn">Reset</button>
                                            <button type="button" id="font-size-increase" class="text-resize-btn">A+</button>
                                            <span id="font-size-display" class="text-text-secondary text-resize-display">100%</span>
                                        </div>
                                    </div>
                                </div>
                                <!-- NEW: Time Zone Setting -->
                                <div class="flex items-center justify-between mt-6 pt-4 border-t border-color">
                                    <span class="text-text-primary">Time Zone</span>
                                    <select id="timezone-selector" class="w-64 px-3 py-1.5 text-sm rounded-lg bg-gray-50 dark:bg-gray-700 text-text-primary border border-gray-300 dark:border-gray-600 focus:border-theme-primary focus:ring-theme-primary">
                                        <option>Loading timezones...</option>
                                    </select>
                                </div>

                                <!-- NEW: Login Screen Wallpaper URL -->
                                <div class="mt-6 pt-4 border-t border-color">
                                    <label for="login-bg-url-input" class="block text-text-primary font-medium mb-2">Login Screen Wallpaper URL</label>
                                    <div class="flex flex-col sm:flex-row gap-3 items-stretch sm:items-start">
                                        <input type="url" id="login-bg-url-input" placeholder="https://example.com/wallpaper.jpg" class="flex-1 px-4 py-2 rounded-lg bg-gray-50 dark:bg-gray-700 text-text-primary border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-theme-primary">
                                        <div class="flex gap-2">
                                            <button id="login-bg-save-btn" class="bg-theme-primary text-white font-semibold px-4 py-2 rounded-lg btn-glow">Save</button>
                                            <button id="login-bg-reset-btn" class="bg-gray-200 dark:bg-gray-700 text-text-primary font-semibold px-4 py-2 rounded-lg border border-color">Reset</button>
                                        </div>
                                    </div>
                                    <div id="login-bg-preview" class="mt-4 w-full h-40 rounded-lg bg-cover bg-center border border-color"></div>
                                    <p class="text-xs text-text-secondary mt-2">Tip: Use any publicly accessible image URL. This will apply to both the Login and PIN verification screens.</p>
                                </div>

                                <!-- NEW: Login Screen Profile Picture URL -->
                                <div class="mt-6 pt-4 border-t border-color">
                                    <label for="login-profile-url-input" class="block text-text-primary font-medium mb-2">Login Screen Profile Picture URL</label>
                                    <div class="flex flex-col sm:flex-row gap-3 items-stretch sm:items-start">
                                        <input type="url" id="login-profile-url-input" placeholder="https://example.com/avatar.jpg" class="flex-1 px-4 py-2 rounded-lg bg-gray-50 dark:bg-gray-700 text-text-primary border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-theme-primary">
                                        <div class="flex gap-2">
                                            <button id="login-profile-save-btn" class="bg-theme-primary text-white font-semibold px-4 py-2 rounded-lg btn-glow">Save</button>
                                            <button id="login-profile-reset-btn" class="bg-gray-200 dark:bg-gray-700 text-text-primary font-semibold px-4 py-2 rounded-lg border border-color">Reset</button>
                                        </div>
                                    </div>
                                    <div class="mt-4 flex items-center gap-3">
                                        <img id="login-profile-preview" src="" alt="Profile Preview" class="w-16 h-16 rounded-full border border-color object-cover bg-gray-100 dark:bg-gray-800">
                                        <p class="text-xs text-text-secondary">Shown at the top of the login form.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
                <footer class="admin-sticky-footer"></footer>
            </div>
        </div>
    </div>
    
    <!-- Order Details Modal -->
    <div id="order-details-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-secondary rounded-lg shadow-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center border-b border-color pb-3 mb-4">
                <h3 class="text-xl font-semibold text-text-primary">Order Details</h3>
                <button id="modal-close-btn" class="text-text-secondary text-3xl leading-none hover:text-text-primary">×</button>
            </div>
            <div id="modal-order-content" class="space-y-4">
                <p>Loading...</p>
            </div>
        </div>
    </div>
    
    <!-- Delivery Man Details Modal -->
    <div id="delivery-man-details-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-secondary rounded-lg shadow-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center border-b border-color pb-3 mb-4">
                <h3 class="text-xl font-semibold text-text-primary">Delivery Man Details</h3>
                <button id="delivery-modal-close-btn" class="text-text-secondary text-3xl leading-none hover:text-text-primary">×</button>
            </div>
            <div id="modal-delivery-man-content" class="space-y-4">
                <p>Loading...</p>
            </div>
        </div>
    </div>

    <!-- User Profile Modal -->
    <div id="user-profile-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-secondary rounded-lg shadow-xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center border-b border-color pb-3 mb-4">
                <h3 class="text-xl font-semibold text-text-primary">User Profile</h3>
                <button id="user-profile-modal-close-btn" class="text-text-secondary text-3xl leading-none hover:text-text-primary">×</button>
            </div>
            <div id="modal-user-profile-content" class="space-y-4">
                <p>Loading...</p>
            </div>
        </div>
    </div>


    <!-- New Order Alert Modal -->
    <div id="new-order-alert" class="fixed top-5 right-5 z-50 bg-secondary rounded-lg shadow-xl p-5 w-full max-w-sm transform transition-transform translate-x-full hidden">
        <div class="flex justify-between items-center border-b border-color pb-2 mb-3">
            <div class="flex items-center space-x-2">
                <i data-lucide="bell-ring" class="text-green-500"></i>
                <h3 class="text-lg font-semibold text-text-primary">New Order Received!</h3>
            </div>
            <button id="new-order-alert-close-btn" class="text-text-secondary text-3xl leading-none hover:text-text-primary">×</button>
        </div>
        <div id="new-order-alert-content" class="space-y-2 text-sm">
            <!-- Dynamic content will go here -->
        </div>
        <div class="mt-4 pt-3 border-t border-color flex justify-end">
             <button id="view-full-order-btn" class="px-4 py-2 bg-theme-primary text-white rounded-lg text-sm btn-glow">View Full Order</button>
        </div>
    </div>

    <!-- New Message Alert Modal -->
    <div id="new-message-alert" class="fixed bottom-5 right-5 z-50 bg-secondary rounded-lg shadow-xl p-5 w-full max-w-sm transform transition-transform translate-x-full hidden">
        <div class="flex justify-between items-center border-b border-color pb-2 mb-3">
            <div class="flex items-center space-x-2">
                <i data-lucide="message-square-text" class="text-blue-500"></i>
                <h3 class="text-lg font-semibold text-text-primary">New Message Received!</h3>
            </div>
            <button id="new-message-alert-close-btn" class="text-text-secondary text-3xl leading-none hover:text-text-primary">×</button>
        </div>
        <div id="new-message-alert-content" class="space-y-2 text-sm">
            <!-- Dynamic content will go here -->
        </div>
        <div class="mt-4 pt-3 border-t border-color flex justify-end">
             <button id="view-full-chat-btn" class="px-4 py-2 bg-theme-primary text-white rounded-lg text-sm btn-glow">View Chat</button>
        </div>
    </div>

    <!-- Live Visitors Modal -->
    <div id="live-visitors-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-secondary rounded-lg shadow-xl p-6 w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center border-b border-color pb-2 mb-4">
                <h3 class="text-xl font-semibold text-text-primary">Live Visitor Sessions</h3>
                <button id="live-visitors-modal-close" class="text-text-secondary hover:text-text-primary">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="text-xs font-semibold tracking-wide text-text-secondary uppercase border-b border-color bg-gray-50 dark:bg-gray-700">
                            <th class="px-4 py-3">Visitor</th>
                            <th class="px-4 py-3">Device</th>
                            <th class="px-4 py-3">IP Address</th>
                            <th class="px-4 py-3">Location</th>
                            <th class="px-4 py-3">Last Active</th>
                        </tr>
                    </thead>
                    <tbody id="live-visitors-table-body" class="divide-y border-color">
                        <tr class="text-text-primary"><td colspan="5" class="px-4 py-3 text-center">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-secondary rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 id="modal-title" class="text-xl font-semibold text-text-primary">Are you sure?</h3>
            <p id="modal-text" class="mt-2 text-text-secondary">This action cannot be undone.</p>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500">Cancel</button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg btn-glow-red">Confirm</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transition-transform transform translate-y-20 opacity-0"><p id="toast-message"></p></div>
    
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer=""></script>

    <script type="module">
        import { initializeApp, deleteApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, createUserWithEmailAndPassword, reauthenticateWithCredential, EmailAuthProvider, setPersistence, browserLocalPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, getDocs, addDoc, serverTimestamp, query, where, getCountFromServer, doc, getDoc, deleteDoc, updateDoc, writeBatch, increment, setDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        /*
            SECURITY NOTE:
            - The Firebase configuration is exposed on the client-side. In a production environment,
              it's crucial to secure your data using Firestore Security Rules.
            - Admin PINs are stored as plaintext. This is not recommended. For a production
              system, PINs/passwords should be hashed using a secure, one-way algorithm (e.g., bcrypt)
              on a server-side environment (like Cloud Functions) before being stored.
            - Deleting delivery men only removes their Firestore record, not their Firebase Authentication
              account, which requires a backend with the Admin SDK. This implementation uses a "soft delete"
              (freezing the account) to prevent orphaned auth accounts.
        */

        // --- Firebase Config & Initialization ---
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
          apiKey: "AIzaSyBIRNr3X-_xOHQ6ITW3pXgqgcjhP2xEEEA",
          authDomain: "tangailbuzz47.firebaseapp.com",
          projectId: "tangailbuzz47",
          storageBucket: "tangailbuzz47.appspot.com",
          messagingSenderId: "1017968115713",
          appId: "1:1017968115713:web:967a0e13107d8816b44000",
          measurementId: "G-7HYDCZTN2H"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let currentUserProfile = null;
        
        // Use a persistent user ID for the anonymous session if no custom token is available.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const userId = auth.currentUser?.uid || crypto.randomUUID();

        // --- State Management & Constants---
        let allProducts = [];
        let allOrders = [];
        let currentProductCategoryFilter = 'all';
        let currentProductSubCategoryFilter = 'all';
    let showDuplicatesOnly = false; // When true, render only duplicated products
    let currentOrderStatusFilter = 'all';
    let duplicateIdSet = new Set(); // computed across all products (global detection)
        let allDeliveryMen = [];
        let notifications = [];
        let confirmCallback = null;
        let unsubscribeListeners = [];
        let allUsersMap = new Map();
        let currentChatUserId = null;
        let unsubscribeMessages = null;
        let initialChatLoadComplete = false;
        let lastChatsSnapshot = null; 
        let initialUsersLoadComplete = false;
        let clockInterval = null;
    let lastTopSalesData = [];
    let lastTopRatedData = [];
    let totalUsersCount = null;
    let totalDeliveryMenCount = null;
    let activeCouponsCount = null;
    let lastDashboardUpdateAt = null;
    const reportsState = { startMs: null, endMs: null, rows: [] };
    const REPORTS_DEFAULT_RANGE_DAYS = 0; // 0 = all time by default
    let reportsPageInitialized = false;
    // Live visitors (website presence) tracking
    let liveVisitorsIntervalId = null;
    let unsubscribePresence = null;
    let lastPresenceDocs = [];
    const PRESENCE_ACTIVE_WINDOW_MS = 2 * 60 * 1000; // consider visitors active if pinged in last 2 minutes

        const UI = {
            loadingSpinner: document.getElementById('loading-spinner'),
            loginScreen: document.getElementById('login-screen'),
            adminPanel: document.getElementById('admin-panel'),
            loginForm: document.getElementById('login-form'),
            loginError: document.getElementById('login-error'),
            pageTitle: document.getElementById('page-title'),
            navLinks: document.querySelectorAll('.nav-link'),
            pages: document.querySelectorAll('.page-content'),
            notificationList: document.getElementById('notification-list'),
            notificationCountBadge: document.getElementById('notification-count'),
            orderDetailsModal: document.getElementById('order-details-modal'),
            orderDetailsContent: document.getElementById('modal-order-content'),
            orderDetailsCloseBtn: document.getElementById('modal-close-btn'),
            deliveryManDetailsModal: document.getElementById('delivery-man-details-modal'),
            deliveryManDetailsContent: document.getElementById('modal-delivery-man-content'),
            deliveryManModalCloseBtn: document.getElementById('delivery-modal-close-btn'),
            userProfileModal: document.getElementById('user-profile-modal'),
            userProfileModalContent: document.getElementById('modal-user-profile-content'),
            userProfileModalCloseBtn: document.getElementById('user-profile-modal-close-btn'),
            confirmationModal: document.getElementById('confirmation-modal'),
            newOrderAlert: document.getElementById('new-order-alert'),
            newMessageAlert: document.getElementById('new-message-alert'),
            liveVisitorsModal: document.getElementById('live-visitors-modal'),
            liveVisitorsModalCloseBtn: document.getElementById('live-visitors-modal-close'),
            liveVisitorsTableBody: document.getElementById('live-visitors-table-body'),
            // PIN verification removed
        };
        
    const PAGE_TITLES = { dashboard: 'Dashboard', chat: 'Live Chat', products: 'All Products', 'low-stock': 'Low Stock Products', 'reports': 'Reports', 'top-sales': 'Top Sales', 'top-rated': 'Top Rated Products', 'flash-sale': 'Flash Sale Products', 'mega-sale': 'Mega Sale Products', 'add-product': 'Add Product', 'edit-product': 'Edit Product', banners: 'Banner Management', 'side-promo': 'Side Promo', coupons: 'Coupon Management', orders: 'All Orders', users: 'All Users', delivery: 'Delivery Management', settings: 'Settings' };

        const CATEGORY_MAP = {
            'electronics': 'Electronics',
            'fashion': 'Fashion',
            'home-garden': 'Home & Garden',
            'health-beauty': 'Health & Beauty',
            'sports-outdoors': 'Sports & Outdoors',
            'books-stationery': 'Books & Stationery',
            'kids-toys': 'Kids & Toys',
            // Align with frontend slug naming
            'cars': 'Cars & Bikes'
        };

        const SUB_CATEGORY_MAP = {
            'electronics': ['Mobile Phone', 'Laptop & Computer', 'Tablet', 'TV & Home Theater', 'Headphone & Speaker', 'Camera & Accessories', 'Wearable Smart Watch', 'Gaming Console'],
            // Trimmed to match simplified frontend filter options
            'fashion': ['Men\'s Clothing', 'Women\'s Clothing', 'Kids\' Clothing', 'Shoes & Sandals', 'Watch & Jewelry', 'Bags & Accessories', 'Traditional Wear'],
            'home-garden': ['Furniture', 'Kitchen Items', 'Home Decor', 'Lighting', 'Garden Tools', 'Home Appliances', 'Storage & Organizer'],
            // Consolidated grooming accessories per frontend scope
            'health-beauty': ['Skincare', 'Haircare', 'Makeup', 'Perfume', 'Health Supplement', 'Fitness Equipment', 'Personal Care', 'Oral Care'],
            'sports-outdoors': ['Sports Apparel', 'Sports Shoes', 'Fitness Gear', 'Cycles', 'Gym Equipment', 'Outdoor Camping Gear', 'Football, Cricket, Badminton Items'],
            'books-stationery': ['Educational Books', 'Story Books', 'Religious Books', 'Office Stationery', 'School Stationery', 'Notebook & Diary', 'Arts & Crafts Supplies'],
            // Removed ride-on items to mirror the storefront taxonomy
            'kids-toys': ['Educational Toys', 'Soft Toys', 'Dolls & Action Figures', 'Games & Puzzles', 'Outdoor Toys', 'Remote Control Toys', 'Lego & Building Blocks'],
            'cars': ['Car Accessories', 'Bike Accessories', 'Helmets & Riding Gear', 'Tires & Wheels', 'Car Care Products', 'Motor Oil & Lubricants', 'Electric Scooters & Bikes']
        };

        // --- Helper & Utility Functions ---
        const formatDateDivider = (date) => {
            const now = new Date();
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterdayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);

            const options = { day: 'numeric', month: 'long', year: 'numeric' };

            if (date >= todayStart) {
                return `Today, ${date.toLocaleDateString([], options)}`;
            }
            if (date >= yesterdayStart) {
                return `Yesterday, ${date.toLocaleDateString([], options)}`;
            }
            return date.toLocaleDateString([], options);
        };

        const formatTimestamp = (timestamp) => {
            if (!timestamp || !timestamp.toDate) {
                try {
                    // Fallbacks for non-Firestore timestamp values
                    if (timestamp instanceof Date) return timestamp.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: true });
                    if (typeof timestamp === 'number') return new Date(timestamp).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: true });
                    if (typeof timestamp === 'string') {
                        const d = new Date(timestamp);
                        if (!isNaN(d)) return d.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: true });
                    }
                } catch {}
                return '';
            }
            const date = timestamp.toDate();
            const now = new Date();
            const diffSeconds = Math.round((now - date) / 1000);

            if (diffSeconds < 60) {
                return 'Just now';
            }
            if (diffSeconds < 3600) {
                return `${Math.floor(diffSeconds / 60)} min ago`;
            }

            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterdayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);

            if (date >= todayStart) {
                // Return time like "10:30 AM" for today
                return date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: true });
            }
            if (date >= yesterdayStart) {
                return 'Yesterday';
            }

            // Return date like "30/09/2025" for older messages
            return date.toLocaleDateString([], { day: '2-digit', month: '2-digit', year: 'numeric' });
        };

        // Safe join date formatter that tolerates different types
        const formatJoinDate = (value, withTime = false) => {
            try {
                if (!value) return 'N/A';
                let date = null;
                if (typeof value?.toDate === 'function') {
                    date = value.toDate();
                } else if (value instanceof Date) {
                    date = value;
                } else if (typeof value === 'number') {
                    date = new Date(value < 1e12 ? value * 1000 : value);
                } else if (typeof value === 'string') {
                    const parsed = new Date(value);
                    if (!isNaN(parsed)) date = parsed;
                }
                if (!date) return 'N/A';
                return withTime ? date.toLocaleString() : date.toLocaleDateString();
            } catch (e) {
                return 'N/A';
            }
        };
        const escapeHtml = (value) => {
            if (value === undefined || value === null) return '';
            return String(value).replace(/[&<>"']/g, (char) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[char]));
        };

        const coerceToDate = (value) => {
            if (!value && value !== 0) return null;
            if (value instanceof Date) {
                return Number.isNaN(value.getTime()) ? null : value;
            }
            if (typeof value?.toDate === 'function') {
                try {
                    const converted = value.toDate();
                    return (converted instanceof Date && !Number.isNaN(converted.getTime())) ? converted : null;
                } catch (_) {
                    return null;
                }
            }
            if (typeof value === 'object' && typeof value.seconds === 'number') {
                const millis = value.seconds * 1000 + ((value.nanoseconds || 0) / 1e6);
                const date = new Date(millis);
                return Number.isNaN(date.getTime()) ? null : date;
            }
            if (typeof value === 'number') {
                if (!Number.isFinite(value)) return null;
                const millis = value > 1e12 ? value : value * 1000;
                const date = new Date(millis);
                return Number.isNaN(date.getTime()) ? null : date;
            }
            if (typeof value === 'string') {
                const trimmed = value.trim();
                if (!trimmed) return null;
                if (/^-?\d+(\.\d+)?$/.test(trimmed)) {
                    const numeric = Number(trimmed);
                    if (Number.isFinite(numeric)) {
                        const millis = numeric > 1e12 ? numeric : numeric * 1000;
                        const numericDate = new Date(millis);
                        if (!Number.isNaN(numericDate.getTime())) return numericDate;
                    }
                }
                const isoCandidate = trimmed.includes('T') ? trimmed : trimmed.replace(' ', 'T');
                const parsedIso = new Date(isoCandidate);
                if (!Number.isNaN(parsedIso.getTime())) return parsedIso;
                const parsed = new Date(trimmed);
                return Number.isNaN(parsed.getTime()) ? null : parsed;
            }
            return null;
        };
        
        const showToast = (message, type = 'success') => {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            
            const typeClasses = {
                success: 'bg-green-500 text-white',
                error: 'bg-red-500 text-white',
                warning: 'bg-yellow-500 text-black'
            };

            toast.className = `fixed bottom-5 right-5 py-2 px-4 rounded-lg shadow-lg transition-transform transform translate-y-20 opacity-0 ${typeClasses[type] || typeClasses.success}`;
            setTimeout(() => {
                toast.className = toast.className.replace('translate-y-20 opacity-0', 'translate-y-0 opacity-100');
            }, 10); // show fast
            setTimeout(() => {
                toast.className = toast.className.replace('translate-y-0 opacity-100', 'translate-y-20 opacity-0');
            }, 3000);
        };

        const handleSnapshotError = (context) => (error) => {
            console.error(`Error loading ${context}:`, error);
            showToast(`Could not load ${context}!`, 'error');
        };

        // --- Sound Effects Logic ---
        let audioCtx;
        const initAudio = () => {
            if (!audioCtx) {
                try {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    // Some browsers require a "silent" sound to be played to fully unlock the audio context.
                    const buffer = audioCtx.createBuffer(1, 1, 22050);
                    const source = audioCtx.createBufferSource();
                    source.buffer = buffer;
                    source.connect(audioCtx.destination);
                    source.start(0);
                    console.log("AudioContext initialized and unlocked.");
                } catch (e) {
                    console.warn("Web Audio API is not supported in this browser.");
                }
            }
        };

        const playSound = async (type) => {
            if (!audioCtx) {
                console.warn("AudioContext not initialized. Cannot play sound.");
                return;
            }

            if (audioCtx.state === 'suspended') {
                await audioCtx.resume();
            }

            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            gainNode.gain.setValueAtTime(0, audioCtx.currentTime);

            switch (type) {
                case 'newOrder':
                    // Two quick, high-pitched beeps
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(880, audioCtx.currentTime); // A5
                    gainNode.gain.linearRampToValueAtTime(0.5, audioCtx.currentTime + 0.05);
                    gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.15);
                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + 0.15);

                    // Schedule the second beep
                    const osc2 = audioCtx.createOscillator();
                    const gain2 = audioCtx.createGain();
                    osc2.connect(gain2);
                    gain2.connect(audioCtx.destination);
                    gain2.gain.setValueAtTime(0, audioCtx.currentTime + 0.15);
                    osc2.type = 'sine';
                    osc2.frequency.setValueAtTime(1046.5, audioCtx.currentTime + 0.15); // C6
                    gain2.gain.linearRampToValueAtTime(0.5, audioCtx.currentTime + 0.15 + 0.05);
                    gain2.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.15 + 0.15);
                    osc2.start(audioCtx.currentTime + 0.15);
                    osc2.stop(audioCtx.currentTime + 0.15 + 0.15);
                    break;
                case 'newMessage':
                    // A single, softer beep
                    oscillator.type = 'triangle';
                    oscillator.frequency.setValueAtTime(659.25, audioCtx.currentTime); // E5
                    gainNode.gain.linearRampToValueAtTime(0.4, audioCtx.currentTime + 0.05);
                    gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.2);
                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + 0.3);
                    break;
                case 'logout':
                    // A descending tone
                    oscillator.type = 'sawtooth';
                    oscillator.frequency.setValueAtTime(440, audioCtx.currentTime); // A4
                    oscillator.frequency.linearRampToValueAtTime(220, audioCtx.currentTime + 0.3);
                    gainNode.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + 0.05);
                    gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.3);
                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + 0.4);
                    break;
                case 'login':
                    // An ascending tone
                    oscillator.type = 'square';
                    oscillator.frequency.setValueAtTime(220, audioCtx.currentTime); // A3
                    oscillator.frequency.linearRampToValueAtTime(440, audioCtx.currentTime + 0.2);
                    gainNode.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + 0.05);
                    gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.2);
                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + 0.3);
                    break;
            }
        };

        const playWelcomeMessage = () => {
            if ('speechSynthesis' in window) {
                // Using Bengali script for better pronunciation by TTS engines
                const utterance = new SpeechSynthesisUtterance("হ্যালো অ্যাডমিন, টাঙ্গাইল বাজ অ্যাডমিন ওয়ার্ল্ডে আপনাকে স্বাগতম");

                const setVoice = () => {
                    const voices = window.speechSynthesis.getVoices();
                    let femaleVoice = voices.find(voice => voice.lang === 'bn-BD' && (voice.name.toLowerCase().includes('female') || voice.gender === 'female'));
                    if (!femaleVoice) {
                        femaleVoice = voices.find(voice => voice.lang === 'bn-IN' && (voice.name.toLowerCase().includes('female') || voice.gender === 'female'));
                    }
                    if (!femaleVoice) {
                        femaleVoice = voices.find(voice => voice.lang.startsWith('bn')); // Any Bengali voice as a fallback
                    }
                     if (!femaleVoice) {
                        femaleVoice = voices.find(voice => voice.lang.startsWith('en') && voice.gender === 'female'); // Fallback to English female
                    }

                    if (femaleVoice) {
                        utterance.voice = femaleVoice;
                    }
                    
                    utterance.lang = 'bn-BD';
                    utterance.rate = 0.9; // Slightly slower for clarity
                    utterance.pitch = 1.1;

                    window.speechSynthesis.speak(utterance);
                };

                // Voices can load asynchronously.
                if (window.speechSynthesis.getVoices().length === 0) {
                    window.speechSynthesis.onvoiceschanged = setVoice;
                } else {
                    setVoice();
                }
            } else {
                console.warn("Speech Synthesis not supported in this browser.");
            }
        };

        // Visual welcome overlay shown after successful login
        const showWelcomeOverlay = () => {
            const overlay = document.getElementById('welcome-overlay');
            if (!overlay) return;
            // Show with fade-in
            overlay.classList.remove('hidden');
            overlay.style.opacity = '0';
            // Force reflow to ensure transition applies
            void overlay.offsetHeight;
            overlay.style.opacity = '1';

            const hide = () => {
                overlay.style.opacity = '0';
                setTimeout(() => overlay.classList.add('hidden'), 700);
                // Clean up listeners
                overlay.removeEventListener('click', hide);
                document.removeEventListener('keydown', onKeyDown);
            };
            const onKeyDown = (e) => {
                if (e.key === 'Enter' || e.key === ' ' || e.key === 'Escape') {
                    e.preventDefault();
                    hide();
                }
            };
            // Only dismiss on user interaction (click or key)
            overlay.addEventListener('click', hide);
            document.addEventListener('keydown', onKeyDown);
        };

        // --- Clock Logic ---
        const updateClock = () => {
            const clockElement = document.getElementById('digital-clock');
            if (!clockElement) return;

            const timeZone = localStorage.getItem('adminTimeZone') || 'Asia/Riyadh'; // Default to Saudi time
            
            try {
                const now = new Date();
                
                const dateOptions = {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    timeZone: timeZone
                };

                const timeOptions = {
                    hour12: true,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    timeZone: timeZone
                };

                const dateString = now.toLocaleDateString('en-GB', dateOptions);
                const timeString = now.toLocaleTimeString('en-US', timeOptions);
                
                // Display date and time on two separate lines
                clockElement.innerHTML = `
                    <div class="text-xs font-medium">${dateString}</div>
                    <div class="text-lg font-semibold">${timeString}</div>
                `;

            } catch (e) {
                console.error("Invalid time zone:", timeZone, e);
                localStorage.removeItem('adminTimeZone'); // Clear invalid setting
                clockElement.textContent = new Date().toLocaleString('en-US');
            }
        };

        const startClock = () => {
            if (!document.getElementById('digital-clock')) {
                stopClock();
                return;
            }
            if (clockInterval) clearInterval(clockInterval);
            updateClock(); // Initial display
            clockInterval = setInterval(updateClock, 1000);
        };

        const stopClock = () => {
            if (clockInterval) clearInterval(clockInterval);
            clockInterval = null;
        };
// --- BULK UPLOAD CSV LOGIC ---

/**
 * CSV টেক্সট পার্স করে একটি JavaScript অবজেক্ট অ্যারেতে রূপান্তর করে।
 * @param {string} csvText - CSV ফাইলের সম্পূর্ণ টেক্সট।
 * @returns {Array<Object>} প্রোডাক্ট ডেটার অ্যারে।
 */
const parseCsvLine = (line) => {
    const values = [];
    let current = '';
    let inQuotes = false;
    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
            if (inQuotes && line[i + 1] === '"') {
                current += '"';
                i++;
            } else {
                inQuotes = !inQuotes;
            }
        } else if (char === ',' && !inQuotes) {
            values.push(current);
            current = '';
        } else {
            current += char;
        }
    }
    values.push(current);
    return values;
};

const parseCSV = (csvText) => {
    const parseBooleanField = (raw) => {
        if (raw === undefined || raw === null) return false;
        const normalized = String(raw).trim().toLowerCase();
        if (!normalized) return false;
        if (['true', 'yes', '1', 'on', 'enabled', 'y'].includes(normalized)) return true;
        if (['false', 'no', '0', 'off', 'disabled', 'n'].includes(normalized)) return false;
        return false;
    };

    const parseNumberField = (raw) => {
        if (raw === undefined || raw === null) return 0;
        const cleaned = String(raw).replace(/[^0-9+\-.]/g, '').trim();
        if (!cleaned) return 0;
        const parsed = parseFloat(cleaned);
        return Number.isNaN(parsed) ? 0 : parsed;
    };

    const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== '');
    if (lines.length === 0) return [];

    // Header row কে কমা দ্বারা ভাগ করে key হিসেবে ব্যবহার করা
    const headers = parseCsvLine(lines[0]).map(header => header.trim());
    const result = [];

    for (let i = 1; i < lines.length; i++) {
        const values = parseCsvLine(lines[i].replace(/\r$/, ''));
        if (values.length < headers.length) {
            while (values.length < headers.length) values.push('');
        } else if (values.length > headers.length) {
            console.warn(`Trimming extra columns on line ${i + 1}. Found ${values.length}, expected ${headers.length}.`);
            values.length = headers.length;
        }

        const obj = {};
        // Collect raw Specification Description chunks (may come from one or more columns)
        const specDescriptionChunks = [];
        // Collect unlimited thumbnails
        const thumbnails = [];

        headers.forEach((header, index) => {
            const rawValue = values[index] ?? '';
            let value = String(rawValue).trim();
            const headerKey = header.trim().toLowerCase();
            let key;

            // আপনার CSV header-কে কোডের key-তে রূপান্তর (Mapping)
            switch (headerKey) {
                case 'product name': key = 'name'; break;
                case 'main price': key = 'mainPrice'; break;
                case 'offer price': key = 'offerPrice'; break;
                case 'discount %': key = 'discount'; break;
                case 'stock count': key = 'stock'; break;
                case 'cost price':
                case 'cost price (৳)':
                case 'cost price ৳':
                case 'purchase price':
                case 'buying price':
                case 'unit cost':
                case 'base cost':
                    key = 'costPrice';
                    break;
                // 'Rating' ফিল্ডটি CSV-তে নেই, তাই এটিকে বাদ দেওয়া হলো।
                case 'on offer': key = 'isOnOffer'; break;
                case 'refundable': key = 'isRefundable'; break;
                case 'main image url': key = 'imageUrl'; break; // নতুন মেইন ইমেজ ফিল্ড
                // Backward compatibility: single thumbnail column
                case 'thumbnil image url': {
                    // Support multiple URLs in a single cell separated by | ; or whitespace
                    const parts = String(value).split(/\s*[|;\n]\s*/).map(s => s.trim()).filter(Boolean);
                    thumbnails.push(...parts);
                    return;
                }
                // New: combined thumbnails column (comma-safe in CSV if quoted)
                case 'thumbnails':
                case 'thumbnail urls':
                case 'thumbnail url':
                case 'thumbnail': {
                    const parts = String(value).split(/\s*[|;\n]\s*/).map(s => s.trim()).filter(Boolean);
                    thumbnails.push(...parts);
                    return;
                }
                case 'description': key = 'details'; break;
                case 'sub-category': key = 'subcategory'; break;
                case 'category': key = 'category'; break;
                case 'brand': key = 'brand'; break;
                case 'warranty': key = 'warranty'; break;
                case 'specifications description': {
                    if (value) specDescriptionChunks.push(value);
                    return; // handled
                }
                case 'flash sale':
                case 'flash sale enabled':
                case 'flashsale':
                case 'flashsaleenabled':
                case 'flash sale active':
                case 'flash enabled':
                case 'flash enabled?':
                case 'flash sell':
                case 'flash sell enabled':
                case 'flashsell':
                case 'flashsellenabled':
                case 'flash deal':
                case 'flash deal enabled':
                case 'flashdeal':
                case 'flashdealenabled':
                case 'flash offer':
                case 'flash offer enabled':
                case 'is flash sale':
                case 'is flashsale':
                case 'isflashsale':
                    obj.flashSaleEnabled = parseBooleanField(value);
                    return;
                case 'flash sale price':
                case 'flashsale price':
                case 'flashsaleprice':
                case 'flash price':
                case 'flash price ৳':
                case 'flashprice':
                case 'flash sell price':
                case 'flashsell price':
                case 'flashsellprice':
                case 'flash deal price':
                case 'flashdeal price':
                case 'flashdealprice':
                case 'flash offer price':
                case 'flashofferprice':
                    obj.flashPrice = parseNumberField(value);
                    return;
                case 'flash sale start':
                case 'flashsale start':
                case 'flash sale start date':
                case 'flash sale start time':
                case 'flash start':
                case 'flash start date':
                case 'flash start time':
                case 'flashstart':
                case 'flashstartdate':
                case 'flashstarttime':
                case 'flash sale from':
                case 'flash from':
                case 'flash start at':
                case 'flash start datetime':
                    obj.flashStart = value;
                    return;
                case 'flash sale end':
                case 'flashsale end':
                case 'flash sale end date':
                case 'flash sale end time':
                case 'flash end':
                case 'flash end date':
                case 'flash end time':
                case 'flashend':
                case 'flashenddate':
                case 'flashendtime':
                case 'flash sale to':
                case 'flash to':
                case 'flash end at':
                case 'flash end datetime':
                    obj.flashEnd = value;
                    return;
                default: key = headerKey.replace(/\s/g, ''); 
            }
            
            // ডেটা টাইপ রূপান্তর: সংখ্যা, বুলিয়ান ইত্যাদি।
            if (key === 'mainPrice' || key === 'offerPrice' || key === 'stock' || key === 'discount' || key === 'costPrice') {
                obj[key] = parseNumberField(value);
            } else if (key === 'isOnOffer' || key === 'isRefundable') {
                obj[key] = parseBooleanField(value);
            } else {
                obj[key] = value;
            }
        });
        
        // *গুরুত্বপূর্ণ ফিক্স:* ক্যাটাগরি ID কে ছোট হাতের অক্ষরে রূপান্তর করা হচ্ছে
        if (obj.category && typeof obj.category === 'string') {
            obj.category = obj.category.toLowerCase().replace(/\s/g, '-').replace('&', 'and');
            if (obj.category === 'cars-bikes') obj.category = 'cars';
        }

        // Heuristic: also pick up columns that look like thumbnail or gallery slots (e.g., Thumbnail 1, Image2, Gallery3)
        headers.forEach((header, idx) => {
            const h = header.trim();
            if (!h) return;
            // Skip the main image header explicitly
            if (h.toLowerCase() === 'main image url') return;
            const val = values[idx] ? String(values[idx]).trim().replace(/^"|"$/g, '') : '';
            if (!val) return;
            const isThumbHeader = /^(thumb(nail)?(\s*\d+)?|image\s*([2-9]|\d{2,})|gallery\s*\d+)$/i.test(h) || /thumbnail/.test(h.toLowerCase());
            if (isThumbHeader) {
                const parts = val.split(/\s*[|;\n]\s*/).map(s => s.trim()).filter(Boolean);
                thumbnails.push(...parts);
            }
        });

        // Normalize thumbnails: trim, remove empty, dedupe, and keep only plausible URLs
        const seen = new Set();
        const normalizedThumbs = [];
        thumbnails.forEach(u => {
            const t = u.trim();
            if (!t) return;
            // Basic plausibility check (allow http, https, data URIs)
            if (!/^https?:\/\//i.test(t) && !/^data:image\//i.test(t)) return;
            if (seen.has(t)) return;
            seen.add(t);
            normalizedThumbs.push(t);
        });

        obj.thumbnails = normalizedThumbs;
        // If no explicit main image provided, use first thumbnail as imageUrl
        if ((!obj.imageUrl || obj.imageUrl === '') && obj.thumbnails.length > 0) {
            obj.imageUrl = obj.thumbnails[0];
        }
        
    // Specifications Description কে একটি specification object এ যুক্ত করা (Key:Value | Key2:Value2)
    const specificationDescription = specDescriptionChunks.join('\n').trim();
    let specsObj = {};
    if (specificationDescription) {
        // Split into pairs by pipe or newline; tolerate multiple separators
        const pairs = specificationDescription.split(/[|\n]+/).map(s => s.trim()).filter(Boolean);
        for (const pair of pairs) {
            // Split only on the first colon to allow colons in the value
            const idx = pair.indexOf(':');
            if (idx === -1) continue; // skip invalid pair
            const rawKey = pair.slice(0, idx).trim();
            const rawVal = pair.slice(idx + 1).trim();
            if (!rawKey || !rawVal) continue;
            specsObj[rawKey] = rawVal;
        }
    }

    // Fallback: if no valid pairs were parsed, store full text under Details
    obj.specification = Object.keys(specsObj).length > 0
        ? specsObj
        : (specificationDescription ? { "Details": specificationDescription } : {});

        // যদি Rating না থাকে, তবে ০ সেট করা
        obj.rating = obj.rating !== undefined ? Number(obj.rating) : 0; 

        // যদি Category ID সঠিক না হয়, তবে প্রোডাক্ট স্কিপ করা
        if (obj.category && !CATEGORY_MAP[obj.category]) {
            console.warn(`Skipping product ${obj.name}: Invalid category key '${obj.category}'.`);
            continue;
        }

        result.push(obj);
    }
    return result;
};


const BULK_UPLOAD_TEMPLATE_HEADERS = [
    'Product Name',
    'Category',
    'Sub-Category',
    'Brand',
    'Main Price',
    'Offer Price',
    'Cost Price',
    'Discount %',
    'Stock Count',
    'Main Image URL',
    'Thumbnail URLs',
    'Description',
    'Specifications Description',
    'Warranty',
    'On Offer',
    'Refundable',
    'Flash Sale Enabled',
    'Flash Sale Price',
    'Flash Sale Start',
    'Flash Sale End'
];

const BULK_UPLOAD_TEMPLATE_SAMPLE = [
    'Classic Silk Sharee',
    'fashion',
    'Women Clothing',
    'Tangail Buzz',
    '1200',
    '999',
    '750',
    '20',
    '50',
    'https://example.com/images/sharee-main.jpg',
    'https://example.com/images/sharee-1.jpg | https://example.com/images/sharee-2.jpg',
    'Soft silk sharee ideal for festive seasons.',
    'Color:Red | Fabric:Silk | Length:5.5m',
    '7 Days Replacement',
    'Yes',
    'Yes',
    'No',
    '',
    '',
    ''
];

const buildCsvRow = (values) => values.map(val => {
    const str = String(val ?? '').replace(/"/g, '""');
    return str.includes(',') || str.includes('\n') || str.includes('"') ? `"${str}"` : str;
}).join(',');

const templateBoolean = (value) => {
    if (value === undefined || value === null) return '';
    return value ? 'Yes' : 'No';
};

const templateNumeric = (value) => {
    if (value === undefined || value === null || value === '') return '';
    if (typeof value === 'number') {
        return Number.isFinite(value) ? value : '';
    }
    if (typeof value === 'string') {
        const trimmed = value.trim();
        if (!trimmed) return '';
        const parsed = Number(trimmed.replace(/[^0-9+\-.]/g, ''));
        return Number.isNaN(parsed) ? trimmed : parsed;
    }
    return '';
};

const templateThumbnails = (data) => {
    if (Array.isArray(data?.thumbnails) && data.thumbnails.length) return data.thumbnails.join(' | ');
    if (Array.isArray(data?.images) && data.images.length) return data.images.join(' | ');
    if (typeof data?.gallery === 'string') return data.gallery;
    return '';
};

const templateSpecification = (spec) => {
    if (!spec) return '';
    if (typeof spec === 'string') return spec;
    if (Array.isArray(spec)) {
        return spec.map(item => {
            if (typeof item === 'string') return item;
            if (item && typeof item === 'object') {
                const [k, v] = Object.entries(item)[0] || [];
                return k && v ? `${k}:${v}` : '';
            }
            return '';
        }).filter(Boolean).join(' | ');
    }
    if (typeof spec === 'object') {
        return Object.entries(spec)
            .filter(([k, v]) => k && v !== undefined && v !== null && v !== '')
            .map(([k, v]) => `${k}:${v}`)
            .join(' | ');
    }
    return '';
};

const resolveCostPrice = (data) => {
    const candidates = [data.costPrice, data.purchasePrice, data.buyingPrice, data.basePrice, data.mainPrice, data.offerPrice];
    for (const candidate of candidates) {
        const normalized = templateNumeric(candidate);
        if (normalized !== '') return normalized;
    }
    return '';
};

const productDocToTemplateRow = (doc) => {
    const data = typeof doc?.data === 'function' ? doc.data() : doc || {};
    const thumbString = templateThumbnails(data);
    const description = data.details || data.description || data.longDescription || '';
    const specString = templateSpecification(data.specification || data.specifications || data.specs || '');
    const flashEnabled = templateBoolean(
        data.flashSaleEnabled ?? data.flashEnabled ?? data.flashSale?.enabled ?? false
    );
    const flashPrice = templateNumeric(
        data.flashPrice ?? data.flashSalePrice ?? (data.flashSale && data.flashSale.price)
    );
    const flashStart = data.flashStart || data.flashSaleStart || (data.flashSale && data.flashSale.start) || '';
    const flashEnd = data.flashEnd || data.flashSaleEnd || (data.flashSale && data.flashSale.end) || '';

    return [
        data.name || '',
        data.category || '',
        data.subcategory || '',
        data.brand || '',
        templateNumeric(data.mainPrice ?? data.price ?? data.sellingPrice ?? ''),
        templateNumeric(data.offerPrice ?? data.salePrice ?? ''),
        resolveCostPrice(data),
        templateNumeric(data.discount ?? data.discountPercentage ?? ''),
        templateNumeric(data.stock ?? data.quantity ?? ''),
        data.imageUrl || data.mainImage || '',
        thumbString,
        description,
        specString,
        data.warranty || '',
        templateBoolean(data.isOnOffer ?? data.onOffer ?? false),
        templateBoolean(data.isRefundable ?? data.refundable ?? false),
        flashEnabled,
        flashPrice,
        flashStart,
        flashEnd
    ];
};

const getSelectedProductDocs = () => {
    const container = document.getElementById('products-page');
    if (!container) return [];
    const checkboxes = Array.from(container.querySelectorAll('input.row-select[data-coll="products"]:checked'));
    if (!checkboxes.length) return [];
    const selectedIds = new Set(checkboxes.map(cb => cb.dataset.id));
    return (allProducts || []).filter(doc => selectedIds.has(doc.id));
};

const downloadBulkTemplate = (selectedDocs = []) => {
    const rows = [buildCsvRow(BULK_UPLOAD_TEMPLATE_HEADERS)];
    if (Array.isArray(selectedDocs) && selectedDocs.length) {
        selectedDocs.forEach(doc => rows.push(buildCsvRow(productDocToTemplateRow(doc))));
    } else {
        rows.push(buildCsvRow(BULK_UPLOAD_TEMPLATE_SAMPLE));
    }

    const csvContent = rows.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'tangailbuzz-product-template.csv';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    setTimeout(() => URL.revokeObjectURL(url), 0);

    if (selectedDocs.length) {
        showToast(`Template downloaded with ${selectedDocs.length} selected product${selectedDocs.length > 1 ? 's' : ''}.`, 'success');
    } else {
        showToast('Template downloaded. Update the sample row with your products.', 'success');
    }
};


/**
 * পার্স করা ডেটা Firestore-এ বাল্ক সেভ করে।
 * @param {Array<Object>} products - প্রোডাক্ট ডেটার অ্যারে।
 */
const saveBulkProducts = async (products) => {
    if (products.length === 0) {
        showToast("No valid product data found in CSV.", "warning");
        return;
    }

    const normalizeKey = (key) => (typeof key === 'string' ? key.toLowerCase().replace(/[\s_\-]/g, '') : '');

    const createNormalizedKeyMap = (obj) => {
        if (!obj || typeof obj !== 'object') return {};
        return Object.keys(obj).reduce((acc, key) => {
            const normalized = normalizeKey(key);
            if (!normalized) return acc;
            acc[normalized] = key;
            return acc;
        }, {});
    };

    const pickValueFromKeys = (source, keyMap, candidates) => {
        for (const candidate of candidates) {
            const normalizedCandidate = normalizeKey(candidate);
            const actualKey = keyMap[normalizedCandidate];
            if (actualKey === undefined) continue;
            const value = source[actualKey];
            if (value === undefined || value === null) continue;
            if (typeof value === 'string' && value.trim() === '') continue;
            return value;
        }
        return undefined;
    };

    const parseBooleanish = (value) => {
        if (value === undefined || value === null) return undefined;
        if (typeof value === 'boolean') return value;
        if (typeof value === 'number') {
            if (Number.isNaN(value)) return undefined;
            return value !== 0;
        }
        if (typeof value === 'string') {
            const normalized = value.trim().toLowerCase();
            if (!normalized) return undefined;
            if (['true', 'yes', '1', 'on', 'enabled', 'y'].includes(normalized)) return true;
            if (['false', 'no', '0', 'off', 'disabled', 'n'].includes(normalized)) return false;
        }
        return undefined;
    };

    const parseNumberish = (value) => {
        if (value === undefined || value === null || value === '') return undefined;
        if (typeof value === 'number') {
            if (Number.isNaN(value)) return undefined;
            return value;
        }
        if (typeof value === 'string') {
            const cleaned = value.replace(/[^0-9+\-.]/g, '').trim();
            if (!cleaned) return undefined;
            const parsed = Number(cleaned);
            if (Number.isNaN(parsed)) return undefined;
            return parsed;
        }
        return undefined;
    };

    const parseDateCandidate = (value) => {
        if (value === undefined || value === null || value === '') return undefined;
        if (value instanceof Date) {
            return Number.isNaN(value.getTime()) ? undefined : value;
        }
        if (typeof value?.toDate === 'function') {
            try {
                const converted = value.toDate();
                return (converted instanceof Date && !Number.isNaN(converted.getTime())) ? converted : undefined;
            } catch (_) {
                return undefined;
            }
        }
        if (typeof value === 'object' && typeof value.seconds === 'number') {
            const millis = value.seconds * 1000 + ((value.nanoseconds || 0) / 1e6);
            const date = new Date(millis);
            return Number.isNaN(date.getTime()) ? undefined : date;
        }
        if (typeof value === 'number') {
            if (!Number.isFinite(value)) return undefined;
            const millis = value > 1e12 ? value : value * 1000;
            const date = new Date(millis);
            return Number.isNaN(date.getTime()) ? undefined : date;
        }
        if (typeof value === 'string') {
            const trimmed = value.trim();
            if (!trimmed) return undefined;
            if (/^-?\d+(\.\d+)?$/.test(trimmed)) {
                const numeric = Number(trimmed);
                if (Number.isFinite(numeric)) {
                    const millis = numeric > 1e12 ? numeric : numeric * 1000;
                    const numericDate = new Date(millis);
                    if (!Number.isNaN(numericDate.getTime())) return numericDate;
                }
            }
            const normalized = trimmed.includes('T') ? trimmed : trimmed.replace(' ', 'T');
            const parsed = new Date(normalized);
            if (!Number.isNaN(parsed.getTime())) return parsed;
            const fallback = new Date(trimmed);
            if (!Number.isNaN(fallback.getTime())) return fallback;
        }
        return undefined;
    };

    const toFiniteNumber = (value) => {
        const parsed = parseNumberish(value);
        if (parsed !== undefined) return parsed;
        const direct = Number(value);
        return Number.isFinite(direct) ? direct : 0;
    };

    const buildFlashSalePayload = (product) => {
        const flashObj = (product.flashSale && typeof product.flashSale === 'object') ? product.flashSale : {};
        const productKeyMap = createNormalizedKeyMap(product);
        const flashKeyMap = createNormalizedKeyMap(flashObj);

        const enabledCandidates = [
            pickValueFromKeys(flashObj, flashKeyMap, ['enabled', 'active']),
            pickValueFromKeys(product, productKeyMap, [
                'flashSaleEnabled',
                'flashSaleActive',
                'flashEnabled',
                'flashSale',
                'flashDeal',
                'flashSell',
                'flash offer',
                'flashOffer',
                'isFlashSale',
                'flashsaleenabled',
                'flashsaleactive'
            ])
        ];

        let enabled = false;
        let enabledResolved = false;
        for (const candidate of enabledCandidates) {
            const parsed = parseBooleanish(candidate);
            if (parsed !== undefined) {
                enabled = parsed;
                enabledResolved = true;
                break;
            }
        }

        const priceCandidates = [
            pickValueFromKeys(flashObj, flashKeyMap, ['price', 'amount', 'flashPrice', 'dealPrice']),
            pickValueFromKeys(product, productKeyMap, [
                'flashPrice',
                'flashSalePrice',
                'flashDealPrice',
                'flashSellPrice',
                'flashofferprice',
                'flashprice'
            ])
        ];

        let price = null;
        for (const candidate of priceCandidates) {
            const parsed = parseNumberish(candidate);
            if (parsed !== undefined) {
                price = parsed;
                break;
            }
        }

        const startCandidates = [
            pickValueFromKeys(flashObj, flashKeyMap, ['start', 'startDate', 'startTime', 'startAt', 'begin', 'from']),
            pickValueFromKeys(product, productKeyMap, [
                'flashStart',
                'flashSaleStart',
                'flashStartDate',
                'flashStartTime',
                'flashStartAt',
                'flashsaleStart'
            ])
        ];

        let start = null;
        for (const candidate of startCandidates) {
            const parsed = parseDateCandidate(candidate);
            if (parsed !== undefined) {
                start = parsed;
                break;
            }
        }

        const endCandidates = [
            pickValueFromKeys(flashObj, flashKeyMap, ['end', 'endDate', 'endTime', 'endAt', 'until', 'to']),
            pickValueFromKeys(product, productKeyMap, [
                'flashEnd',
                'flashSaleEnd',
                'flashEndDate',
                'flashEndTime',
                'flashEndAt',
                'flashsaleEnd'
            ])
        ];

        let end = null;
        for (const candidate of endCandidates) {
            const parsed = parseDateCandidate(candidate);
            if (parsed !== undefined) {
                end = parsed;
                break;
            }
        }

        if (start && end && end < start) {
            console.warn(`Flash sale end precedes start for product ${product.name || product.model || ''}. Setting end time to null.`);
            end = null;
        }

        if (!enabledResolved && (price !== null || start !== null || end !== null)) {
            enabled = true;
        }

        if (!enabled) {
            return { enabled: false };
        }

        return {
            enabled: true,
            price: price ?? null,
            start: start ?? null,
            end: end ?? null
        };
    };

    let batch = writeBatch(db);
    const productsCollectionRef = collection(db, 'products');
    let successfulCount = 0;

    for (const product of products) {
        const newDocRef = doc(productsCollectionRef);
        const productModel = product.model || newDocRef.id.substring(0, 8); 

        const flashSale = buildFlashSalePayload(product);
        const resolvedIsOnOffer = parseBooleanish(product.isOnOffer);
        const resolvedIsRefundable = parseBooleanish(product.isRefundable);

        const productData = { 
            ...product,
            createdAt: serverTimestamp(),
            // নিশ্চিত করা যে data types ঠিক আছে
            mainPrice: toFiniteNumber(product.mainPrice),
            offerPrice: toFiniteNumber(product.offerPrice),
            discount: toFiniteNumber(product.discount),
            stock: toFiniteNumber(product.stock),
            costPrice: toFiniteNumber(
                product.costPrice ??
                product.purchasePrice ??
                product.buyingPrice ??
                product.basePrice ??
                product.cost
            ),
            rating: toFiniteNumber(product.rating),
            isOnOffer: resolvedIsOnOffer !== undefined ? resolvedIsOnOffer : false,
            isRefundable: resolvedIsRefundable !== undefined ? resolvedIsRefundable : false,
            model: productModel,
            // নতুন কাঠামোর ডেটা
            specification: product.specification || {},
            thumbnails: product.thumbnails || [],
            imageUrl: product.imageUrl || '',
            flashSale,
            flashSaleEnabled: flashSale.enabled,
            flashPrice: flashSale.enabled ? (flashSale.price ?? null) : null,
            flashStart: flashSale.enabled ? (flashSale.start ?? null) : null,
            flashEnd: flashSale.enabled ? (flashSale.end ?? null) : null,
        };

        batch.set(newDocRef, productData);
        successfulCount++;

        if (successfulCount % 499 === 0) { 
            console.log("Committing batch...");
            await batch.commit();
            batch = writeBatch(db);
        }
    }

    if (successfulCount % 499 !== 0) {
        await batch.commit();
    }

    showToast(`${successfulCount} products uploaded successfully!`, 'success');
};







        const renderFilteredOrders = () => {
            const searchTerm = document.getElementById('order-search-input').value.toLowerCase().trim();
            const filteredDocs = allOrders.filter(doc => {
                const order = doc.data();
                const orderId = order.orderId || doc.id;

                // Normalize statuses to canonical values to ensure filter works with variants
                const normalizeStatus = (s) => {
                    if (!s) return 'pending';
                    const raw = String(s).trim().toLowerCase();
                    if (raw === 'canceled') return 'cancelled';
                    const hyphenated = raw.replace(/\s+/g, '-');
                    if (hyphenated === 'out-for-delivery') return 'out-for-delivery';
                    return hyphenated;
                };

                const statusMatch = currentOrderStatusFilter === 'all' || normalizeStatus(order.status || 'pending') === currentOrderStatusFilter;
                const searchMatch = searchTerm === '' || orderId.toLowerCase().includes(searchTerm);
                
                return statusMatch && searchMatch;
            });
            
            // Re-render the table with only the filtered documents
            renderTable({ docs: filteredDocs, empty: filteredDocs.length === 0 }, 'all-orders-body', renderOrderRow_All);
        };

        const setButtonLoading = (button, isLoading, text = 'Loading...') => {
            if (!button) return;
            if (isLoading) {
                button.disabled = true;
                button.dataset.originalText = button.textContent;
                button.innerHTML = `<span class="inline-flex items-center">${text} <svg class="animate-spin -mr-1 ml-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></span>`;
            } else {
                button.disabled = false;
                button.innerHTML = button.dataset.originalText || 'Submit';
            }
        };

        const cleanupListeners = () => {
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
            if (liveVisitorsIntervalId) { clearInterval(liveVisitorsIntervalId); liveVisitorsIntervalId = null; }
            if (typeof unsubscribePresence === 'function') { unsubscribePresence(); unsubscribePresence = null; }
            lastPresenceDocs = [];
            if (UI.liveVisitorsModal) UI.liveVisitorsModal.classList.add('hidden');
        };

        // --- Authentication & PIN Logic ---
        // The isAdmin function was removed as it causes a "Missing or insufficient permissions" error.
        // The security rules prevent non-admins from reading the 'admins' collection to check their own status.
        // Role checking is now done securely via ID token claims in the onAuthStateChanged listener below.

        const showScreen = (screenName) => {
            const screens = ['loading-spinner', 'login-screen', 'admin-panel'];
            screens.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.toggle('hidden', id !== screenName);
            });
        };

     onAuthStateChanged(auth, async (user) => {
         showScreen('loading-spinner');
            if (user) {
                try {
                    // Force refresh the token to get the latest custom claims (e.g., role)
                    const idTokenResult = await user.getIdTokenResult(true);
                    
                    // Check if the user's token has an 'admin' or 'co-admin' role claim.
                    // This is the secure way to verify admin status on the client.
                    const userIsAdmin = idTokenResult.claims.role === 'admin' || idTokenResult.claims.role === 'co-admin';

                    if (userIsAdmin) {
                        const adminDoc = await getDoc(doc(db, "admins", user.uid));
                        if(adminDoc.exists()) {
                            currentUserProfile = { id: adminDoc.id, ...adminDoc.data() };
                        }
                        // Bypass PIN verification and go directly to admin panel
                        showScreen('admin-panel');
                        initializeAdminPanel(user);
                        // Show a welcome message only when this session came from a fresh login
                        const cameFromLogin = sessionStorage.getItem('pendingLogin') === '1';
                        if (cameFromLogin) {
                            showToast('Welcome to New World!');
                            try { showWelcomeOverlay(); } catch (_) {}
                            sessionStorage.removeItem('pendingLogin');
                        }
                    } else {
                        // If a user is logged in but is not an admin, show an error and sign them out.
                        console.warn("Non-admin user attempted to access the panel. Signing out.");
                        showToast("You do not have permission to access this panel.", "error");
                        await signOut(auth); // This will re-trigger onAuthStateChanged with user=null
                    }
                } catch (error) {
                    // If any error occurs during the admin check, sign out for security.
                    console.error("Error verifying admin status:", error);
                    showToast("An error occurred during verification. Please log in again.", "error");
                    await signOut(auth);
                }
            } else {
                cleanupListeners();
                stopClock(); // Stop the clock on logout
                showScreen('login-screen');
            }
        });

        UI.loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const button = e.target.querySelector('button[type="submit"]');
            setButtonLoading(button, true, 'LOGGING IN...');
            UI.loginError.textContent = '';
            
            const email = e.target.email.value;
            const password = e.target.password.value;
            // Checkbox removed: default to local persistence (stay signed in)
            const keepSignedIn = true;

            try {
                // Mark that a login attempt is in progress so we can show welcome on success
                sessionStorage.setItem('pendingLogin', '1');
                // Set persistence (default: keep signed in)
                await setPersistence(auth, browserLocalPersistence);
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged will handle the rest
            } catch (error) {
                console.error("Login failed:", error);
                const errorCode = error.code;
                let errorMessage = 'An unknown error occurred.';
                if (errorCode === 'auth/user-not-found' || errorCode === 'auth/wrong-password' || errorCode === 'auth/invalid-credential') {
                    errorMessage = 'Invalid email or password. Please try again.';
                } else if (errorCode === 'auth/too-many-requests') {
                    errorMessage = 'Access to this account has been temporarily disabled due to many failed login attempts. You can immediately restore it by resetting your password or you can try again later.';
                }
                UI.loginError.textContent = errorMessage;
                // Clear the pending flag if login failed
                sessionStorage.removeItem('pendingLogin');
            } finally {
                setButtonLoading(button, false);
            }
        });

        // PIN verification disabled; no separate handler needed.

        document.getElementById('logout-button').addEventListener('click', () => {
            playSound('logout');
            signOut(auth);
        });
        
        // --- Navigation ---
        const showPage = (pageId) => {
            const targetPage = document.getElementById(`${pageId}-page`);
            if (!targetPage) {
                console.warn(`Page not found: ${pageId}. Redirecting to dashboard.`);
                pageId = 'dashboard';
            }

            // If we are navigating away from the chat page, reset its state.
            if (pageId !== 'chat') {
                resetChatView();
            }

            UI.pages.forEach(p => p.classList.toggle('hidden', p.id !== `${pageId}-page`));
            UI.navLinks.forEach(l => l.classList.toggle('active', l.dataset.page === pageId));
            UI.pageTitle.textContent = PAGE_TITLES[pageId] || 'Dashboard';
            // Keep quick section dropdown in sync
            const quickSel = document.getElementById('quick-section-select');
            if (quickSel && quickSel.value !== pageId) quickSel.value = pageId;

            // On-demand renders
            if (pageId === 'low-stock' && typeof renderLowStockProducts === 'function') {
                renderLowStockProducts();
            }
            if (pageId === 'reports' && typeof prepareReportsView === 'function') {
                prepareReportsView();
            }
            if (pageId === 'top-sales' && typeof renderTopSales === 'function') {
                renderTopSales();
            }
            if (pageId === 'top-rated' && typeof renderTopRated === 'function') {
                renderTopRated();
            }
            if (pageId === 'flash-sale' && typeof renderFlashSaleProducts === 'function') {
                renderFlashSaleProducts();
            }
            if (pageId === 'mega-sale' && typeof renderMegaSaleProducts === 'function') {
                renderMegaSaleProducts();
            }
        };

        // --- Appearance & Theming ---
        const applyTheme = (themeName) => {
            document.documentElement.className = document.documentElement.className.replace(/theme-\w+/g, '');
            document.documentElement.classList.add(`theme-${themeName}`);
            localStorage.setItem('adminTheme', themeName);
            document.querySelectorAll('.theme-option').forEach(opt => {
                const checkIcon = opt.querySelector('.theme-check');
                const colorBox = opt.querySelector('.relative.border-4');
                const isActive = opt.dataset.theme === themeName;
                checkIcon.classList.toggle('hidden', !isActive);
                colorBox.classList.toggle('border-transparent', !isActive);
                colorBox.classList.toggle('border-blue-500', isActive);
                colorBox.classList.toggle('dark:border-blue-400', isActive);
            });
        };

        const applyDarkMode = (isDark) => {
            document.documentElement.classList.toggle('dark', isDark);
            if(document.getElementById('dark-mode-toggle')) {
                document.getElementById('dark-mode-toggle').checked = isDark;
            }
        };

        const initializeAppearance = () => {
            applyTheme(localStorage.getItem('adminTheme') || 'forest');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            applyDarkMode(localStorage.theme === 'dark' || (!('theme' in localStorage) && prefersDark));
            
            // Apply saved wallpapers and avatars to auth screens
            const loginScreenDivs = document.querySelectorAll('#login-screen, #pin-verification-screen');
            const loginProfilePic = document.getElementById('login-profile-pic');
            const defaultBg = 'https://github.com/tangailbuzzbd-svg/TangailBuzz-Picture-/blob/main/vecteezy_ai-generated-empty-wooden-table-on-the-natural-background_40890255.jpg?raw=true';
            const defaultAvatar = 'https://github.com/tangailbuzzbd-svg/TangailBuzz-Picture-/blob/main/WhatsApp%20Image%202025-07-30%20at%2019.29.33_9f8c7d06.jpg?raw=true';
            
            const bgUrl = `url('${localStorage.getItem('login-bg-url') || defaultBg}')`;
            loginScreenDivs.forEach(div => div.style.backgroundImage = bgUrl);
            loginProfilePic.src = localStorage.getItem('login-profile-url') || defaultAvatar;
        };

        // --- Reports Helpers ---
        const safeNumber = (value, fallback = 0) => {
            const num = Number(value);
            return Number.isFinite(num) ? num : fallback;
        };

        const toMillisSafe = (value) => {
            if (!value) return 0;
            if (typeof value.toMillis === 'function') return value.toMillis();
            if (typeof value.toDate === 'function') return value.toDate().getTime();
            if (value instanceof Date) return value.getTime();
            if (typeof value === 'number') return value < 1e12 ? value * 1000 : value;
            if (typeof value === 'string') {
                const parsed = new Date(value);
                if (!Number.isNaN(parsed.getTime())) return parsed.getTime();
            }
            return 0;
        };

        const formatCurrencyBDT = (value) => {
            const amount = safeNumber(value);
            const sign = amount < 0 ? '-' : '';
            const formatted = Math.abs(amount).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            return `${sign}৳${formatted}`;
        };

        const toDateInputValue = (ms) => {
            if (!ms) return '';
            const date = new Date(ms);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const parseDateInputValue = (value, isEnd = false) => {
            if (!value) return null;
            const [year, month, day] = value.split('-').map(Number);
            if (![year, month, day].every(n => Number.isFinite(n))) return null;
            if (isEnd) {
                return new Date(year, month - 1, day, 23, 59, 59, 999).getTime();
            }
            return new Date(year, month - 1, day).getTime();
        };

        const getDefaultReportsRange = () => {
            if (!REPORTS_DEFAULT_RANGE_DAYS) {
                return { startMs: null, endMs: null };
            }
            const now = new Date();
            const endMs = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999).getTime();
            const startMs = endMs - (REPORTS_DEFAULT_RANGE_DAYS - 1) * 24 * 60 * 60 * 1000;
            return { startMs, endMs };
        };

        const applyReportsRangeToInputs = (startMs, endMs) => {
            const startInput = document.getElementById('reports-start-date');
            const endInput = document.getElementById('reports-end-date');
            if (startInput) startInput.value = startMs ? toDateInputValue(startMs) : '';
            if (endInput) endInput.value = endMs ? toDateInputValue(endMs) : '';
        };

        const getOrderItemsArray = (orderData) => {
            if (!orderData) return [];
            const candidates = [orderData.items, orderData.products, orderData.orderItems, orderData.cartItems];
            for (const list of candidates) {
                if (Array.isArray(list) && list.length) return list;
            }
            return [];
        };

        const REPORTS_INCLUDED_STATUSES = new Set([
            'delivered',
            'completed',
            'fulfilled',
            'paid',
            'confirmed',
            'shipped',
            'out-for-delivery',
            'processing',
            'processed',
            'ready-for-delivery'
        ]);

        const buildProductCostLookup = () => {
            const lookup = new Map();
            (allProducts || []).forEach(productDoc => {
                const data = typeof productDoc?.data === 'function' ? productDoc.data() : productDoc;
                if (!data) return;
                let finalCost = 0;
                const costCandidates = [data.costPrice, data.purchasePrice, data.mainPrice, data.basePrice, data.buyingPrice, data.cost];
                for (const candidate of costCandidates) {
                    const numeric = safeNumber(candidate);
                    if (numeric > 0) {
                        finalCost = numeric;
                        break;
                    }
                }
                if (!finalCost) {
                    const fallbackPrice = safeNumber(data.price ?? data.sellingPrice ?? data.offerPrice);
                    if (fallbackPrice > 0) finalCost = fallbackPrice;
                }
                const keys = [
                    productDoc?.id,
                    data.id,
                    data.productId,
                    data.productID,
                    data.productCode,
                    data.code,
                    data.sku,
                    data.slug,
                    data.model,
                    data.name,
                    data.title
                ].filter(Boolean);
                keys.forEach(key => {
                    const normalized = String(key).toLowerCase();
                    if (!lookup.has(normalized)) {
                        lookup.set(normalized, finalCost);
                    }
                });
            });
            return lookup;
        };

        const resolveItemCost = (item, lookup) => {
            if (!item) return 0;
            const directCandidates = [item.costPrice, item.purchasePrice, item.mainPrice, item.basePrice, item.buyingPrice, item.cost];
            for (const candidate of directCandidates) {
                const numeric = safeNumber(candidate);
                if (numeric > 0) return numeric;
            }
            const keyCandidates = [item.productId, item.productID, item.id, item.sku, item.slug, item.model, item.code, item.name, item.title].filter(Boolean);
            for (const key of keyCandidates) {
                const match = lookup.get(String(key).toLowerCase());
                if (typeof match === 'number') return match;
            }
            return safeNumber(item.originalPrice ?? item.price);
        };

        const resolveItemName = (item) => {
            return item?.name || item?.productName || item?.title || item?.productTitle || item?.productId || item?.model || 'Unnamed item';
        };

        const summariseOrderItems = (items, orderData, costLookup) => {
            let totalQuantity = 0;
            let derivedSales = 0;
            let derivedCost = 0;
            const itemSummaries = items.map(item => {
                const quantityRaw = safeNumber(item.quantity ?? item.qty ?? item.count, 1);
                const quantity = quantityRaw > 0 ? quantityRaw : 1;
                const explicitTotal = safeNumber(item.totalPrice ?? item.total ?? item.lineTotal ?? item.subtotal ?? item.amount);
                const unitPrice = safeNumber(item.sellingPrice ?? item.salePrice ?? item.offerPrice ?? item.price ?? item.unitPrice);
                const lineSales = explicitTotal > 0 ? explicitTotal : unitPrice * quantity;
                const unitCost = resolveItemCost(item, costLookup);
                const lineCost = safeNumber(unitCost) * quantity;
                totalQuantity += quantity;
                derivedSales += safeNumber(lineSales);
                derivedCost += safeNumber(lineCost);
                return {
                    name: resolveItemName(item),
                    quantity,
                    sales: safeNumber(lineSales),
                    cost: safeNumber(lineCost)
                };
            });
            const orderTotals = safeNumber(orderData?.totalAmount ?? orderData?.total ?? orderData?.totalPrice ?? orderData?.grandTotal ?? orderData?.netTotal);
            const shipping = safeNumber(orderData?.shippingFee ?? orderData?.deliveryCharge ?? orderData?.deliveryFee ?? orderData?.shippingCost);
            const discount = safeNumber(orderData?.discount ?? orderData?.couponDiscount ?? orderData?.promoDiscount);
            const sales = orderTotals > 0 ? orderTotals : Math.max(0, derivedSales + shipping - discount);
            return { itemSummaries, quantity: totalQuantity, sales, cost: derivedCost };
        };

        const normalizeStatus = (status) => {
            if (!status) return '';
            const raw = String(status).trim().toLowerCase();
            if (raw === 'canceled') return 'cancelled';
            return raw.replace(/\s+/g, '-');
        };

        const generateReportsRows = (startMs, endMs) => {
            const costLookup = buildProductCostLookup();
            const rows = [];
            (allOrders || []).forEach(orderDoc => {
                const data = typeof orderDoc?.data === 'function' ? orderDoc.data() : orderDoc;
                if (!data) return;
                const status = normalizeStatus(data.status || data.orderStatus || data.paymentStatus);
                const deliveredTs = data.deliveredAt || data.completedAt || data.updatedAt || data.confirmedAt;
                const baseTimestamp = deliveredTs || data.orderFulfilledAt || data.paymentCompletedAt || data.paymentDate;
                const createdTimestamp = data.createdAt || data.orderDate || data.placedAt || data.timestamp;
                let timestamp = toMillisSafe(baseTimestamp);
                if (!timestamp) {
                    timestamp = toMillisSafe(createdTimestamp);
                }
                if (!timestamp) return;
                const shouldInclude = REPORTS_INCLUDED_STATUSES.has(status) || Boolean(baseTimestamp);
                if (!shouldInclude) return;
                if (startMs && timestamp < startMs) return;
                if (endMs && timestamp > endMs) return;
                const items = getOrderItemsArray(data);
                const { itemSummaries, quantity, sales, cost } = summariseOrderItems(items, data, costLookup);
                const productsLabel = itemSummaries.map(item => `${item.name} ×${item.quantity}`).join(', ');
                const shortLabel = productsLabel.length > 90 ? `${productsLabel.slice(0, 87)}…` : productsLabel;
                rows.push({
                    id: orderDoc?.id || data.id,
                    invoice: data.invoiceId || data.invoiceNumber || data.invoice || data.orderNo || data.orderNumber || data.orderId || orderDoc?.id || 'N/A',
                    customer: data.userName || data.customerName || data.name || 'Customer',
                    productsLabel: shortLabel,
                    quantity,
                    dateMs: timestamp,
                    status,
                    sales: safeNumber(sales),
                    cost: safeNumber(cost),
                    profit: safeNumber(sales) - safeNumber(cost)
                });
            });
            return rows.sort((a, b) => b.dateMs - a.dateMs);
        };

        const renderReportsSummary = (rows) => {
            const salesEl = document.getElementById('reports-total-sales');
            const costEl = document.getElementById('reports-total-cost');
            const profitEl = document.getElementById('reports-total-profit');
            const totalSales = rows.reduce((sum, row) => sum + safeNumber(row.sales), 0);
            const totalCost = rows.reduce((sum, row) => sum + safeNumber(row.cost), 0);
            const totalProfit = totalSales - totalCost;
            if (salesEl) salesEl.textContent = formatCurrencyBDT(totalSales);
            if (costEl) costEl.textContent = formatCurrencyBDT(totalCost);
            if (profitEl) {
                profitEl.textContent = formatCurrencyBDT(totalProfit);
                profitEl.classList.toggle('text-rose-500', totalProfit < 0);
                profitEl.classList.toggle('text-theme-primary', totalProfit >= 0);
            }
        };

        const updateReportsMeta = (rows) => {
            const badgeEl = document.getElementById('reports-profit-badge');
            const summaryEl = document.getElementById('reports-orders-summary');
            if (!badgeEl || !summaryEl) return;
            if (!rows.length) {
                badgeEl.textContent = '0 Orders';
                summaryEl.textContent = 'No data for the selected range.';
                return;
            }
            const orderCount = rows.length;
            const totalProfit = rows.reduce((sum, row) => sum + safeNumber(row.profit), 0);
            const totalUnits = rows.reduce((sum, row) => sum + safeNumber(row.quantity), 0);
            const avgProfit = orderCount ? totalProfit / orderCount : 0;
            const dateFormatter = new Intl.DateTimeFormat('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            const startLabel = reportsState.startMs ? dateFormatter.format(new Date(reportsState.startMs)) : 'beginning';
            const endLabel = reportsState.endMs ? dateFormatter.format(new Date(reportsState.endMs)) : 'now';
            badgeEl.textContent = `${orderCount} ${orderCount === 1 ? 'Order' : 'Orders'} • Avg Profit ${formatCurrencyBDT(avgProfit)}`;
            const unitLabel = `${totalUnits} ${totalUnits === 1 ? 'unit' : 'units'}`;
            summaryEl.textContent = `Showing delivered orders from ${startLabel} to ${endLabel} • ${unitLabel} sold.`;
        };

        const renderReportsTable = (rows) => {
            const tbody = document.getElementById('reports-table-body');
            const emptyState = document.getElementById('reports-empty-state');
            if (!tbody || !emptyState) return;
            tbody.innerHTML = '';
            if (!rows.length) {
                emptyState.classList.remove('hidden');
                return;
            }
            emptyState.classList.add('hidden');
            const statusStyles = {
                delivered: 'bg-emerald-100 text-emerald-600 dark:bg-emerald-500/10 dark:text-emerald-400',
                completed: 'bg-blue-100 text-blue-600 dark:bg-blue-500/10 dark:text-blue-400',
                fulfilled: 'bg-indigo-100 text-indigo-600 dark:bg-indigo-500/10 dark:text-indigo-400',
                paid: 'bg-teal-100 text-teal-600 dark:bg-teal-500/10 dark:text-teal-400'
            };
            const dateFormatter = new Intl.DateTimeFormat('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            rows.forEach(row => {
                const statusClass = statusStyles[row.status] || 'bg-gray-100 text-gray-600 dark:bg-gray-700/60 dark:text-gray-300';
                const statusLabel = row.status ? row.status.replace(/-/g, ' ') : 'delivered';
                const dateLabel = dateFormatter.format(new Date(row.dateMs));
                const profitClass = row.profit >= 0 ? 'text-emerald-500' : 'text-rose-500';
                const invoiceLabel = escapeHtml(row.invoice || row.id || 'N/A');
                const customerLabel = escapeHtml(row.customer || '');
                const productsLabel = escapeHtml(row.productsLabel || '—');
                const statusDisplay = escapeHtml(statusLabel.charAt(0).toUpperCase() + statusLabel.slice(1));
                tbody.insertAdjacentHTML('beforeend', `
                    <tr>
                        <td class="px-3 py-2 align-top">
                            <div class="font-semibold text-text-primary">${invoiceLabel}</div>
                            <div class="text-xs text-text-secondary">${customerLabel}</div>
                            <div class="text-xs text-text-secondary truncate max-w-xs" title="${productsLabel}">${productsLabel}</div>
                        </td>
                        <td class="px-3 py-2 align-top whitespace-nowrap">${dateLabel}</td>
                        <td class="px-3 py-2 align-top">
                            <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-semibold ${statusClass}">
                                ${statusDisplay}
                            </span>
                        </td>
                        <td class="px-3 py-2 align-top text-right">${formatCurrencyBDT(row.sales)}</td>
                        <td class="px-3 py-2 align-top text-right">${formatCurrencyBDT(row.cost)}</td>
                        <td class="px-3 py-2 align-top text-right ${profitClass}">${formatCurrencyBDT(row.profit)}</td>
                    </tr>
                `);
            });
            if (window.lucide?.createIcons) window.lucide.createIcons();
        };

        const renderReportsView = () => {
            const rows = reportsState.rows || [];
            renderReportsSummary(rows);
            renderReportsTable(rows);
            updateReportsMeta(rows);
        };

        const applyReportsFilters = () => {
            const startValue = document.getElementById('reports-start-date')?.value || '';
            const endValue = document.getElementById('reports-end-date')?.value || '';
            const startMs = parseDateInputValue(startValue);
            const endMs = parseDateInputValue(endValue, true);
            if (startMs && endMs && startMs > endMs) {
                showToast('Start date cannot be after end date.', 'warning');
                return;
            }
            reportsState.startMs = startMs || null;
            reportsState.endMs = endMs || null;
            reportsState.rows = generateReportsRows(reportsState.startMs, reportsState.endMs);
            renderReportsView();
        };

        const resetReportsFilters = (silent = false) => {
            const { startMs, endMs } = getDefaultReportsRange();
            reportsState.startMs = startMs;
            reportsState.endMs = endMs;
            applyReportsRangeToInputs(startMs, endMs);
            reportsState.rows = generateReportsRows(startMs, endMs);
            renderReportsView();
            if (!silent) {
                if (!REPORTS_DEFAULT_RANGE_DAYS) {
                    showToast('Showing all delivered orders.', 'success');
                } else {
                    showToast(`Showing last ${REPORTS_DEFAULT_RANGE_DAYS} days.`, 'success');
                }
            }
        };

        const csvEscape = (value) => {
            const str = String(value ?? '');
            if (/[",\n]/.test(str)) {
                return `"${str.replace(/"/g, '""')}"`;
            }
            return str;
        };

        const exportReportsCsv = () => {
            if (!reportsState.rows.length) {
                showToast('No data to export for the selected range.', 'warning');
                return;
            }
            const header = ['Order', 'Date', 'Status', 'Sale', 'Cost', 'Profit'];
            const dataRows = reportsState.rows.map(row => [
                csvEscape(row.invoice || row.id),
                csvEscape(toDateInputValue(row.dateMs)),
                csvEscape(row.status || 'delivered'),
                csvEscape(safeNumber(row.sales).toFixed(2)),
                csvEscape(safeNumber(row.cost).toFixed(2)),
                csvEscape(safeNumber(row.profit).toFixed(2))
            ].join(','));
            const csvContent = [header.join(','), ...dataRows].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const fromLabel = reportsState.startMs ? toDateInputValue(reportsState.startMs) : 'all';
            const toLabel = reportsState.endMs ? toDateInputValue(reportsState.endMs) : 'latest';
            const link = document.createElement('a');
            link.href = url;
            link.download = `tangailbuzz-reports-${fromLabel}-to-${toLabel}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            setTimeout(() => URL.revokeObjectURL(url), 0);
            showToast('Report exported as CSV.', 'success');
        };

        const refreshReportsData = () => {
            if (!reportsPageInitialized) return;
            reportsState.rows = generateReportsRows(reportsState.startMs, reportsState.endMs);
            renderReportsView();
        };

        const ensureReportsPageSetup = () => {
            if (reportsPageInitialized) return;
            const applyBtn = document.getElementById('reports-apply-btn');
            const resetBtn = document.getElementById('reports-reset-btn');
            const exportBtn = document.getElementById('reports-export-btn');
            if (!applyBtn || !resetBtn || !exportBtn) return;
            applyBtn.addEventListener('click', (event) => {
                event.preventDefault();
                applyReportsFilters();
            });
            resetBtn.addEventListener('click', (event) => {
                event.preventDefault();
                resetReportsFilters();
            });
            exportBtn.addEventListener('click', (event) => {
                event.preventDefault();
                exportReportsCsv();
            });
            const { startMs, endMs } = getDefaultReportsRange();
            reportsState.startMs = startMs;
            reportsState.endMs = endMs;
            applyReportsRangeToInputs(startMs, endMs);
            reportsState.rows = generateReportsRows(startMs, endMs);
            renderReportsView();
            reportsPageInitialized = true;
        };

        const prepareReportsView = () => {
            ensureReportsPageSetup();
            if (!reportsPageInitialized) return;
            applyReportsRangeToInputs(reportsState.startMs, reportsState.endMs);
            refreshReportsData();
        };

        // --- Data Loading & Rendering ---
        // --- Reviews & Ratings Rendering ---
        const renderReviewsList = async () => {
            const tbody = document.getElementById('reviews-body');
            const totalEl = document.getElementById('reviews-summary-total');
            const avgEl = document.getElementById('reviews-summary-avg');
            if (!tbody) return;
            tbody.innerHTML = `<tr class="text-text-primary"><td colspan="7" class="px-4 py-3 text-center">Loading...</td></tr>`;
            try {
                const productsSnap = await getDocs(collection(db, 'products'));
                let allReviews = [];
                productsSnap.forEach(doc => {
                    const data = doc.data();
                    if (Array.isArray(data.reviews)) {
                        data.reviews.forEach((review, idx) => {
                            allReviews.push({
                                productName: data.name || 'Unknown Product',
                                productId: doc.id,
                                reviewIdx: idx,
                                productImage: data.imageUrl || '',
                                ...review
                            });
                        });
                    }
                });

                if (totalEl) totalEl.textContent = String(allReviews.length);
                const numericRatings = allReviews.map(r => Number(r.rating)).filter(v => !Number.isNaN(v));
                const avg = numericRatings.length ? (numericRatings.reduce((a, b) => a + b, 0) / numericRatings.length) : 0;
                if (avgEl) avgEl.textContent = avg.toFixed(1);

                if (allReviews.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-text-secondary">No reviews found.</td></tr>`;
                    return;
                }

                allReviews.sort((a, b) => {
                    const ta = (a.timestamp && a.timestamp.toDate) ? a.timestamp.toDate().getTime() : new Date(a.timestamp || 0).getTime();
                    const tb = (b.timestamp && b.timestamp.toDate) ? b.timestamp.toDate().getTime() : new Date(b.timestamp || 0).getTime();
                    return tb - ta;
                });

                tbody.innerHTML = '';
                allReviews.forEach((r, idx) => {
                    let dateString = '';
                    if (r.timestamp && r.timestamp.toDate) {
                        dateString = r.timestamp.toDate().toLocaleString();
                    } else if (r.timestamp instanceof Date) {
                        dateString = r.timestamp.toLocaleString();
                    } else if (typeof r.timestamp === 'string' || typeof r.timestamp === 'number') {
                        dateString = new Date(r.timestamp).toLocaleString();
                    } else {
                        dateString = 'N/A';
                    }

                    const productImage = r.productImage || r.imageUrl || 'https://placehold.co/48x48/e2e8f0/64748b?text=Img';
                    const ratingText = (r.rating !== undefined && r.rating !== null && r.rating !== '') ? `${r.rating} ★` : 'No rating';

                    tbody.insertAdjacentHTML('beforeend', `
                        <tr class="text-text-primary">
                            <td class="px-4 py-3 text-sm">${idx + 1}</td>
                            <td class="px-4 py-3 text-center"><input type=\"checkbox\" class=\"row-select accent-theme-primary\" data-coll=\"review\" data-product-id=\"${r.productId}\" data-review-idx=\"${r.reviewIdx}\"></td>
                            <td class="px-4 py-3 text-sm">
                                <div class="flex items-center gap-3">
                                    <img src="${productImage}" onerror="this.src='https://placehold.co/48x48/e2e8f0/64748b?text=Img'" class="h-10 w-10 object-cover rounded">
                                    <span class="font-semibold">${r.productName}</span>
                                </div>
                            </td>
                            <td class="px-4 py-3 text-sm text-yellow-600 font-semibold">${ratingText}</td>
                            <td class="px-4 py-3 text-sm truncate max-w-[28rem]" title="${(r.comment || '').replace(/"/g, '&quot;')}">${r.comment || '—'}</td>
                            <td class="px-4 py-3 text-sm">${r.author || 'Anonymous'}</td>
                            <td class="px-4 py-3 text-sm whitespace-nowrap">${dateString}</td>
                            <td class="px-4 py-3">
                                <button class="delete-review-btn text-red-500 hover:text-red-700" data-product-id="${r.productId}" data-review-idx="${r.reviewIdx}" title="Delete Review">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                            </td>
                        </tr>
                    `);
                });

                // Attach delete listeners & refresh icons
                document.querySelectorAll('.delete-review-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const productId = btn.getAttribute('data-product-id');
                        const reviewIdx = parseInt(btn.getAttribute('data-review-idx'), 10);
                        if (!productId || Number.isNaN(reviewIdx)) return;
                        if (!confirm('Are you sure you want to delete this review?')) return;
                        try {
                            const productRef = doc(db, 'products', productId);
                            const productSnap = await getDoc(productRef);
                            if (!productSnap.exists()) throw new Error('Product not found');
                            const data = productSnap.data();
                            if (!Array.isArray(data.reviews)) throw new Error('No reviews found');
                            data.reviews.splice(reviewIdx, 1);
                            await updateDoc(productRef, { reviews: data.reviews });
                            showToast('Review deleted!', 'success');
                            renderReviewsList();
                        } catch (err) {
                            showToast('Failed to delete review', 'error');
                        }
                    });
                });
                if (window.lucide && typeof window.lucide.createIcons === 'function') window.lucide.createIcons();
            } catch (err) {
                if (tbody) tbody.innerHTML = '<tr><td colspan="7" class="p-4 text-center text-red-500">Failed to load reviews.</td></tr>';
            }
        };
        const loadAdminProfile = async (user) => {
            if (!user) return;
            document.getElementById('admin-profile-email').textContent = user.email;
            document.getElementById('dropdown-admin-email').textContent = user.email;

            const adminDoc = await getDoc(doc(db, "admins", user.uid));
            if (adminDoc.exists()) {
                const data = adminDoc.data();
                const name = data.name || 'Admin';
                const imageUrl = data.imageUrl || `https://placehold.co/32x32/e2e8f0/64748b?text=${name.charAt(0)}`;
                
                document.getElementById('admin-name').value = data.name || '';
                document.getElementById('admin-image').value = data.imageUrl || '';
                document.getElementById('header-admin-name').textContent = name;
                document.getElementById('header-admin-image').src = imageUrl;
                document.getElementById('dropdown-admin-name').textContent = name;
            }
        };

        const loadDashboardStats = async () => {
            try {
                const ordersSnapshot = await getDocs(query(collection(db, "orders")));
                const ordersData = ordersSnapshot.docs.map(doc => doc.data());
                
                const statusCounts = ordersData.reduce((acc, order) => {
                    // Ensure that the status is always retrieved, defaulting to 'pending' if missing (as intended)
                    const status = (order.status || 'pending').toLowerCase();
                    acc[status] = (acc[status] || 0) + 1;
                    return acc;
                }, {});

                // Filter for delivered orders to calculate Total Sales
                const deliveredOrdersData = ordersData.filter(order => order.status === 'delivered');
                const totalSales = deliveredOrdersData.reduce((sum, order) => sum + (order.totalAmount || 0), 0);
                const formatCurrency = (value) => `৳${Number(value || 0).toFixed(2)}`;
                
                const usersSnap = await getCountFromServer(collection(db, "users"));
                const productsSnap = await getCountFromServer(collection(db, "products"));
                const deliveryMenSnap = await getCountFromServer(collection(db, "deliveryMen"));
                
                // FIX: Perform an initial count of unseen SMS on load for immediate feedback.
                // The real-time listener will keep it updated afterwards.
                const chatsQuery = query(collection(db, "live_chats"));
                const chatsSnapshot = await getDocs(chatsQuery);
                const unseenSmsCount = chatsSnapshot.docs.filter(doc => !doc.data().isReadByAdmin).length;
                document.getElementById('total-unseen-sms').textContent = unseenSmsCount;
                
                // FIX: Fetch all coupons and filter client-side to avoid complex query permission issues.
                const allCouponsSnap = await getDocs(collection(db, "coupons"));
                const todayStr = new Date().toISOString().split('T')[0];
                let activeCoupons = 0;
                allCouponsSnap.forEach(doc => {
                    const data = doc.data();
                    const rawExpiry = data.expiryDate;
                    if (!rawExpiry) return;

                    let expiryComparable = null;
                    if (rawExpiry?.toDate) {
                        const dt = rawExpiry.toDate();
                        expiryComparable = dt.toISOString().split('T')[0];
                    } else if (typeof rawExpiry === 'string') {
                        expiryComparable = rawExpiry;
                    } else if (typeof rawExpiry === 'number') {
                        expiryComparable = new Date(rawExpiry).toISOString().split('T')[0];
                    }

                    if (expiryComparable && expiryComparable >= todayStr) {
                        activeCoupons++;
                    }
                });

                const productsQuerySnap = await getDocs(query(collection(db, "products")));
                const productDocs = productsQuerySnap.docs;
                const productsData = productDocs.map(d => d.data());
                const productCostLookup = new Map();
                productDocs.forEach(docSnap => {
                    const data = docSnap.data() || {};
                    let finalCost = 0;
                    const costCandidates = [data.costPrice, data.purchasePrice, data.buyingPrice, data.basePrice, data.cost, data.unitCost, data.mainPrice, data.offerPrice];
                    for (const candidate of costCandidates) {
                        const numeric = safeNumber(candidate);
                        if (numeric > 0) {
                            finalCost = numeric;
                            break;
                        }
                    }
                    const keys = [
                        docSnap.id,
                        data.id,
                        data.productId,
                        data.productID,
                        data.productCode,
                        data.code,
                        data.sku,
                        data.slug,
                        data.model,
                        data.name,
                        data.title
                    ].filter(Boolean);
                    keys.forEach(key => {
                        const normalized = String(key).toLowerCase();
                        if (!productCostLookup.has(normalized)) {
                            productCostLookup.set(normalized, finalCost);
                        }
                    });
                });

                let totalProfit = 0;
                deliveredOrdersData.forEach(order => {
                    const items = getOrderItemsArray(order);
                    if (items.length) {
                        const { itemSummaries } = summariseOrderItems(items, order, productCostLookup);
                        totalProfit += itemSummaries.reduce((sum, item) => sum + (safeNumber(item.sales) - safeNumber(item.cost)), 0);
                    } else {
                        const orderTotal = safeNumber(order.totalAmount ?? order.total ?? order.totalPrice);
                        const costHint = safeNumber(order.totalCost ?? order.costTotal ?? order.purchaseTotal ?? 0);
                        if (orderTotal || costHint) {
                            totalProfit += orderTotal - costHint;
                        }
                    }
                });

                // Calculate Total Stock Cost: (Main Price * Stock) for all products
                const totalStockValue = productsData.reduce((sum, product) => {
                    const unitCost = safeNumber(
                        product.costPrice ??
                        product.purchasePrice ??
                        product.buyingPrice ??
                        product.basePrice ??
                        product.unitCost ??
                        product.mainPrice ??
                        product.price ??
                        product.offerPrice
                    );
                    return sum + (unitCost > 0 ? unitCost : 0) * (safeNumber(product.stock) || 0);
                }, 0);
                const totalStockCount = productsData.reduce((sum, product) => sum + (product.stock || 0), 0);

                const usersCount = usersSnap.data().count;
                const productsCount = productsSnap.data().count;
                const deliveryMenCount = deliveryMenSnap.data().count;
                totalUsersCount = usersCount;
                totalDeliveryMenCount = deliveryMenCount;
                activeCouponsCount = activeCoupons;

                document.getElementById('total-orders').textContent = ordersData.length;
                document.getElementById('total-sale').textContent = formatCurrency(totalSales);
                const totalProfitEl = document.getElementById('total-profit');
                if (totalProfitEl) totalProfitEl.textContent = formatCurrency(totalProfit);
                document.getElementById('total-users').textContent = usersCount;
                document.getElementById('total-products-stat').textContent = productsCount;
                document.getElementById('total-delivery-men').textContent = deliveryMenCount;
                document.getElementById('total-active-coupons').textContent = activeCoupons;
                document.getElementById('total-pending').textContent = statusCounts.pending || 0;
                document.getElementById('total-confirmed').textContent = statusCounts.confirmed || 0;
                document.getElementById('total-shipped').textContent = statusCounts.shipped || 0;
                document.getElementById('total-out-for-delivery').textContent = statusCounts['out-for-delivery'] || 0;
                document.getElementById('total-delivered').textContent = statusCounts.delivered || 0;
                document.getElementById('total-cancelled').textContent = statusCounts.cancelled || 0;
                document.getElementById('total-stock-value').textContent = `৳${Math.round(totalStockValue)}`;
                document.getElementById('total-stock-count').textContent = totalStockCount;
                updateDashboardLastUpdatedLabel();
            } catch (e) {
                console.error("Error loading dashboard stats", e);
                showToast("Failed to load dashboard stats!", 'error');
            }
        };

        // --- Dashboard Metrics Aggregation + Chart ---
        const drawOrdersChart = async (days = 7) => {
            try {
                const canvas = document.getElementById('ordersChart');
                if (!canvas) return;

                // CHART.JS FIX: Destroy previous instance using official Chart.js method
                const existingChart = Chart.getChart(canvas);
                if (existingChart) {
                    existingChart.destroy();
                }

                const tz = localStorage.getItem('adminTimeZone') || 'Asia/Riyadh';
                const now = new Date();
                const dayMs = 24 * 60 * 60 * 1000;
                const fmtKey = (d) => new Intl.DateTimeFormat('en-CA', { timeZone: tz, year: 'numeric', month: '2-digit', day: '2-digit' }).format(d);
                const labels = Array.from({ length: days }, (_, i) => fmtKey(new Date(now.getTime() - (days - 1 - i) * dayMs)));

                // Initialize metrics maps
                const baseMap = () => new Map(labels.map(k => [k, 0]));
                const mOrders = baseMap();
                const mDelivered = baseMap();
                const mOFD = baseMap();
                const mUsers = baseMap();
                const mProducts = baseMap();
                const mSales = baseMap(); // amount
                const mProfit = baseMap(); // profit amount

                const startDate = new Date(now.getTime() - (days - 1) * dayMs);
                const costLookup = buildProductCostLookup();

                // Helper: safe JS Date from various timestamp shapes
                const toJSDate = (v) => {
                    if (!v) return null;
                    if (typeof v?.toDate === 'function') return v.toDate();
                    if (v instanceof Date) return v;
                    if (typeof v === 'number') return new Date(v < 1e12 ? v * 1000 : v);
                    if (typeof v === 'string') { const d = new Date(v); return isNaN(d) ? null : d; }
                    return null;
                };

                // Fetch and aggregate Orders
                const qOrders = query(collection(db, 'orders'), where('createdAt', '>=', startDate), orderBy('createdAt', 'asc'));
                const snapOrders = await getDocs(qOrders);
                snapOrders.forEach(docSnap => {
                    const o = docSnap.data() || {};
                    const d = toJSDate(o.createdAt);
                    if (!d) return;
                    const key = fmtKey(d);
                    if (!mOrders.has(key)) return;
                    mOrders.set(key, (mOrders.get(key) || 0) + 1);
                    const status = String(o.status || '').toLowerCase().replace(/\s+/g, '-');
                    if (status === 'delivered') {
                        mDelivered.set(key, (mDelivered.get(key) || 0) + 1);
                        const amt = Number(o.totalAmount || 0);
                        mSales.set(key, (mSales.get(key) || 0) + (isNaN(amt) ? 0 : amt));
                        const items = getOrderItemsArray(o);
                        if (items.length) {
                            const { itemSummaries } = summariseOrderItems(items, o, costLookup);
                            const profit = itemSummaries.reduce((sum, item) => sum + (safeNumber(item.sales) - safeNumber(item.cost)), 0);
                            mProfit.set(key, (mProfit.get(key) || 0) + profit);
                        } else {
                            const fallbackSales = safeNumber(o.totalAmount ?? o.total ?? o.totalPrice);
                            const fallbackCost = safeNumber(o.totalCost ?? o.costTotal ?? o.purchaseTotal ?? 0);
                            if (fallbackSales || fallbackCost) {
                                mProfit.set(key, (mProfit.get(key) || 0) + (fallbackSales - fallbackCost));
                            }
                        }
                    }
                    if (status === 'out-for-delivery') {
                        mOFD.set(key, (mOFD.get(key) || 0) + 1);
                    }
                });

                // New Users
                const qUsers = query(collection(db, 'users'), where('createdAt', '>=', startDate), orderBy('createdAt', 'asc'));
                const snapUsers = await getDocs(qUsers);
                snapUsers.forEach(docSnap => {
                    const u = docSnap.data() || {};
                    const d = toJSDate(u.createdAt);
                    if (!d) return;
                    const key = fmtKey(d);
                    if (mUsers.has(key)) mUsers.set(key, (mUsers.get(key) || 0) + 1);
                });

                // New Products
                const qProducts = query(collection(db, 'products'), where('createdAt', '>=', startDate), orderBy('createdAt', 'asc'));
                const snapProducts = await getDocs(qProducts);
                snapProducts.forEach(docSnap => {
                    const p = docSnap.data() || {};
                    const d = toJSDate(p.createdAt);
                    if (!d) return;
                    const key = fmtKey(d);
                    if (mProducts.has(key)) mProducts.set(key, (mProducts.get(key) || 0) + 1);
                });

                // Build datasets per selected metrics
                const isChecked = (id) => !!document.getElementById(id)?.checked;
                const wantOrders = isChecked('metric-orders');
                const wantDelivered = isChecked('metric-delivered');
                const wantOFD = isChecked('metric-ofd');
                const wantUsers = isChecked('metric-users');
                const wantProducts = isChecked('metric-products');
                const wantSales = isChecked('metric-sales');
                const wantProfit = isChecked('metric-profit');

                const css = getComputedStyle(document.documentElement);
                const cPrimary = (css.getPropertyValue('--c-primary') || '#4f46e5').trim();
                const palette = {
                    orders: cPrimary,
                    delivered: '#10b981', // emerald-500
                    ofd: '#f59e0b',       // amber-500
                    users: '#3b82f6',     // blue-500
                    products: '#8b5cf6',  // violet-500
                    sales: '#ef4444',      // red-500
                    profit: '#f97316'     // orange-500
                };

                const datasets = [];
                const makeDataset = (label, map, color, yAxisID = 'y') => ({
                    type: yAxisID === 'y1' ? 'line' : 'bar',
                    label,
                    data: labels.map(k => map.get(k) || 0),
                    backgroundColor: yAxisID === 'y1' ? 'transparent' : color,
                    borderColor: color,
                    borderWidth: 2,
                    fill: yAxisID === 'y1' ? false : true,
                    borderRadius: yAxisID === 'y1' ? 0 : 6,
                    maxBarThickness: 26,
                    yAxisID
                });

                if (wantOrders) datasets.push(makeDataset('Orders', mOrders, palette.orders));
                if (wantDelivered) datasets.push(makeDataset('Delivered', mDelivered, palette.delivered));
                if (wantOFD) datasets.push(makeDataset('Out for Delivery', mOFD, palette.ofd));
                if (wantUsers) datasets.push(makeDataset('New Users', mUsers, palette.users));
                if (wantProducts) datasets.push(makeDataset('New Products', mProducts, palette.products));
                if (wantSales) datasets.push(makeDataset('Sales Amount', mSales, palette.sales, 'y1'));
                if (wantProfit) datasets.push(makeDataset('Profit', mProfit, palette.profit, 'y1'));

                const ctx = canvas.getContext('2d');
                const isDark = document.documentElement.classList.contains('dark');
                const gridColor = isDark ? '#374151' : '#e5e7eb';
                const tickColor = isDark ? '#d1d5db' : '#6b7280';

                const chart = new Chart(ctx, {
                    data: { labels, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: (ctx) => {
                                        const label = ctx.dataset.label || '';
                                        const v = ctx.parsed.y;
                                        const lower = label.toLowerCase();
                                        if (lower.includes('sales') || lower.includes('profit')) return ` ${label}: ৳${Number(v).toFixed(2)}`;
                                        return ` ${label}: ${v}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { grid: { display: false }, ticks: { color: tickColor } },
                            y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: tickColor, precision: 0 } },
                            y1: { position: 'right', grid: { drawOnChartArea: false }, ticks: { color: tickColor, callback: (v) => `৳${v}` } }
                        }
                    }
                });
                // CHART.JS FIX: Removed the custom 'canvas.chart = chart;' assignment
                // Chart.getChart(canvas) will now work correctly.
            } catch (err) {
                console.error('drawOrdersChart failed:', err);
            }
        };

        // Download aggregated metrics as Excel for the current range
        const downloadMetricsExcel = async () => {
            const days = Number(document.getElementById('ordersChartDays')?.value) || 7;
            const tz = localStorage.getItem('adminTimeZone') || 'Asia/Riyadh';
            const now = new Date();
            const dayMs = 24 * 60 * 60 * 1000;
            const fmtKey = (d) => new Intl.DateTimeFormat('en-CA', { timeZone: tz, year: 'numeric', month: '2-digit', day: '2-digit' }).format(d);
            const labels = Array.from({ length: days }, (_, i) => fmtKey(new Date(now.getTime() - (days - 1 - i) * dayMs)));

            // Reuse chart aggregation quickly by calling drawOrdersChart and reading its computed values is complex.
            // Instead, recompute minimal aggregation for export.
            const baseMap = () => new Map(labels.map(k => [k, 0]));
            const mOrders = baseMap();
            const mDelivered = baseMap();
            const mOFD = baseMap();
            const mUsers = baseMap();
            const mProducts = baseMap();
            const mSales = baseMap();
            const mProfit = baseMap();
            const startDate = new Date(now.getTime() - (days - 1) * dayMs);
            const toJSDate = (v) => (typeof v?.toDate === 'function') ? v.toDate() : (v instanceof Date ? v : (typeof v === 'number' ? new Date(v < 1e12 ? v * 1000 : v) : (typeof v === 'string' ? new Date(v) : null)));
            const costLookup = buildProductCostLookup();

            // Orders
            const snapOrders = await getDocs(query(collection(db, 'orders'), where('createdAt', '>=', startDate), orderBy('createdAt', 'asc')));
            snapOrders.forEach(s => {
                const o = s.data() || {}; const d = toJSDate(o.createdAt); if (!d) return; const k = fmtKey(d); if (!mOrders.has(k)) return;
                mOrders.set(k, (mOrders.get(k) || 0) + 1);
                const st = String(o.status || '').toLowerCase().replace(/\s+/g, '-');
                if (st === 'delivered') {
                    mDelivered.set(k, (mDelivered.get(k) || 0) + 1);
                    const saleAmount = Number(o.totalAmount || 0);
                    mSales.set(k, (mSales.get(k) || 0) + (Number.isFinite(saleAmount) ? saleAmount : 0));
                    const items = getOrderItemsArray(o);
                    if (items.length) {
                        const { itemSummaries } = summariseOrderItems(items, o, costLookup);
                        const profit = itemSummaries.reduce((sum, item) => sum + (safeNumber(item.sales) - safeNumber(item.cost)), 0);
                        mProfit.set(k, (mProfit.get(k) || 0) + profit);
                    } else {
                        const fallbackSales = safeNumber(o.totalAmount ?? o.total ?? o.totalPrice);
                        const fallbackCost = safeNumber(o.totalCost ?? o.costTotal ?? o.purchaseTotal ?? 0);
                        if (fallbackSales || fallbackCost) {
                            mProfit.set(k, (mProfit.get(k) || 0) + (fallbackSales - fallbackCost));
                        }
                    }
                }
                if (st === 'out-for-delivery') { mOFD.set(k, (mOFD.get(k) || 0) + 1); }
            });
            // Users
            const snapUsers = await getDocs(query(collection(db, 'users'), where('createdAt', '>=', startDate), orderBy('createdAt', 'asc')));
            snapUsers.forEach(s => { const u = s.data() || {}; const d = toJSDate(u.createdAt); if (!d) return; const k = fmtKey(d); if (mUsers.has(k)) mUsers.set(k, (mUsers.get(k) || 0) + 1); });
            // Products
            const snapProducts = await getDocs(query(collection(db, 'products'), where('createdAt', '>=', startDate), orderBy('createdAt', 'asc')));
            snapProducts.forEach(s => { const p = s.data() || {}; const d = toJSDate(p.createdAt); if (!d) return; const k = fmtKey(d); if (mProducts.has(k)) mProducts.set(k, (mProducts.get(k) || 0) + 1); });

            const rows = labels.map(k => ({
                Date: k,
                Orders: mOrders.get(k) || 0,
                Delivered: mDelivered.get(k) || 0,
                OutForDelivery: mOFD.get(k) || 0,
                NewUsers: mUsers.get(k) || 0,
                NewProducts: mProducts.get(k) || 0,
                SalesAmount: Number(mSales.get(k) || 0),
                ProfitAmount: Number(mProfit.get(k) || 0)
            }));

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(rows);
            XLSX.utils.book_append_sheet(wb, ws, 'Metrics');
            XLSX.writeFile(wb, `dashboard_metrics_${days}d.xlsx`);
        };

        const renderTable = (snapshot, bodyId, rowRenderer) => {
            const body = document.getElementById(bodyId);
            if (!body) return;
            body.innerHTML = '';
            
            // Client-side sorting: Newest first
            const sortedDocs = snapshot.docs.sort((a, b) => (b.data().createdAt?.toMillis() || 0) - (a.data().createdAt?.toMillis() || 0));

            if (snapshot.empty) {
                const colSpan = body.parentElement.querySelector('thead tr').children.length;
                body.innerHTML = `<tr><td colspan="${colSpan}" class="p-4 text-center text-text-secondary">No data found.</td></tr>`;
                return;
            }
            
            // Render rows with serial number (slNo)
            sortedDocs.forEach((doc, index) => body.insertAdjacentHTML('beforeend', rowRenderer(doc, index + 1)));
            lucide.createIcons();
        };

        // --- Top Sales (Products by Units Sold) ---
        const affectsStock = (status) => ['pending','shipped','out-for-delivery','delivered'].includes(String(status||'').toLowerCase());

        const getTopSalesData = (rangeValue) => {
            const now = Date.now();
            let cutoff = 0;
            if (rangeValue && rangeValue !== 'all') {
                const days = Number(rangeValue);
                if (!Number.isNaN(days) && days > 0) cutoff = now - days*24*60*60*1000;
            }

            const productIndex = new Map(); // productId -> { units, revenue, productId }

            allOrders.forEach(doc => {
                const d = doc.data();
                const createdAtMs = d.createdAt?.toMillis?.() || (d.createdAt?.seconds ? d.createdAt.seconds*1000 : 0);
                if (cutoff && createdAtMs < cutoff) return;
                if (!affectsStock(d.status)) return;
                const items = Array.isArray(d.items) ? d.items : [];
                items.forEach(item => {
                    const pid = item.productId || item.id || item.sku || item.name;
                    if (!pid) return;
                    const qty = Number(item.quantity) || 0;
                    const price = Number(item.price) || 0;
                    if (!productIndex.has(pid)) productIndex.set(pid, { productId: pid, units: 0, revenue: 0 });
                    const rec = productIndex.get(pid);
                    rec.units += qty;
                    rec.revenue += qty * price;
                });
            });

            // Enrich with product data
            const productsById = new Map(allProducts.map(p => [p.id, p]));
            const rows = Array.from(productIndex.values()).map(rec => {
                const prodDoc = productsById.get(rec.productId);
                const pdata = prodDoc?.data?.() || {};
                const name = pdata.name || pdata.title || rec.productId;
                const image = (Array.isArray(pdata.thumbnails) && pdata.thumbnails[0]) || pdata.imageUrl || pdata.image || '';
                const category = CATEGORY_MAP[pdata.category] || pdata.category || '—';
                const stock = pdata.stock ?? '—';
                return { ...rec, name, image, category, stock };
            });

            rows.sort((a,b) => (b.units - a.units) || (b.revenue - a.revenue));
            return rows;
        };

        const renderTopSales = () => {
            const body = document.getElementById('top-sales-body');
            if (!body) return;
            const range = document.getElementById('top-sales-range')?.value || '30';
            const data = getTopSalesData(range);
            lastTopSalesData = data;
            if (data.length === 0) {
                body.innerHTML = '<tr class="text-text-primary"><td colspan="7" class="px-4 py-6 text-center">No sales data found for the selected range.</td></tr>';
                return;
            }
            const toMoney = (v) => `৳${(Number(v)||0).toFixed(2)}`;
            body.innerHTML = data.slice(0, 100).map((row, idx) => `
                <tr class="text-text-primary">
                    <td class="px-4 py-3">${idx+1}</td>
                    <td class="px-4 py-3">
                        <div class="flex items-center gap-3">
                            <img src="${row.image || 'https://placehold.co/40x40/e2e8f0/64748b?text=Img'}" onerror="this.src='https://placehold.co/40x40/e2e8f0/64748b?text=Img'" class="w-10 h-10 rounded object-cover border border-color"/>
                            <div>
                                <div class="font-semibold line-clamp-1">${row.name}</div>
                                <div class="text-xs text-text-secondary">${row.productId}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3 font-mono">${row.productId}</td>
                    <td class="px-4 py-3">${row.category}</td>
                    <td class="px-4 py-3 font-semibold">${row.units}</td>
                    <td class="px-4 py-3">${toMoney(row.revenue)}</td>
                    <td class="px-4 py-3">${row.stock}</td>
                </tr>
            `).join('');
            if (window.lucide?.createIcons) lucide.createIcons();
        };

        const renderMegaSaleProducts = () => {
            const body = document.getElementById('mega-sale-body');
            if (!body) return;

            const parsePrice = (value) => {
                if (value === undefined || value === null || value === '') return null;
                if (typeof value === 'number') {
                    return Number.isFinite(value) ? value : null;
                }
                const cleaned = String(value).replace(/[^0-9+\-.]/g, '').trim();
                if (!cleaned) return null;
                const parsed = Number(cleaned);
                return Number.isFinite(parsed) ? parsed : null;
            };

            const isExplicitTrue = (value) => {
                if (value === true) return true;
                if (typeof value === 'number') return Number.isFinite(value) && value !== 0;
                if (typeof value === 'string') {
                    const normalized = value.trim().toLowerCase();
                    return ['true', 'yes', '1', 'on', 'enabled', 'enable', 'active'].includes(normalized);
                }
                return false;
            };

            const isExplicitFalse = (value) => {
                if (value === false) return true;
                if (typeof value === 'number') return Number.isFinite(value) && value === 0;
                if (typeof value === 'string') {
                    const normalized = value.trim().toLowerCase();
                    return ['false', 'no', '0', 'off', 'disabled', 'disable', 'inactive'].includes(normalized);
                }
                return false;
            };

            const formatCurrency = (value) => {
                const num = Number(value);
                if (!Number.isFinite(num)) return null;
                return `৳${num.toLocaleString('en-US', { minimumFractionDigits: 0 })}`;
            };

            const MEGA_THRESHOLD = 25;
            const rows = [];

            allProducts.forEach(doc => {
                const data = doc.data() || {};
                const mega = (data.megaSale && typeof data.megaSale === 'object') ? data.megaSale : {};

                const price = [mega.price, data.megaSalePrice, data.offerPrice, data.flashPrice, data.price]
                    .map(parsePrice)
                    .find(value => value !== null) ?? null;

                const original = [mega.originalPrice, data.megaSaleOriginalPrice, data.mainPrice, data.basePrice, data.price]
                    .map(parsePrice)
                    .find(value => value !== null) ?? null;

                let discount = parsePrice(mega.discountPercent);
                if (!Number.isFinite(discount)) {
                    const discountPercentFromData = parsePrice(data.discountPercent);
                    if (Number.isFinite(discountPercentFromData)) {
                        discount = discountPercentFromData;
                    }
                }
                if (!Number.isFinite(discount) && original && price && original > price) {
                    discount = Math.round(((original - price) / original) * 100);
                }
                if (!Number.isFinite(discount)) {
                    discount = null;
                }

                const manualTrue = [mega.enabled, data.megaSaleEnabled, data.mega_sale_enabled]
                    .some(value => isExplicitTrue(value));
                const manualFalse = [mega.enabled, data.megaSaleEnabled, data.mega_sale_enabled]
                    .some(value => isExplicitFalse(value));

                const qualifiesByDiscount = !manualFalse && Number.isFinite(discount) && discount >= MEGA_THRESHOLD && original && price && original > price;
                const shouldInclude = manualTrue || qualifiesByDiscount;

                if (!shouldInclude) {
                    return;
                }

                const status = manualTrue
                    ? { label: 'Manual Flag', className: 'bg-purple-100 text-purple-700 dark:bg-purple-900/40 dark:text-purple-200' }
                    : { label: 'Auto (≥25%)', className: 'bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-200' };

                const category = data.categoryName || data.category || data.categoryId || data.categoryTitle || '—';
                const modelDisplay = data.model || data.productId || data.productCode || data.sku || doc.id;
                const imageUrl = data.imageUrl || data.thumbnail || (Array.isArray(data.thumbnails) ? data.thumbnails[0] : '') || 'https://placehold.co/56x56/e2e8f0/64748b?text=Img';

                const formattedPrice = formatCurrency(price);
                const formattedOriginal = formatCurrency(original);
                const discountTag = Number.isFinite(discount) && discount > 0 ? `-${Math.round(discount)}%` : null;

                rows.push({
                    doc,
                    data,
                    modelDisplay,
                    category,
                    imageUrl,
                    formattedPrice,
                    formattedOriginal,
                    discountTag,
                    status
                });
            });

            if (rows.length === 0) {
                body.innerHTML = `<tr><td colspan="7" class="px-4 py-6 text-center text-text-secondary">No mega sale products configured yet.</td></tr>`;
                if (window.lucide?.createIcons) lucide.createIcons();
                return;
            }

            rows.sort((a, b) => {
                const getValue = (row) => {
                    const tag = row.discountTag;
                    if (!tag) return 0;
                    const numeric = Number(tag.replace(/[^0-9]/g, ''));
                    return Number.isFinite(numeric) ? numeric : 0;
                };
                return getValue(b) - getValue(a);
            });

            body.innerHTML = '';
            rows.forEach((row, index) => {
                const priceBlock = `
                    <div class="flex flex-col text-sm leading-tight">
                        <span class="font-semibold">${row.formattedPrice || '—'}</span>
                        ${row.formattedOriginal && row.formattedOriginal !== row.formattedPrice ? `<span class="text-xs text-text-secondary line-through">${row.formattedOriginal}</span>` : ''}
                        ${row.discountTag ? `<span class="text-xs font-semibold text-theme-primary mt-0.5">${row.discountTag}</span>` : ''}
                    </div>`;

                body.insertAdjacentHTML('beforeend', `
                    <tr class="text-text-primary">
                        <td class="px-4 py-3 text-sm">${index + 1}</td>
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-3">
                                <img src="${row.imageUrl}" onerror="this.src='https://placehold.co/56x56/e2e8f0/64748b?text=Img'" class="h-12 w-12 rounded object-cover" alt="Product image">
                                <div>
                                    <p class="font-semibold text-sm">${escapeHtml(row.data.name || 'N/A')}</p>
                                    <p class="text-xs text-text-secondary">${escapeHtml(row.data.brand || row.category || '—')}</p>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-sm font-mono" title="Document ID: ${row.doc.id}">${escapeHtml(String(row.modelDisplay || '—'))}</td>
                        <td class="px-4 py-3 text-sm">${escapeHtml(row.category || '—')}</td>
                        <td class="px-4 py-3">${priceBlock}</td>
                        <td class="px-4 py-3 text-xs"><span class="px-2 py-1 rounded-full font-semibold ${row.status.className}">${row.status.label}</span></td>
                        <td class="px-4 py-3 flex items-center gap-2">
                            <button class="edit-btn text-indigo-500 hover:text-indigo-700" data-id="${row.doc.id}" title="Edit product">
                                <i data-lucide="edit" class="w-5 h-5"></i>
                            </button>
                            <button class="mega-sale-remove-btn text-red-500 hover:text-red-700" data-id="${row.doc.id}" title="Remove from Mega Sale">
                                <i data-lucide="minus-circle" class="w-5 h-5"></i>
                            </button>
                        </td>
                    </tr>
                `);
            });

            if (window.lucide?.createIcons) lucide.createIcons();
        };

        const getTopRatedData = (minRatingValue, minReviewsValue) => {
            const minRating = Number(minRatingValue);
            const minReviews = Number(minReviewsValue);

            return allProducts.map(doc => {
                const data = doc.data?.() || doc.data || {};
                const productId = doc.id || data.productId || data.id;
                const name = data.name || data.title || productId || 'Unknown Product';
                const image = (Array.isArray(data.thumbnails) && data.thumbnails[0]) || data.imageUrl || data.image || '';
                const category = CATEGORY_MAP[data.category] || data.category || '—';
                const stock = data.stock ?? '—';

                const reviews = Array.isArray(data.reviews) ? data.reviews : [];
                const numericRatings = reviews.map(r => Number(r?.rating ?? r?.stars ?? r)).filter(v => !Number.isNaN(v) && v > 0);
                let reviewCount = numericRatings.length;
                let avgRating = reviewCount ? (numericRatings.reduce((sum, val) => sum + val, 0) / reviewCount) : null;

                const ratingCandidates = [data.avgRating, data.averageRating, data.rating, data.star, data.stars];
                if ((avgRating === null || Number.isNaN(avgRating) || avgRating === 0) && ratingCandidates.length) {
                    for (const candidate of ratingCandidates) {
                        const num = Number(candidate);
                        if (!Number.isNaN(num) && num > 0) {
                            avgRating = num;
                            break;
                        }
                    }
                }

                const reviewCountCandidates = [data.ratingCount, data.reviewsCount, data.totalRatings, data.totalReviews, data.reviewCount];
                if ((Number.isNaN(reviewCount) || reviewCount === 0) && reviewCountCandidates.length) {
                    for (const candidate of reviewCountCandidates) {
                        const num = Number(candidate);
                        if (!Number.isNaN(num) && num > 0) {
                            reviewCount = num;
                            break;
                        }
                    }
                }

                avgRating = Number(avgRating || 0);
                reviewCount = Number(reviewCount || 0);

                return { productId, name, image, category, stock, rating: avgRating, reviews: reviewCount };
            }).filter(row => {
                // Require meaningful rating data by default
                if (row.rating <= 0 || row.reviews <= 0) return false;
                if (!Number.isNaN(minRating) && row.rating < minRating) return false;
                if (!Number.isNaN(minReviews) && row.reviews < minReviews) return false;
                return true;
            }).sort((a, b) => {
                const ratingDiff = b.rating - a.rating;
                if (Math.abs(ratingDiff) > 0.0001) return ratingDiff;
                const reviewDiff = b.reviews - a.reviews;
                if (reviewDiff !== 0) return reviewDiff;
                return (a.name || '').localeCompare(b.name || '');
            });
        };

        const renderTopRated = () => {
            const body = document.getElementById('top-rated-body');
            if (!body) return;
            const minRating = document.getElementById('top-rated-min-rating')?.value || '0';
            const minReviews = document.getElementById('top-rated-min-reviews')?.value || '0';
            const data = getTopRatedData(minRating, minReviews);
            lastTopRatedData = data;
            if (data.length === 0) {
                body.innerHTML = '<tr class="text-text-primary"><td colspan="7" class="px-4 py-6 text-center">No rated products match the selected filters.</td></tr>';
                return;
            }

            body.innerHTML = data.slice(0, 100).map((row, idx) => `
                <tr class="text-text-primary">
                    <td class="px-4 py-3">${idx + 1}</td>
                    <td class="px-4 py-3">
                        <div class="flex items-center gap-3">
                            <img src="${row.image || 'https://placehold.co/40x40/e2e8f0/64748b?text=Img'}" onerror="this.src='https://placehold.co/40x40/e2e8f0/64748b?text=Img'" class="w-10 h-10 rounded object-cover border border-color"/>
                            <div>
                                <div class="font-semibold line-clamp-1">${row.name}</div>
                                <div class="text-xs text-text-secondary">${row.productId}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3 font-mono">${row.productId}</td>
                    <td class="px-4 py-3">${row.category}</td>
                    <td class="px-4 py-3 font-semibold text-yellow-600">${row.rating.toFixed(1)} ★</td>
                    <td class="px-4 py-3">${row.reviews}</td>
                    <td class="px-4 py-3">${row.stock}</td>
                </tr>
            `).join('');
            if (window.lucide?.createIcons) lucide.createIcons();
        };

        const updateDashboardLastUpdatedLabel = () => {
            const label = document.getElementById('dashboard-last-updated');
            const timeTarget = document.getElementById('dashboard-last-updated-time');
            if (!label || !timeTarget) return;
            const tz = localStorage.getItem('adminTimeZone') || 'Asia/Riyadh';
            const now = new Date();
            const dateFormatter = new Intl.DateTimeFormat('en-GB', { timeZone: tz, day: '2-digit', month: 'short', year: 'numeric' });
            const timeFormatter = new Intl.DateTimeFormat('en-GB', { timeZone: tz, hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
            const formattedDate = dateFormatter.format(now);
            const formattedTime = timeFormatter.format(now);
            timeTarget.textContent = `${formattedDate} ${formattedTime}`;
            label.title = `Last refreshed at ${formattedDate} ${formattedTime} (${tz})`;
            label.classList.remove('hidden');
            lastDashboardUpdateAt = now;
        };

        const updateDashboardSummary = () => {
            const totalOrdersEl = document.getElementById('total-orders');
            if (!totalOrdersEl) return;

            const toMoney = (value, fractionDigits = 2) => {
                const num = Number(value) || 0;
                return `৳${num.toLocaleString('en-US', { minimumFractionDigits: fractionDigits, maximumFractionDigits: fractionDigits })}`;
            };

            const statusCounts = {};
            let totalSales = 0;
            let totalProfit = 0;
            const costLookup = buildProductCostLookup();

            const normalizeStatus = (value) => {
                if (!value) return 'pending';
                const raw = String(value).trim().toLowerCase();
                if (raw === 'canceled') return 'cancelled';
                const hyphenated = raw.replace(/\s+/g, '-');
                if (hyphenated === 'out-for-delivery') return 'out-for-delivery';
                return hyphenated;
            };

            allOrders.forEach(docSnap => {
                const data = typeof docSnap.data === 'function' ? docSnap.data() : docSnap?.data || {};
                const status = normalizeStatus(data.status);
                statusCounts[status] = (statusCounts[status] || 0) + 1;
                if (status === 'delivered') {
                    totalSales += Number(data.totalAmount) || 0;
                    const items = getOrderItemsArray(data);
                    if (items.length) {
                        const { itemSummaries } = summariseOrderItems(items, data, costLookup);
                        totalProfit += itemSummaries.reduce((sum, item) => sum + (safeNumber(item.sales) - safeNumber(item.cost)), 0);
                    } else {
                        const orderTotal = safeNumber(data.totalAmount ?? data.total ?? data.totalPrice);
                        const costHint = safeNumber(data.totalCost ?? data.costTotal ?? data.purchaseTotal ?? 0);
                        if (orderTotal || costHint) {
                            totalProfit += orderTotal - costHint;
                        }
                    }
                }
            });

            totalOrdersEl.textContent = String(allOrders.length);
            const totalSaleEl = document.getElementById('total-sale');
            if (totalSaleEl) totalSaleEl.textContent = toMoney(totalSales);
            const totalProfitEl = document.getElementById('total-profit');
            if (totalProfitEl) totalProfitEl.textContent = toMoney(totalProfit);

            const statusMapping = {
                pending: 'total-pending',
                confirmed: 'total-confirmed',
                shipped: 'total-shipped',
                'out-for-delivery': 'total-out-for-delivery',
                delivered: 'total-delivered',
                cancelled: 'total-cancelled'
            };
            Object.entries(statusMapping).forEach(([statusKey, elementId]) => {
                const el = document.getElementById(elementId);
                if (el) el.textContent = String(statusCounts[statusKey] || 0);
            });

            let totalStockValue = 0;
            let totalStockCount = 0;
            allProducts.forEach(docSnap => {
                const data = typeof docSnap.data === 'function' ? docSnap.data() : docSnap?.data || {};
                const costPrice = safeNumber(
                    data.costPrice ??
                    data.purchasePrice ??
                    data.buyingPrice ??
                    data.basePrice ??
                    data.unitCost ??
                    data.mainPrice ??
                    data.price ??
                    data.offerPrice
                );
                const price = costPrice > 0 ? costPrice : 0;
                const stock = Number(data.stock ?? 0) || 0;
                if (!Number.isNaN(price) && !Number.isNaN(stock)) {
                    totalStockValue += price * stock;
                    totalStockCount += stock;
                }
            });

            const stockValueEl = document.getElementById('total-stock-value');
            if (stockValueEl) stockValueEl.textContent = toMoney(Math.round(totalStockValue), 0);
            const stockCountEl = document.getElementById('total-stock-count');
            if (stockCountEl) stockCountEl.textContent = totalStockCount.toLocaleString('en-US');

            const productsEl = document.getElementById('total-products-stat');
            if (productsEl) productsEl.textContent = String(allProducts.length);

            if (typeof totalUsersCount === 'number') {
                const usersEl = document.getElementById('total-users');
                if (usersEl) usersEl.textContent = totalUsersCount.toLocaleString('en-US');
            }

            if (typeof totalDeliveryMenCount === 'number') {
                const deliveryEl = document.getElementById('total-delivery-men');
                if (deliveryEl) deliveryEl.textContent = totalDeliveryMenCount.toLocaleString('en-US');
            }

            if (typeof activeCouponsCount === 'number') {
                const couponsEl = document.getElementById('total-active-coupons');
                if (couponsEl) couponsEl.textContent = activeCouponsCount.toLocaleString('en-US');
            }

            updateDashboardLastUpdatedLabel();
        };

        // --- Dashboard: Live Visitors counter ---
        const extractTimestampMs = (value) => {
            if (!value) return 0;
            try {
                if (typeof value.toMillis === 'function') {
                    return value.toMillis();
                }
                if (typeof value.seconds === 'number') {
                    const nanos = typeof value.nanoseconds === 'number' ? value.nanoseconds : 0;
                    return value.seconds * 1000 + Math.floor(nanos / 1e6);
                }
                if (value instanceof Date) {
                    return value.getTime();
                }
                if (typeof value === 'number') {
                    return value;
                }
                if (typeof value === 'string') {
                    const parsed = Date.parse(value);
                    return Number.isNaN(parsed) ? 0 : parsed;
                }
            } catch (err) {
                console.warn('Failed to parse timestamp value', err);
            }
            return 0;
        };

        const formatRelativeTimeFromMs = (ms) => {
            if (!ms) return 'Unknown';
            const diffSeconds = Math.round((Date.now() - ms) / 1000);
            if (diffSeconds < 10) return 'Just now';
            if (diffSeconds < 60) return `${diffSeconds}s ago`;
            if (diffSeconds < 3600) return `${Math.floor(diffSeconds / 60)}m ago`;
            if (diffSeconds < 86400) return `${Math.floor(diffSeconds / 3600)}h ago`;
            return new Date(ms).toLocaleString();
        };

        const formatVisitorLocation = (location) => {
            if (!location) return '';
            if (typeof location === 'string') return location;
            if (location.display) return location.display;
            const parts = [location.city, location.region, location.country].filter(Boolean);
            if (parts.length > 0) return parts.join(', ');
            if (location.country) return location.country;
            if (location.timezone) return location.timezone;
            return '';
        };

        const formatVisitorDevice = (device, userAgent) => {
            if (!device) {
                return userAgent ? userAgent.slice(0, 60) : 'Unknown device';
            }
            if (device.label) return device.label;
            const segments = [device.deviceType, device.os, device.browser].filter(Boolean);
            if (segments.length > 0) return segments.join(' | ');
            return userAgent ? userAgent.slice(0, 60) : 'Unknown device';
        };

        const getActivePresenceRecords = () => {
            const cutoffMs = Date.now() - PRESENCE_ACTIVE_WINDOW_MS;
            const sessions = new Map();
            for (const item of lastPresenceDocs) {
                if (!item) continue;
                const data = item.data || {};
                const sessionId = data.sessionId || item.id;
                if (!sessionId) continue;

                const lastActiveMs = extractTimestampMs(
                    data.lastActive ?? data.lastActiveAt ?? data.lastSeen ?? data.lastSeenAt ?? data.updatedAt ?? data.timestamp
                );
                const startedMs = extractTimestampMs(data.startedAt);
                const effectiveMs = lastActiveMs || startedMs;
                if (!effectiveMs || effectiveMs < cutoffMs) continue;

                const existing = sessions.get(sessionId);
                if (!existing || effectiveMs > existing.lastActiveMs) {
                    sessions.set(sessionId, {
                        sessionId,
                        docId: item.id,
                        data,
                        lastActiveMs: effectiveMs,
                        startedMs,
                    });
                }
            }
            return Array.from(sessions.values()).sort((a, b) => (b.lastActiveMs || 0) - (a.lastActiveMs || 0));
        };

        const renderLiveVisitorsModal = () => {
            if (!UI.liveVisitorsModal || !UI.liveVisitorsTableBody) return;
            const records = getActivePresenceRecords();
            if (records.length === 0) {
                UI.liveVisitorsTableBody.innerHTML = '<tr class="text-text-primary"><td colspan="5" class="px-4 py-3 text-center">No active visitors in the last 2 minutes.</td></tr>';
                return;
            }

            const rows = records.map(record => {
                const data = record.data || {};
                const visitorType = data.isLoggedIn ? 'Signed-in user' : 'Guest visitor';
                const uid = data.uid ? `${data.uid.slice(0, 8)}...` : '';
                const visitorLabel = uid ? `${visitorType} (${uid})` : visitorType;
                const path = data.path || '/';
                const deviceText = formatVisitorDevice(data.device, data.userAgent);
                const brand = data.device?.brand ? `<div class="text-xs text-text-secondary">${escapeHtml(data.device.brand)}</div>` : '';
                const ipAddress = data.location?.ip || data.location?.ipAddress || data.ip || data.ipAddress || 'Unknown';
                const locationText = formatVisitorLocation(data.location) || 'Unknown';
                const orgText = data.location?.org ? `<div class="text-xs text-text-secondary">${escapeHtml(data.location.org)}</div>` : '';
                const lastActiveText = formatRelativeTimeFromMs(record.lastActiveMs);

                return `
                    <tr class="text-text-primary">
                        <td class="px-4 py-3">
                            <div class="font-semibold">${escapeHtml(visitorLabel)}</div>
                            <div class="text-xs text-text-secondary truncate" title="${escapeHtml(path)}">${escapeHtml(path)}</div>
                        </td>
                        <td class="px-4 py-3">
                            <div>${escapeHtml(deviceText)}</div>
                            ${brand}
                        </td>
                        <td class="px-4 py-3">${escapeHtml(ipAddress)}</td>
                        <td class="px-4 py-3">
                            <div>${escapeHtml(locationText)}</div>
                            ${orgText}
                        </td>
                        <td class="px-4 py-3">${escapeHtml(lastActiveText)}</td>
                    </tr>
                `;
            }).join('');

            UI.liveVisitorsTableBody.innerHTML = rows;
        };

        const updateLiveVisitorsModalIfOpen = () => {
            if (!UI.liveVisitorsModal || UI.liveVisitorsModal.classList.contains('hidden')) return;
            renderLiveVisitorsModal();
            if (window.lucide?.createIcons) window.lucide.createIcons();
        };

        const openLiveVisitorsModal = () => {
            if (!UI.liveVisitorsModal) return;
            renderLiveVisitorsModal();
            UI.liveVisitorsModal.classList.remove('hidden');
            if (window.lucide?.createIcons) window.lucide.createIcons();
        };

        const closeLiveVisitorsModal = () => {
            if (!UI.liveVisitorsModal) return;
            UI.liveVisitorsModal.classList.add('hidden');
        };

        const recomputeLiveVisitorsFromDocs = () => {
            const cardCountEl = document.getElementById('live-visitors');
            const headerCountEl = document.getElementById('header-live-visitors-count');
            if (!cardCountEl && !headerCountEl) return;
            try {
                const activeRecords = getActivePresenceRecords();
                const countText = String(activeRecords.length);
                if (cardCountEl) cardCountEl.textContent = countText;
                if (headerCountEl) headerCountEl.textContent = countText;
                updateLiveVisitorsModalIfOpen();
            } catch (e) {
                console.warn('Live visitors recompute failed', e);
            }
        };

        const startLiveVisitorsWatcher = () => {
            if (liveVisitorsIntervalId) clearInterval(liveVisitorsIntervalId);
            if (typeof unsubscribePresence === 'function') { unsubscribePresence(); unsubscribePresence = null; }

            unsubscribePresence = onSnapshot(collection(db, 'presence'), (snap) => {
                lastPresenceDocs = Array.isArray(snap?.docs)
                    ? snap.docs.map(docSnap => ({ id: docSnap.id, data: docSnap.data({ serverTimestamps: 'estimate' }) || {} }))
                    : [];
                recomputeLiveVisitorsFromDocs();
            }, handleSnapshotError('Presence'));

            recomputeLiveVisitorsFromDocs();
            liveVisitorsIntervalId = setInterval(recomputeLiveVisitorsFromDocs, 10000);
        };

        const stopLiveVisitorsWatcher = () => {
            if (liveVisitorsIntervalId) { clearInterval(liveVisitorsIntervalId); liveVisitorsIntervalId = null; }
            if (typeof unsubscribePresence === 'function') { unsubscribePresence(); unsubscribePresence = null; }
        };

        const getStatusBadge = (status) => { 
            const colors = { pending: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300', confirmed: 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300', shipped: 'bg-purple-100 text-purple-800 dark:bg-purple-900/50 dark:text-purple-300', 'out-for-delivery': 'bg-orange-100 text-orange-800 dark:bg-orange-900/50 dark:text-orange-300', delivered: 'bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300', cancelled: 'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300' }; 
            
            // FIX: Use simple string manipulation to replace hyphens and capitalize words
            const text = (status || '').replace(/-/g, ' '); 
            const formattedText = text.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');

            return `<span class="px-2 py-1 font-semibold leading-tight rounded-full ${colors[status] || ''}">${formattedText}</span>`; 
        };
        
        // Updated renderOrderRow_Recent to include Sl. No. and respect the sorting (index is now slNo)
        const renderOrderRow_Recent = (doc, slNo) => { 
            const d = doc.data(); 
            const orderIdDisplay = d.orderId || doc.id.substring(0, 6); // Use d.orderId or fallback
            const isPending = d.status === 'pending';
            const rowClass = isPending ? 'pending-order' : 'text-text-primary';
            return `<tr class="${rowClass}"><td class="px-4 py-3 text-sm">${slNo}</td><td class="px-4 py-3 text-sm font-mono" title="Full ID: ${doc.id}">#${orderIdDisplay}</td><td class="px-4 py-3 text-sm">${d.userName || 'N/A'}</td><td class="px-4 py-3 text-sm">৳${d.totalAmount || 0}</td><td class="px-4 py-3 text-xs">${getStatusBadge(d.status)}</td></tr>`; 
        };
    const renderUserRow_Recent = doc => { const d = doc.data(); return `<tr class="text-text-primary"><td class="px-4 py-3 text-sm">${d.name || 'N/A'}</td><td class="px-4 py-3 text-sm">${d.email || 'N/A'}</td><td class="px-4 py-3 text-sm">${formatJoinDate(d.createdAt)}</td></tr>`; };
        
        const renderFilteredProducts = () => {
            const body = document.getElementById('all-products-body');
            body.innerHTML = '';
            // Base filter by category and subcategory
            let filteredProducts = allProducts.filter(doc => {
                const data = doc.data();
                const categoryMatch = currentProductCategoryFilter === 'all' || data.category === currentProductCategoryFilter;
                const subCategoryMatch = currentProductSubCategoryFilter === 'all' || data.subcategory === currentProductSubCategoryFilter;
                return categoryMatch && subCategoryMatch;
            });

            // If duplicate-only mode, further narrow using global duplicateIdSet
            if (showDuplicatesOnly) {
                filteredProducts = filteredProducts.filter(doc => duplicateIdSet.has(doc.id));
            }

            if (filteredProducts.length === 0) {
                const colSpan = body.parentElement.querySelector('thead th').parentElement.children.length;
                body.innerHTML = `<tr><td colspan="${colSpan}" class="p-4 text-center text-text-secondary">No products found.</td></tr>`;
                return;
            }
            filteredProducts.forEach((doc, idx) => body.insertAdjacentHTML('beforeend', renderProductRow_All(doc, idx + 1)));
            lucide.createIcons();
            // Update summary after rendering
            updateDuplicatesSummary(filteredProducts);
        };

        // Update duplicates summary badge
        const updateDuplicatesSummary = (filteredDocs) => {
            const el = document.getElementById('duplicates-summary');
            if (!el) return;
            if (!showDuplicatesOnly) { el.textContent = ''; return; }
            const count = Array.isArray(filteredDocs) ? filteredDocs.length : 0;
            el.textContent = count > 0 ? `Duplicate items: ${count}` : 'No duplicates found';
        };

        // Compute duplicates globally across allProducts using multiple heuristics
        const computeDuplicateSet = () => {
            const norm = (s) => String(s || '').trim().toLowerCase().replace(/\s+/g, ' ');
            const addGroupHits = (map, key, doc) => {
                if (!key) return;
                if (!map[key]) map[key] = [];
                map[key].push(doc);
            };
            const maps = { byModel: {}, bySku: {}, byNameCat: {}, byImage: {} };
            allProducts.forEach(doc => {
                const d = doc.data() || {};
                const model = norm(d.model);
                const sku = norm(d.sku || d.productId);
                const name = norm(d.name);
                const cat = norm(d.category);
                const sub = norm(d.subcategory);
                const img = norm(d.imageUrl);
                addGroupHits(maps.byModel, model ? `model:${model}` : '', doc);
                addGroupHits(maps.bySku, sku ? `sku:${sku}` : '', doc);
                addGroupHits(maps.byNameCat, (name && cat) ? `namecat:${name}|${cat}|${sub}` : '', doc);
                addGroupHits(maps.byImage, img ? `img:${img}` : '', doc);
            });
            const dup = new Set();
            Object.values(maps).forEach(groupMap => {
                Object.values(groupMap).forEach(arr => {
                    if (arr.length >= 2) arr.forEach(doc => dup.add(doc.id));
                });
            });
            duplicateIdSet = dup;
        };

        const renderProductFilters = () => {
            const filtersContainer = document.getElementById('product-category-filters');
            const counts = allProducts.reduce((acc, doc) => {
                const category = doc.data().category;
                if (category) acc[category] = (acc[category] || 0) + 1;
                return acc;
            }, {});
            let buttonsHtml = `<button class="category-filter-btn px-3 py-1 text-sm rounded-full ${currentProductCategoryFilter === 'all' ? 'bg-theme-primary text-white' : 'bg-gray-200 dark:bg-gray-700 text-text-primary'}" data-category="all">All <span class="ml-1 px-2 py-0.5 text-xs rounded-full bg-gray-400 dark:bg-gray-500 text-white">${allProducts.length}</span></button>`;
            for (const key in CATEGORY_MAP) {
                if (counts[key]) {
                     buttonsHtml += `<button class="category-filter-btn px-3 py-1 text-sm rounded-full ${currentProductCategoryFilter === key ? 'bg-theme-primary text-white' : 'bg-gray-200 dark:bg-gray-700 text-text-primary'}" data-category="${key}">${CATEGORY_MAP[key]} <span class="ml-1 px-2 py-0.5 text-xs rounded-full bg-gray-400 dark:bg-gray-500 text-white">${counts[key]}</span></button>`;
                }
            }
            filtersContainer.innerHTML = buttonsHtml;
        };
        
        const renderSubCategoryFilter = () => {
            const container = document.getElementById('product-subcategory-filter-container');
            const subCategories = SUB_CATEGORY_MAP[currentProductCategoryFilter];

            if (!subCategories || subCategories.length === 0) {
                container.innerHTML = '';
                container.classList.add('hidden');
                return;
            }

            const subCategoryCounts = allProducts
                .filter(doc => doc.data().category === currentProductCategoryFilter)
                .reduce((acc, doc) => {
                    const sub = doc.data().subcategory;
                    if (sub) acc[sub] = (acc[sub] || 0) + 1;
                    return acc;
                }, {});
            
            const totalInCategory = Object.values(subCategoryCounts).reduce((sum, count) => sum + count, 0);

            let optionsHtml = `<option value="all">All Sub-categories (${totalInCategory})</option>`;
            subCategories.forEach(sub => {
                if (subCategoryCounts[sub]) {
                    optionsHtml += `<option value="${sub}" ${currentProductSubCategoryFilter === sub ? 'selected' : ''}>${sub} (${subCategoryCounts[sub]})</option>`;
                }
            });

            container.innerHTML = `
                <select id="product-subcategory-select" class="w-full sm:w-auto px-3 py-1.5 text-sm rounded-full bg-gray-200 dark:bg-gray-700 text-text-primary border-transparent focus:border-theme-primary focus:ring-theme-primary">
                    ${optionsHtml}
                </select>
            `;
            container.classList.remove('hidden');
            
            document.getElementById('product-subcategory-select').addEventListener('change', (e) => {
                currentProductSubCategoryFilter = e.target.value;
                renderFilteredProducts();
            });
        };

        const renderProductRow_All = (doc, slNo) => { 
            const d = doc.data();
            const categoryName = CATEGORY_MAP[d.category] || d.category || 'N/A';
            const subCategoryName = d.subcategory || 'N/A';
            const isLowStock = d.stock < 5;
            const stockValue = d.stock !== undefined ? d.stock : 'N/A';
            const lowStockClass = isLowStock ? 'bg-yellow-100 dark:bg-yellow-900/20' : '';
            const lowStockIcon = isLowStock ? '<i data-lucide="alert-triangle" class="w-4 h-4 text-yellow-500 inline-block ml-2"></i>' : '';
            const isOfferHtml = (d.isOnOffer) ? `<span class="px-2 py-1 font-semibold leading-tight text-green-700 bg-green-100 rounded-full dark:bg-green-700 dark:text-green-100">Yes</span>` : `<span class="px-2 py-1 font-semibold leading-tight text-gray-700 bg-gray-100 rounded-full dark:bg-gray-700 dark:text-gray-100">No</span>`;
            const isRefundableHtml = d.isRefundable ? `<span class="px-2 py-1 font-semibold leading-tight text-blue-700 bg-blue-100 rounded-full dark:bg-blue-700 dark:text-blue-100">Yes</span>` : `<span class="px-2 py-1 font-semibold leading-tight text-gray-700 bg-gray-100 rounded-full dark:bg-gray-700 dark:text-gray-100">No</span>`;
            const productIdDisplay = d.model || d.productId || doc.id; // prefer model/code from form, then explicit productId, else doc id

            return `<tr class="text-text-primary ${lowStockClass}">
                <td class="px-4 py-3 text-sm">${slNo}</td>
                <td class="px-4 py-3 text-center"><input type="checkbox" class="row-select accent-theme-primary" data-id="${doc.id}" data-coll="products"></td>
                <td class="px-4 py-3"><img src="${d.imageUrl}" onerror="this.src='https://placehold.co/48x48/e2e8f0/64748b?text=Img'" class="h-12 w-12 object-cover rounded"></td>
                <td class="px-4 py-3 text-sm font-semibold">${d.name || 'N/A'}</td>
                <td class="px-4 py-3 text-sm font-mono" title="Full ID: ${doc.id}">${productIdDisplay}</td>
                <td class="px-4 py-3 text-sm">${categoryName}</td>
                <td class="px-4 py-3 text-sm">${subCategoryName}</td>
                <td class="px-4 py-3 text-sm">৳${d.mainPrice || 0}</td>
                <td class="px-4 py-3 text-sm">৳${d.offerPrice || 0}</td>
                <td class="px-4 py-3 text-sm">${stockValue}${lowStockIcon}</td>
                <td class="px-4 py-3 text-sm">${d.discount || 0}%</td>
                <td class="px-4 py-3 text-xs">${isOfferHtml}</td>
                <td class="px-4 py-3 text-xs">${isRefundableHtml}</td>
                <td class="px-4 py-3 flex items-center"><button class="edit-btn text-indigo-500 hover:text-indigo-700 mr-2" data-id="${doc.id}"><i data-lucide="edit" class="w-5 h-5"></i></button><button class="delete-btn text-red-500 hover:text-red-700" data-id="${doc.id}" data-coll="products"><i data-lucide="trash-2" class="w-5 h-5"></i></button></td>
            </tr>`; 
        };

        // --- Low Stock Products ---
        const LOW_STOCK_THRESHOLD = 5; // default threshold; can be made configurable later
        const renderLowStockProducts = () => {
            const body = document.getElementById('low-stock-body');
            const thresholdEl = document.getElementById('low-stock-threshold-display');
            if (thresholdEl) thresholdEl.textContent = String(LOW_STOCK_THRESHOLD);
            if (!body) return;
            body.innerHTML = '';

            const lowStockDocs = allProducts.filter(doc => {
                const s = Number(doc.data().stock ?? 0);
                return !Number.isNaN(s) && s < LOW_STOCK_THRESHOLD;
            });

            if (lowStockDocs.length === 0) {
                body.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-text-secondary">No low stock products.</td></tr>`;
                return;
            }

            lowStockDocs.forEach((doc, idx) => {
                const d = doc.data();
                const categoryName = CATEGORY_MAP[d.category] || d.category || 'N/A';
                const subCategoryName = d.subcategory || 'N/A';
                const stockValue = d.stock !== undefined ? d.stock : 'N/A';
                body.insertAdjacentHTML('beforeend', `
                    <tr class="text-text-primary">
                        <td class="px-4 py-3 text-sm">${idx + 1}</td>
                        <td class="px-4 py-3 text-center"><input type="checkbox" class="row-select accent-theme-primary" data-id="${doc.id}" data-coll="products"></td>
                        <td class="px-4 py-3"><img src="${d.imageUrl}" onerror="this.src='https://placehold.co/48x48/e2e8f0/64748b?text=Img'" class="h-12 w-12 object-cover rounded"></td>
                        <td class="px-4 py-3 text-sm font-semibold">${d.name || 'N/A'}</td>
                        <td class="px-4 py-3 text-sm">${categoryName}</td>
                        <td class="px-4 py-3 text-sm">${subCategoryName}</td>
                        <td class="px-4 py-3 text-sm">${stockValue} <i data-lucide="alert-triangle" class="w-4 h-4 text-yellow-500 inline-block ml-1"></i></td>
                        <td class="px-4 py-3 flex items-center">
                            <button class="edit-btn text-indigo-500 hover:text-indigo-700 mr-2" data-id="${doc.id}"><i data-lucide="edit" class="w-5 h-5"></i></button>
                            <button class="delete-btn text-red-500 hover:text-red-700" data-id="${doc.id}" data-coll="products"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                        </td>
                    </tr>
                `);
            });
            lucide.createIcons();
        };

        const renderFlashSaleProducts = () => {
            const body = document.getElementById('flash-sale-body');
            if (!body) return;

            const totalEl = document.getElementById('flash-sale-summary-total');
            const activeEl = document.getElementById('flash-sale-summary-active');
            const upcomingEl = document.getElementById('flash-sale-summary-upcoming');
            const endedEl = document.getElementById('flash-sale-summary-ended');

            const parsePrice = (value) => {
                if (value === undefined || value === null || value === '') return null;
                if (typeof value === 'number') {
                    return Number.isFinite(value) ? value : null;
                }
                const trimmed = String(value).trim();
                if (!trimmed) return null;
                const direct = Number(trimmed);
                if (Number.isFinite(direct)) return direct;
                const cleaned = trimmed.replace(/[^0-9+\-.]/g, '');
                if (!cleaned) return null;
                const parsed = Number(cleaned);
                return Number.isFinite(parsed) ? parsed : null;
            };

            const now = new Date();
            const rows = [];
            let activeCount = 0;
            let upcomingCount = 0;
            let endedCount = 0;

            const formatDateTime = (date) => {
                if (!date) return '—';
                return date.toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'short' });
            };

            const describeWindow = (start, end) => {
                if (start && end) {
                    return `${formatDateTime(start)} → ${formatDateTime(end)}`;
                }
                if (start) {
                    return `Starts ${formatDateTime(start)}`;
                }
                if (end) {
                    return `Ends ${formatDateTime(end)}`;
                }
                return 'No schedule';
            };

            const resolveStatus = (start, end) => {
                if (start && now < start) {
                    upcomingCount += 1;
                    return { label: 'Upcoming', className: 'bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-200' };
                }
                if (end && now > end) {
                    endedCount += 1;
                    return { label: 'Ended', className: 'bg-gray-200 text-gray-700 dark:bg-gray-800 dark:text-gray-200' };
                }
                activeCount += 1;
                return { label: 'Live', className: 'bg-green-100 text-green-700 dark:bg-green-900/40 dark:text-green-200' };
            };

            const flashDocs = allProducts.filter(doc => {
                const data = doc.data();
                const flashInfo = (data.flashSale && typeof data.flashSale === 'object') ? data.flashSale : {};
                const enabled = Boolean(flashInfo.enabled ?? data.flashSaleEnabled ?? false);
                if (!enabled) return false;
                const price = parsePrice(flashInfo.price ?? data.flashPrice ?? null);
                const start = coerceToDate(flashInfo.start ?? data.flashStart ?? null);
                const end = coerceToDate(flashInfo.end ?? data.flashEnd ?? null);
                rows.push({ doc, data, price, start, end });
                return true;
            });

            if (flashDocs.length === 0) {
                body.innerHTML = `<tr><td colspan="7" class="px-4 py-6 text-center text-text-secondary">No flash sale products configured yet.</td></tr>`;
                if (totalEl) totalEl.textContent = '0';
                if (activeEl) activeEl.textContent = '0';
                if (upcomingEl) upcomingEl.textContent = '0';
                if (endedEl) endedEl.textContent = '0';
                return;
            }

            rows.sort((a, b) => {
                const startA = a.start ? a.start.getTime() : 0;
                const startB = b.start ? b.start.getTime() : 0;
                const score = (row) => {
                    if (row.end && now > row.end) return 2; // ended
                    if (row.start && now < row.start) return 1; // upcoming
                    return 0; // live
                };
                const statusDiff = score(a) - score(b);
                if (statusDiff !== 0) return statusDiff;
                return startA - startB;
            });

            body.innerHTML = '';
            rows.forEach((row, index) => {
                const { doc, data, price, start, end } = row;
                const status = resolveStatus(start, end);
                const mainPrice = Number(data.mainPrice ?? 0);
                const fallbackPrice = price ?? (Number(data.offerPrice ?? 0) || null);
                const priceDisplay = fallbackPrice !== null ? `৳${fallbackPrice}` : '—';
                const modelDisplay = data.model || data.productId || doc.id;
                const windowText = describeWindow(start, end);
                const discountBadge = (price !== null && mainPrice > 0 && price < mainPrice)
                    ? `<span class="ml-2 text-xs font-semibold px-2 py-0.5 rounded-full bg-amber-100 text-amber-700 dark:bg-amber-900/40 dark:text-amber-200">-${Math.round(((mainPrice - price) / mainPrice) * 100)}%</span>`
                    : '';

                body.insertAdjacentHTML('beforeend', `
                    <tr class="text-text-primary">
                        <td class="px-4 py-3 text-sm">${index + 1}</td>
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-3">
                                <img src="${data.imageUrl || ''}" onerror="this.src='https://placehold.co/56x56/e2e8f0/64748b?text=Img'" class="h-12 w-12 rounded object-cover">
                                <div>
                                    <p class="font-semibold text-sm">${escapeHtml(data.name || 'N/A')}</p>
                                    <p class="text-xs text-text-secondary">Main: ৳${mainPrice || 0}${discountBadge}</p>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-sm font-mono" title="Document ID: ${doc.id}">${escapeHtml(modelDisplay)}</td>
                        <td class="px-4 py-3 text-sm">${priceDisplay}</td>
                        <td class="px-4 py-3 text-sm">${windowText}</td>
                        <td class="px-4 py-3 text-xs"><span class="px-2 py-1 rounded-full font-semibold ${status.className}">${status.label}</span></td>
                        <td class="px-4 py-3 flex items-center gap-2">
                            <button class="edit-btn text-indigo-500 hover:text-indigo-700" data-id="${doc.id}" title="Edit product">
                                <i data-lucide="edit" class="w-5 h-5"></i>
                            </button>
                            <button class="flash-sale-remove-btn text-red-500 hover:text-red-700" data-id="${doc.id}" title="Remove from Flash Sale">
                                <i data-lucide="minus-circle" class="w-5 h-5"></i>
                            </button>
                        </td>
                    </tr>
                `);
            });

            if (totalEl) totalEl.textContent = String(rows.length);
            if (activeEl) activeEl.textContent = String(activeCount);
            if (upcomingEl) upcomingEl.textContent = String(upcomingCount);
            if (endedEl) endedEl.textContent = String(endedCount);

            if (window.lucide?.createIcons) lucide.createIcons();
        };
        const getDeliveryManDropdown = (deliveryMen, orderId, currentDeliveryManId) => {
            let options = deliveryMen
                .filter(doc => (doc.data().accountStatus || 'active') === 'active') // Filter for active delivery men
                .map(doc => {
                    const man = doc.data();
                    return `<option value="${doc.id}" ${doc.id === currentDeliveryManId ? 'selected' : ''}>${man.name}</option>`;
                }).join('');
            return `<select class="delivery-man-assign border rounded p-1 bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600" data-id="${orderId}"><option value="">Unassigned</option>${options}</select>`;
        };
        const getStatusDropdown = (id, currentStatus) => { 
            const statuses = ['pending', 'confirmed', 'shipped', 'out-for-delivery', 'delivered', 'cancelled']; 
            
            // Helper function for display text
            const getDisplayText = (s) => s.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');

            return `<select class="status-change border rounded p-1 bg-gray-50 dark:bg-gray-700 border-gray-300 dark:border-gray-600" data-id="${id}">
                ${statuses.map(s => `<option value="${s}" ${s === currentStatus ? 'selected' : ''}>${getDisplayText(s)}</option>`).join('')}
            </select>`; 
        };
        
        // Updated renderOrderRow_All to include Sl. No. and highlight pending orders
        const renderOrderRow_All = (doc, slNo) => {
            const d = doc.data();
            const orderIdDisplay = d.orderId || doc.id.substring(0, 6); // Use d.orderId or fallback
            const itemsHtml = d.items?.map(item => `<div class="whitespace-nowrap">${item.name} (x${item.quantity})</div>`).join('') || 'N/A';
            const isPending = d.status === 'pending';
            const rowClass = isPending ? 'pending-order' : 'text-text-primary';

            return `<tr class="${rowClass}">
                <td class="px-4 py-3 text-sm">${slNo}</td>
                <td class="px-4 py-3 text-center"><input type="checkbox" class="row-select accent-theme-primary" data-id="${doc.id}" data-coll="orders"></td>
                <td class="px-4 py-3 text-sm font-mono" title="Full ID: ${doc.id}">#${orderIdDisplay}</td>
                <td class="px-4 py-3 text-sm">${d.userName || 'N/A'}</td>
                <td class="px-4 py-3 text-sm">${d.userMobile || 'N/A'}</td>
                <td class="px-4 py-3 text-sm">${d.createdAt?.toDate().toLocaleString() || 'N/A'}</td>
                <td class="px-4 py-3 text-xs">${itemsHtml}</td>
                <td class="px-4 py-3 text-sm">৳${d.totalAmount || 0}</td>
                <td class="px-4 py-3 text-sm">${d.userLocation || 'N/A'}</td>
                <td class="px-4 py-3 text-sm">${d.paymentMethod || 'N/A'}</td>
                <td class="px-4 py-3 text-sm">৳${d.deliveryCharge || 0}</td>
                <td class="px-4 py-3 text-sm">${getDeliveryManDropdown(allDeliveryMen, doc.id, d.assignedDeliveryManId)}</td>
                <td class="px-4 py-3">${getStatusBadge(d.status)}</td>
                <td class="px-4 py-3 flex items-center space-x-2">
                   <button class="view-order-btn text-blue-500 hover:text-blue-700 p-1 rounded-full hover:bg-blue-100 dark:hover:bg-gray-700" data-id="${doc.id}" title="View Details"><i data-lucide="eye" class="w-5 h-5"></i></button>
                   <div class="relative">${getStatusDropdown(doc.id, d.status)}</div>
                   <button class="delete-btn text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 dark:hover:bg-gray-700" data-id="${doc.id}" data-coll="orders" title="Delete Order"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                </td>
            </tr>`;
        };
        const renderUserRow_All = doc => { 
            const d = doc.data(); 
            const isBlocked = d.isBlocked || false;
            const statusBadge = isBlocked
                ? `<span class="px-2 py-1 text-xs font-semibold leading-tight text-red-700 bg-red-100 rounded-full dark:bg-red-700 dark:text-red-100">Blocked</span>`
                : `<span class="px-2 py-1 text-xs font-semibold leading-tight text-green-700 bg-green-100 rounded-full dark:bg-green-700 dark:text-green-100">Active</span>`;

            const blockButtonIcon = isBlocked ? 'play' : 'lock';
            const blockButtonTitle = isBlocked ? 'Unblock User' : 'Block User';
            const blockButtonColor = isBlocked ? 'text-yellow-500 hover:text-yellow-700' : 'text-gray-500 hover:text-gray-700';

            const rowClass = isBlocked ? 'bg-red-50 dark:bg-red-900/10' : 'text-text-primary';

            return `<tr class="${rowClass}" data-uid="${doc.id}">
                <td class="px-4 py-3 text-sm flex items-center">
                    <img src="${d.photoURL || `https://placehold.co/32x32/e2e8f0/64748b?text=${(d.name || 'U').charAt(0)}`}" class="w-8 h-8 rounded-full object-cover mr-3">
                    <span>${d.name || 'N/A'}</span>
                </td>
                <td class="px-4 py-3 text-center"><input type="checkbox" class="row-select accent-theme-primary" data-id="${doc.id}" data-coll="users"></td>
                <td class="px-4 py-3 text-sm">${d.email || 'N/A'}</td>
                <td class="px-4 py-3 text-sm">${d.mobile || 'N/A'}</td>
                <td class="px-4 py-3 text-sm">${d.location || 'N/A'}</td>
                <td class="px-4 py-3 text-sm">${formatJoinDate(d.createdAt)}</td>
                <td class="px-4 py-3 text-xs font-mono">${doc.id}</td>
                <td class="px-4 py-3 text-xs">${statusBadge}</td>
                <td class="px-4 py-3 flex items-center space-x-2">
                      <button class="view-user-btn text-blue-500 hover:text-blue-700 p-1 rounded-full hover:bg-blue-100 dark:hover:bg-gray-700" data-id="${doc.id}" title="View Profile">
                          <i data-lucide="eye" class="w-5 h-5"></i>
                      </button>
                       <button class="block-user-btn ${blockButtonColor} p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700" data-id="${doc.id}" data-blocked="${isBlocked}" title="${blockButtonTitle}">
                           <i data-lucide="${blockButtonIcon}" class="w-5 h-5"></i>
                       </button>
                    <button class="delete-btn text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 dark:hover:bg-gray-700" data-id="${doc.id}" data-coll="users" title="Delete User">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                </td>
            </tr>`; 
        };
        
        const renderDeliveryManCard = (manDoc, stats) => {
            const d = manDoc.data();
            const manId = manDoc.id;
            const status = d.accountStatus || 'active';

            const {
                totalDelivered = 0,
                cashCollected = 0,
            } = stats[manId] || {};

            const statusBadgeColor = status === 'frozen' ? 'bg-yellow-500' : 'bg-green-500';
            const statusText = status.charAt(0).toUpperCase() + status.slice(1);

            return `
            <div class="bg-secondary p-6 rounded-lg shadow-md flex flex-col space-y-4 relative">
                <div class="absolute top-2 right-2 flex space-x-1">
                    <button class="view-delivery-man-btn p-2 rounded-full text-blue-400 dark:text-blue-300 hover:text-blue-300 dark:hover:text-blue-200 hover:bg-gray-100 dark:hover:bg-white/10" data-id="${manId}" title="View Details">
                        <i data-lucide="eye" class="w-5 h-5"></i>
                    </button>
                    <button class="account-status-toggle-btn p-2 rounded-full ${status === 'frozen' ? 'text-yellow-400' : 'text-green-400'} hover:text-yellow-300 dark:hover:text-yellow-300 hover:bg-gray-100 dark:hover:bg-white/10" data-id="${manId}" data-status="${status}" title="${status === 'frozen' ? 'Unfreeze Account' : 'Block/Freeze Account'}">
                        <i data-lucide="${status === 'frozen' ? 'play' : 'lock'}" class="w-5 h-5"></i>
                    </button>
                     <button class="delete-btn p-2 rounded-full text-red-500 dark:text-red-400 hover:text-red-400 dark:hover:text-red-300 hover:bg-gray-100 dark:hover:bg-white/10" data-id="${manId}" data-coll="deliveryMen" title="Delete Account">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <div class="flex-shrink-0">
                    <div class="flex items-center space-x-3 mb-2 pr-20">
                        <h4 class="text-xl font-bold text-primary">${d.name || 'N/A'}</h4>
                        <span class="text-xs font-bold px-2 py-1 ${statusBadgeColor} text-white rounded-full">${statusText}</span>
                    </div>
                    <p class="text-sm text-secondary">${d.email || 'N/A'}</p>
                    <p class="text-sm text-secondary">Phone: ${d.phone || 'N/A'}</p>
                </div>
                
                <div class="grid grid-cols-2 gap-4 text-center py-4 border-y border-color">
                    <div>
                        <p class="text-xs text-secondary uppercase tracking-wider">Total Delivered</p>
                        <p class="text-2xl font-semibold text-primary">${totalDelivered}</p>
                    </div>
                    <div>
                        <p class="text-xs text-secondary uppercase tracking-wider">Cash Collected</p>
                        <p class="text-2xl font-semibold text-primary">৳${Math.round(cashCollected)}</p>
                    </div>
                </div>
            </div>`;
        };

        const renderDeliverySection = async (deliveryMenSnapshot) => {
            const container = document.getElementById('delivery-man-cards-container');
            if (!container) return;
            container.innerHTML = '<div class="text-text-primary text-center xl:col-span-2">Calculating stats...</div>';

            try {
                // 1. Fetch all orders (needed to calculate stats for all delivery men)
                // We fetch all orders and filter/calculate client-side to prevent complex index/permission issues.
                const ordersQuery = query(collection(db, "orders"));
                const ordersSnapshot = await getDocs(ordersQuery);

                // 2. Process orders to calculate stats for each delivery man
                const deliveryStats = {};
                ordersSnapshot.docs.forEach(orderDoc => {
                    const order = orderDoc.data();
                    const manId = order.assignedDeliveryManId;
                    
                    // We only count orders that were successfully delivered and assigned
                    if (manId && order.status === 'delivered') {
                        if (!deliveryStats[manId]) {
                            deliveryStats[manId] = { totalDelivered: 0, cashCollected: 0 };
                        }
                        deliveryStats[manId].totalDelivered++;
                        // Assuming totalAmount includes everything collected
                        deliveryStats[manId].cashCollected += order.totalAmount || 0;
                    }
                });
                
                // 3. Render cards
                container.innerHTML = '';
                if (deliveryMenSnapshot.empty) {
                    container.innerHTML = '<p class="text-center text-text-secondary col-span-full">No delivery men have been added.</p>';
                    return;
                }
                
                deliveryMenSnapshot.forEach(manDoc => {
                    container.insertAdjacentHTML('beforeend', renderDeliveryManCard(manDoc, deliveryStats));
                });

                lucide.createIcons();
            } catch (error) {
                console.error("Error rendering delivery section:", error);
                container.innerHTML = '<p class="text-center text-red-500 col-span-full">Could not load delivery man data.</p>';
                showToast('Failed to load delivery section!', 'error');
            }
        };

        const renderBanners = (snapshot) => {
            const list = document.getElementById('banners-list');
            list.innerHTML = '';
            if (snapshot.empty) { list.innerHTML = `<p class="text-center text-text-secondary col-span-full">No banners have been added.</p>`; return; }
            
            const sortedDocs = snapshot.docs.sort((a, b) => (b.data().createdAt?.toMillis() || 0) - (a.data().createdAt?.toMillis() || 0));

            sortedDocs.forEach(doc => {
                const d = doc.data();
                list.insertAdjacentHTML('beforeend', `<div class="relative group"><img src="${d.imageUrl}" onerror="this.src='https://placehold.co/400x160/e2e8f0/64748b?text=Banner'" class="w-full h-40 object-cover rounded-lg shadow-md"><div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><button class="delete-btn text-white" data-id="${doc.id}" data-coll="banners"><i data-lucide="trash-2" class="w-8 h-8"></i></button></div></div>`);
            });
            lucide.createIcons();
        };

        // --- Side Promos Rendering ---
        const renderSidePromos = (snapshot) => {
            const list = document.getElementById('side-promos-list');
            if (!list) return;
            list.innerHTML = '';
            if (snapshot.empty) {
                list.innerHTML = `<p class="text-center text-text-secondary col-span-full">No side promos have been added.</p>`;
                return;
            }

            const sortedDocs = snapshot.docs.sort((a, b) => (b.data().createdAt?.toMillis?.() || 0) - (a.data().createdAt?.toMillis?.() || 0));
            sortedDocs.forEach(docSnap => {
                const d = docSnap.data();
                const linkOpen = d.link ? `<a href="${d.link}" target="_blank" class="absolute inset-0" aria-label="Open promo link"></a>` : '';
                const activeBadge = (d.active !== false)
                    ? '<span class="absolute top-2 left-2 text-[10px] font-semibold px-1.5 py-0.5 rounded bg-green-100 text-green-700 dark:bg-green-800/40 dark:text-green-300">Active</span>'
                    : '<span class="absolute top-2 left-2 text-[10px] font-semibold px-1.5 py-0.5 rounded bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300">Inactive</span>';
                list.insertAdjacentHTML('beforeend', `
                    <div>
                        <div class="relative group">
                            ${activeBadge}
                            <img src="${d.imageUrl}" onerror="this.src='https://placehold.co/400x160/e2e8f0/64748b?text=Side+Promo'" class="w-full h-40 object-cover rounded-lg shadow-md">
                            ${linkOpen}
                            <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <button class="delete-btn text-white" data-id="${docSnap.id}" data-coll="sidePromos" title="Delete">
                                    <i data-lucide="trash-2" class="w-8 h-8"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mt-2 text-sm text-text-primary">
                            ${d.title ? `<p class="font-semibold truncate" title="${d.title}">${d.title}</p>` : ''}
                            ${d.subtitle ? `<p class="text-xs text-text-secondary truncate" title="${d.subtitle}">${d.subtitle}</p>` : ''}
                            ${d.title_bn ? `<p class="font-semibold truncate" title="${d.title_bn}">${d.title_bn}</p>` : ''}
                            ${d.subtitle_bn ? `<p class="text-xs text-text-secondary truncate" title="${d.subtitle_bn}">${d.subtitle_bn}</p>` : ''}
                            ${(typeof d.order === 'number') ? `<p class="text-[11px] text-text-secondary mt-1">Order: ${d.order}</p>` : ''}
                        </div>
                    </div>
                `);
            });
            if (window.lucide?.createIcons) lucide.createIcons();
        };

        const renderCoupons = (snapshot) => {
            const rowRenderer = (doc) => {
                const d = doc.data();
                const now = new Date();
                const expiry = new Date(d.expiryDate);
                const isActive = expiry >= now;

                const valueText = d.type === 'percentage' ? `${d.value}%` : `৳${d.value}`;
                const statusBadge = isActive 
                    ? `<span class="px-2 py-1 text-xs font-semibold leading-tight text-green-700 bg-green-100 rounded-full dark:bg-green-700 dark:text-green-100">Active</span>`
                    : `<span class="px-2 py-1 text-xs font-semibold leading-tight text-gray-700 bg-gray-100 rounded-full dark:bg-gray-700 dark:text-gray-100">Expired</span>`;

                return `<tr class="text-text-primary">
                    <td class="px-4 py-3 text-sm font-semibold">${d.code}</td>
                    <td class="px-4 py-3 text-sm">${d.type}</td>
                    <td class="px-4 py-3 text-sm">${valueText}</td>
                    <td class="px-4 py-3 text-sm">${d.minSpend > 0 ? `৳${d.minSpend}` : 'N/A'}</td>
                    <td class="px-4 py-3 text-sm">${d.expiryDate}</td>
                    <td class="px-4 py-3 text-xs">${statusBadge}</td>
                    <td class="px-4 py-3 flex gap-2">
                        <button class="edit-coupon-btn text-blue-500 hover:text-blue-700" data-id="${doc.id}" data-coll="coupons">
                            <i data-lucide="edit-2" class="w-5 h-5"></i>
                        </button>
                        <button class="delete-btn text-red-500 hover:text-red-700" data-id="${doc.id}" data-coll="coupons">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </td>
                </tr>`;
            };
            renderTable(snapshot, 'all-coupons-body', rowRenderer);
        };
        
        const renderOrderFilters = () => {
            const filtersContainer = document.getElementById('order-status-filters');
            if (!filtersContainer) return;

            // Normalize status strings to canonical forms for consistent counting
            const normalizeStatus = (s) => {
                if (!s) return 'pending';
                const raw = String(s).trim().toLowerCase();
                if (raw === 'canceled') return 'cancelled';
                if (raw.replace(/\s+/g, '-') === 'out-for-delivery' || raw === 'out-for-delivery') return 'out-for-delivery';
                return raw.replace(/\s+/g, '-');
            };

            const counts = allOrders.reduce((acc, doc) => {
                const status = normalizeStatus(doc.data().status || 'pending');
                acc[status] = (acc[status] || 0) + 1;
                return acc;
            }, {});

            const getStatusDisplayText = (s) => s.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');

            // Always show the full set of filters in consistent order, even if count is 0
            const filterOrder = ['all', 'pending', 'confirmed', 'shipped', 'out-for-delivery', 'delivered', 'cancelled'];

            const buttonsHtml = filterOrder
                .map(status => {
                    const count = status === 'all' ? allOrders.length : (counts[status] || 0);
                    const isActive = currentOrderStatusFilter === status;
                    const activeClass = isActive ? 'bg-theme-primary text-white' : 'bg-gray-200 dark:bg-gray-700 text-text-primary';
                    return `<button class="order-status-filter-btn px-3 py-1 text-sm rounded-full ${activeClass}" data-status="${status}">${getStatusDisplayText(status)} <span class="ml-1 px-2 py-0.5 text-xs rounded-full bg-gray-400 dark:bg-gray-500 text-white">${count}</span></button>`;
                })
                .join('');

            filtersContainer.innerHTML = buttonsHtml;
        };

        const applyAndShowOrdersFilter = (status) => {
            currentOrderStatusFilter = status;
            showPage('orders');
            renderOrderFilters(); // Re-render filters to show active state
            renderFilteredOrders(); // Re-render table with the filter applied
        };


        // --- Product Form Logic ---
        const getProductFormHTML = (prefix) => {
            const categoryOptions = Object.entries(CATEGORY_MAP).map(([key, value]) => `<option value="${key}">${value}</option>`).join('');
            return `
            <input type="hidden" id="${prefix}product-id-hidden">
            <div class="p-4 border rounded-lg bg-gray-50/50 dark:bg-gray-800/50 border-color space-y-4">
                <h3 class="font-semibold text-lg text-text-primary">Category</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="${prefix}product-category" class="block text-text-primary font-medium mb-2">Category</label>
                        <select id="${prefix}product-category" required class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary">
                            <option value="">Select a category</option>${categoryOptions}
                        </select>
                    </div>
                    <div>
                        <label for="${prefix}product-subcategory" class="block text-text-primary font-medium mb-2">Sub-Category</label>
                        <select id="${prefix}product-subcategory" class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary hidden" disabled>
                            <option value="">Select sub-category</option>
                        </select>
                        <div id="${prefix}subcategory-info" class="text-xs text-text-secondary mt-1"></div>
                    </div>
                </div>
            </div>
            
            <div class="p-4 border rounded-lg bg-gray-50/50 dark:bg-gray-800/50 border-color space-y-4">
                <h3 class="font-semibold text-lg text-text-primary">Common Details</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label for="${prefix}product-name" class="block text-text-primary font-medium mb-2">Product Name</label><input type="text" id="${prefix}product-name" required class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary"></div>
                    <div><label for="${prefix}product-id" class="block text-text-primary font-medium mb-2">Model Number / Code</label><input type="text" id="${prefix}product-id" required class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary"></div>
                    <div><label for="${prefix}product-brand" class="block text-text-primary font-medium mb-2">Brand</label><input type="text" id="${prefix}product-brand" class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary"></div>
                    <div><label for="${prefix}product-warranty" class="block text-text-primary font-medium mb-2">Warranty</label><input type="text" id="${prefix}product-warranty" placeholder="e.g., 1 year, 2 years" class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div><label for="${prefix}product-main-price" class="block text-text-primary font-medium mb-2">Main Price (৳)</label><input type="number" id="${prefix}product-main-price" required class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary"></div>
                    <div><label for="${prefix}product-offer-price" class="block text-text-primary font-medium mb-2">Offer Price (৳)</label><input type="number" id="${prefix}product-offer-price" class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary"></div>
                    <div><label for="${prefix}product-discount" class="block text-text-primary font-medium mb-2">Discount (%)</label><input type="number" id="${prefix}product-discount" readonly class="w-full px-4 py-2 bg-gray-200 dark:bg-gray-600 border border-gray-300 dark:border-gray-600 rounded-lg"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div><label for="${prefix}product-stock" class="block text-text-primary font-medium mb-2">Stock Count</label><input type="number" id="${prefix}product-stock" required class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary" value="0"></div>
                    <div><label for="${prefix}product-cost-price" class="block text-text-primary font-medium mb-2">Cost Price (৳)</label><input type="number" id="${prefix}product-cost-price" class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary" value="0"></div>
                    <div><label for="${prefix}product-rating" class="block text-text-primary font-medium mb-2">Rating (0-5)</label><input type="number" id="${prefix}product-rating" step="0.1" min="0" max="5" class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary" value="0"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-2 border-t border-color">
                    <div class="flex items-center justify-between">
                        <span class="text-text-primary font-medium">On Offer</span>
                        <label for="${prefix}product-on-offer" class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="${prefix}product-on-offer" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-600 peer-checked:bg-theme-primary peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
                        </label>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-text-primary font-medium">Refundable</span>
                        <label for="${prefix}product-refundable" class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="${prefix}product-refundable" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-600 peer-checked:bg-theme-primary peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
                        </label>
                    </div>
                </div>
                <div class="pt-4 border-t border-dashed border-color space-y-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <span class="text-text-primary font-medium">Flash Sale</span>
                            <p class="text-xs text-text-secondary">Enable limited-time pricing with a countdown on the storefront.</p>
                        </div>
                        <label for="${prefix}product-flash-enabled" class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="${prefix}product-flash-enabled" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-600 peer-checked:bg-theme-primary peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
                        </label>
                    </div>
                    <div id="${prefix}flash-sale-fields" class="grid grid-cols-1 md:grid-cols-3 gap-6 hidden">
                        <div>
                            <label for="${prefix}product-flash-price" class="block text-text-primary font-medium mb-2">Flash Price (৳)</label>
                            <input type="number" id="${prefix}product-flash-price" class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary" min="0" step="0.01" disabled>
                        </div>
                        <div>
                            <label for="${prefix}product-flash-start" class="block text-text-primary font-medium mb-2">Start Time</label>
                            <input type="datetime-local" id="${prefix}product-flash-start" class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary" disabled>
                        </div>
                        <div>
                            <label for="${prefix}product-flash-end" class="block text-text-primary font-medium mb-2">End Time</label>
                            <input type="datetime-local" id="${prefix}product-flash-end" class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary" disabled>
                        </div>
                    </div>
                </div>
                <div class="pt-4 border-t border-dashed border-color space-y-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <span class="text-text-primary font-medium">Mega Sale</span>
                            <p class="text-xs text-text-secondary">Pin hero deals on the storefront Mega Sale rail with custom pricing.</p>
                        </div>
                        <label for="${prefix}product-mega-enabled" class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="${prefix}product-mega-enabled" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-600 peer-checked:bg-theme-primary peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all"></div>
                        </label>
                    </div>
                    <div id="${prefix}mega-sale-fields" class="grid grid-cols-1 md:grid-cols-2 gap-6 hidden">
                        <div>
                            <label for="${prefix}product-mega-discount" class="block text-text-primary font-medium mb-2">Discount (%)</label>
                            <input type="number" id="${prefix}product-mega-discount" class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary" min="0" max="100" step="0.01" disabled>
                        </div>
                        <div>
                            <label for="${prefix}product-mega-label" class="block text-text-primary font-medium mb-2">Badge Label</label>
                            <input type="text" id="${prefix}product-mega-label" class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary" placeholder="e.g., Mega Deal" maxlength="32" disabled>
                        </div>
                        <div>
                            <label for="${prefix}product-mega-price" class="block text-text-primary font-medium mb-2">Mega Price (৳)</label>
                            <input type="number" id="${prefix}product-mega-price" class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary" min="0" step="0.01" disabled>
                        </div>
                        <div>
                            <label for="${prefix}product-mega-original" class="block text-text-primary font-medium mb-2">Original Price (৳)</label>
                            <input type="number" id="${prefix}product-mega-original" class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary" min="0" step="0.01" disabled>
                        </div>
                    </div>
                </div>
                <div><label for="${prefix}product-main-image" class="block text-text-primary font-medium mb-2">Main Image URL</label><input type="url" id="${prefix}product-main-image" required class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-primary" placeholder="https://example.com/main-image.jpg"></div>
                <div>
                    <div class="flex items-center justify-between mb-2"><label class="block text-text-primary font-medium">Specifications</label><button type="button" id="${prefix}add-specification-btn" class="text-sm bg-theme-primary text-white py-1 px-3 rounded-lg hover:bg-theme-primary-hover">+ Add</button></div>
                    <div id="${prefix}specification-container" class="space-y-2"></div>
                </div>
                <div>
                    <div class="flex items-center justify-between mb-2"><label class="block text-text-primary font-medium">Thumbnail Images</label><button type="button" id="${prefix}add-thumbnail-btn" class="text-sm bg-theme-primary text-white py-1 px-3 rounded-lg hover:bg-theme-primary-hover">+ Add</button></div>
                    <div id="${prefix}thumbnail-container" class="space-y-2"></div>
                </div>
            </div>
            
            <div><label for="${prefix}product-details" class="block text-text-primary font-medium mb-2">Description</label><textarea id="${prefix}product-details" rows="4" class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"></textarea></div>
            
            <button type="submit" class="w-full bg-theme-primary text-white font-bold py-3 px-4 rounded-lg disabled:bg-opacity-70 btn-glow">${prefix === 'edit-' ? 'Save Changes' : 'Add Product'}</button>
            `;
        }

        const createSpecificationInput = (container, key = '', value = '') => {
            const inputWrapper = document.createElement('div');
            inputWrapper.className = 'flex items-center space-x-2 spec-row';
            inputWrapper.innerHTML = `
                <input type="text" class="w-1/3 px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-sm spec-key" placeholder="e.g., Color" value="${key}">
                <input type="text" class="w-2/3 px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-sm spec-value" placeholder="e.g., Red" value="${value}">
                <button type="button" class="remove-spec-btn text-red-500 hover:text-red-700 p-1"><i data-lucide="x-circle" class="w-5 h-5"></i></button>
            `;
            container.appendChild(inputWrapper);
            lucide.createIcons();
        };

        const setupProductForm = (formElement, prefix) => {
            if (!formElement) return;
            formElement.innerHTML = getProductFormHTML(prefix);

            const mainPrice = document.getElementById(`${prefix}product-main-price`);
            const offerPrice = document.getElementById(`${prefix}product-offer-price`);
            const discount = document.getElementById(`${prefix}product-discount`);
            
            const calculateDiscount = () => {
                const main = parseFloat(mainPrice.value) || 0;
                const offer = parseFloat(offerPrice.value) || 0;
                discount.value = (main > 0 && offer > 0 && main > offer) ? Math.round(((main - offer) / main) * 100) : 0;
            };
            mainPrice.addEventListener('input', calculateDiscount);
            offerPrice.addEventListener('input', calculateDiscount);

            const categorySelect = document.getElementById(`${prefix}product-category`);
            const subCategorySelect = document.getElementById(`${prefix}product-subcategory`);
            const subCategoryInfo = document.getElementById(`${prefix}subcategory-info`);

            categorySelect.addEventListener('change', (e) => {
                const selectedCategory = e.target.value;
                const subCategories = SUB_CATEGORY_MAP[selectedCategory];
                
                subCategorySelect.innerHTML = '<option value="">Select sub-category</option>'; // Reset
                subCategoryInfo.innerHTML = ''; // Reset info text

                if (subCategories && subCategories.length > 0) {
                    subCategories.forEach(sub => {
                        const option = document.createElement('option');
                        option.value = sub;
                        option.textContent = sub;
                        subCategorySelect.appendChild(option);
                    });
                    subCategorySelect.disabled = false;
                    subCategorySelect.classList.remove('hidden');
                    subCategoryInfo.innerHTML = `Available: ${subCategories.join(', ')}`;
                } else {
                    subCategorySelect.disabled = true;
                    subCategorySelect.classList.add('hidden');
                }
            });

            document.getElementById(`${prefix}add-thumbnail-btn`).addEventListener('click', () => {
                const container = document.getElementById(`${prefix}thumbnail-container`);
                const inputWrapper = document.createElement('div');
                inputWrapper.className = 'flex items-center space-x-2';
                inputWrapper.innerHTML = `
                    <input type="url" class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg thumbnail-input" placeholder="https://example.com/image.jpg">
                    <button type="button" class="remove-thumbnail-btn text-red-500 hover:text-red-700 p-1"><i data-lucide="x-circle" class="w-5 h-5"></i></button>
                `;
                container.appendChild(inputWrapper);
                lucide.createIcons();
            });

            document.getElementById(`${prefix}add-specification-btn`).addEventListener('click', () => {
                const container = document.getElementById(`${prefix}specification-container`);
                createSpecificationInput(container);
            });

            const flashToggle = document.getElementById(`${prefix}product-flash-enabled`);
            const flashFields = document.getElementById(`${prefix}flash-sale-fields`);
            const flashPriceInput = document.getElementById(`${prefix}product-flash-price`);
            const flashStartInput = document.getElementById(`${prefix}product-flash-start`);
            const flashEndInput = document.getElementById(`${prefix}product-flash-end`);

            const syncFlashSaleState = (preserveValues = true) => {
                if (!flashFields || !flashToggle) return;
                const enabled = !!flashToggle.checked;
                flashFields.classList.toggle('hidden', !enabled);
                [flashPriceInput, flashStartInput, flashEndInput].forEach(input => {
                    if (!input) return;
                    input.disabled = !enabled;
                    if (!enabled && !preserveValues) {
                        input.value = '';
                    }
                });
            };

            if (flashToggle) {
                flashToggle.addEventListener('change', () => syncFlashSaleState(false));
            }
            syncFlashSaleState(true);
            formElement.__syncFlashSale = syncFlashSaleState;

            const megaToggle = document.getElementById(`${prefix}product-mega-enabled`);
            const megaFields = document.getElementById(`${prefix}mega-sale-fields`);
            const megaDiscountInput = document.getElementById(`${prefix}product-mega-discount`);
            const megaLabelInput = document.getElementById(`${prefix}product-mega-label`);
            const megaPriceInput = document.getElementById(`${prefix}product-mega-price`);
            const megaOriginalInput = document.getElementById(`${prefix}product-mega-original`);
            const megaInputs = [megaDiscountInput, megaLabelInput, megaPriceInput, megaOriginalInput];

            const autoSyncMegaDiscount = () => {
                if (!megaDiscountInput) return;
                const price = parseFloat(megaPriceInput?.value || '');
                const original = parseFloat(megaOriginalInput?.value || '');
                if (Number.isFinite(price) && Number.isFinite(original) && original > 0 && price > 0 && original > price) {
                    megaDiscountInput.value = Math.round(((original - price) / original) * 100);
                }
            };

            const syncMegaSaleState = (preserveValues = true) => {
                if (!megaFields || !megaToggle) return;
                const enabled = !!megaToggle.checked;
                megaFields.classList.toggle('hidden', !enabled);
                megaInputs.forEach(input => {
                    if (!input) return;
                    input.disabled = !enabled;
                    if (!enabled && !preserveValues) {
                        input.value = '';
                    }
                });
                if (enabled) {
                    autoSyncMegaDiscount();
                }
            };

            if (megaToggle) {
                megaToggle.addEventListener('change', () => syncMegaSaleState(false));
            }
            if (megaPriceInput) megaPriceInput.addEventListener('input', autoSyncMegaDiscount);
            if (megaOriginalInput) megaOriginalInput.addEventListener('input', autoSyncMegaDiscount);

            syncMegaSaleState(true);
            formElement.__syncMegaSale = syncMegaSaleState;
        };

        const getProductDataFromForm = (form, prefix) => {
            const thumbnailInputs = form.querySelectorAll(`#${prefix}thumbnail-container .thumbnail-input`);
            const thumbnails = Array.from(thumbnailInputs).map(input => input.value).filter(Boolean);
            
            const specification = {};
            const specRows = form.querySelectorAll(`#${prefix}specification-container .spec-row`);
            specRows.forEach(row => {
                const key = row.querySelector('.spec-key').value.trim();
                const value = row.querySelector('.spec-value').value.trim();
                if (key) {
                    specification[key] = value;
                }
            });

            const parseDateInputValue = (value) => {
                if (!value) return null;
                const date = new Date(value);
                return Number.isNaN(date.getTime()) ? null : date;
            };

            const flashEnabled = form.querySelector(`#${prefix}product-flash-enabled`)?.checked || false;
            const flashPriceValue = parseFloat(form.querySelector(`#${prefix}product-flash-price`)?.value) || 0;
            const flashStartValue = form.querySelector(`#${prefix}product-flash-start`)?.value || '';
            const flashEndValue = form.querySelector(`#${prefix}product-flash-end`)?.value || '';

            const flashSale = flashEnabled ? {
                enabled: true,
                price: flashPriceValue > 0 ? flashPriceValue : null,
                start: parseDateInputValue(flashStartValue),
                end: parseDateInputValue(flashEndValue)
            } : { enabled: false };

            const normalizeNumber = (value) => {
                const num = Number(value);
                return Number.isFinite(num) ? num : null;
            };

            const megaEnabled = form.querySelector(`#${prefix}product-mega-enabled`)?.checked || false;
            const megaDiscountRaw = form.querySelector(`#${prefix}product-mega-discount`)?.value;
            const megaPriceRaw = form.querySelector(`#${prefix}product-mega-price`)?.value;
            const megaOriginalRaw = form.querySelector(`#${prefix}product-mega-original`)?.value;
            const megaLabelRaw = form.querySelector(`#${prefix}product-mega-label`)?.value?.trim();

            const megaPrice = normalizeNumber(megaPriceRaw);
            const megaOriginal = normalizeNumber(megaOriginalRaw);
            let megaDiscount = normalizeNumber(megaDiscountRaw);
            if (megaEnabled && (!Number.isFinite(megaDiscount) || megaDiscount === null) && Number.isFinite(megaOriginal) && Number.isFinite(megaPrice) && megaOriginal > megaPrice) {
                megaDiscount = Math.round(((megaOriginal - megaPrice) / megaOriginal) * 100);
            }

            const megaLabel = megaLabelRaw ? megaLabelRaw : null;
            const megaSale = megaEnabled ? {
                enabled: true,
                discountPercent: Number.isFinite(megaDiscount) ? megaDiscount : null,
                price: Number.isFinite(megaPrice) ? megaPrice : null,
                originalPrice: Number.isFinite(megaOriginal) ? megaOriginal : null,
                label: megaLabel
            } : { enabled: false };

            return {
                name: form.querySelector(`#${prefix}product-name`).value,
                model: form.querySelector(`#${prefix}product-id`).value,
                brand: form.querySelector(`#${prefix}product-brand`).value,
                warranty: form.querySelector(`#${prefix}product-warranty`).value,
                mainPrice: parseFloat(form.querySelector(`#${prefix}product-main-price`).value) || 0,
                offerPrice: parseFloat(form.querySelector(`#${prefix}product-offer-price`).value) || 0,
                discount: parseFloat(form.querySelector(`#${prefix}product-discount`).value) || 0,
                stock: parseInt(form.querySelector(`#${prefix}product-stock`).value, 10) || 0,
                costPrice: parseFloat(form.querySelector(`#${prefix}product-cost-price`)?.value) || 0,
                rating: parseFloat(form.querySelector(`#${prefix}product-rating`).value) || 0,
                imageUrl: form.querySelector(`#${prefix}product-main-image`).value,
                thumbnails,
                category: form.querySelector(`#${prefix}product-category`).value,
                subcategory: form.querySelector(`#${prefix}product-subcategory`).value,
                details: form.querySelector(`#${prefix}product-details`).value,
                specification: specification,
                isOnOffer: form.querySelector(`#${prefix}product-on-offer`).checked,
                isRefundable: form.querySelector(`#${prefix}product-refundable`).checked,
                flashSale,
                flashSaleEnabled: flashSale.enabled,
                flashPrice: flashSale.enabled && flashSale.price ? flashSale.price : null,
                flashStart: flashSale.enabled && flashSale.start ? flashSale.start : null,
                flashEnd: flashSale.enabled && flashSale.end ? flashSale.end : null,
                megaSale,
                megaSaleEnabled: megaEnabled,
                mega_sale_enabled: megaEnabled,
                megaSalePrice: megaEnabled && Number.isFinite(megaPrice) ? megaPrice : null,
                megaSaleOriginalPrice: megaEnabled && Number.isFinite(megaOriginal) ? megaOriginal : null,
                megaSaleDiscount: megaEnabled && Number.isFinite(megaDiscount) ? megaDiscount : null,
                megaSaleLabel: megaLabel
            };
        };

        // --- Event Delegation & Handlers ---
        document.addEventListener('submit', async e => {
            e.preventDefault();
            const formId = e.target.id;
            const button = e.target.querySelector('button[type="submit"]');

            if (formId === 'add-product-form') {
                setButtonLoading(button, true, 'Adding...');
                try {
                    const productData = getProductDataFromForm(e.target, 'add-');
                    const newRef = await addDoc(collection(db, 'products'), { ...productData, createdAt: serverTimestamp() });
                    showToast(`Product added successfully! ID: ${newRef.id}`);
                    e.target.reset();
                    document.getElementById('add-thumbnail-container').innerHTML = '';
                    document.getElementById('add-specification-container').innerHTML = '';
                    if (typeof e.target.__syncFlashSale === 'function') {
                        e.target.__syncFlashSale(false);
                    }
                    if (typeof e.target.__syncMegaSale === 'function') {
                        e.target.__syncMegaSale(false);
                    }
                } catch (err) {
                    console.error("Error adding product: ", err);
                    showToast('Failed to add product!', 'error');
                } finally {
                    setButtonLoading(button, false);
                }
            } else if (formId === 'edit-product-form') {
                setButtonLoading(button, true, 'Saving...');
                try {
                    const productId = document.getElementById('edit-product-id-hidden').value;
                    const updatedData = getProductDataFromForm(e.target, 'edit-');
                    await updateDoc(doc(db, 'products', productId), updatedData);
                    showToast('Product updated successfully!');
                    showPage('products');
                } catch (err) {
                    console.error("Error updating product:", err);
                    showToast('Failed to update product!', 'error');
                } finally {
                    setButtonLoading(button, false);
                }
            } else if (formId === 'add-banner-form') {
                setButtonLoading(button, true, 'Adding...');
                try {
                    await addDoc(collection(db, 'banners'), { 
                        imageUrl: e.target['banner-image'].value, 
                        link: e.target['banner-link'].value, 
                        createdAt: serverTimestamp() 
                    });
                    showToast('Banner added successfully!');
                    e.target.reset();
                } catch(err) {
                    showToast('Failed to add banner!', 'error');
                } finally {
                    setButtonLoading(button, false);
                }
            } else if (formId === 'add-coupon-form') {
                setButtonLoading(button, true, 'Adding...');
                try {
                    const code = e.target['coupon-code'].value.toUpperCase();
                    const existingCouponQuery = query(collection(db, "coupons"), where("code", "==", code));
                    const existingCouponSnap = await getDocs(existingCouponQuery);

                    if (!existingCouponSnap.empty) {
                        throw new Error("Coupon code already exists.");
                    }
                    
                    await addDoc(collection(db, 'coupons'), {
                        code: code,
                        type: e.target['coupon-type'].value,
                        value: parseFloat(e.target['coupon-value'].value),
                        expiryDate: e.target['coupon-expiry'].value,
                        minSpend: parseFloat(e.target['coupon-min-spend'].value) || 0,
                        createdAt: serverTimestamp()
                    });
                    showToast('Coupon added successfully!');
                    e.target.reset();
                } catch (err) {
                    console.error("Error adding coupon:", err);
                    showToast(err.message || 'Failed to add coupon!', 'error');
                } finally {
                    setButtonLoading(button, false);
                }
            } else if (formId === 'add-side-promo-form') {
                setButtonLoading(button, true, 'Adding...');
                try {
                    const imageUrl = e.target['side-promo-image'].value;
                    const title = (e.target['side-promo-title']?.value || '').trim();
                    const title_bn = (e.target['side-promo-title-bn']?.value || '').trim();
                    const subtitle = (e.target['side-promo-subtitle']?.value || '').trim();
                    const subtitle_bn = (e.target['side-promo-subtitle-bn']?.value || '').trim();
                    const link = e.target['side-promo-link'].value;
                    const alt = (e.target['side-promo-alt']?.value || '').trim();
                    const order = parseInt(e.target['side-promo-order']?.value) || 0;
                    const active = e.target['side-promo-active'].checked;
                    await addDoc(collection(db, 'sidePromos'), {
                        imageUrl,
                        title,
                        title_bn,
                        subtitle,
                        subtitle_bn,
                        link,
                        alt,
                        order,
                        active,
                        createdAt: serverTimestamp()
                    });
                    showToast('Side promo added successfully!');
                    e.target.reset();
                    // default to active after reset
                    const activeInput = document.getElementById('side-promo-active');
                    if (activeInput) activeInput.checked = true;
                } catch (err) {
                    console.error('Error adding side promo:', err);
                    showToast('Failed to add side promo!', 'error');
                } finally {
                    setButtonLoading(button, false);
                }
            } else if (formId === 'add-delivery-man-form') {
                 setButtonLoading(button, true, 'Adding...');
                const email = e.target['delivery-man-email'].value;
                const password = e.target['delivery-man-password'].value;
                const name = e.target['delivery-man-name'].value;
                const phone = e.target['delivery-man-phone'].value;
                const vehicle = e.target['delivery-man-vehicle'].value;
                
                const tempAppName = `temp-app-${Date.now()}`;
                let secondaryApp;
                try {
                    secondaryApp = initializeApp(firebaseConfig, tempAppName);
                    const secondaryAuth = getAuth(secondaryApp);
                    
                    const userCredential = await createUserWithEmailAndPassword(secondaryAuth, email, password);
                    const newUserUid = userCredential.user.uid;

                    await setDoc(doc(db, 'deliveryMen', newUserUid), {
                        name: name,
                        email: email,
                        phone: phone,
                        vehicle: vehicle,
                        accountStatus: 'active',
                        createdAt: serverTimestamp()
                    });
                    
                    await signOut(secondaryAuth);
                    showToast('Delivery man added successfully!');
                    e.target.reset();
                } catch (err) {
                    console.error("Error adding delivery man: ", err);
                    showToast(err.code === 'auth/email-already-in-use' ? 'This email is already registered.' : `Failed to add delivery man!`, 'error');
                } finally {
                    if (secondaryApp) {
                        await deleteApp(secondaryApp).catch(e => console.error("Could not delete temp app", e));
                    }
                    setButtonLoading(button, false);
                }
            } else if(formId === 'profile-settings-form') {
                setButtonLoading(button, true, 'Saving...');
                try {
                    const user = auth.currentUser;
                    if (!user) throw new Error("User not found");
                    const newName = document.getElementById('admin-name').value;
                    const newImageUrl = document.getElementById('admin-image').value;
                    await updateDoc(doc(db, "admins", user.uid), { name: newName, imageUrl: newImageUrl });
                    await loadAdminProfile(user);
                    showToast("Profile updated successfully!");
                } catch(err) {
                    showToast("Failed to update profile!", 'error');
                } finally {
                    setButtonLoading(button, false);
                }
            } else if (formId === 'chat-message-form') {
                const input = document.getElementById('chat-message-input');
                const messageText = input.value.trim();

                if (messageText && currentChatUserId) {
                    input.value = ''; 
                    try {
                        const messageData = {
                            sender: 'admin',
                            text: messageText,
                            timestamp: serverTimestamp(),
                            adminId: auth.currentUser.uid
                        };
                        const chatRef = doc(db, 'live_chats', currentChatUserId);
                        
                        await addDoc(collection(chatRef, 'messages'), messageData);
                        
                        await updateDoc(chatRef, {
                            lastMessage: messageText,
                            lastMessageTimestamp: serverTimestamp(),
                            lastSender: 'admin',
                            isReadByAdmin: true,
                            isReadByUser: false
                        });
                    } catch (err) {
                        console.error("Error sending message:", err);
                        showToast("Failed to send message!", 'error');
                        input.value = messageText;
                    }
                }
            }
        });

        document.addEventListener('click', (e) => {
            const liveVisitorsCard = e.target.closest('#live-visitors-card');
            if (liveVisitorsCard) {
                openLiveVisitorsModal();
                return;
            }
            const liveVisitorsHeader = e.target.closest('#header-live-visitors');
            if (liveVisitorsHeader) {
                openLiveVisitorsModal();
                return;
            }
// Show edit coupon modal and populate fields
async function openEditCouponModal(couponId) {
    // Create modal if not exists
    let modal = document.getElementById('edit-coupon-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'edit-coupon-modal';
        modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
        modal.innerHTML = `
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-8 w-full max-w-md relative">
                <button id="edit-coupon-modal-close" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                <h2 class="text-xl font-bold mb-4 text-text-primary">Edit Coupon</h2>
                <form id="edit-coupon-form" class="space-y-4">
                    <input type="hidden" id="edit-coupon-id">
                    <div>
                        <label for="edit-coupon-code" class="block text-text-primary font-medium mb-2">Coupon Code</label>
                        <input type="text" id="edit-coupon-code" required class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border rounded-lg">
                    </div>
                    <div>
                        <label for="edit-coupon-type" class="block text-text-primary font-medium mb-2">Discount Type</label>
                        <select id="edit-coupon-type" required class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border rounded-lg">
                            <option value="percentage">Percentage</option>
                            <option value="fixed">Fixed Amount</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit-coupon-value" class="block text-text-primary font-medium mb-2">Value</label>
                        <input type="number" id="edit-coupon-value" required min="0" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border rounded-lg">
                    </div>
                    <div>
                        <label for="edit-coupon-expiry" class="block text-text-primary font-medium mb-2">Expiry Date</label>
                        <input type="date" id="edit-coupon-expiry" required class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border rounded-lg">
                    </div>
                    <div>
                        <label for="edit-coupon-min-spend" class="block text-text-primary font-medium mb-2">Minimum Spend</label>
                        <input type="number" id="edit-coupon-min-spend" min="0" class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border rounded-lg">
                    </div>
                    <button type="submit" class="w-full bg-theme-primary text-white font-bold py-3 px-4 rounded-lg">Update Coupon</button>
                </form>
            </div>
        `;
        document.body.appendChild(modal);
        document.getElementById('edit-coupon-modal-close').onclick = () => modal.remove();
        document.getElementById('edit-coupon-form').onsubmit = handleEditCouponSubmit;
    }
    modal.classList.remove('hidden');
    // Fetch coupon data from Firestore
    const db = window.db;
    const docRef = db.collection ? db.collection('coupons').doc(couponId) : window.doc(db, 'coupons', couponId);
    let couponData;
    if (docRef.get) {
        couponData = (await docRef.get()).data();
    } else {
        couponData = (await window.getDoc(docRef)).data();
    }
    document.getElementById('edit-coupon-id').value = couponId;
    document.getElementById('edit-coupon-code').value = couponData.code || '';
    document.getElementById('edit-coupon-type').value = couponData.type || 'percentage';
    document.getElementById('edit-coupon-value').value = couponData.value || 0;
    document.getElementById('edit-coupon-expiry').value = couponData.expiryDate || '';
    document.getElementById('edit-coupon-min-spend').value = couponData.minSpend || 0;
}

// Handle edit coupon form submit
async function handleEditCouponSubmit(e) {
    e.preventDefault();
    const db = window.db;
    const couponId = document.getElementById('edit-coupon-id').value;
    const code = document.getElementById('edit-coupon-code').value.trim().toUpperCase();
    const type = document.getElementById('edit-coupon-type').value;
    const value = parseFloat(document.getElementById('edit-coupon-value').value);
    const expiryDate = document.getElementById('edit-coupon-expiry').value;
    const minSpend = parseFloat(document.getElementById('edit-coupon-min-spend').value) || 0;
    const docRef = db.collection ? db.collection('coupons').doc(couponId) : window.doc(db, 'coupons', couponId);
    try {
        if (docRef.update) {
            await docRef.update({ code, type, value, expiryDate, minSpend });
        } else {
            await window.updateDoc(docRef, { code, type, value, expiryDate, minSpend });
        }
        showToast('Coupon updated successfully!');
        document.getElementById('edit-coupon-modal').remove();
    } catch (err) {
        showToast('Failed to update coupon!', 'error');
        console.error(err);
    }
}
            const editCouponBtn = e.target.closest('.edit-coupon-btn');
            if (editCouponBtn) {
                const couponId = editCouponBtn.dataset.id;
                openEditCouponModal(couponId);
                return;
            }
            const navLink = e.target.closest('.nav-link');
            if(navLink) {
                e.preventDefault();
                const pageId = navLink.dataset.page;
                history.pushState({pageId}, '', `#${pageId}`);
                showPage(pageId);
                return;
            }

            // Chat search and unread toggle (click)
            const searchInput = e.target.closest('#chat-search-input');
            if (searchInput && lastChatsSnapshot) {
                renderChatList(lastChatsSnapshot);
                return;
            }

            const unreadToggle = e.target.closest('#chat-unread-toggle');
            if (unreadToggle && lastChatsSnapshot) {
                renderChatList(lastChatsSnapshot);
                return;
            }

            const statCard = e.target.closest('.stat-card[data-page]');
            if (statCard) {
                const page = statCard.dataset.page;
                const filter = statCard.dataset.filter;
                
                if (page === 'orders' && filter) {
                    applyAndShowOrdersFilter(filter);
                } else {
                    showPage(page);
                }
                return;
            }

            const orderStatusFilterBtn = e.target.closest('.order-status-filter-btn');
            if(orderStatusFilterBtn) {
                applyAndShowOrdersFilter(orderStatusFilterBtn.dataset.status);
                return;
            }
    
            const chatListItem = e.target.closest('.chat-list-item');
            if (chatListItem) {
                openChat(chatListItem.dataset.userId);
                return;
            }

            const themeOption = e.target.closest('.theme-option');
            if (themeOption) {
                applyTheme(themeOption.dataset.theme);
                return;
            }
            
            const deleteBtn = e.target.closest('.delete-btn');
            if (deleteBtn) {
                const collectionName = deleteBtn.dataset.coll;
                const id = deleteBtn.dataset.id;
                let title = "Are you sure?";
                let text = `Do you really want to delete this ${collectionName.slice(0,-1)}? This action cannot be undone.`;

                if (collectionName === 'users') {
                    title = "Delete User?";
                    text = "This only removes the user's data, not their authentication account. This action cannot be undone.";
                } else if (collectionName === 'deliveryMen') {
                    title = "Delete Delivery Man?";
                    text = "This will permanently delete the delivery man's data. Their login account will NOT be deleted. Consider 'Blocking' the account instead. This action is irreversible.";
                }

                showConfirmationModal(async () => {
                    try {
                        await deleteDoc(doc(db, collectionName, id));
                        showToast(`${collectionName.slice(0, -1)} deleted successfully!`);
                    } catch (err) {
                        showToast(`Failed to delete ${collectionName.slice(0, -1)}!`, 'error');
                        console.error(`Error deleting from ${collectionName}:`, err);
                    }
                }, title, text);
                return;
            }

            // Toggle Duplicates view
            const dupToggleBtn = e.target.closest('#products-toggle-duplicates');
            if (dupToggleBtn) {
                showDuplicatesOnly = !showDuplicatesOnly;
                dupToggleBtn.innerHTML = showDuplicatesOnly 
                    ? '<i data-lucide="list" class="w-4 h-4 mr-2"></i> Show All'
                    : '<i data-lucide="alert-triangle" class="w-4 h-4 mr-2"></i> Show Duplicates';
                renderFilteredProducts();
                if (window.lucide?.createIcons) lucide.createIcons();
                return;
            }

            const flashSaleAddBtn = e.target.closest('#flash-sale-add-product');
            if (flashSaleAddBtn) {
                history.pushState({ pageId: 'add-product' }, '', '#add-product');
                showPage('add-product');
                const addForm = document.getElementById('add-product-form');
                if (addForm) {
                    const flashToggle = document.getElementById('add-product-flash-enabled');
                    if (flashToggle && !flashToggle.checked) {
                        flashToggle.checked = true;
                    }
                    if (typeof addForm.__syncFlashSale === 'function') {
                        addForm.__syncFlashSale(true);
                    }
                    const flashPriceInput = document.getElementById('add-product-flash-price');
                    if (flashPriceInput) {
                        flashPriceInput.disabled = false;
                        flashPriceInput.focus();
                    }
                }
                return;
            }

            const flashSaleRemoveBtn = e.target.closest('.flash-sale-remove-btn');
            if (flashSaleRemoveBtn) {
                const productId = flashSaleRemoveBtn.dataset.id;
                showConfirmationModal(async () => {
                    try {
                        await updateDoc(doc(db, 'products', productId), {
                            flashSale: { enabled: false },
                            flashSaleEnabled: false,
                            flashPrice: null,
                            flashStart: null,
                            flashEnd: null
                        });
                        showToast('Removed from Flash Sale.');
                        if (typeof renderFlashSaleProducts === 'function') renderFlashSaleProducts();
                        if (typeof renderFilteredProducts === 'function') renderFilteredProducts();
                    } catch (err) {
                        console.error('Failed to remove flash sale settings', err);
                        showToast('Failed to remove from Flash Sale!', 'error');
                    }
                }, 'Remove from Flash Sale?', 'This keeps the product but clears flash sale pricing and schedule.');
                return;
            }

            const megaSaleAddBtn = e.target.closest('#mega-sale-add-product');
            if (megaSaleAddBtn) {
                history.pushState({ pageId: 'add-product' }, '', '#add-product');
                showPage('add-product');
                const addForm = document.getElementById('add-product-form');
                if (addForm) {
                    const megaToggle = document.getElementById('add-product-mega-enabled');
                    if (megaToggle && !megaToggle.checked) {
                        megaToggle.checked = true;
                    }
                    if (typeof addForm.__syncMegaSale === 'function') {
                        addForm.__syncMegaSale(true);
                    }
                    const megaDiscountInput = document.getElementById('add-product-mega-discount');
                    if (megaDiscountInput) {
                        megaDiscountInput.focus();
                    }
                }
                return;
            }

            const megaSaleRemoveBtn = e.target.closest('.mega-sale-remove-btn');
            if (megaSaleRemoveBtn) {
                const productId = megaSaleRemoveBtn.dataset.id;
                showConfirmationModal(async () => {
                    try {
                        await updateDoc(doc(db, 'products', productId), {
                            megaSale: { enabled: false },
                            megaSaleEnabled: false,
                            mega_sale_enabled: false,
                            megaSalePrice: null,
                            megaSaleOriginalPrice: null,
                            megaSaleDiscount: null,
                            megaSaleLabel: null,
                            mega_sale_label: null
                        });
                        showToast('Removed from Mega Sale.');
                        if (typeof renderMegaSaleProducts === 'function') renderMegaSaleProducts();
                        if (typeof renderFilteredProducts === 'function') renderFilteredProducts();
                    } catch (err) {
                        console.error('Failed to remove mega sale settings', err);
                        showToast('Failed to remove from Mega Sale!', 'error');
                    }
                }, 'Remove from Mega Sale?', 'This keeps the product but clears mega sale pricing and badge.');
                return;
            }
            
            // FIX: Product edit korar jonno button handler add kora hoyeche
            const editBtn = e.target.closest('.edit-btn');
            if (editBtn) {
                loadProductForEdit(editBtn.dataset.id);
                return;
            }

            if (e.target.closest('#new-order-alert-close-btn')) {
                hideNewOrderAlert();
            }

            if (e.target.closest('#new-message-alert-close-btn')) {
                hideNewMessageAlert();
            }

            if (e.target.closest('#view-full-chat-btn')) {
                const userId = e.target.closest('#view-full-chat-btn').dataset.id;
                if(userId) {
                    showPage('chat');
                    openChat(userId);
                }
                hideNewMessageAlert();
                return;
            }

            if (e.target.closest('#view-full-order-btn')) {
                const orderId = e.target.closest('#view-full-order-btn').dataset.id;
                if(orderId) {
                    showOrderDetails(orderId);
                }
                hideNewOrderAlert();
            }

            const accountStatusToggleBtn = e.target.closest('.account-status-toggle-btn');
            if (accountStatusToggleBtn) {
                const id = accountStatusToggleBtn.dataset.id;
                const currentStatus = accountStatusToggleBtn.dataset.status;
                const newStatus = currentStatus === 'active' ? 'frozen' : 'active';
                const actionText = newStatus === 'frozen' ? 'block' : 'unblock';
                const modalText = `Are you sure you want to ${actionText} this account? This prevents them from being assigned new orders.`;

                showConfirmationModal(async () => {
                    try {
                        await updateDoc(doc(db, "deliveryMen", id), { accountStatus: newStatus });
                        showToast(`Account ${actionText}ed successfully!`);
                    } catch (error) {
                        showToast(`Failed to ${actionText} account.`, 'error');
                        console.error(error);
                    }
                }, `Confirm ${actionText}`, modalText);
            }

            const viewDeliveryManBtn = e.target.closest('.view-delivery-man-btn');
            if(viewDeliveryManBtn) {
                showDeliveryManDetails(viewDeliveryManBtn.dataset.id);
            }

            const viewUserBtn = e.target.closest('.view-user-btn');
            if (viewUserBtn) {
                const uid = viewUserBtn.dataset.id;
                openUserProfile(uid);
                return;
            }

            const blockUserBtn = e.target.closest('.block-user-btn');
            if (blockUserBtn) {
                const userId = blockUserBtn.dataset.id;
                const isCurrentlyBlocked = blockUserBtn.dataset.blocked === 'true';
                const actionText = isCurrentlyBlocked ? 'unblock' : 'block';

                showConfirmationModal(async () => {
                    try {
                        await updateDoc(doc(db, "users", userId), { isBlocked: !isCurrentlyBlocked });
                        showToast(`User ${actionText}ed successfully!`);
                    } catch (error) {
                        console.error(`Error ${actionText}ing user:`, error);
                        showToast(`Failed to ${actionText} user!`, 'error');
                    }
                }, `Confirm ${actionText}`, `Are you sure you want to ${actionText} this user?`);
                return;
            }
            
            const deleteChatBtn = e.target.closest('.delete-chat-btn');
            if (deleteChatBtn) {
                e.stopPropagation(); // Prevent opening the chat
                const userId = deleteChatBtn.dataset.id;
                showConfirmationModal(async () => {
                    // Note: This only deletes the main chat document. The messages subcollection
                    // will remain in Firestore but will be inaccessible from the app.
                    // For a complete deletion, a Cloud Function is recommended.
                    try {
                        await deleteDoc(doc(db, 'live_chats', userId));
                        showToast('Chat deleted successfully!');
                        // After deletion, reset chat view if needed
                        if (currentChatUserId === userId) {
                            resetChatView();
                        }
                        // Remove chat item from UI immediately
                        const chatItem = document.querySelector(`.chat-list-item[data-user-id='${userId}']`);
                        if (chatItem) chatItem.remove();
                        // Optionally, re-fetch chat list if you have a function like renderChatList
                        if (typeof renderChatList === 'function') {
                            renderChatList();
                        }
                    } catch (error) {
                        console.error("Error deleting chat:", error);
                        showToast('Failed to delete chat! Check your security rules.', 'error');
                    }
                }, 'Delete Chat?', 'Are you sure you want to permanently delete this entire conversation? This action cannot be undone.');
                return;
            }

            const viewOrderBtn = e.target.closest('.view-order-btn');
            if (viewOrderBtn) {
                showOrderDetails(viewOrderBtn.dataset.id);
            }

            const categoryFilterBtn = e.target.closest('.category-filter-btn');
            if(categoryFilterBtn) {
                currentProductCategoryFilter = categoryFilterBtn.dataset.category;
                currentProductSubCategoryFilter = 'all'; // Reset sub-category on main category change
                renderProductFilters();
                renderSubCategoryFilter();
                renderFilteredProducts();
                return;
            }
            
            const removeBtn = e.target.closest('.remove-spec-btn, .remove-thumbnail-btn');
            if (removeBtn) {
                removeBtn.parentElement.remove();
            }

            const exportTopSalesBtn = e.target.closest('#top-sales-export');
            if (exportTopSalesBtn) {
                // Build CSV from lastTopSalesData
                const headers = ['Rank','Product ID','Name','Category','Units Sold','Revenue','Stock'];
                const lines = [headers.join(',')];
                lastTopSalesData.slice(0, 100).forEach((row, idx) => {
                    const revenue = (Number(row.revenue)||0).toFixed(2);
                    const safeName = String(row.name || '').replaceAll(',', ' ');
                    const vals = [idx+1, row.productId, safeName, row.category, row.units, revenue, row.stock];
                    lines.push(vals.join(','));
                });
                const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `top-sales-${new Date().toISOString().slice(0,10)}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            const exportTopRatedBtn = e.target.closest('#top-rated-export');
            if (exportTopRatedBtn) {
                const headers = ['Rank','Product ID','Name','Category','Rating','Reviews','Stock'];
                const lines = [headers.join(',')];
                lastTopRatedData.slice(0, 100).forEach((row, idx) => {
                    const safeName = String(row.name || '').replaceAll(',', ' ');
                    const rating = (Number(row.rating) || 0).toFixed(2);
                    const vals = [idx + 1, row.productId, safeName, row.category, rating, row.reviews, row.stock];
                    lines.push(vals.join(','));
                });
                const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `top-rated-${new Date().toISOString().slice(0,10)}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        });

        // Live Chat search filter (type to filter)
        document.addEventListener('input', (e) => {
            if (e.target && e.target.id === 'chat-search-input') {
                if (lastChatsSnapshot) renderChatList(lastChatsSnapshot);
            }
        });

        // Live Chat unread-only toggle
        document.addEventListener('change', (e) => {
            if (e.target && e.target.id === 'chat-unread-toggle') {
                if (lastChatsSnapshot) renderChatList(lastChatsSnapshot);
            }
        });

        document.addEventListener('change', async (e) => {
            if (e.target.id === 'dark-mode-toggle') {
                localStorage.theme = e.target.checked ? 'dark' : 'light';
                applyDarkMode(e.target.checked);
                // Re-render chart to apply theme colors
                await drawOrdersChart(Number(document.getElementById('ordersChartDays')?.value) || 7);
            }

            if (e.target.id === 'top-sales-range') {
                if (typeof renderTopSales === 'function') renderTopSales();
            }

            if (e.target.id === 'top-rated-min-rating' || e.target.id === 'top-rated-min-reviews') {
                if (typeof renderTopRated === 'function') renderTopRated();
            }

            if (e.target.classList.contains('status-change')) {
                const orderId = e.target.dataset.id;
                const newStatus = e.target.value;
                const orderRef = doc(db, 'orders', orderId);

                try {
                    const orderDoc = await getDoc(orderRef);
                    if (!orderDoc.exists()) throw new Error("Order not found");
                    
                    const orderData = orderDoc.data();
                    const oldStatus = orderData.status;

                    if(oldStatus === newStatus) return;

                    const batch = writeBatch(db);
                    
                    const affectsStock = (status) => ['pending', 'shipped', 'out-for-delivery', 'delivered'].includes(status);

                    if (!affectsStock(oldStatus) && affectsStock(newStatus)) {
                        for (const item of orderData.items) {
                            const productRef = doc(db, 'products', item.productId);
                            batch.update(productRef, { stock: increment(-item.quantity) });
                        }
                    } else if (affectsStock(oldStatus) && !affectsStock(newStatus)) {
                        for (const item of orderData.items) {
                            const productRef = doc(db, 'products', item.productId);
                            batch.update(productRef, { stock: increment(item.quantity) });
                        }
                    }

                    batch.update(orderRef, { status: newStatus });
                    
                    await batch.commit();
                    showToast('Status updated successfully!');
                    if (!UI.orderDetailsModal.classList.contains('hidden')) {
                        showOrderDetails(orderId); 
                    }
                } catch (err) {
                    console.error("Failed to update status/stock: ", err);
                    showToast('Failed to update status!', 'error');
                    const docSnap = await getDoc(orderRef);
                    if (docSnap.exists()) {
                        e.target.value = docSnap.data().status; 
                    }
                }
            }

            if (e.target.classList.contains('delivery-man-assign')) {
                const orderId = e.target.dataset.id;
                const deliveryManId = e.target.value;
                const deliveryManName = deliveryManId ? e.target.options[e.target.selectedIndex].text : '';

                try {
                    const updateData = {
                        assignedDeliveryManId: deliveryManId,
                        assignedDeliveryManName: deliveryManName
                    };
                    
                    await updateDoc(doc(db, 'orders', orderId), updateData);
                    showToast('Delivery man assigned!');
                } catch(err) {
                    console.error("Failed to assign delivery man:", err);
                    showToast('Failed to assign delivery man!', 'error');
                }
            }
        });

        // Select All toggles per section
        document.addEventListener('change', (e) => {
            const id = e.target?.id;
            if (!id) return;
            const map = {
                'products-select-all': 'products-page',
                'low-stock-select-all': 'low-stock-page',
                'reviews-select-all': 'reviews-page',
                'orders-select-all': 'orders-page',
                'users-select-all': 'users-page',
            };
            const pageId = map[id];
            if (!pageId) return;
            const container = document.getElementById(pageId);
            if (!container) return;
            const checked = e.target.checked;
            container.querySelectorAll('input.row-select').forEach(cb => cb.checked = checked);
        });

        // Bulk delete selected per section
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('#products-delete-selected, #low-stock-delete-selected, #reviews-delete-selected, #orders-delete-selected, #users-delete-selected');
            if (!btn) return;

            const pageMap = {
                'products-delete-selected': 'products-page',
                'low-stock-delete-selected': 'low-stock-page',
                'reviews-delete-selected': 'reviews-page',
                'orders-delete-selected': 'orders-page',
                'users-delete-selected': 'users-page'
            };
            const pageId = pageMap[btn.id];
            const container = document.getElementById(pageId);
            if (!container) return;

            const selected = Array.from(container.querySelectorAll('input.row-select:checked'));
            if (selected.length === 0) { showToast('No items selected', 'warning'); return; }

            const doBulkDelete = async () => {
                const groups = { products: [], orders: [], users: [], review: [] };
                selected.forEach(cb => {
                    const coll = cb.dataset.coll;
                    if (coll === 'review') {
                        groups.review.push({ productId: cb.dataset.productId, reviewIdx: Number(cb.dataset.reviewIdx) });
                    } else if (groups[coll]) {
                        groups[coll].push(cb.dataset.id);
                    }
                });

                try {
                    // Delete products using writeBatch for speed (up to 500 per commit)
                    if (groups.products.length) {
                        const chunkSize = 450; // keep headroom for safety
                        for (let i = 0; i < groups.products.length; i += chunkSize) {
                            const chunk = groups.products.slice(i, i + chunkSize);
                            const batch = writeBatch(db);
                            chunk.forEach(pid => batch.delete(doc(db, 'products', pid)));
                            await batch.commit();
                        }
                    }

                    // Delete orders and users (usually smaller counts). If needed, we can batch similarly later.
                    for (const coll of ['orders', 'users']) {
                        const ids = groups[coll];
                        for (let i = 0; i < ids.length; i += 50) { // small concurrency-friendly chunks
                            const slice = ids.slice(i, i + 50);
                            await Promise.all(slice.map(id => deleteDoc(doc(db, coll, id))));
                        }
                    }
                    // Delete embedded reviews grouped by product
                    if (groups.review.length) {
                        const byProduct = groups.review.reduce((acc, r) => {
                            (acc[r.productId] ||= []).push(r.reviewIdx);
                            return acc;
                        }, {});
                        for (const [productId, idxs] of Object.entries(byProduct)) {
                            const pref = doc(db, 'products', productId);
                            const psnap = await getDoc(pref);
                            if (!psnap.exists()) continue;
                            const data = psnap.data();
                            if (!Array.isArray(data.reviews)) continue;
                            idxs.sort((a,b) => b - a).forEach(i => { if (i >= 0 && i < data.reviews.length) data.reviews.splice(i, 1); });
                            await updateDoc(pref, { reviews: data.reviews });
                        }
                    }

                    showToast('Selected items deleted successfully!');
                    // Clear selections
                    const selectAll = container.querySelector('input[id$="-select-all"]');
                    if (selectAll) selectAll.checked = false;
                    container.querySelectorAll('input.row-select').forEach(cb => cb.checked = false);
                    if (pageId === 'reviews-page') renderReviewsList();
                } catch (err) {
                    console.error('Bulk delete failed', err);
                    showToast('Failed to delete some items', 'error');
                }
            };

            showConfirmationModal(doBulkDelete, 'Delete selected?', `Are you sure you want to delete ${selected.length} selected item(s)? This action cannot be undone.`);
        });

        const loadProductForEdit = async (productId) => {
            try {
                const productDoc = await getDoc(doc(db, "products", productId));
                if (!productDoc.exists()) {
                    showToast("Product not found!", "error");
                    return;
                }
                const data = productDoc.data();
                const form = document.getElementById('edit-product-form');

                form.querySelector('#edit-product-id-hidden').value = productId;
                const docIdField = document.getElementById('edit-product-doc-id');
                if (docIdField) docIdField.value = productId;
                form.querySelector('#edit-product-name').value = data.name || '';
                form.querySelector('#edit-product-id').value = data.model || '';
                form.querySelector('#edit-product-brand').value = data.brand || '';
                form.querySelector('#edit-product-warranty').value = data.warranty || '';
                form.querySelector('#edit-product-main-price').value = data.mainPrice || 0;
                form.querySelector('#edit-product-offer-price').value = data.offerPrice || 0;
                form.querySelector('#edit-product-discount').value = data.discount || 0;
                form.querySelector('#edit-product-main-image').value = data.imageUrl || '';
                form.querySelector('#edit-product-stock').value = data.stock || 0;
                form.querySelector('#edit-product-rating').value = data.rating || 0;
                form.querySelector('#edit-product-details').value = data.details || '';
                
                const mainCategorySelect = form.querySelector('#edit-product-category');
                mainCategorySelect.value = data.category || '';
                // Manually trigger the change event to populate sub-categories
                mainCategorySelect.dispatchEvent(new Event('change')); 

                // Use a small delay to ensure the sub-category dropdown is populated before setting its value
                setTimeout(() => {
                    form.querySelector('#edit-product-subcategory').value = data.subcategory || '';
                }, 100);

                form.querySelector('#edit-product-on-offer').checked = data.isOnOffer || false;
                form.querySelector('#edit-product-refundable').checked = data.isRefundable || false;

                const normalizeToDateInput = (raw) => {
                    if (!raw) return '';
                    let dateValue = null;
                    if (raw instanceof Date) {
                        dateValue = raw;
                    } else if (typeof raw?.toDate === 'function') {
                        try { dateValue = raw.toDate(); } catch (_) { dateValue = null; }
                    } else if (typeof raw === 'number') {
                        dateValue = new Date(raw);
                    } else if (typeof raw === 'string') {
                        const parsed = new Date(raw);
                        if (!Number.isNaN(parsed.getTime())) {
                            dateValue = parsed;
                        }
                    } else if (typeof raw === 'object' && typeof raw.seconds === 'number') {
                        const millis = raw.seconds * 1000 + (raw.nanoseconds || 0) / 1e6;
                        dateValue = new Date(millis);
                    }
                    if (!dateValue || Number.isNaN(dateValue.getTime())) return '';
                    const tzOffset = dateValue.getTimezoneOffset();
                    const local = new Date(dateValue.getTime() - tzOffset * 60000);
                    return local.toISOString().slice(0, 16);
                };

                const flashSaleInfo = (data.flashSale && typeof data.flashSale === 'object') ? data.flashSale : {};
                const flashToggle = form.querySelector('#edit-product-flash-enabled');
                const flashPriceInput = form.querySelector('#edit-product-flash-price');
                const flashStartInput = form.querySelector('#edit-product-flash-start');
                const flashEndInput = form.querySelector('#edit-product-flash-end');

                const resolvedFlashEnabled = Boolean(flashSaleInfo.enabled ?? data.flashSaleEnabled ?? false);
                if (flashToggle) flashToggle.checked = resolvedFlashEnabled;
                if (flashPriceInput) {
                    const priceValue = flashSaleInfo.price ?? data.flashPrice ?? '';
                    flashPriceInput.value = priceValue !== null && priceValue !== undefined ? priceValue : '';
                }
                if (flashStartInput) {
                    const startValue = flashSaleInfo.start ?? data.flashStart ?? null;
                    flashStartInput.value = normalizeToDateInput(startValue);
                }
                if (flashEndInput) {
                    const endValue = flashSaleInfo.end ?? data.flashEnd ?? null;
                    flashEndInput.value = normalizeToDateInput(endValue);
                }
                if (typeof form.__syncFlashSale === 'function') {
                    form.__syncFlashSale(true);
                }

                const megaInfo = (data.megaSale && typeof data.megaSale === 'object') ? data.megaSale : {};
                const megaToggle = form.querySelector('#edit-product-mega-enabled');
                const megaDiscountInput = form.querySelector('#edit-product-mega-discount');
                const megaLabelInput = form.querySelector('#edit-product-mega-label');
                const megaPriceInput = form.querySelector('#edit-product-mega-price');
                const megaOriginalInput = form.querySelector('#edit-product-mega-original');

                const resolveNumericValue = (...candidates) => {
                    for (const candidate of candidates) {
                        if (candidate === null || candidate === undefined || candidate === '') continue;
                        const num = Number(candidate);
                        if (Number.isFinite(num)) return num;
                    }
                    return '';
                };

                const costPriceInput = form.querySelector('#edit-product-cost-price');
                if (costPriceInput) {
                    const costValue = resolveNumericValue(
                        data.costPrice,
                        data.purchasePrice,
                        data.buyingPrice,
                        data.basePrice,
                        data.cost,
                        data.unitCost
                    );
                    costPriceInput.value = costValue === '' ? '' : costValue;
                }

                const resolvedMegaEnabled = Boolean(megaInfo.enabled ?? data.megaSaleEnabled ?? data.mega_sale_enabled ?? false);
                if (megaToggle) megaToggle.checked = resolvedMegaEnabled;

                if (megaDiscountInput) {
                    const discountValue = resolveNumericValue(megaInfo.discountPercent, data.megaSaleDiscount, data.megaSalePercent, data.discountPercent);
                    megaDiscountInput.value = discountValue === '' ? '' : discountValue;
                }
                if (megaPriceInput) {
                    const priceValue = resolveNumericValue(megaInfo.price, data.megaSalePrice, data.mega_sale_price, data.offerPrice);
                    megaPriceInput.value = priceValue === '' ? '' : priceValue;
                }
                if (megaOriginalInput) {
                    const originalValue = resolveNumericValue(megaInfo.originalPrice, data.megaSaleOriginalPrice, data.mega_sale_original_price, data.mainPrice);
                    megaOriginalInput.value = originalValue === '' ? '' : originalValue;
                }
                if (megaLabelInput) {
                    megaLabelInput.value = megaInfo.label || data.megaSaleLabel || data.mega_sale_label || '';
                }
                if (typeof form.__syncMegaSale === 'function') {
                    form.__syncMegaSale(true);
                }
                
                const thumbnailContainer = form.querySelector('#edit-thumbnail-container');
                thumbnailContainer.innerHTML = '';
                (data.thumbnails || []).forEach(url => {
                     const inputWrapper = document.createElement('div');
                    inputWrapper.className = 'flex items-center space-x-2';
                    inputWrapper.innerHTML = `
                        <input type="url" class="w-full px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg thumbnail-input" value="${url}" placeholder="https://example.com/image.jpg">
                        <button type="button" class="remove-thumbnail-btn text-red-500 hover:text-red-700 p-1"><i data-lucide="x-circle" class="w-5 h-5"></i></button>
                    `;
                    thumbnailContainer.appendChild(inputWrapper);
                });

                const specContainer = form.querySelector('#edit-specification-container');
                specContainer.innerHTML = '';
                if(data.specification && typeof data.specification === 'object'){
                    for(const [key, value] of Object.entries(data.specification)){
                        createSpecificationInput(specContainer, key, value);
                    }
                }

                lucide.createIcons();
                showPage('edit-product');
            } catch (error) {
                console.error("Error loading product for edit:", error);
                showToast("Could not load product data.", "error");
            }
        };

        const showConfirmationModal = (callback, title = "Are you sure?", text = "This action cannot be undone.") => {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-text').textContent = text;
            confirmCallback = callback;
            UI.confirmationModal.classList.remove('hidden');
        };

        const hideConfirmationModal = () => {
            confirmCallback = null;
            UI.confirmationModal.classList.add('hidden');
        };

        const showOrderDetails = async (orderId) => {
            UI.orderDetailsContent.innerHTML = '<p>Loading...</p>';
            UI.orderDetailsModal.classList.remove('hidden');

            try {
                const orderDoc = await getDoc(doc(db, "orders", orderId));
                if (!orderDoc.exists()) {
                    UI.orderDetailsContent.innerHTML = '<p class="text-red-500">Order not found.</p>';
                    return;
                }

                const data = orderDoc.data();
                const orderIdDisplay = data.orderId || orderDoc.id.substring(0, 6); // Use d.orderId or fallback
                const itemsHtml = data.items?.map(item => `
                    <div class="flex items-center justify-between py-2 border-b border-color">
                        <div class="flex items-center">
                            <img src="${item.imageUrl || item.image}" onerror="this.src='https://placehold.co/40x40/e2e8f0/64748b?text=Img'" class="w-10 h-10 object-cover rounded mr-4">
                            <div>
                                <p class="font-semibold text-text-primary">${item.name}</p>
                                <p class="text-sm text-text-secondary">Qty: ${item.quantity}</p>
                            </div>
                        </div>
                        <p class="text-text-primary">৳${((item.price || 0) * (item.quantity || 1)).toFixed(2)}</p>
                    </div>
                `).join('') || '<div>No items found.</div>';
        
                const deliveryManName = data.assignedDeliveryManId ? (allDeliveryMen.find(d => d.id === data.assignedDeliveryManId)?.data().name || 'N/A') : 'Unassigned';

                // Get the status dropdown for quick actions in the modal
                const statusDropdownHtml = getStatusDropdown(orderId, data.status);

                UI.orderDetailsContent.innerHTML = `
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                        <div><strong class="text-text-secondary">Order ID:</strong> <span class="font-mono" title="Full ID: ${orderDoc.id}">#${orderIdDisplay}</span></div>
                        <div><strong class="text-text-secondary">Date:</strong> ${data.createdAt?.toDate().toLocaleString() || 'N/A'}</div>
                        <div><strong class="text-text-secondary">Customer:</strong> ${data.userName || 'N/A'}</div>
                        <div><strong class="text-text-secondary">Mobile:</strong> ${data.userMobile || 'N/A'}</div>
                        <div class="sm:col-span-2"><strong class="text-text-secondary">Location:</strong> ${data.userLocation || 'N/A'}</div>
                        <div><strong class="text-text-secondary">Payment:</strong> ${data.paymentMethod || 'N/A'}</div>
                        <div><strong class="text-text-secondary">Status:</strong> ${getStatusBadge(data.status)}</div>
                        <div class="flex items-center space-x-2"><strong class="text-text-secondary">Change Status:</strong> ${statusDropdownHtml}</div>
                        <div><strong class="text-text-secondary">Assigned To:</strong> ${deliveryManName}</div>
                        <div><strong class="text-text-secondary">Delivery Charge:</strong> ৳${data.deliveryCharge || 0}</div>
                    </div>
                    <div class="mt-4">
                        <h4 class="font-semibold text-text-primary mb-2">Items Ordered</h4>
                        <div class="space-y-2">${itemsHtml}</div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-color text-right">
                        <strong class="text-lg text-text-primary">Total: ৳${(data.totalAmount || 0).toFixed(2)}</strong>
                    </div>
                `;
                lucide.createIcons();
            } catch (error) {
                console.error("Error fetching order details:", error);
                UI.orderDetailsContent.innerHTML = '<p class="text-red-500">Could not load order details.</p>';
                showToast("Error fetching order details!", 'error');
            }
        };

        // Open User Profile modal by UID and render details + recent summary
        const openUserProfile = async (uid) => {
            try {
                UI.userProfileModalContent.innerHTML = '<p>Loading...</p>';
                UI.userProfileModal.classList.remove('hidden');

                const userRef = doc(db, 'users', uid);
                const userSnap = await getDoc(userRef);
                if (!userSnap.exists()) {
                    UI.userProfileModalContent.innerHTML = '<p class="text-red-500">User not found.</p>';
                    return;
                }
                const u = userSnap.data();
                const avatar = u.photoURL || `https://placehold.co/64x64/e2e8f0/64748b?text=${(u.name || 'U').charAt(0)}`;
                const created = formatJoinDate(u.createdAt);

                const formatCurrency = (n) => `৳${Number(n || 0).toLocaleString('en-US', { maximumFractionDigits: 2 })}`;
                const statusKey = (s) => {
                    if (!s) return 'pending';
                    const raw = String(s).trim().toLowerCase();
                    return (raw === 'canceled') ? 'cancelled' : raw.replace(/\s+/g, '-');
                };
                const toMillis = (ts) => ts?.toMillis?.() || ts?.toDate?.()?.getTime?.() || (typeof ts === 'number' ? ts : 0);

                // Gather orders from memory; if empty, fetch directly by UID
                let userOrders = (allOrders || []).filter(o => (o.data()?.userId || o.data()?.uid || o.data()?.userUID) === uid);
                if (userOrders.length === 0) {
                    const ordersCol = collection(db, 'orders');
                    const results = [];
                    for (const f of ['userId', 'uid', 'userUID']) {
                        try {
                            const snap = await getDocs(query(ordersCol, where(f, '==', uid)));
                            snap.forEach(d => results.push(d));
                        } catch { /* ignore field/index issues */ }
                    }
                    const seen = new Set();
                    userOrders = results.filter(d => !seen.has(d.id) && (seen.add(d.id) || true)).map(d => ({ id: d.id, data: () => d.data() }));
                }

                userOrders.sort((a, b) => toMillis(b.data().createdAt) - toMillis(a.data().createdAt));
                const totalOrders = userOrders.length;
                const totalSpent = userOrders.reduce((sum, o) => sum + Number(o.data()?.totalAmount || 0), 0);
                const lastOrder = userOrders[0];
                const lastOrderAt = lastOrder ? (lastOrder.data().createdAt ? new Date(toMillis(lastOrder.data().createdAt)).toLocaleString() : 'N/A') : 'N/A';

                const statusCounts = userOrders.reduce((acc, o) => {
                    const k = statusKey(o.data()?.status);
                    acc[k] = (acc[k] || 0) + 1;
                    return acc;
                }, {});
                const statusOrder = ['pending', 'confirmed', 'shipped', 'out-for-delivery', 'delivered', 'cancelled'];
                const statusBadgesHtml = statusOrder.map(k => {
                    const count = statusCounts[k] || 0;
                    const label = k.replace(/-/g,' ');
                    return `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs bg-gray-100 dark:bg-gray-700 text-text-secondary mr-1 mb-1">${label}: <strong class="ml-1 text-text-primary">${count}</strong></span>`;
                }).join('');

                // Product insights by name
                const productNameCounts = {};
                userOrders.forEach(o => (o.data()?.items || []).forEach(it => {
                    const name = (it.name || it.productName || it.title || it.productId || 'Item').toString();
                    productNameCounts[name] = (productNameCounts[name] || 0) + (Number(it.quantity) || 1);
                }));
                const distinctProducts = Object.keys(productNameCounts).length;
                const topProductsList = Object.entries(productNameCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .map(([name, qty]) => `<li class="flex justify-between"><span class="truncate max-w-[70%]">${name}</span> <span class="text-text-secondary">x${qty}</span></li>`) 
                    .join('') || '<li class="text-text-secondary">No products</li>';

                const recentOrdersList = (userOrders.slice(0, 3).map(o => {
                    const d = o.data();
                    const oid = d.orderId || o.id || '';
                    const amt = formatCurrency(d.totalAmount || 0);
                    const when = d.createdAt ? new Date(toMillis(d.createdAt)).toLocaleString() : 'N/A';
                    const st = statusKey(d.status).replace(/-/g, ' ');
                    return `<li class=\"flex justify-between text-sm\"><span class=\"font-mono\">#${oid}</span><span class=\"text-text-secondary\">${when}</span><span>${amt}</span><span class=\"text-text-secondary\">${st}</span></li>`;
                }).join('')) || '<li class="text-text-secondary">No recent orders</li>';

                // Wishlist (best-effort)
                let wishlistItems = [];
                try {
                    const wlSnap = await getDocs(collection(db, `users/${uid}/wishlist`));
                    wishlistItems = wlSnap.docs.map(d => d.data());
                } catch { /* ignore if missing */ }
                const wishlistCount = wishlistItems.length;
                const wishlistListHtml = wishlistItems.slice(0, 5)
                    .map(w => `<li class=\"truncate\">${w.name || w.productName || w.productId || 'Item'}</li>`)
                    .join('') || '<li class="text-text-secondary">No wishlist items</li>';

                UI.userProfileModalContent.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <img src="${avatar}" class="w-16 h-16 rounded-full object-cover" />
                        <div>
                            <div class="text-lg font-semibold text-text-primary">${u.name || 'N/A'}</div>
                            <div class="text-sm text-text-secondary">${u.email || ''}</div>
                            <div class="text-sm text-text-secondary">${u.mobile || ''}</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div><span class="text-text-secondary">UID:</span> <span class="font-mono">${uid}</span></div>
                        <div><span class="text-text-secondary">Joined:</span> ${created}</div>
                        <div><span class="text-text-secondary">Location:</span> ${u.location || 'N/A'}</div>
                        <div class="flex items-center gap-2"><span class="text-text-secondary">Status:</span> ${(u.isBlocked ? '<span class="px-2 py-0.5 rounded bg-red-100 text-red-700 text-xs">Blocked</span>' : '<span class="px-2 py-0.5 rounded bg-green-100 text-green-700 text-xs">Active</span>')}
                            <button id="profile-block-toggle" class="ml-auto px-2 py-1 text-xs rounded ${u.isBlocked ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}" data-id="${uid}" data-blocked="${!!u.isBlocked}">
                                ${u.isBlocked ? 'Unblock' : 'Block'}
                            </button>
                        </div>
                    </div>
                    <div class="mt-3 p-3 rounded border border-color bg-gray-50/50 dark:bg-gray-800/40">
                        <div class="font-semibold text-text-primary mb-2">Order Summary</div>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div><span class="text-text-secondary">Total Orders:</span> ${totalOrders}</div>
                            <div><span class="text-text-secondary">Total Spent:</span> ${formatCurrency(totalSpent)}</div>
                            <div class="col-span-2"><span class="text-text-secondary">Last Order:</span> ${lastOrderAt}</div>
                        </div>
                        <div class="mt-2">${statusBadgesHtml}</div>
                        <div class="mt-2">
                            <div class="text-sm text-text-secondary">Distinct Products Ordered: ${distinctProducts}</div>
                            <div class="text-sm text-text-secondary">Top products:</div>
                            <ul class="list-disc list-inside text-sm">${topProductsList}</ul>
                        </div>
                        <div class="mt-2">
                            <div class="text-sm font-medium text-text-primary">Recent Orders</div>
                            <ul class="space-y-1">${recentOrdersList}</ul>
                        </div>
                    </div>
                    <div class="mt-3 p-3 rounded border border-color bg-gray-50/50 dark:bg-gray-800/40">
                        <div class="font-semibold text-text-primary mb-2">Wishlist</div>
                        <div class="text-sm text-text-secondary mb-1">Items: ${wishlistCount}</div>
                        <ul class="list-disc list-inside text-sm">${wishlistListHtml}</ul>
                    </div>
                `;

                // Wire modal block/unblock toggle
                const toggleBtn = document.getElementById('profile-block-toggle');
                if (toggleBtn) {
                    toggleBtn.addEventListener('click', async () => {
                        const id = toggleBtn.dataset.id;
                        const currentlyBlocked = toggleBtn.dataset.blocked === 'true';
                        const actionText = currentlyBlocked ? 'unblock' : 'block';
                        try {
                            await updateDoc(doc(db, 'users', id), { isBlocked: !currentlyBlocked });
                            showToast(`User ${actionText}ed successfully!`);
                            toggleBtn.dataset.blocked = String(!currentlyBlocked);
                            toggleBtn.textContent = !currentlyBlocked ? 'Unblock' : 'Block';
                            toggleBtn.classList.toggle('bg-green-600', !currentlyBlocked);
                            toggleBtn.classList.toggle('bg-red-600', currentlyBlocked);
                        } catch (err) {
                            console.error('Failed to toggle block:', err);
                            showToast(`Failed to ${actionText} user!`, 'error');
                        }
                    });
                }
            } catch (err) {
                console.error('Failed to open user profile', err);
                UI.userProfileModalContent.innerHTML = '<p class="text-red-500">Failed to load user profile.</p>';
            }
        };

        // Modal close wiring for user profile
        UI.userProfileModalCloseBtn.addEventListener('click', () => UI.userProfileModal.classList.add('hidden'));

        UI.orderDetailsCloseBtn.addEventListener('click', () => UI.orderDetailsModal.classList.add('hidden'));

        document.getElementById('modal-confirm-btn').addEventListener('click', () => {
            if (typeof confirmCallback === 'function') {
                confirmCallback();
            }
            hideConfirmationModal();
        });

        document.getElementById('modal-cancel-btn').addEventListener('click', hideConfirmationModal);
        UI.liveVisitorsModalCloseBtn?.addEventListener('click', () => closeLiveVisitorsModal());
        UI.liveVisitorsModal?.addEventListener('click', (event) => {
            if (event.target === UI.liveVisitorsModal) {
                closeLiveVisitorsModal();
            }
        });
        
        const showDeliveryManDetails = async (deliveryManId) => {
            UI.deliveryManDetailsContent.innerHTML = '<p>Loading...</p>';
            UI.deliveryManDetailsModal.classList.remove('hidden');
            try {
                const manDoc = await getDoc(doc(db, "deliveryMen", deliveryManId));
                if (!manDoc.exists()) throw new Error("Delivery man not found");
                
                const data = manDoc.data();
                // Fetch all orders assigned to this man
                const assignedOrdersQuery = query(collection(db, "orders"), where("assignedDeliveryManId", "==", deliveryManId));
                const ordersSnapshot = await getDocs(assignedOrdersQuery);
                
                let totalDeliveredCount = 0, totalProductsDelivered = 0, totalCashCollectedCOD = 0, totalNormalDeliveredCount = 0, subTotalDelivered = 0, grandTotalCollected = 0;
                let currentlyAssignedOrdersHtml = '';
                let deliveryHistoryHtml = '';
                
                const deliveredOrders = [];

                ordersSnapshot.docs.forEach(orderDoc => {
                    const order = orderDoc.data();
                    
                    if (order.status === 'delivered') {
                        totalDeliveredCount++;
                        const orderSubTotal = order.items?.reduce((sum, item) => sum + (item.price * item.quantity), 0) || 0;
                        subTotalDelivered += orderSubTotal;
                        grandTotalCollected += order.totalAmount || 0;

                        if(order.items && Array.isArray(order.items)){
                            totalProductsDelivered += order.items.reduce((sum, item) => sum + item.quantity, 0);
                        }

                        if (order.paymentMethod === 'Cash on Delivery') {
                            totalCashCollectedCOD += order.totalAmount || 0;
                        } else {
                            totalNormalDeliveredCount++;
                        }
                        
                        // Add to delivered list for history
                        deliveredOrders.push({ id: orderDoc.id, data: order });
                        
                    } else if (order.status !== 'cancelled') {
                        // Current/Pending/Shipped orders
                        currentlyAssignedOrdersHtml += `<li class="flex justify-between items-center text-sm"><span>ID: #${(order.orderId || orderDoc.id.substring(0, 6))}</span> ${getStatusBadge(order.status)}</li>`;
                    }
                });

                // Sort delivered orders by creation date (most recent first)
                deliveredOrders.sort((a, b) => (b.data.createdAt?.toMillis() || 0) - (a.data.createdAt?.toMillis() || 0));
                
                if (deliveredOrders.length > 0) {
                     deliveredOrders.slice(0, 5).forEach(order => {
                        const date = order.data.createdAt?.toDate().toLocaleDateString() || 'N/A';
                        const orderIdDisplay = order.data.orderId || order.id.substring(0, 6);
                        deliveryHistoryHtml += `
                            <li class="flex justify-between items-center text-sm py-1 border-b border-color/50">
                                <span class="font-mono" title="Full ID: ${order.id}">Order ID: #${orderIdDisplay}</span>
                                <span class="font-semibold text-text-primary">৳${(order.data.totalAmount || 0).toFixed(2)} (${date})</span>
                            </li>
                        `;
                    });
                } else {
                    deliveryHistoryHtml = '<p class="text-text-secondary text-sm">No delivered orders found in history.</p>';
                }


                if (currentlyAssignedOrdersHtml === '') {
                    currentlyAssignedOrdersHtml = '<p class="text-text-secondary text-sm">No currently assigned orders.</p>';
                }


                UI.deliveryManDetailsContent.innerHTML = `
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm pb-4 border-b border-color">
                        <div><strong class="text-text-secondary">Name:</strong> ${data.name}</div>
                        <div><strong class="text-text-secondary">Email:</strong> ${data.email}</div>
                        <div><strong class="text-text-secondary">Phone:</strong> ${data.phone}</div>
                        <div><strong class="text-text-secondary">Vehicle:</strong> ${data.vehicle || 'N/A'}</div>
                        <div><strong class="text-text-secondary">Status:</strong> ${getStatusBadge(data.accountStatus || 'active')}</div>
                    </div>
                    <div class="mt-4">
                        <h4 class="font-semibold text-text-primary mb-2">Performance Summary</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                            <div><strong class="text-text-secondary">Total Orders Delivered:</strong> ${totalDeliveredCount}</div>
                            <div><strong class="text-text-secondary">Total Products Delivered:</strong> ${totalProductsDelivered}</div>
                            <div><strong class="text-text-secondary">Normal Deliveries:</strong> ${totalNormalDeliveredCount}</div>
                            <div><strong class="text-text-secondary">COD Deliveries:</strong> ${totalDeliveredCount - totalNormalDeliveredCount}</div>
                            <div><strong class="text-text-secondary">Sub-Total Delivered:</strong> ৳${subTotalDelivered.toFixed(2)}</div>
                            <div><strong class="text-text-secondary">Grand Total Collected:</strong> ৳${grandTotalCollected.toFixed(2)}</div>
                            <div class="sm:col-span-2"><strong class="text-text-secondary">Total Cash Collected (COD):</strong> ৳${totalCashCollectedCOD.toFixed(2)}</div>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-color">
                        <h4 class="font-semibold text-text-primary mb-2">Currently Assigned Orders (${ordersSnapshot.docs.length - totalDeliveredCount})</h4>
                        <ul class="space-y-2">${currentlyAssignedOrdersHtml}</ul>
                    </div>
                    <div class="mt-4 pt-4 border-t border-color">
                        <h4 class="font-semibold text-text-primary mb-2">Delivery History (Last 5)</h4>
                        <ul class="space-y-1">${deliveryHistoryHtml}</ul>
                    </div>
                `;
                 lucide.createIcons();
            } catch(error) {
                console.error("Error fetching delivery man details:", error);
                UI.deliveryManDetailsContent.innerHTML = `<p class="text-red-500">Could not load details.</p>`;
            }
        };

        UI.deliveryManModalCloseBtn.addEventListener('click', () => UI.deliveryManDetailsModal.classList.add('hidden'));

        UI.userProfileModalCloseBtn.addEventListener('click', () => UI.userProfileModal.classList.add('hidden'));

        // --- Live Chat Logic ---
        const renderChatList = (chats) => {
            const container = document.getElementById('chat-list-container');
            container.innerHTML = '';
            if (chats.length === 0) {
                container.innerHTML = '<p class="p-4 text-center text-text-secondary">No active conversations.</p>';
                return;
            }

            const unreadChatsExist = chats.some(chat => {
                const lastMs = chat.lastMessageTimestamp?.toMillis?.() || chat.lastMessageTimestamp?.toDate?.().getTime?.() || 0;
                const openedMs = chat.lastOpenedByAdminAt?.toMillis?.() || chat.lastOpenedByAdminAt?.toDate?.().getTime?.() || 0;
                return chat.lastSender === 'user' && lastMs > openedMs;
            });
            document.getElementById('chat-notification-bubble').classList.toggle('hidden', !unreadChatsExist);

            // Apply search and unread-only filters
            const searchEl = document.getElementById('chat-search-input');
            const unreadOnlyEl = document.getElementById('chat-unread-toggle');
            const q = (searchEl?.value || '').toLowerCase().trim();
            const unreadOnly = !!unreadOnlyEl?.checked;

            const filtered = chats.filter(chat => {
                const lastMs = chat.lastMessageTimestamp?.toMillis?.() || chat.lastMessageTimestamp?.toDate?.().getTime?.() || 0;
                const openedMs = chat.lastOpenedByAdminAt?.toMillis?.() || chat.lastOpenedByAdminAt?.toDate?.().getTime?.() || 0;
                const isUnread = chat.lastSender === 'user' && lastMs > openedMs;
                if (unreadOnly && !isUnread) return false;
                const userData = allUsersMap.get(chat.userId);
                const name = (userData?.name || chat.userName || 'unknown').toLowerCase();
                const text = (chat.lastMessage || '').toLowerCase();
                return !q || name.includes(q) || text.includes(q);
            });

            if (filtered.length === 0) {
                container.innerHTML = '<p class="p-4 text-center text-text-secondary">No conversations match your filters.</p>';
                return;
            }

            filtered.forEach(chat => {
                const isActive = chat.userId === currentChatUserId;
                const lastMs = chat.lastMessageTimestamp?.toMillis?.() || chat.lastMessageTimestamp?.toDate?.().getTime?.() || 0;
                const openedMs = chat.lastOpenedByAdminAt?.toMillis?.() || chat.lastOpenedByAdminAt?.toDate?.().getTime?.() || 0;
                const isUnread = chat.lastSender === 'user' && lastMs > openedMs;
                const userData = allUsersMap.get(chat.userId);
                const userName = userData?.name || chat.userName || 'Unknown User';
                const userAvatar = userData?.photoURL || 'https://placehold.co/40x40/e2e8f0/64748b?text=U';


                const isLastFromAdmin = chat.lastSender === 'admin';
                const readTick = isLastFromAdmin ? (chat.isReadByUser ? '<span class="ml-1 text-cyan-500">✔✔</span>' : '<span class="ml-1 text-gray-400">✔</span>') : '';
                const itemHtml = `
                    <div class="chat-list-item group cursor-pointer flex items-center p-4 border-b border-color ${isActive ? 'bg-theme-bg-light' : (isUnread ? 'unread-chat' : 'hover:bg-gray-100 dark:hover:bg-gray-700')}" data-user-id="${chat.userId}">
                        <div class="relative">
                            <img src="${userAvatar}" onerror="this.src='https://placehold.co/40x40/e2e8f0/64748b?text=U'" class="w-10 h-10 rounded-full object-cover">
                            ${isUnread ? '<span class="absolute top-0 right-0 block h-2.5 w-2.5 rounded-full bg-red-500 ring-2 ring-white dark:ring-gray-800"></span>' : ''}
                        </div>
                        <div class="ml-3 flex-1 overflow-hidden">
                            <p class="font-semibold text-text-primary truncate ${isUnread ? 'font-bold' : ''}">${userName}</p>
                            <p class="text-xs truncate ${isUnread ? 'font-semibold text-text-primary dark:text-gray-200' : 'text-text-secondary'}">${chat.lastMessage || 'No messages yet.'} ${readTick}</p>
                        </div>
                        <div class="flex flex-col items-end space-y-1 text-right">
                             <div class="text-xs text-text-secondary whitespace-nowrap">
                                 ${formatTimestamp(chat.lastMessageTimestamp)}
                             </div>
                             <button class="delete-chat-btn text-red-500 hover:text-red-700 p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity focus:opacity-100" data-id="${chat.userId}" title="Delete Conversation">
                                 <i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i>
                             </button>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', itemHtml);
            });
            // Refresh icons for newly inserted items
            if (window.lucide?.createIcons) lucide.createIcons();
        };

        const renderMessages = (messages) => {
            const container = document.getElementById('messages-container');
            container.innerHTML = '';
            let lastMessageDateString = null;

            // Ensure messages are sorted by timestamp on the client-side as a safeguard.
            // This prevents messages from appearing out of order due to latency.
            const getMs = (t) => {
                try {
                    if (!t) return 0;
                    if (typeof t.toMillis === 'function') return t.toMillis();
                    if (typeof t.toDate === 'function') return t.toDate().getTime();
                    if (t instanceof Date) return t.getTime();
                    if (typeof t === 'number') return t < 1e12 ? t * 1000 : t; // tolerate seconds
                    if (typeof t === 'string') { const d = new Date(t); if (!isNaN(d)) return d.getTime(); }
                } catch {}
                return 0;
            };

            const sortedMessages = messages
                .filter(msg => msg && msg.text)
                .sort((a, b) => getMs(a.timestamp) - getMs(b.timestamp));

            sortedMessages.forEach(msg => {
                // The filter above makes this check redundant, but it's kept for safety
                const ms = getMs(msg.timestamp);
                if (!ms) return;
                const messageDate = new Date(ms);
                const messageDateString = messageDate.toDateString();

                if (messageDateString !== lastMessageDateString) {
                    const dividerHtml = `
                        <div class="flex justify-center my-4">
                            <span class="px-3 py-1 text-xs font-semibold text-gray-500 bg-gray-200 dark:bg-gray-700 dark:text-gray-400 rounded-full">
                                ${formatDateDivider(messageDate)}
                            </span>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', dividerHtml);
                    lastMessageDateString = messageDateString;
                }
                
                const isFromAdmin = msg.sender === 'admin';
                const messageTime = messageDate.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: true });

                // Display the user's name above their messages, similar to the provided screenshot.
                const senderNameHtml = !isFromAdmin ? `<p class="text-xs text-text-secondary mb-1">${document.getElementById('chat-header-name').textContent || 'User'}</p>` : '';

                const isLast = sortedMessages[sortedMessages.length - 1] === msg;
                const ticks = isFromAdmin ? (msg.isReadByUser ? '✔✔' : '✔') : '';
                const messageHtml = `
                       <div class="flex flex-col ${isFromAdmin ? 'items-end' : 'items-start'}">
                           ${senderNameHtml}
                           <div class="max-w-xs md:max-w-md p-3 rounded-xl ${isFromAdmin ? 'bg-theme-primary text-white rounded-br-none' : 'bg-white dark:bg-gray-700 text-text-primary rounded-bl-none shadow-md'}">
                               <p class="text-sm whitespace-pre-wrap break-words">${msg.text}</p>
                               <p class="text-[10px] ${isFromAdmin ? 'text-white/70' : 'text-black/50 dark:text-white/50'} mt-1 text-right">${messageTime} ${isFromAdmin ? `<span>${ticks}</span>` : ''}</p>
                           </div>
                       </div>
                `;
                container.insertAdjacentHTML('beforeend', messageHtml);
            });
            // Scroll to the latest message
            container.scrollTop = container.scrollHeight;
        };
        
        const resetChatView = () => {
            if (unsubscribeMessages) {
                unsubscribeMessages();
                unsubscribeMessages = null;
            }
            currentChatUserId = null;

            document.getElementById('chat-window-placeholder').classList.remove('hidden');
            const chatWindowMain = document.getElementById('chat-window-main');
            chatWindowMain.classList.add('hidden');
            chatWindowMain.classList.remove('flex');

            // Remove active state from all chat list items
            const items = document.querySelectorAll('#chat-list-container .chat-list-item');
            items.forEach(item => {
                item.classList.remove('bg-theme-bg-light');
                item.classList.add('hover:bg-gray-100', 'dark:hover:bg-gray-700');
            });
            setupChatInputEnhancements();
        };

        const openChat = async (userId) => {
            if (currentChatUserId === userId) return; // Don't re-open the same chat
            
            // Clear previous message listener
            if (unsubscribeMessages) unsubscribeMessages();
            
            currentChatUserId = userId; // Set the new current user

            // --- Mark chat as read on open ---
            try {
                await updateDoc(doc(db, 'live_chats', userId), { isReadByAdmin: true, lastOpenedByAdminAt: serverTimestamp() });
            } catch (error) {
                // This is a non-critical error, so we just log it. The chat will still open.
                console.error("Could not mark chat as read on open:", error);
            }

            // Show the main chat window
            document.getElementById('chat-window-placeholder').classList.add('hidden');
            const chatWindowMain = document.getElementById('chat-window-main');
            chatWindowMain.classList.remove('hidden');
            chatWindowMain.classList.add('flex');
            setupChatInputEnhancements();
            
            // --- Populate Header & Add Click Listener ---
            const chatHeader = document.getElementById('chat-header');
            const headerAvatar = document.getElementById('chat-header-avatar');
            const headerName = document.getElementById('chat-header-name');
            const headerStatus = document.getElementById('chat-header-status');
            const headerBlockedBadge = document.getElementById('chat-header-blocked-badge');
            const headerBlockBtn = document.getElementById('chat-header-block-btn');
            const headerDeleteBtn = document.getElementById('chat-header-delete-btn');
            const blockedBanner = document.getElementById('chat-blocked-banner');
            const messageInput = document.getElementById('chat-message-input');

            const userDoc = await getDoc(doc(db, 'users', userId));
            if (userDoc.exists()) {
                const userData = userDoc.data();
                headerName.textContent = userData.name || 'Unknown User';
                headerAvatar.src = userData.photoURL || `https://placehold.co/40x40/e2e8f0/64748b?text=${(userData.name || 'U').charAt(0)}`;
                const isBlocked = !!userData.isBlocked;
                headerBlockedBadge.classList.toggle('hidden', !isBlocked);
                headerBlockBtn.dataset.id = userId;
                headerBlockBtn.dataset.blocked = String(isBlocked);
                headerBlockBtn.title = isBlocked ? 'Unblock user' : 'Block user';
                blockedBanner.classList.toggle('hidden', !isBlocked);
                messageInput.disabled = isBlocked;
                headerStatus.textContent = userData.lastSeen ? `Last seen ${formatJoinDate(userData.lastSeen, true)}` : 'Online status unavailable';
            } else {
                 headerName.textContent = 'User (Not Found)';
                 headerAvatar.src = 'https://placehold.co/40x40';
                 headerBlockedBadge.classList.add('hidden');
                 blockedBanner.classList.add('hidden');
                 messageInput.disabled = false;
                 headerStatus.textContent = 'User record missing';
            }
            
            // To safely replace event listeners, clone and replace the node.
            const newHeader = chatHeader.cloneNode(true); // true to clone children
            chatHeader.parentNode.replaceChild(newHeader, chatHeader);
            newHeader.querySelector('.view-profile-btn')?.addEventListener('click', (ev) => { ev.stopPropagation(); showUserProfileModal(userId); });
            newHeader.querySelector('#chat-header-delete-btn')?.addEventListener('click', (ev) => {
                ev.stopPropagation();
                showConfirmationModal(async () => {
                    try {
                        await deleteDoc(doc(db, 'live_chats', userId));
                        showToast('Chat deleted successfully!');
                        if (currentChatUserId === userId) resetChatView();
                    } catch (e) {
                        showToast('Failed to delete chat!', 'error');
                        console.error(e);
                    }
                }, 'Delete Chat?', 'Are you sure you want to permanently delete this entire conversation? This action cannot be undone.');
            });
            newHeader.querySelector('#chat-header-block-btn')?.addEventListener('click', async (ev) => {
                ev.stopPropagation();
                const btn = ev.currentTarget;
                const isBlocked = btn.getAttribute('data-blocked') === 'true';
                const actionText = isBlocked ? 'unblock' : 'block';
                showConfirmationModal(async () => {
                    try {
                        await updateDoc(doc(db, 'users', userId), { isBlocked: !isBlocked });
                        showToast(`User ${actionText}ed successfully!`);
                        // Reflect immediately in UI
                        headerBlockedBadge.classList.toggle('hidden', isBlocked);
                        btn.setAttribute('data-blocked', String(!isBlocked));
                        btn.title = !isBlocked ? 'Unblock user' : 'Block user';
                        blockedBanner.classList.toggle('hidden', isBlocked);
                        messageInput.disabled = !isBlocked;
                    } catch (e) {
                        showToast(`Failed to ${actionText} user!`, 'error');
                        console.error(e);
                    }
                }, `Confirm ${actionText}`, `Are you sure you want to ${actionText} this user?`);
            });
            
            // --- Listen for new messages ---
            // The chat is now marked as read on open.
            const messagesQuery = query(collection(db, `live_chats/${userId}/messages`), orderBy('timestamp'));
            unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
                const messages = snapshot.docs.map(doc => doc.data());
                renderMessages(messages);
                // After messages load, if the chat is open, mark read flag in UI elements
                try {
                    updateDoc(doc(db, 'live_chats', userId), { isReadByAdmin: true });
                } catch (e) {
                    console.warn('Failed to update read flag after opening chat', e);
                }
                // Hide side chat red dot if there are no unread chats left
                const remainingUnread = (lastChatsSnapshot || []).some(c => !c.isReadByAdmin && c.userId !== userId);
                if (!remainingUnread) {
                    const chatBubble = document.getElementById('chat-notification-bubble');
                    if (chatBubble) chatBubble.classList.add('hidden');
                }
                // Update header last activity time based on last message
                const last = messages[messages.length - 1];
                if (last?.timestamp?.toDate) {
                    headerStatus.textContent = `Last message ${formatJoinDate(last.timestamp, true)}`;
                }
            }, handleSnapshotError('Chat Messages'));
            
            // --- Update Active State in Chat List ---
            const items = document.querySelectorAll('#chat-list-container .chat-list-item');
            items.forEach(item => {
                const isActive = item.dataset.userId === currentChatUserId;
                item.classList.toggle('bg-theme-bg-light', isActive);
                if (!isActive) {
                    item.classList.add('hover:bg-gray-100', 'dark:hover:bg-gray-700');
                } else {
                    item.classList.remove('hover:bg-gray-100', 'dark:hover:bg-gray-700');
                }
            });
            setupChatInputEnhancements();
        };

        const showUserProfileModal = (userId) => {
            UI.userProfileModalContent.innerHTML = '<p>Loading...</p>';
            UI.userProfileModal.classList.remove('hidden');

            const userData = allUsersMap.get(userId);

            if (!userData) {
                UI.userProfileModalContent.innerHTML = '<p class="text-red-500">User details not found.</p>';
                return;
            }

            const profilePic = userData.photoURL || `https://placehold.co/80x80/e2e8f0/64748b?text=${(userData.name || 'U').charAt(0)}`;

            const isBlocked = userData.isBlocked || false;
            const blockButtonText = isBlocked ? 'Unblock User' : 'Block User';
            const blockButtonClasses = isBlocked 
                ? 'bg-green-500 hover:bg-green-600 focus:ring-green-400' 
                : 'bg-red-600 hover:bg-red-700 focus:ring-red-500';

            UI.userProfileModalContent.innerHTML = `
                <div class="flex flex-col items-center text-center">
                    <img src="${profilePic}" onerror="this.src='https://placehold.co/80x80/e2e8f0/64748b?text=U'" class="w-20 h-20 rounded-full object-cover mb-4 border-2 border-theme-primary">
                    <h4 class="text-lg font-bold text-text-primary">${userData.name || 'N/A'}</h4>
                    <p class="text-sm text-text-secondary">${userData.email || 'N/A'}</p>
                </div>
                <div class="mt-4 pt-4 border-t border-color space-y-2 text-sm">
                    <div><strong class="text-text-secondary w-24 inline-block">Mobile:</strong> <span class="text-text-primary">${userData.mobile || 'N/A'}</span></div>
                    <div><strong class="text-text-secondary w-24 inline-block">Location:</strong> <span class="text-text-primary">${userData.location || 'N/A'}</span></div>
                    <div><strong class="text-text-secondary w-24 inline-block">Joined:</strong> <span class="text-text-primary">${userData.createdAt?.toDate().toLocaleDateString() || 'N/A'}</span></div>
                </div>
                <div class="mt-4 pt-4 border-t border-color">
                    <button id="modal-block-user-btn" 
                            data-id="${userId}" 
                            data-blocked="${isBlocked}" 
                            class="w-full py-2 px-4 text-white font-semibold rounded-lg ${blockButtonClasses} focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-gray-800">
                        ${blockButtonText}
                    </button>
                </div>
            `;
        };

        // --- Notification Logic ---
        const handleNotificationClick = (alpineData) => {
            alpineData.notificationsOpen = !alpineData.notificationsOpen;
            if (alpineData.notificationsOpen && notifications.length > 0) {
                setTimeout(() => {
                    notifications = [];
                    updateNotificationUI();
                }, 2000);
            }
        };
        window.handleNotificationClick = handleNotificationClick;

        const addNotification = (text, page) => {
            notifications.unshift({ text, page });
            updateNotificationUI();
        };

        // Update bell icon badge and dropdown list
        const updateNotificationUI = () => {
            const count = notifications.length;
            const badge = UI.notificationCountBadge;
            const list = UI.notificationList;
            if (!badge || !list) return;
            if (count > 0) {
                badge.textContent = count > 9 ? '9+' : String(count);
                badge.classList.remove('hidden');
                list.innerHTML = notifications.map(n => `
                    <div class="p-2 border-b border-color hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer" data-page="${n.page}">
                        <p class="text-sm text-text-primary">${n.text}</p>
                    </div>
                `).join('');
            } else {
                badge.classList.add('hidden');
                list.innerHTML = '<p class="p-2 text-text-secondary text-sm">No new notifications</p>';
            }
        };

        const listenForNotifications = () => {
            const startTime = new Date();
            const unsub = onSnapshot(query(collection(db, "orders"), where("createdAt", ">", startTime)), (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === "added") {
                        const orderData = change.doc.data();
                        const orderId = change.doc.id;
                        // Show new order alert popup
                        showNewOrderAlert(orderData, orderId);
                        // Add notification to bell icon
                        addNotification(`New order from ${orderData.userName || 'Customer'} (৳${orderData.totalAmount || 0})`, 'orders');
                        // Note: Do not toggle the chat bubble for orders; it's reserved for chat unread
                    }
                });
            }, handleSnapshotError('Order Notifications'));
            unsubscribeListeners.push(unsub);
        };
        
        const showNewOrderAlert = async (orderData, orderId) => {
            await playSound('newOrder');
            const content = document.getElementById('new-order-alert-content');
            content.innerHTML = `<p><strong class="font-semibold text-text-secondary">Customer:</strong> ${orderData.userName || 'N/A'}</p><p><strong class="font-semibold text-text-secondary">Total:</strong> ৳${orderData.totalAmount || 0}</p>`;
            document.getElementById('view-full-order-btn').dataset.id = orderId;
            UI.newOrderAlert.classList.remove('hidden', 'translate-x-full');
            UI.newOrderAlert.classList.add('translate-x-0');
            lucide.createIcons();
        };

        const hideNewOrderAlert = () => {
            UI.newOrderAlert.classList.remove('translate-x-0');
            UI.newOrderAlert.classList.add('translate-x-full');
            setTimeout(() => UI.newOrderAlert.classList.add('hidden'), 300);
        };
        
        const showNewMessageAlert = async (chatData, userId) => {
            await playSound('newMessage');
            const content = document.getElementById('new-message-alert-content');
            content.innerHTML = `<p><strong class="font-semibold text-text-secondary">From:</strong> ${chatData.userName || 'N/A'}</p><p class="truncate"><strong class="font-semibold text-text-secondary">Message:</strong> ${chatData.lastMessage || ''}</p>`;
            document.getElementById('view-full-chat-btn').dataset.id = userId;
            UI.newMessageAlert.classList.remove('hidden', 'translate-x-full');
            UI.newMessageAlert.classList.add('translate-x-0');
            lucide.createIcons();
        };

        const hideNewMessageAlert = () => {
            UI.newMessageAlert.classList.remove('translate-x-0');
            UI.newMessageAlert.classList.add('translate-x-full');
            setTimeout(() => UI.newMessageAlert.classList.add('hidden'), 300);
        };
        
        const manualDataRefresh = async (event) => {
            const button = event.currentTarget;
            if (!button) return;

            const icon = button.querySelector('svg');
            
            if (icon) {
                icon.classList.add('animate-spin');
            }
            button.disabled = true;

            showToast("Refreshing data...");
            await loadDashboardStats();
            // Refresh dashboard chart as well
            await drawOrdersChart(Number(document.getElementById('ordersChartDays')?.value) || 7);
            updateDashboardLastUpdatedLabel();
            showToast("Data refreshed successfully!");
            
            // Using a timeout to ensure the user sees the spin animation
            setTimeout(() => {
                if (icon) {
                    icon.classList.remove('animate-spin');
                }
                button.disabled = false;
            }, 500);
        };

        // --- Data Listeners Setup ---
        const setupDataListeners = () => {
            cleanupListeners(); // Clear any existing listeners
            
            // Recent Data for Dashboard
            const unsubOrders = onSnapshot(collection(db, "orders"), snap => {
                // Client-side sorting: Newest first
                const sortedDocs = snap.docs.sort((a, b) => (b.data().createdAt?.toMillis() || 0) - (a.data().createdAt?.toMillis() || 0)).slice(0, 5);
                const slicedSnapshot = { empty: sortedDocs.length === 0, docs: sortedDocs, forEach: cb => sortedDocs.forEach(cb) };
                renderTable(slicedSnapshot, 'recent-orders-body', renderOrderRow_Recent);
            }, handleSnapshotError('Recent Orders'));

            // Filter the users collection to exclude deliveryMen based on UID if they somehow exist
            const unsubUsers = onSnapshot(collection(db, "users"), snap => {
                const sortedDocs = snap.docs.sort((a, b) => (b.data().createdAt?.toMillis() || 0) - (a.data().createdAt?.toMillis() || 0)).filter(doc => !allDeliveryMen.some(man => man.id === doc.id)).slice(0, 5);
                const slicedSnapshot = { empty: sortedDocs.length === 0, docs: sortedDocs, forEach: cb => sortedDocs.forEach(cb) };
                renderTable(slicedSnapshot, 'recent-users-body', renderUserRow_Recent);
            }, handleSnapshotError('Recent Users'));

            // Full Data for Pages (All sorted client-side)
            const unsubAllProducts = onSnapshot(collection(db, "products"), snap => {
                allProducts = snap.docs.sort((a, b) => (b.data().createdAt?.toMillis() || 0) - (a.data().createdAt?.toMillis() || 0));
                computeDuplicateSet(); // refresh duplicates globally whenever products change
                renderProductFilters();
                renderSubCategoryFilter();
                renderFilteredProducts();
                if (typeof renderFlashSaleProducts === 'function') renderFlashSaleProducts();
                if (typeof renderMegaSaleProducts === 'function') renderMegaSaleProducts();
                if (typeof renderLowStockProducts === 'function') renderLowStockProducts();
                // Sidebar badge: count of out-of-stock items (stock === 0)
                const outOfStock = allProducts.filter(d => Number(d.data().stock ?? 0) === 0).length;
                const oosBadge = document.getElementById('out-of-stock-badge');
                if (oosBadge) {
                    if (outOfStock > 0) {
                        oosBadge.textContent = String(outOfStock);
                        oosBadge.classList.remove('hidden');
                    } else {
                        oosBadge.classList.add('hidden');
                    }
                }
                // Dashboard card: Low Stock count (< threshold)
                const lowStockCount = allProducts.filter(d => {
                    const s = Number(d.data().stock ?? 0);
                    return !Number.isNaN(s) && s < (typeof LOW_STOCK_THRESHOLD !== 'undefined' ? LOW_STOCK_THRESHOLD : 5);
                }).length;
                const lowStockEl = document.getElementById('total-low-stock');
                if (lowStockEl) lowStockEl.textContent = String(lowStockCount);
                if (typeof renderTopSales === 'function') renderTopSales();
                if (typeof renderTopRated === 'function') renderTopRated();
                updateDashboardSummary();
                refreshReportsData();
            }, handleSnapshotError('All Products'));
            
            const unsubAllOrders = onSnapshot(collection(db, "orders"), snap => {
                // Client-side sorting: Newest first, store all orders, then render
                allOrders = snap.docs.sort((a, b) => (b.data().createdAt?.toMillis() || 0) - (a.data().createdAt?.toMillis() || 0));
                renderOrderFilters();
                renderFilteredOrders();
                if (typeof renderTopSales === 'function') renderTopSales();
                // Sidebar badge: count of pending orders
                const pendingCount = allOrders.filter(doc => (doc.data().status || 'pending').toLowerCase() === 'pending').length;
                const pendingBadge = document.getElementById('pending-orders-badge');
                if (pendingBadge) {
                    if (pendingCount > 0) {
                        pendingBadge.textContent = String(pendingCount);
                        pendingBadge.classList.remove('hidden');
                    } else {
                        pendingBadge.classList.add('hidden');
                    }
                }
                updateDashboardSummary();
                refreshReportsData();
            }, handleSnapshotError('All Orders'));

            const unsubAllUsers = onSnapshot(collection(db, "users"), snap => {
                 // Filter the users collection to exclude deliveryMen and populate user map
                 allUsersMap.clear();
                 snap.docs.forEach(doc => allUsersMap.set(doc.id, doc.data()));
                 initialUsersLoadComplete = true;
                 totalUsersCount = snap.size;
                 updateDashboardSummary();

                 // If chat data arrived first, render it now that we have user names.
                 if (lastChatsSnapshot) {
                     renderChatList(lastChatsSnapshot);
                 }

                 const sortedDocs = snap.docs.sort((a, b) => (b.data().createdAt?.toMillis() || 0) - (a.data().createdAt?.toMillis() || 0)).filter(doc => !allDeliveryMen.some(man => man.id === doc.id));
                renderTable({ ...snap, docs: sortedDocs, forEach: cb => sortedDocs.forEach(cb) }, 'all-users-body', renderUserRow_All);
            }, handleSnapshotError('All Users'));
            
            const unsubBanners = onSnapshot(collection(db, "banners"), snap => {
                renderBanners(snap);
            }, handleSnapshotError('Banners'));

            const unsubSidePromos = onSnapshot(collection(db, "sidePromos"), snap => {
                renderSidePromos(snap);
            }, handleSnapshotError('Side Promos'));

            const unsubCoupons = onSnapshot(collection(db, "coupons"), snap => {
                renderCoupons(snap);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                activeCouponsCount = snap.docs.reduce((count, docSnap) => {
                    const data = docSnap.data() || {};
                    const rawExpiry = data.expiryDate;
                    let expiryDate = null;
                    if (rawExpiry?.toDate) {
                        expiryDate = rawExpiry.toDate();
                    } else if (typeof rawExpiry === 'number') {
                        expiryDate = new Date(rawExpiry);
                    } else if (typeof rawExpiry === 'string') {
                        const parsed = new Date(rawExpiry);
                        if (!Number.isNaN(parsed.getTime())) expiryDate = parsed;
                    }
                    if (!expiryDate) return count;
                    const normalized = new Date(expiryDate.getFullYear(), expiryDate.getMonth(), expiryDate.getDate(), 23, 59, 59, 999);
                    return normalized >= today ? count + 1 : count;
                }, 0);
                updateDashboardSummary();
            }, handleSnapshotError('Coupons'));
            
            const unsubDeliveryMen = onSnapshot(collection(db, "deliveryMen"), 
                snap => {
                    const sortedDocs = snap.docs.sort((a, b) => (b.data().createdAt?.toMillis() || 0) - (a.data().createdAt?.toMillis() || 0));
                    allDeliveryMen = sortedDocs; // keep this for the orders page dropdown
                    totalDeliveryMenCount = sortedDocs.length;
                    updateDashboardSummary();
                    renderDeliverySection({ ...snap, docs: sortedDocs, forEach: cb => sortedDocs.forEach(cb) });
                }, 
                handleSnapshotError('Delivery Men')
            );
            
            const unsubChats = onSnapshot(query(collection(db, "live_chats")), (snapshot) => {
                let chats = snapshot.docs.map(doc => ({ userId: doc.id, ...doc.data() }));
                
                // FIX: Make unseen count consistent with UI highlighting (!isReadByAdmin).
                // This correctly counts chats where the flag is `false` OR missing entirely.
                const unseenSmsCount = chats.filter(chat => {
                    const lastMs = chat.lastMessageTimestamp?.toMillis?.() || chat.lastMessageTimestamp?.toDate?.().getTime?.() || 0;
                    const openedMs = chat.lastOpenedByAdminAt?.toMillis?.() || chat.lastOpenedByAdminAt?.toDate?.().getTime?.() || 0;
                    return chat.lastSender === 'user' && lastMs > openedMs;
                }).length;
                document.getElementById('total-unseen-sms').textContent = unseenSmsCount;
                const unseenBadge = document.getElementById('unseen-sms-badge');
                if (unseenBadge) {
                    if (unseenSmsCount > 0) {
                        unseenBadge.textContent = String(unseenSmsCount);
                        unseenBadge.classList.remove('hidden');
                    } else {
                        unseenBadge.classList.add('hidden');
                    }
                }

                // FIX: Client-side sorting to handle chats without lastMessageTimestamp
                chats.sort((a, b) => {
                    const timeA = a.lastMessageTimestamp?.toMillis() || a.createdAt?.toMillis() || 0;
                    const timeB = b.lastMessageTimestamp?.toMillis() || b.createdAt?.toMillis() || 0;
                    return timeB - timeA;
                });

                lastChatsSnapshot = chats; 
                
                // Only render if we have user data. Otherwise, the user listener will handle it.
                if(initialUsersLoadComplete) {
                    renderChatList(chats);
                }

                if (initialChatLoadComplete) {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === "modified" || change.type === "added") { // Listen for added chats too
                            const chatData = change.doc.data();
                            const lastMs = chatData.lastMessageTimestamp?.toMillis?.() || chatData.lastMessageTimestamp?.toDate?.().getTime?.() || 0;
                            const openedMs = chatData.lastOpenedByAdminAt?.toMillis?.() || chatData.lastOpenedByAdminAt?.toDate?.().getTime?.() || 0;
                            const hasUnread = chatData.lastSender === 'user' && lastMs > openedMs;
                            if (hasUnread && currentChatUserId !== change.doc.id) {
                                const userData = allUsersMap.get(change.doc.id);
                                const userName = userData?.name || chatData.userName || 'A user';
                                addNotification(`New message from: ${userName}`, 'chat');
                                showNewMessageAlert({ ...chatData, userName }, change.doc.id);
                                // Show side menu chat red dot
                                const chatBubble = document.getElementById('chat-notification-bubble');
                                if (chatBubble) chatBubble.classList.remove('hidden');
                            }
                        }
                    });
                } else {
                    initialChatLoadComplete = true;
                }
            }, handleSnapshotError('Live Chats'));

            listenForNotifications();
            
            unsubscribeListeners.push(unsubOrders, unsubUsers, unsubAllProducts, unsubAllOrders, unsubAllUsers, unsubBanners, unsubSidePromos, unsubCoupons, unsubDeliveryMen, unsubChats);
        };

        // Enhance message textarea UX: autosize and Enter-to-send
        const setupChatInputEnhancements = () => {
            const ta = document.getElementById('chat-message-input');
            if (!ta) return;
            if (ta.dataset.enhanced === 'true') return; // prevent duplicate listeners
            const autosize = () => {
                ta.style.height = 'auto';
                ta.style.height = Math.min(200, ta.scrollHeight) + 'px';
            };
            ta.addEventListener('input', autosize);
            autosize();
            ta.addEventListener('keydown', (ev) => {
                if (ev.key === 'Enter' && !ev.shiftKey) {
                    ev.preventDefault();
                    const form = document.getElementById('chat-message-form');
                    if (form) form.requestSubmit();
                }
            });
            ta.dataset.enhanced = 'true';
        };

        const FONT_SCALE_KEY = 'adminFontScale';
        const FONT_SCALE_DEFAULT = 1;
        const FONT_SCALE_MIN = 0.85;
        const FONT_SCALE_MAX = 1.35;
        const FONT_SCALE_STEP = 0.05;

        const setupFontResizer = () => {
            const decreaseBtn = document.getElementById('font-size-decrease');
            const increaseBtn = document.getElementById('font-size-increase');
            const resetBtn = document.getElementById('font-size-reset');
            const display = document.getElementById('font-size-display');
            if (!decreaseBtn || !increaseBtn || !resetBtn || !display) return;

            const clampScale = (value) => {
                const numeric = typeof value === 'number' ? value : parseFloat(value);
                if (Number.isNaN(numeric)) return FONT_SCALE_DEFAULT;
                return Math.min(FONT_SCALE_MAX, Math.max(FONT_SCALE_MIN, numeric));
            };

            let scale = clampScale(localStorage.getItem(FONT_SCALE_KEY) ?? FONT_SCALE_DEFAULT);

            const applyScale = () => {
                const percent = Math.round(scale * 100);
                document.documentElement.style.setProperty('--admin-font-size', `${percent}%`);
                display.textContent = `${percent}%`;
                decreaseBtn.disabled = scale <= FONT_SCALE_MIN + 0.001;
                increaseBtn.disabled = scale >= FONT_SCALE_MAX - 0.001;
            };

            const updateScale = (next) => {
                scale = clampScale(next);
                if (Math.abs(scale - FONT_SCALE_DEFAULT) < 0.001) {
                    localStorage.removeItem(FONT_SCALE_KEY);
                } else {
                    localStorage.setItem(FONT_SCALE_KEY, scale.toFixed(2));
                }
                applyScale();
            };

            decreaseBtn.addEventListener('click', () => updateScale(scale - FONT_SCALE_STEP));
            increaseBtn.addEventListener('click', () => updateScale(scale + FONT_SCALE_STEP));
            resetBtn.addEventListener('click', () => updateScale(FONT_SCALE_DEFAULT));

            applyScale();
        };

        // --- Settings Page Logic ---
        const setupSettingsPage = () => {
            const timezoneSelector = document.getElementById('timezone-selector');
            if (!timezoneSelector) return;

            const savedTimeZone = localStorage.getItem('adminTimeZone') || 'Asia/Riyadh'; // Default to Riyadh

            const customTimezones = {
                'Asia/Dhaka': 'Dhaka, Bangladesh',
                'Asia/Riyadh': 'Riyadh, Saudi Arabia',
                'Asia/Singapore': 'Singapore',
                'Europe/Rome': 'Rome, Italy'
            };

            timezoneSelector.innerHTML = Object.entries(customTimezones).map(([tzValue, tzDisplay]) =>
                `<option value="${tzValue}" ${tzValue === savedTimeZone ? 'selected' : ''}>${tzDisplay}</option>`
            ).join('');
            
            // Set a default if the saved timezone is not in our custom list
            if (!customTimezones[savedTimeZone]) {
                localStorage.setItem('adminTimeZone', 'Asia/Riyadh');
                timezoneSelector.value = 'Asia/Riyadh';
            }

            timezoneSelector.addEventListener('change', (e) => {
                const newTimeZone = e.target.value;
                localStorage.setItem('adminTimeZone', newTimeZone);
                const displayName = customTimezones[newTimeZone] || newTimeZone;
                showToast(`Time zone set to ${displayName}`);
                updateClock(); // Update immediately on change
            });

            // Login Screen Wallpaper controls
            const defaultBg = 'https://github.com/tangailbuzzbd-svg/TangailBuzz-Picture-/blob/main/vecteezy_ai-generated-empty-wooden-table-on-the-natural-background_40890255.jpg?raw=true';
            const bgInput = document.getElementById('login-bg-url-input');
            const bgPreview = document.getElementById('login-bg-preview');
            const bgSaveBtn = document.getElementById('login-bg-save-btn');
            const bgResetBtn = document.getElementById('login-bg-reset-btn');

            const applyWallpaperToScreens = (url) => {
                const safe = url || defaultBg;
                document.querySelectorAll('#login-screen, #pin-verification-screen').forEach(div => {
                    if (div) div.style.backgroundImage = `url('${safe}')`;
                });
            };

            if (bgInput && bgPreview && bgSaveBtn && bgResetBtn) {
                const current = localStorage.getItem('login-bg-url') || defaultBg;
                bgInput.value = current;
                bgPreview.style.backgroundImage = `url('${current}')`;

                bgInput.addEventListener('input', (e) => {
                    const url = (e.target.value || '').trim();
                    bgPreview.style.backgroundImage = url ? `url('${url}')` : '';
                });

                bgSaveBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const url = (bgInput.value || '').trim();
                    if (!/^https?:\/\//i.test(url)) {
                        showToast('Please enter a valid http(s) image URL.', 'warning');
                        return;
                    }
                    localStorage.setItem('login-bg-url', url);
                    applyWallpaperToScreens(url);
                    showToast('Login wallpaper updated.');
                });

                bgResetBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    localStorage.removeItem('login-bg-url');
                    bgInput.value = defaultBg;
                    bgPreview.style.backgroundImage = `url('${defaultBg}')`;
                    applyWallpaperToScreens(defaultBg);
                    showToast('Login wallpaper reset to default.');
                });
            }

            // Login Screen Profile controls
            const defaultAvatar = 'https://github.com/tangailbuzzbd-svg/TangailBuzz-Picture-/blob/main/WhatsApp%20Image%202025-07-30%20at%2019.29.33_9f8c7d06.jpg?raw=true';
            const lpInput = document.getElementById('login-profile-url-input');
            const lpPreview = document.getElementById('login-profile-preview');
            const lpSaveBtn = document.getElementById('login-profile-save-btn');
            const lpResetBtn = document.getElementById('login-profile-reset-btn');

            const applyProfileToLogin = (url) => {
                const img = document.getElementById('login-profile-pic');
                if (img) img.src = url || defaultAvatar;
            };

            if (lpInput && lpPreview && lpSaveBtn && lpResetBtn) {
                const currentProfile = localStorage.getItem('login-profile-url') || defaultAvatar;
                lpInput.value = currentProfile;
                lpPreview.src = currentProfile;

                lpInput.addEventListener('input', (e) => {
                    const url = (e.target.value || '').trim();
                    lpPreview.src = url || defaultAvatar;
                });

                lpSaveBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const url = (lpInput.value || '').trim();
                    if (!/^https?:\/\//i.test(url)) {
                        showToast('Please enter a valid http(s) image URL.', 'warning');
                        return;
                    }
                    localStorage.setItem('login-profile-url', url);
                    applyProfileToLogin(url);
                    showToast('Login profile picture updated.');
                });

                lpResetBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    localStorage.removeItem('login-profile-url');
                    lpInput.value = defaultAvatar;
                    lpPreview.src = defaultAvatar;
                    applyProfileToLogin(defaultAvatar);
                    showToast('Login profile picture reset to default.');
                });
            }
        };
        // --- BULK UPLOAD EVENT LISTENERS ---
const bulkUploadBtn = document.getElementById('bulk-upload-btn');
const csvFileInput = document.getElementById('csv-file-input');

if (bulkUploadBtn && csvFileInput) {
    // 1. আপলোড বাটন ক্লিক করলে ফাইল সিলেক্ট করার অপশন চালু করা
    bulkUploadBtn.addEventListener('click', () => {
        csvFileInput.click();
    });

    // 2. ফাইল সিলেক্ট হলে প্রক্রিয়া শুরু করা
    csvFileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;

        // শুধু CSV ফাইল কিনা, চেক করা
        if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
            showToast("Please select a valid CSV file.", "error");
            event.target.value = null; // ফাইল রিসেট করা
            return;
        }

        const button = bulkUploadBtn;
        setButtonLoading(button, true, 'Processing...');

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const csvText = e.target.result;
                const productsArray = parseCSV(csvText);
                
                if (productsArray.length > 0) {
                    await saveBulkProducts(productsArray);
                } else {
                    showToast("No valid data found or CSV is empty.", "warning");
                }
            } catch (error) {
                console.error("CSV Processing Error:", error);
                showToast("An error occurred during bulk upload.", "error");
            } finally {
                setButtonLoading(button, false);
                event.target.value = null; // ফাইল ইনপুট রিসেট করা
            }
        };
        reader.readAsText(file);
    });
}

const downloadTemplateBtn = document.getElementById('download-template-btn');
if (downloadTemplateBtn) {
    downloadTemplateBtn.addEventListener('click', () => {
        const selectedDocs = getSelectedProductDocs();
        downloadBulkTemplate(selectedDocs);
    });
}

        // --- Main Initialization ---
    const initializeAdminPanel = (user) => {
            const pageId = window.location.hash.substring(1) || 'dashboard';
            showPage(pageId);
        ensureReportsPageSetup();
            // Keep quick-section-select in sync and wire navigation
            const quickSel = document.getElementById('quick-section-select');
            if (quickSel) {
                quickSel.value = pageId;
                quickSel.addEventListener('change', (e) => {
                    const val = e.target.value;
                    history.pushState({pageId: val}, '', `#${val}`);
                    showPage(val);
                });
            }
            const addForm = document.getElementById('add-product-form');
            const editForm = document.getElementById('edit-product-form');
            setupProductForm(addForm, 'add-');
            setupProductForm(editForm, 'edit-');
            document.getElementById('order-search-input').addEventListener('input', renderFilteredOrders);
            document.getElementById('manual-refresh-button').addEventListener('click', manualDataRefresh);
            // Listen for reviews only when reviews page is shown
            function handleReviewsPage() {
                renderReviewsList();
            }
            document.querySelectorAll('.nav-link[data-page="reviews"]').forEach(link => {
                link.addEventListener('click', handleReviewsPage);
            });
            
            loadAdminProfile(user);
            setupDataListeners();
            loadDashboardStats();
            // Start Live Visitors watcher (refreshes every 10s)
            startLiveVisitorsWatcher();
            // Initialize dashboard chart and its selector
            const daysSelect = document.getElementById('ordersChartDays');
            if (daysSelect) {
                daysSelect.addEventListener('change', (e) => {
                    const v = Number(e.target.value) || 7;
                    drawOrdersChart(v);
                });
                drawOrdersChart(Number(daysSelect.value) || 7);
            }
            // Metric toggle listeners
            ['metric-orders','metric-delivered','metric-ofd','metric-users','metric-products','metric-sales','metric-profit'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('change', () => drawOrdersChart(Number(daysSelect?.value) || 7));
            });
            // Download button
            const dlBtn = document.getElementById('downloadMetricsExcel');
            if (dlBtn) dlBtn.addEventListener('click', () => { downloadMetricsExcel(); });
            startClock();
            setupSettingsPage();
            lucide.createIcons();

            window.onpopstate = (event) => {
                if (event.state && event.state.pageId) {
                    showPage(event.state.pageId);
                }
            };
        };

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            initializeAppearance();
            setupFontResizer();
            // Global search: try orders, users, products, deliveryMen by id or key
            const globalSearchInput = document.getElementById('global-search-input');
            if (globalSearchInput) {
                const doGlobalSearch = async (raw) => {
                    const term = (raw || '').trim();
                    if (!term) return;
                    try {
                        // Orders by doc id or orderId
                        const ordersCol = collection(db, 'orders');
                        const orderDoc = await getDoc(doc(db, 'orders', term));
                        if (orderDoc.exists()) {
                            // Navigate to Orders page
                            showPage('orders');
                            // Pre-fill order search box for easier focus
                            const orderInput = document.getElementById('order-search-input');
                            if (orderInput) {
                                orderInput.value = orderDoc.id;
                                renderFilteredOrders();
                            }
                            return;
                        }
                        // Try matching by orderId field using a query (faster than scanning)
                        try {
                            const byOrderIdSnap = await getDocs(query(ordersCol, where('orderId', '==', term)));
                            if (!byOrderIdSnap.empty) {
                                showPage('orders');
                                const orderInput = document.getElementById('order-search-input');
                                if (orderInput) {
                                    orderInput.value = byOrderIdSnap.docs[0].data().orderId;
                                    renderFilteredOrders();
                                }
                                return;
                            }
                        } catch (innerErr) {
                            // As a fallback (e.g., if query fails for some reason), do a minimal scan
                            console.warn('orderId query failed, falling back to scan:', innerErr);
                            const ordersSnap = await getDocs(ordersCol);
                            const byOrderId = ordersSnap.docs.find(d => (d.data().orderId || '').toString() === term);
                            if (byOrderId) {
                                showPage('orders');
                                const orderInput = document.getElementById('order-search-input');
                                if (orderInput) {
                                    orderInput.value = byOrderId.data().orderId;
                                    renderFilteredOrders();
                                }
                                return;
                            }
                        }

                        // Users by uid (doc id)
                        const userDoc = await getDoc(doc(db, 'users', term));
                        if (userDoc.exists()) {
                            // Open user profile modal with full info
                            await openUserProfile(term);
                            return;
                        }

                        // Products by document id or business Product ID (model/productId)
                        const productDoc = await getDoc(doc(db, 'products', term));
                        if (productDoc.exists()) {
                            // Open directly in edit view for convenience
                            await loadProductForEdit(productDoc.id);
                            return;
                        }
                        const productsCol = collection(db, 'products');
                        // Try exact match on model
                        try {
                            const byModelSnap = await getDocs(query(productsCol, where('model', '==', term)));
                            if (!byModelSnap.empty) {
                                await loadProductForEdit(byModelSnap.docs[0].id);
                                return;
                            }
                            // Try exact match on productId field if present
                            const byPidSnap = await getDocs(query(productsCol, where('productId', '==', term)));
                            if (!byPidSnap.empty) {
                                await loadProductForEdit(byPidSnap.docs[0].id);
                                return;
                            }
                        } catch (prodQueryErr) {
                            console.warn('Product id query failed, falling back to scan:', prodQueryErr);
                        }
                        // Fallback: scan and match case-insensitively or substring
                        const productsSnap = await getDocs(productsCol);
                        const lowerTerm = term.toLowerCase();
                        const foundProd = productsSnap.docs.find(d => {
                            const data = d.data();
                            const model = (data.model || '').toString();
                            const pid = (data.productId || '').toString();
                            return model.toLowerCase() === lowerTerm || pid.toLowerCase() === lowerTerm || model.toLowerCase().includes(lowerTerm) || pid.toLowerCase().includes(lowerTerm);
                        });
                        if (foundProd) {
                            await loadProductForEdit(foundProd.id);
                            return;
                        }

                        // Delivery man by id
                        const dmDoc = await getDoc(doc(db, 'deliveryMen', term));
                        if (dmDoc.exists()) {
                            showPage('delivery');
                            return;
                        }

                        showToast('No matching record found', 'warning');
                    } catch (e) {
                        console.error('Global search error', e);
                        showToast('Search failed. Check permissions or try again.', 'error');
                    }
                };

                // Fire on Enter (use keydown for better cross-browser reliability)
                globalSearchInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        doGlobalSearch(globalSearchInput.value);
                    }
                });
            }
            // Initialize AudioContext and Speech Synthesis on first user interaction to comply with browser policies
            const primeAudioAndSpeech = () => {
                initAudio();
                // Prime the speech synthesis engine by getting voices list
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.getVoices();
                }
                // Remove the listeners after the first interaction to avoid re-triggering
                document.body.removeEventListener('click', primeAudioAndSpeech);
                document.body.removeEventListener('keydown', primeAudioAndSpeech);
            };

            document.body.addEventListener('click', primeAudioAndSpeech);
            document.body.addEventListener('keydown', primeAudioAndSpeech);
        });

    </script>

</body>
</html>
